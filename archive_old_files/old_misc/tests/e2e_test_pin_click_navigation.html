<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>E2Eテスト: ピンクリック→地域切り替えシナリオ</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  max-width: 1200px;
  margin: 40px auto;
  padding: 20px;
  background: #f5f5f5;
}
.test-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 30px;
  border-radius: 12px;
  margin-bottom: 30px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.test-header h1 {
  margin: 0 0 10px 0;
  font-size: 28px;
}
.test-header p {
  margin: 0;
  opacity: 0.9;
  font-size: 14px;
}
.test-section {
  background: white;
  padding: 25px;
  margin-bottom: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}
.test-section h2 {
  margin: 0 0 20px 0;
  color: #333;
  font-size: 20px;
  border-bottom: 2px solid #667eea;
  padding-bottom: 10px;
}
.test-case {
  padding: 15px;
  margin-bottom: 15px;
  border-left: 4px solid #667eea;
  background: #f8f9fa;
  border-radius: 4px;
}
.test-case.passed {
  border-left-color: #10b981;
  background: #f0fdf4;
}
.test-case.failed {
  border-left-color: #ef4444;
  background: #fef2f2;
}
.test-case h3 {
  margin: 0 0 10px 0;
  font-size: 16px;
  color: #1f2937;
}
.test-case .status {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  margin-left: 10px;
}
.status.passed {
  background: #10b981;
  color: white;
}
.status.failed {
  background: #ef4444;
  color: white;
}
.status.pending {
  background: #f59e0b;
  color: white;
}
.test-details {
  margin-top: 10px;
  font-size: 14px;
  line-height: 1.6;
  color: #4b5563;
}
.test-details ul {
  margin: 10px 0;
  padding-left: 20px;
}
.test-details li {
  margin: 5px 0;
}
.test-summary {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin-top: 20px;
}
.summary-card {
  background: white;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}
.summary-card .label {
  font-size: 14px;
  color: #6b7280;
  margin-bottom: 8px;
}
.summary-card .value {
  font-size: 32px;
  font-weight: 700;
}
.summary-card.total .value {
  color: #667eea;
}
.summary-card.passed .value {
  color: #10b981;
}
.summary-card.failed .value {
  color: #ef4444;
}
.run-button {
  background: #667eea;
  color: white;
  border: none;
  padding: 12px 30px;
  border-radius: 6px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 20px;
  transition: background 0.3s;
}
.run-button:hover {
  background: #5568d3;
}
.run-button:disabled {
  background: #9ca3af;
  cursor: not-allowed;
}
#testOutput {
  margin-top: 20px;
}
.code-block {
  background: #1f2937;
  color: #f3f4f6;
  padding: 15px;
  border-radius: 6px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  overflow-x: auto;
  margin: 10px 0;
}
</style>
</head>
<body>

<div class="test-header">
  <h1>E2Eテスト: ピンクリック→地域切り替えシナリオ</h1>
  <p>テスト種別: End-to-End Test | 実施日: <span id="testDate"></span></p>
</div>

<div class="test-section">
  <h2>テスト概要</h2>
  <div class="test-details">
    <p><strong>目的</strong>: 実際のユーザー操作を模倣して、近隣地域ピンクリック→地域切り替え機能が正しく動作することを検証する</p>
    <p><strong>テスト範囲</strong>:</p>
    <ul>
      <li>フロントエンドUI（ブラウザ操作）</li>
      <li>地図マーカー表示・クリックイベント</li>
      <li>都道府県・市町村プルダウンの連動</li>
      <li>データ読み込み→表示の一連の流れ</li>
    </ul>
    <p><strong>実施方法</strong>: HTMLファイル埋め込みダミーデータを使用した自動テスト</p>
  </div>
</div>

<div class="test-section">
  <h2>テスト実行</h2>
  <button class="run-button" id="runTestBtn">テストを実行</button>
  <div id="testOutput"></div>
</div>

<script>
// テスト日付設定
document.getElementById('testDate').textContent = new Date().toLocaleDateString('ja-JP');

// テスト結果格納
let testResults = [];

// テスト実行ボタン
document.getElementById('runTestBtn').addEventListener('click', async function() {
  this.disabled = true;
  testResults = [];

  const output = document.getElementById('testOutput');
  output.innerHTML = '<p style="color: #667eea; font-weight: 600;">テストを実行中...</p>';

  // テスト実行（非同期）
  await runE2ETests();

  // 結果表示
  displayResults();

  this.disabled = false;
});

// E2Eテスト実行
async function runE2ETests() {
  // Scenario 1: HTMLファイル読み込み確認
  await testScenario1();

  // Scenario 2: 初期表示確認（都道府県・市町村プルダウン、地図マーカー）
  await testScenario2();

  // Scenario 3: ピンクリック→地域切り替え
  await testScenario3();

  // Scenario 4: 都道府県変更→市町村更新
  await testScenario4();

  // Scenario 5: フロータブ表示確認
  await testScenario5();
}

// Scenario 1: HTMLファイル読み込み確認
async function testScenario1() {
  const testCase = {
    id: 'E2E-001',
    name: 'HTMLファイル読み込み確認',
    status: 'pending',
    details: []
  };

  try {
    // map_complete_prototype_Ver2.htmlをiframeで読み込む
    const iframe = document.createElement('iframe');
    iframe.id = 'testIframe';
    iframe.src = '../gas_files/html/map_complete_prototype_Ver2.html';
    iframe.style.width = '1px';
    iframe.style.height = '1px';
    iframe.style.position = 'absolute';
    iframe.style.left = '-9999px';
    document.body.appendChild(iframe);

    // 読み込み待機
    await new Promise((resolve) => {
      iframe.onload = resolve;
      setTimeout(resolve, 5000); // 5秒タイムアウト
    });

    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

    // 検証1: documentが存在するか
    if (!iframeDoc) {
      throw new Error('iframeのdocumentが取得できません');
    }
    testCase.details.push('✅ HTMLファイルが正常に読み込まれました');

    // 検証2: 都道府県プルダウンが存在するか
    const prefectureSelect = iframeDoc.querySelector('#prefectureSelect');
    if (!prefectureSelect) {
      throw new Error('都道府県プルダウンが見つかりません');
    }
    testCase.details.push('✅ 都道府県プルダウンが存在します');

    // 検証3: 市町村プルダウンが存在するか
    const municipalitySelect = iframeDoc.querySelector('#municipalitySelect');
    if (!municipalitySelect) {
      throw new Error('市町村プルダウンが見つかりません');
    }
    testCase.details.push('✅ 市町村プルダウンが存在します');

    // 検証4: 地図要素が存在するか
    const mapElement = iframeDoc.querySelector('#map');
    if (!mapElement) {
      throw new Error('地図要素が見つかりません');
    }
    testCase.details.push('✅ 地図要素が存在します');

    testCase.status = 'passed';
  } catch (error) {
    testCase.status = 'failed';
    testCase.details.push(`❌ エラー: ${error.message}`);
  }

  testResults.push(testCase);
}

// Scenario 2: 初期表示確認
async function testScenario2() {
  const testCase = {
    id: 'E2E-002',
    name: '初期表示確認（プルダウン・マーカー）',
    status: 'pending',
    details: []
  };

  try {
    const iframe = document.getElementById('testIframe');
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    const iframeWindow = iframe.contentWindow;

    // 1秒待機（JavaScriptの初期化完了待ち）
    await new Promise(resolve => setTimeout(resolve, 1000));

    // 検証1: 都道府県プルダウンにオプションが存在するか
    const prefectureSelect = iframeDoc.querySelector('#prefectureSelect');
    const prefOptions = prefectureSelect.querySelectorAll('option');
    if (prefOptions.length < 2) { // 最低2件（プレースホルダー + 1都道府県）
      throw new Error(`都道府県プルダウンのオプション数が不足: ${prefOptions.length}件`);
    }
    testCase.details.push(`✅ 都道府県プルダウンに${prefOptions.length}件のオプションが存在します`);

    // 検証2: 市町村プルダウンにオプションが存在するか
    const municipalitySelect = iframeDoc.querySelector('#municipalitySelect');
    const muniOptions = municipalitySelect.querySelectorAll('option');
    if (muniOptions.length < 2) {
      throw new Error(`市町村プルダウンのオプション数が不足: ${muniOptions.length}件`);
    }
    testCase.details.push(`✅ 市町村プルダウンに${muniOptions.length}件のオプションが存在します`);

    // 検証3: 地図が初期化されているか（Leaflet mapインスタンス）
    if (!iframeWindow.map) {
      throw new Error('地図インスタンスが初期化されていません');
    }
    testCase.details.push('✅ 地図が正常に初期化されています');

    // 検証4: マーカーレイヤーが存在するか
    if (!iframeWindow.markersLayer) {
      throw new Error('マーカーレイヤーが存在しません');
    }
    testCase.details.push('✅ マーカーレイヤーが存在します');

    // 検証5: マーカーが表示されているか
    const markers = iframeWindow.markersLayer.getLayers();
    if (markers.length === 0) {
      throw new Error('マーカーが1つも表示されていません');
    }
    testCase.details.push(`✅ 地図上に${markers.length}個のマーカーが表示されています`);

    testCase.status = 'passed';
  } catch (error) {
    testCase.status = 'failed';
    testCase.details.push(`❌ エラー: ${error.message}`);
  }

  testResults.push(testCase);
}

// Scenario 3: ピンクリック→地域切り替え
async function testScenario3() {
  const testCase = {
    id: 'E2E-003',
    name: 'ピンクリック→地域切り替えシナリオ',
    status: 'pending',
    details: []
  };

  try {
    const iframe = document.getElementById('testIframe');
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    const iframeWindow = iframe.contentWindow;

    // 検証準備: 初期選択地域を取得
    const initialPrefecture = iframeDoc.querySelector('#prefectureSelect').value;
    const initialMunicipality = iframeDoc.querySelector('#municipalitySelect').value;
    testCase.details.push(`初期地域: ${initialPrefecture} ${initialMunicipality}`);

    // 検証1: 近隣地域ピンが存在するか
    const markers = iframeWindow.markersLayer.getLayers();
    const nearbyMarkers = markers.filter(m => {
      // 赤色マーカー（選択中）以外を近隣地域とみなす
      return m.options && m.options.color !== '#ef4444';
    });

    if (nearbyMarkers.length === 0) {
      throw new Error('近隣地域ピンが見つかりません');
    }
    testCase.details.push(`✅ 近隣地域ピン: ${nearbyMarkers.length}個`);

    // 検証2: 近隣地域ピンをクリック
    const targetMarker = nearbyMarkers[0];
    targetMarker.fire('click');
    testCase.details.push('✅ 近隣地域ピンをクリックしました');

    // クリック処理完了待機
    await new Promise(resolve => setTimeout(resolve, 500));

    // 検証3: 地域が切り替わったか
    const newPrefecture = iframeDoc.querySelector('#prefectureSelect').value;
    const newMunicipality = iframeDoc.querySelector('#municipalitySelect').value;

    if (newPrefecture === initialPrefecture && newMunicipality === initialMunicipality) {
      throw new Error('地域が切り替わっていません');
    }
    testCase.details.push(`✅ 地域が切り替わりました: ${newPrefecture} ${newMunicipality}`);

    // 検証4: マーカーが再描画されたか
    const newMarkers = iframeWindow.markersLayer.getLayers();
    if (newMarkers.length === 0) {
      throw new Error('マーカーが再描画されていません');
    }
    testCase.details.push(`✅ マーカーが再描画されました: ${newMarkers.length}個`);

    // 検証5: 選択中マーカー（赤色）が存在するか
    const currentMarker = newMarkers.find(m => m.options && m.options.color === '#ef4444');
    if (!currentMarker) {
      throw new Error('選択中マーカー（赤色）が見つかりません');
    }
    testCase.details.push('✅ 選択中マーカー（赤色）が正しく表示されています');

    testCase.status = 'passed';
  } catch (error) {
    testCase.status = 'failed';
    testCase.details.push(`❌ エラー: ${error.message}`);
  }

  testResults.push(testCase);
}

// Scenario 4: 都道府県変更→市町村更新
async function testScenario4() {
  const testCase = {
    id: 'E2E-004',
    name: '都道府県変更→市町村プルダウン更新',
    status: 'pending',
    details: []
  };

  try {
    const iframe = document.getElementById('testIframe');
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    const iframeWindow = iframe.contentWindow;

    const prefectureSelect = iframeDoc.querySelector('#prefectureSelect');
    const municipalitySelect = iframeDoc.querySelector('#municipalitySelect');

    // 検証準備: 初期都道府県を取得
    const initialPrefecture = prefectureSelect.value;
    const initialMuniCount = municipalitySelect.querySelectorAll('option').length;
    testCase.details.push(`初期都道府県: ${initialPrefecture} (市町村: ${initialMuniCount}件)`);

    // 検証1: 別の都道府県を選択
    const allPrefOptions = Array.from(prefectureSelect.querySelectorAll('option')).filter(opt => opt.value !== '' && opt.value !== initialPrefecture);

    if (allPrefOptions.length === 0) {
      throw new Error('切り替え可能な都道府県が見つかりません');
    }

    const targetPrefecture = allPrefOptions[0].value;
    prefectureSelect.value = targetPrefecture;
    prefectureSelect.dispatchEvent(new Event('change'));
    testCase.details.push(`✅ 都道府県を変更: ${targetPrefecture}`);

    // 変更処理完了待機
    await new Promise(resolve => setTimeout(resolve, 500));

    // 検証2: 市町村プルダウンが更新されたか
    const newMuniOptions = municipalitySelect.querySelectorAll('option');
    testCase.details.push(`✅ 市町村プルダウンが更新されました: ${newMuniOptions.length}件`);

    // 検証3: 市町村が選択可能か（プレースホルダー以外のオプションが存在）
    const selectableMunis = Array.from(newMuniOptions).filter(opt => opt.value !== '');
    if (selectableMunis.length === 0) {
      throw new Error('選択可能な市町村がありません');
    }
    testCase.details.push(`✅ 選択可能な市町村: ${selectableMunis.length}件`);

    testCase.status = 'passed';
  } catch (error) {
    testCase.status = 'failed';
    testCase.details.push(`❌ エラー: ${error.message}`);
  }

  testResults.push(testCase);
}

// Scenario 5: フロータブ表示確認
async function testScenario5() {
  const testCase = {
    id: 'E2E-005',
    name: 'フロータブ表示確認',
    status: 'pending',
    details: []
  };

  try {
    const iframe = document.getElementById('testIframe');
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    const iframeWindow = iframe.contentWindow;

    // 検証1: フロータブボタンが存在するか
    const flowTabButton = iframeDoc.querySelector('button[data-tab="flow"]');
    if (!flowTabButton) {
      throw new Error('フロータブボタンが見つかりません');
    }
    testCase.details.push('✅ フロータブボタンが存在します');

    // 検証2: フロータブをクリック
    flowTabButton.click();
    testCase.details.push('✅ フロータブをクリックしました');

    // タブ切り替え処理完了待機
    await new Promise(resolve => setTimeout(resolve, 300));

    // 検証3: フロータブパネルが表示されているか
    const flowPanel = iframeDoc.querySelector('.panel[data-panel="flow"]');
    if (!flowPanel) {
      throw new Error('フロータブパネルが見つかりません');
    }

    const isVisible = flowPanel.style.display !== 'none' &&
                      flowPanel.offsetHeight > 0;
    if (!isVisible) {
      throw new Error('フロータブパネルが非表示です');
    }
    testCase.details.push('✅ フロータブパネルが表示されています');

    // 検証4: KPI（重要指標）が表示されているか
    const kpiElements = flowPanel.querySelectorAll('.kpi-item, .metric-card');
    if (kpiElements.length === 0) {
      throw new Error('KPI要素が見つかりません');
    }
    testCase.details.push(`✅ KPI要素が表示されています: ${kpiElements.length}個`);

    // 検証5: フローテーブル（流入・流出）が存在するか
    const tables = flowPanel.querySelectorAll('table');
    if (tables.length === 0) {
      throw new Error('フローテーブルが見つかりません');
    }
    testCase.details.push(`✅ フローテーブルが存在します: ${tables.length}個`);

    // 検証6: 地図上にフロー矢印が表示されているか
    if (!iframeWindow.flowLayer) {
      throw new Error('フロー矢印レイヤーが存在しません');
    }

    const flowArrows = iframeWindow.flowLayer.getLayers();
    if (flowArrows.length === 0) {
      throw new Error('フロー矢印が1つも表示されていません');
    }
    testCase.details.push(`✅ 地図上にフロー矢印が表示されています: ${flowArrows.length}本`);

    testCase.status = 'passed';
  } catch (error) {
    testCase.status = 'failed';
    testCase.details.push(`❌ エラー: ${error.message}`);
  }

  testResults.push(testCase);
}

// 結果表示
function displayResults() {
  const output = document.getElementById('testOutput');

  const passedCount = testResults.filter(t => t.status === 'passed').length;
  const failedCount = testResults.filter(t => t.status === 'failed').length;
  const totalCount = testResults.length;
  const successRate = totalCount > 0 ? ((passedCount / totalCount) * 100).toFixed(1) : 0;

  let html = `
    <div class="test-summary">
      <div class="summary-card total">
        <div class="label">総テスト数</div>
        <div class="value">${totalCount}</div>
      </div>
      <div class="summary-card passed">
        <div class="label">成功</div>
        <div class="value">${passedCount}</div>
      </div>
      <div class="summary-card failed">
        <div class="label">失敗</div>
        <div class="value">${failedCount}</div>
      </div>
    </div>

    <div style="margin-top: 20px; padding: 15px; background: ${successRate >= 95 ? '#f0fdf4' : '#fef2f2'}; border-radius: 8px; text-align: center;">
      <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">成功率</div>
      <div style="font-size: 36px; font-weight: 700; color: ${successRate >= 95 ? '#10b981' : '#ef4444'};">${successRate}%</div>
      <div style="font-size: 14px; color: #6b7280; margin-top: 5px;">
        ${successRate >= 95 ? '✅ 品質要件を満たしています（95%以上）' : '⚠️ 品質要件未達（95%未満）'}
      </div>
    </div>
  `;

  testResults.forEach(test => {
    html += `
      <div class="test-case ${test.status}">
        <h3>
          ${test.id}: ${test.name}
          <span class="status ${test.status}">${test.status === 'passed' ? 'PASS' : 'FAIL'}</span>
        </h3>
        <div class="test-details">
          ${test.details.map(detail => `<div>${detail}</div>`).join('')}
        </div>
      </div>
    `;
  });

  output.innerHTML = html;

  // テスト完了後、iframeを削除
  const iframe = document.getElementById('testIframe');
  if (iframe) {
    iframe.remove();
  }
}
</script>

</body>
</html>
