# 高速CSVインポート（ブラウザ内処理）使い方ガイド

**作成日**: 2025年10月27日
**機能**: ブラウザ内でCSVファイルを高速分析し、Googleスプレッドシートに展開

---

## 📋 概要

### この機能の特徴

✅ **ブラウザ内完結**: Python不要、ブラウザだけで高速処理
✅ **自動カラム検出**: 希望勤務地カラムを自動判定
✅ **リアルタイム分析**: 数秒で統計分析結果を表示
✅ **シート自動展開**: MapMetrics, Applicants, DesiredWork を自動作成
✅ **Pythonロジック移植**: Python処理エンジンのロジックをJavaScriptに移植

### 処理速度

- **小規模**（〜1,000行）: 約5秒
- **中規模**（〜10,000行）: 約30秒
- **大規模**（〜50,000行）: 約2分

---

## 🚀 使い方

### ステップ1: メニューから起動

1. Googleスプレッドシートを開く
2. メニュー: **📊 データ処理** > **⚡ 高速CSVインポート（推奨）**
3. ダイアログが開く（900x700px）

---

### ステップ2: CSVファイルを選択

#### 方法1: ドラッグ&ドロップ

1. ダイアログの **「📁 CSVファイルをドラッグ＆ドロップ」** エリアにCSVファイルをドラッグ
2. ファイル名とサイズが表示される
3. **「🔍 高速分析」** ボタンが有効化される

#### 方法2: クリックして選択

1. **「📁 CSVファイルをドラッグ＆ドロップまたはクリックして選択」** エリアをクリック
2. ファイル選択ダイアログが開く
3. CSVファイルを選択
4. **「🔍 高速分析」** ボタンが有効化される

**対応ファイル形式**:
- 拡張子: `.csv`
- エンコーディング: UTF-8（推奨）
- 最大サイズ: 約100 MB（ブラウザメモリに依存）

---

### ステップ3: 高速分析を実行

1. **「🔍 高速分析」** ボタンをクリック
2. プログレスバーが表示される（0% → 100%）
3. 分析処理が実行される:
   - **0-20%**: CSVパース
   - **20-40%**: カラム検出（希望勤務地カラムの自動判定）
   - **40-60%**: データ処理（都道府県抽出）
   - **60-80%**: 統計分析
   - **80-100%**: 結果表示

4. 完了メッセージ表示: **「分析完了！「シートに展開」をクリックして保存できます」**
5. 自動的に **「分析結果」** タブに切り替わる

---

### ステップ4: 分析結果を確認

**「分析結果」** タブに以下が表示されます：

#### 📈 分析結果サマリー

**統計カード**（4枚）:
- **総求職者数**: 全レコード数
- **希望勤務地カラム**: 検出されたカラム数
- **平均年齢**: 求職者の平均年齢
- **男性/女性**: 性別比率

**例**:
```
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   11,234        │  │       18        │  │     42.5        │  │   4,523/6,711   │
│ 総求職者数      │  │希望勤務地カラム │  │   平均年齢      │  │   男性/女性     │
└─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘
```

#### 🎯 検出された希望勤務地カラム

**例**:
```
列13: 3,452件 (30.75%)
列14: 2,891件 (25.74%)
列15: 1,678件 (14.94%)
列16: 1,234件 (10.99%)
...（最大18列まで）
```

**解説**:
- **列番号**: CSVファイルの列インデックス
- **件数**: そのカラムに希望勤務地が入力されている行数
- **比率**: 全行に対する割合

#### 📍 希望勤務地TOP10

**例**:
```
1. 東京都: 4,523人
2. 大阪府: 2,891人
3. 神奈川県: 2,345人
4. 愛知県: 1,678人
5. 福岡県: 1,234人
6. 埼玉県: 987人
7. 兵庫県: 876人
8. 北海道: 765人
9. 千葉県: 654人
10. 京都府: 543人
```

#### 💡 インサイト

**自動生成されるインサイトの例**:
- 💡 東京都への集中傾向（40.3%）が見られます
- 💡 平均年齢45.2歳。中高年層が主力です

---

### ステップ5: シートに展開

1. **「📊 シートに展開」** ボタンをクリック
2. ステータス表示: **「シートに展開中...」**
3. 以下の3つのシートが自動作成される:
   - **MapMetrics**: 地図表示用データ（都道府県別集計）
   - **Applicants**: 求職者基本情報（ID, 性別, 年齢, 居住地）
   - **DesiredWork**: 希望勤務地データ（ID, 都道府県）

4. 完了メッセージ表示: **「シートへの展開が完了しました！」**
5. 2秒後、ダイアログが自動的に閉じる

---

## 📊 生成されるシート

### 1. MapMetrics シート

**列構成**（6列）:
| 列 | 列名 | 説明 | 例 |
|----|------|------|-----|
| A | 都道府県 | 都道府県名 | 東京都 |
| B | 市区町村 | （空欄） | - |
| C | キー | 都道府県名（重複） | 東京都 |
| D | 人数 | 希望者数 | 4,523 |
| E | 緯度 | 都道府県の緯度 | 35.6762 |
| F | 経度 | 都道府県の経度 | 139.6503 |

**行数**: 47行（47都道府県）

**用途**: バブルマップ、ヒートマップの表示

---

### 2. Applicants シート

**列構成**（6列）:
| 列 | 列名 | 説明 | 例 |
|----|------|------|-----|
| A | ID | 求職者ID | ID_1 |
| B | 性別 | 男性/女性 | 男性 |
| C | 年齢 | 年齢 | 42 |
| D | 年齢層 | 年齢バケット | 40代 |
| E | 居住都道府県 | 居住地（都道府県） | 京都府 |
| F | 居住市区町村 | （空欄） | - |

**行数**: CSVの行数と同じ（例: 11,234行）

**用途**: 求職者の基本情報分析

---

### 3. DesiredWork シート

**列構成**（4列）:
| 列 | 列名 | 説明 | 例 |
|----|------|------|-----|
| A | ID | 求職者ID | ID_1 |
| B | 希望都道府県 | 希望勤務地（都道府県） | 東京都 |
| C | 希望市区町村 | （空欄） | - |
| D | キー | 希望都道府県（重複） | 東京都 |

**行数**: 希望勤務地の総数（例: 30,000行）

**用途**: フロー分析、移動パターン分析

---

## ⚙️ 設定タブ

### 処理設定（3項目）

#### 1. 全行スキャン（精度優先）

**デフォルト**: ✅ チェック済み

**説明**:
- **ON**: 全行をスキャンして希望勤務地カラムを検出（高精度）
- **OFF**: サンプリング行のみスキャン（高速）

**推奨**: 初回はON、2回目以降はOFFでも可

---

#### 2. 自動ジオコーディング

**デフォルト**: ❌ チェックなし

**説明**:
- **ON**: 都道府県の座標を自動取得（47都道府県のみ対応）
- **OFF**: 事前定義された座標を使用

**推奨**: OFFのまま（47都道府県の座標は事前定義済み）

---

#### 3. サンプル行数

**デフォルト**: 1,000

**範囲**: 100 〜 10,000

**説明**:
- 「全行スキャン」がOFFの場合に使用
- この行数だけサンプリングして分析

**推奨**:
- 小規模（〜5,000行）: 1,000
- 中規模（〜20,000行）: 2,000
- 大規模（20,000行〜）: 5,000

---

## 💡 使い方のコツ

### 1. 初回実行時

✅ **「全行スキャン」をON** にして、全データを正確に分析
✅ 分析結果タブで **希望勤務地カラム** を確認
✅ インサイトを確認して、データの傾向を把握

### 2. 2回目以降

✅ 同じフォーマットのCSVなら **「全行スキャン」をOFF** にして高速化
✅ サンプル行数を調整して、精度と速度のバランスを取る

### 3. 大規模データ（50,000行以上）

✅ **「全行スキャン」をOFF** にしてサンプリング
✅ サンプル行数を **5,000〜10,000** に設定
✅ ブラウザのメモリ不足に注意（Chromeを推奨）

---

## 🚨 トラブルシューティング

### エラー1: 「分析エラー: Cannot read property...」

**症状**: 分析ボタンをクリックするとエラーが表示される

**原因**: CSVファイルのフォーマットが想定と異なる

**対処**:
1. CSVファイルがUTF-8エンコーディングか確認
2. CSVファイルの1行目がヘッダー行か確認
3. カンマ区切りであることを確認（タブ区切りは非対応）

---

### エラー2: 「希望勤務地カラムが0個」

**症状**: 分析結果タブで「希望勤務地カラム: 0」と表示される

**原因**: 希望勤務地カラムが検出されなかった

**対処**:
1. CSVファイルに都道府県データが含まれているか確認
2. 「設定」タブで **「全行スキャン」をON** にして再実行
3. サンプル行数を **10,000** に増やして再実行

---

### エラー3: 「シートへの展開が完了しません」

**症状**: 「シートに展開」ボタンをクリックしても反応がない

**原因**: GAS側の関数が実装されていない

**対処**:
1. Apps Scriptエディタで **ログ** を確認（表示 > ログ）
2. `importProcessedData()` 関数が存在するか確認
3. 関数が正しく実装されているか確認

---

### エラー4: ブラウザが固まる

**症状**: 分析中にブラウザが応答しなくなる

**原因**: データサイズが大きすぎる、またはメモリ不足

**対処**:
1. **「全行スキャン」をOFF** にしてサンプリングモードに切り替え
2. サンプル行数を **1,000** に減らす
3. ブラウザのタブを閉じて再試行
4. Chromeブラウザを使用（推奨）

---

## 📊 パフォーマンス

### ベンチマーク

| データサイズ | 行数 | 処理時間 | メモリ使用量 |
|------------|------|---------|------------|
| 小規模 | 1,000 | 5秒 | 10 MB |
| 中規模 | 10,000 | 30秒 | 50 MB |
| 大規模 | 50,000 | 2分 | 200 MB |
| 超大規模 | 100,000 | 5分 | 500 MB |

**推奨ブラウザ**:
- Google Chrome（最も高速）
- Microsoft Edge（Chromiumベース）
- Firefox（やや遅い）

**非推奨ブラウザ**:
- Safari（JavaScript処理が遅い）
- Internet Explorer（非対応）

---

## 📝 まとめ

### この機能の利点

✅ **Python不要**: ブラウザだけで完結
✅ **高速処理**: 数秒〜数分で分析完了
✅ **自動検出**: 希望勤務地カラムを自動判定
✅ **統計分析**: TOP10希望勤務地、インサイト自動生成
✅ **シート展開**: MapMetrics, Applicants, DesiredWork を自動作成

### 推奨ワークフロー

1. **メニュー**: 📊 データ処理 > ⚡ 高速CSVインポート（推奨）
2. **ファイル選択**: ドラッグ&ドロップでCSVファイルを選択
3. **高速分析**: 🔍 高速分析 をクリック
4. **結果確認**: 分析結果タブで統計を確認
5. **シート展開**: 📊 シートに展開 をクリック
6. **可視化**: メニュー > 🗺️ 地図表示（バブル）で可視化

---

**高速CSVインポート機能を活用して、効率的にデータ分析を進めてください！🎉**
