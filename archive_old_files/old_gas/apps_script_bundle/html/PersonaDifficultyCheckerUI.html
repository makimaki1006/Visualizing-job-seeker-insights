<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
      margin: 0;
    }

    h2 {
      color: #1976d2;
      margin-bottom: 20px;
      text-align: center;
    }

    .filter-panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-label {
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
    }

    select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      background: white;
    }

    select[multiple] {
      min-height: 120px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    button {
      padding: 10px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #1976d2;
      color: white;
    }

    .btn-primary:hover {
      background: #1565c0;
    }

    .btn-secondary {
      background: #757575;
      color: white;
    }

    .btn-secondary:hover {
      background: #616161;
    }

    .stats-panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
    }

    .stat-card {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 4px;
      text-align: center;
    }

    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #1976d2;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    .persona-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .persona-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .persona-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .difficulty-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      color: white;
    }

    .difficulty-S { background: #d32f2f; }
    .difficulty-A { background: #f57c00; }
    .difficulty-B { background: #fbc02d; }
    .difficulty-C { background: #7cb342; }
    .difficulty-D { background: #66bb6a; }
    .difficulty-E { background: #81c784; }

    .persona-header {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }

    .persona-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }

    .persona-subtitle {
      font-size: 14px;
      color: #666;
    }

    .persona-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .metric-item {
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
    }

    .metric-label {
      font-size: 11px;
      color: #666;
      margin-bottom: 3px;
    }

    .metric-value {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }

    .persona-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .category-tag {
      padding: 4px 10px;
      background: #e0e0e0;
      border-radius: 12px;
      font-size: 11px;
      color: #333;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .no-results {
      text-align: center;
      padding: 60px;
      color: #999;
      font-size: 18px;
    }

    .help-text {
      font-size: 12px;
      color: #666;
      font-style: italic;
      margin-top: 5px;
    }

    .score-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }

    .score-fill {
      height: 100%;
      background: linear-gradient(90deg, #81c784 0%, #fbc02d 50%, #d32f2f 100%);
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <h2>ğŸ¯ ãƒšãƒ«ã‚½ãƒŠé›£æ˜“åº¦ç¢ºèª</h2>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒãƒ« -->
  <div class="filter-panel">
    <h3 style="margin-top: 0; color: #1976d2;">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</h3>

    <div class="filter-grid">
      <!-- é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ« -->
      <div class="filter-group">
        <div class="filter-label">é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ«</div>
        <select id="difficultyFilter" multiple>
          <option value="Sç´šï¼ˆæœ€é›£ï¼‰">Sç´šï¼ˆæœ€é›£ï¼‰</option>
          <option value="Aç´šï¼ˆé›£ï¼‰">Aç´šï¼ˆé›£ï¼‰</option>
          <option value="Bç´šï¼ˆã‚„ã‚„é›£ï¼‰">Bç´šï¼ˆã‚„ã‚„é›£ï¼‰</option>
          <option value="Cç´šï¼ˆæ™®é€šï¼‰">Cç´šï¼ˆæ™®é€šï¼‰</option>
          <option value="Dç´šï¼ˆã‚„ã‚„æ˜“ï¼‰">Dç´šï¼ˆã‚„ã‚„æ˜“ï¼‰</option>
          <option value="Eç´šï¼ˆæ˜“ï¼‰">Eç´šï¼ˆæ˜“ï¼‰</option>
        </select>
        <div class="help-text">æ¡ç”¨é›£æ˜“åº¦ãƒ©ãƒ³ã‚¯</div>
      </div>

      <!-- å¹´é½¢ã‚°ãƒ«ãƒ¼ãƒ— -->
      <div class="filter-group">
        <div class="filter-label">å¹´é½¢å±¤</div>
        <select id="ageGroupFilter" multiple>
          <option value="æ–°å’å±¤ï¼ˆï½24æ­³ï¼‰">æ–°å’å±¤ï¼ˆï½24æ­³ï¼‰</option>
          <option value="è‹¥æ‰‹å±¤ï¼ˆ25ï½29æ­³ï¼‰">è‹¥æ‰‹å±¤ï¼ˆ25ï½29æ­³ï¼‰</option>
          <option value="è‹¥æ‰‹ä¸­å …å±¤ï¼ˆ30ï½34æ­³ï¼‰">è‹¥æ‰‹ä¸­å …å±¤ï¼ˆ30ï½34æ­³ï¼‰</option>
          <option value="ä¸­å …å±¤ï¼ˆ35ï½39æ­³ï¼‰">ä¸­å …å±¤ï¼ˆ35ï½39æ­³ï¼‰</option>
          <option value="ãƒŸãƒ‰ãƒ«å±¤ï¼ˆ40ï½44æ­³ï¼‰">ãƒŸãƒ‰ãƒ«å±¤ï¼ˆ40ï½44æ­³ï¼‰</option>
          <option value="ã‚·ãƒ‹ã‚¢ãƒŸãƒ‰ãƒ«å±¤ï¼ˆ45ï½49æ­³ï¼‰">ã‚·ãƒ‹ã‚¢ãƒŸãƒ‰ãƒ«å±¤ï¼ˆ45ï½49æ­³ï¼‰</option>
          <option value="ãƒ—ãƒ¬ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ50ï½54æ­³ï¼‰">ãƒ—ãƒ¬ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ50ï½54æ­³ï¼‰</option>
          <option value="ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ55ï½59æ­³ï¼‰">ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ55ï½59æ­³ï¼‰</option>
          <option value="ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ60ï½64æ­³ï¼‰">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ60ï½64æ­³ï¼‰</option>
          <option value="é«˜é½¢å±¤ï¼ˆ65æ­³ï½ï¼‰">é«˜é½¢å±¤ï¼ˆ65æ­³ï½ï¼‰</option>
        </select>
        <div class="help-text">å¹³å‡å¹´é½¢ã«ã‚ˆã‚‹ã‚°ãƒ«ãƒ¼ãƒ—åˆ†é¡</div>
      </div>

      <!-- è³‡æ ¼ãƒ¬ãƒ™ãƒ« -->
      <div class="filter-group">
        <div class="filter-label">è³‡æ ¼ä¿æœ‰ãƒ¬ãƒ™ãƒ«</div>
        <select id="qualificationFilter" multiple>
          <option value="è¶…é«˜è³‡æ ¼å±¤ï¼ˆ5å€‹ä»¥ä¸Šï¼‰">è¶…é«˜è³‡æ ¼å±¤ï¼ˆ5å€‹ä»¥ä¸Šï¼‰</option>
          <option value="é«˜è³‡æ ¼å±¤ï¼ˆ3ï½4å€‹ï¼‰">é«˜è³‡æ ¼å±¤ï¼ˆ3ï½4å€‹ï¼‰</option>
          <option value="ä¸­è³‡æ ¼å±¤ï¼ˆ2ï½3å€‹ï¼‰">ä¸­è³‡æ ¼å±¤ï¼ˆ2ï½3å€‹ï¼‰</option>
          <option value="ä½è³‡æ ¼å±¤ï¼ˆ1ï½2å€‹ï¼‰">ä½è³‡æ ¼å±¤ï¼ˆ1ï½2å€‹ï¼‰</option>
          <option value="å¾®è³‡æ ¼å±¤ï¼ˆ0.5ï½1å€‹ï¼‰">å¾®è³‡æ ¼å±¤ï¼ˆ0.5ï½1å€‹ï¼‰</option>
          <option value="ç„¡è³‡æ ¼å±¤ï¼ˆ0.5å€‹æœªæº€ï¼‰">ç„¡è³‡æ ¼å±¤ï¼ˆ0.5å€‹æœªæº€ï¼‰</option>
        </select>
        <div class="help-text">å¹³å‡è³‡æ ¼ä¿æœ‰æ•°</div>
      </div>

      <!-- ç§»å‹•æ€§ãƒ¬ãƒ™ãƒ« -->
      <div class="filter-group">
        <div class="filter-label">å¸Œæœ›å‹¤å‹™åœ°ã®åºƒã•</div>
        <select id="mobilityFilter" multiple>
          <option value="è¶…åºƒåŸŸå¸Œæœ›ï¼ˆ10ç®‡æ‰€ä»¥ä¸Šï¼‰">è¶…åºƒåŸŸå¸Œæœ›ï¼ˆ10ç®‡æ‰€ä»¥ä¸Šï¼‰</option>
          <option value="åºƒåŸŸå¸Œæœ›ï¼ˆ6ï½9ç®‡æ‰€ï¼‰">åºƒåŸŸå¸Œæœ›ï¼ˆ6ï½9ç®‡æ‰€ï¼‰</option>
          <option value="ä¸­åŸŸå¸Œæœ›ï¼ˆ4ï½5ç®‡æ‰€ï¼‰">ä¸­åŸŸå¸Œæœ›ï¼ˆ4ï½5ç®‡æ‰€ï¼‰</option>
          <option value="ç‹­åŸŸå¸Œæœ›ï¼ˆ2.5ï½3.5ç®‡æ‰€ï¼‰">ç‹­åŸŸå¸Œæœ›ï¼ˆ2.5ï½3.5ç®‡æ‰€ï¼‰</option>
          <option value="é™å®šå¸Œæœ›ï¼ˆ1.5ï½2.5ç®‡æ‰€ï¼‰">é™å®šå¸Œæœ›ï¼ˆ1.5ï½2.5ç®‡æ‰€ï¼‰</option>
          <option value="å›ºå®šå¸Œæœ›ï¼ˆ1.5ç®‡æ‰€æœªæº€ï¼‰">å›ºå®šå¸Œæœ›ï¼ˆ1.5ç®‡æ‰€æœªæº€ï¼‰</option>
        </select>
        <div class="help-text">å¸Œæœ›å‹¤å‹™åœ°æ•°ã«ã‚ˆã‚‹æŸ”è»Ÿæ€§</div>
      </div>

      <!-- æ€§åˆ¥ã‚«ãƒ†ã‚´ãƒª -->
      <div class="filter-group">
        <div class="filter-label">æ€§åˆ¥æ§‹æˆ</div>
        <select id="genderFilter" multiple>
          <option value="å¥³æ€§ç‰¹åŒ–å±¤ï¼ˆ90%ä»¥ä¸Šï¼‰">å¥³æ€§ç‰¹åŒ–å±¤ï¼ˆ90%ä»¥ä¸Šï¼‰</option>
          <option value="å¥³æ€§å„ªå‹¢å±¤ï¼ˆ70ï½89%ï¼‰">å¥³æ€§å„ªå‹¢å±¤ï¼ˆ70ï½89%ï¼‰</option>
          <option value="å¥³æ€§ã‚„ã‚„å¤šå±¤ï¼ˆ55ï½69%ï¼‰">å¥³æ€§ã‚„ã‚„å¤šå±¤ï¼ˆ55ï½69%ï¼‰</option>
          <option value="ç”·å¥³å‡è¡¡å±¤ï¼ˆ45ï½54%ï¼‰">ç”·å¥³å‡è¡¡å±¤ï¼ˆ45ï½54%ï¼‰</option>
          <option value="ç”·æ€§ã‚„ã‚„å¤šå±¤ï¼ˆ31ï½44%ï¼‰">ç”·æ€§ã‚„ã‚„å¤šå±¤ï¼ˆ31ï½44%ï¼‰</option>
          <option value="ç”·æ€§å„ªå‹¢å±¤ï¼ˆ11ï½30%ï¼‰">ç”·æ€§å„ªå‹¢å±¤ï¼ˆ11ï½30%ï¼‰</option>
          <option value="ç”·æ€§ç‰¹åŒ–å±¤ï¼ˆ10%ä»¥ä¸‹ï¼‰">ç”·æ€§ç‰¹åŒ–å±¤ï¼ˆ10%ä»¥ä¸‹ï¼‰</option>
        </select>
        <div class="help-text">å¥³æ€§æ¯”ç‡ã«ã‚ˆã‚‹åˆ†é¡</div>
      </div>

      <!-- å¸‚å ´è¦æ¨¡ -->
      <div class="filter-group">
        <div class="filter-label">å¸‚å ´è¦æ¨¡</div>
        <select id="marketSizeFilter" multiple>
          <option value="è¶…å¤§è¦æ¨¡ï¼ˆ20%ä»¥ä¸Šï¼‰">è¶…å¤§è¦æ¨¡ï¼ˆ20%ä»¥ä¸Šï¼‰</option>
          <option value="å¤§è¦æ¨¡ï¼ˆ15ï½19%ï¼‰">å¤§è¦æ¨¡ï¼ˆ15ï½19%ï¼‰</option>
          <option value="ä¸­è¦æ¨¡ï¼ˆ10ï½14%ï¼‰">ä¸­è¦æ¨¡ï¼ˆ10ï½14%ï¼‰</option>
          <option value="ã‚„ã‚„å°è¦æ¨¡ï¼ˆ7ï½9%ï¼‰">ã‚„ã‚„å°è¦æ¨¡ï¼ˆ7ï½9%ï¼‰</option>
          <option value="å°è¦æ¨¡ï¼ˆ4ï½6%ï¼‰">å°è¦æ¨¡ï¼ˆ4ï½6%ï¼‰</option>
          <option value="è¶…å°è¦æ¨¡ï¼ˆ2ï½3%ï¼‰">è¶…å°è¦æ¨¡ï¼ˆ2ï½3%ï¼‰</option>
          <option value="ãƒ‹ãƒƒãƒï¼ˆ2%æœªæº€ï¼‰">ãƒ‹ãƒƒãƒï¼ˆ2%æœªæº€ï¼‰</option>
        </select>
        <div class="help-text">å…¨ä½“ã«å ã‚ã‚‹å‰²åˆ</div>
      </div>
    </div>

    <div class="button-group">
      <button class="btn-primary" onclick="applyFilters()">çµã‚Šè¾¼ã¿å®Ÿè¡Œ</button>
      <button class="btn-secondary" onclick="resetFilters()">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <!-- çµ±è¨ˆãƒ‘ãƒãƒ« -->
  <div class="stats-panel" id="statsPanel" style="display: none;">
    <h3 style="margin-top: 0; color: #1976d2;">çµ±è¨ˆã‚µãƒãƒªãƒ¼</h3>
    <div class="stats-grid" id="statsGrid"></div>
  </div>

  <!-- ãƒšãƒ«ã‚½ãƒŠè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div id="personaContainer" class="loading">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>

  <script>
    let allPersonas = [];

    // åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          allPersonas = result.personas;
          displayPersonas(allPersonas);
          loadStatistics();
        } else {
          document.getElementById('personaContainer').innerHTML =
            '<div class="no-results">ã‚¨ãƒ©ãƒ¼: ' + result.message + '</div>';
        }
      })
      .withFailureHandler(function(error) {
        document.getElementById('personaContainer').innerHTML =
          '<div class="no-results">ã‚¨ãƒ©ãƒ¼: ' + error + '</div>';
      })
      .getPersonaDataForDifficulty();

    // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
    function loadStatistics() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
              <div class="stat-card">
                <div class="stat-value">${result.totalPersonas}</div>
                <div class="stat-label">ãƒšãƒ«ã‚½ãƒŠæ•°</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${result.totalCount.toLocaleString()}</div>
                <div class="stat-label">ç·æ±‚è·è€…æ•°</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${result.avgDifficultyScore.toFixed(1)}</div>
                <div class="stat-label">å¹³å‡é›£æ˜“åº¦</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${Object.keys(result.difficultyDistribution).length}</div>
                <div class="stat-label">é›£æ˜“åº¦ç¨®é¡</div>
              </div>
            `;
            document.getElementById('statsPanel').style.display = 'block';
          }
        })
        .getPersonaDifficultyStatistics();
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
    function applyFilters() {
      const filters = {
        difficultyLevels: getSelectedValues('difficultyFilter'),
        ageGroups: getSelectedValues('ageGroupFilter'),
        qualificationLevels: getSelectedValues('qualificationFilter'),
        mobilityLevels: getSelectedValues('mobilityFilter'),
        genderCategories: getSelectedValues('genderFilter'),
        marketSizeCategories: getSelectedValues('marketSizeFilter')
      };

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            displayPersonas(result.personas);
          }
        })
        .filterPersonasByConditions(filters);
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
    function resetFilters() {
      document.querySelectorAll('select[multiple]').forEach(select => {
        select.selectedIndex = -1;
      });
      displayPersonas(allPersonas);
    }

    // é¸æŠå€¤å–å¾—
    function getSelectedValues(selectId) {
      const select = document.getElementById(selectId);
      return Array.from(select.selectedOptions).map(opt => opt.value);
    }

    // ãƒšãƒ«ã‚½ãƒŠè¡¨ç¤º
    function displayPersonas(personas) {
      const container = document.getElementById('personaContainer');

      if (personas.length === 0) {
        container.innerHTML = '<div class="no-results">è©²å½“ã™ã‚‹ãƒšãƒ«ã‚½ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        return;
      }

      container.innerHTML = '';
      container.className = 'persona-grid';

      personas.forEach(function(p) {
        const difficultyClass = 'difficulty-' + p.difficultyLevel.charAt(0);
        const scorePercent = p.difficultyScore;

        const card = document.createElement('div');
        card.className = 'persona-card';
        card.innerHTML = `
          <div class="difficulty-badge ${difficultyClass}">
            ${p.difficultyLevel} (${p.difficultyScore}ç‚¹)
          </div>

          <div class="persona-header">
            <div class="persona-title">${p.segmentName}</div>
            <div class="persona-subtitle">
              ã‚»ã‚°ãƒ¡ãƒ³ãƒˆID: ${p.segmentId} | ${p.count.toLocaleString()}äºº (${p.percentage.toFixed(1)}%)
            </div>
          </div>

          <div class="persona-metrics">
            <div class="metric-item">
              <div class="metric-label">å¹³å‡å¹´é½¢</div>
              <div class="metric-value">${p.avgAge.toFixed(1)}æ­³</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">å¥³æ€§æ¯”ç‡</div>
              <div class="metric-value">${(p.femaleRatio * 100).toFixed(1)}%</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">å¹³å‡è³‡æ ¼æ•°</div>
              <div class="metric-value">${p.avgQualifications.toFixed(2)}å€‹</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">å¸Œæœ›å‹¤å‹™åœ°æ•°</div>
              <div class="metric-value">${p.avgDesiredLocations.toFixed(1)}ç®‡æ‰€</div>
            </div>
          </div>

          <div class="score-bar">
            <div class="score-fill" style="width: ${scorePercent}%"></div>
          </div>

          <div class="persona-categories" style="margin-top: 15px;">
            <div class="category-tag">${p.ageGroup}</div>
            <div class="category-tag">${p.qualificationLevel}</div>
            <div class="category-tag">${p.mobilityLevel}</div>
            <div class="category-tag">${p.genderCategory}</div>
            <div class="category-tag">${p.marketSizeCategory}</div>
          </div>
        `;

        container.appendChild(card);
      });
    }
  </script>
</body>
</html>
