<!-- ===== BubbleMap.html ===== -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>å¸Œæœ›å‹¤å‹™åœ°ãƒãƒ–ãƒ«ãƒãƒƒãƒ—</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
    }
    .container {
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 350px;
      background: white;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    .map-container {
      flex: 1;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    h2 {
      color: #667eea;
      font-size: 20px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .stats-label {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 5px;
    }
    .stats-value {
      font-size: 28px;
      font-weight: bold;
    }
    .top10-list {
      list-style: none;
      margin-top: 10px;
    }
    .top10-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      margin-bottom: 5px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 13px;
    }
    .top10-rank {
      font-weight: bold;
      color: #667eea;
      margin-right: 10px;
    }
    .top10-prefecture {
      flex: 1;
    }
    .top10-count {
      font-weight: bold;
      color: #333;
    }
    .gender-chart {
      margin-top: 15px;
      height: 150px;
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      font-size: 18px;
      color: #667eea;
    }
    .error {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      padding: 30px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 400px;
    }
    .error-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    .error-message {
      color: #721c24;
      font-size: 14px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h2>ğŸ“Š çµ±è¨ˆæƒ…å ±</h2>

      <div class="stats-card">
        <div class="stats-label">ç·æ±‚è·è€…æ•°</div>
        <div class="stats-value" id="totalCount">-</div>
      </div>

      <div class="stats-card">
        <div class="stats-label">å¹³å‡å¹´é½¢</div>
        <div class="stats-value" id="avgAge">-</div>
      </div>

      <h2>ğŸ“ å¸Œæœ›å‹¤å‹™åœ° TOP10</h2>
      <ul class="top10-list" id="top10List"></ul>

      <h2>ğŸ‘¥ æ€§åˆ¥åˆ†å¸ƒ</h2>
      <div class="gender-chart" id="genderChart"></div>
    </div>

    <div class="map-container">
      <div class="loading" id="loading">
        ğŸ”„ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
      </div>
      <div id="map"></div>
    </div>
  </div>

  <script>
    let map;
    let markers = [];

    // Google Chartsèª­ã¿è¾¼ã¿
    google.charts.load('current', {'packages':['corechart']});

    // åˆæœŸåŒ–
    function init() {
      // æ—¥æœ¬ä¸­å¿ƒã®åœ°å›³ã‚’åˆæœŸåŒ–
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 36.5, lng: 138.0 },
        zoom: 6,
        mapTypeId: 'roadmap'
      });

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      loadData();
    }

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadData() {
      document.getElementById('loading').style.display = 'block';

      Promise.all([
        callGAS('getMapMetricsData'),
        callGAS('getApplicantsStats'),
        callGAS('getDesiredWorkTop10')
      ]).then(([mapData, stats, top10]) => {
        document.getElementById('loading').style.display = 'none';

        // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
        displayStats(stats);

        // TOP10è¡¨ç¤º
        displayTop10(top10);

        // åœ°å›³ã«ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
        displayMarkers(mapData);

        // æ€§åˆ¥ã‚°ãƒ©ãƒ•è¡¨ç¤º
        google.charts.setOnLoadCallback(() => displayGenderChart(stats.byGender));

      }).catch(error => {
        document.getElementById('loading').innerHTML = `
          <div class="error">
            <div class="error-icon">âš ï¸</div>
            <div class="error-message">
              <strong>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</strong><br><br>
              ${error.message}
            </div>
          </div>
        `;
      });
    }

    // GASé–¢æ•°å‘¼ã³å‡ºã—ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function callGAS(functionName) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          [functionName]();
      });
    }

    // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
    function displayStats(stats) {
      document.getElementById('totalCount').textContent = stats.total.toLocaleString();
      document.getElementById('avgAge').textContent = stats.avgAge + 'æ­³';
    }

    // TOP10è¡¨ç¤º
    function displayTop10(top10) {
      const listEl = document.getElementById('top10List');
      listEl.innerHTML = '';

      top10.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'top10-item';
        li.innerHTML = `
          <span class="top10-rank">${index + 1}</span>
          <span class="top10-prefecture">${item.prefecture}</span>
          <span class="top10-count">${item.count.toLocaleString()}äºº</span>
        `;
        listEl.appendChild(li);
      });
    }

    // ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
    function displayMarkers(data) {
      // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
      markers.forEach(marker => marker.setMap(null));
      markers = [];

      // æœ€å¤§å€¤ã‚’å–å¾—ï¼ˆãƒãƒ–ãƒ«ã‚µã‚¤ã‚ºè¨ˆç®—ç”¨ï¼‰
      const maxCount = Math.max(...data.map(item => item.count));

      data.forEach(item => {
        // ãƒãƒ–ãƒ«ã‚µã‚¤ã‚ºè¨ˆç®—ï¼ˆ10-50pxï¼‰
        const radius = 10 + (item.count / maxCount) * 40;

        // ã‚µãƒ¼ã‚¯ãƒ«ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ
        const circle = new google.maps.Circle({
          strokeColor: '#667eea',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: '#667eea',
          fillOpacity: 0.35,
          map: map,
          center: { lat: item.lat, lng: item.lng },
          radius: radius * 1000 // ãƒ¡ãƒ¼ãƒˆãƒ«å˜ä½
        });

        // æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
        const infoWindow = new google.maps.InfoWindow({
          content: `
            <div style="padding: 10px;">
              <strong style="font-size: 16px; color: #667eea;">${item.prefecture}</strong><br>
              <span style="font-size: 14px;">å¸Œæœ›è€…æ•°: <strong>${item.count.toLocaleString()}äºº</strong></span>
            </div>
          `
        });

        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        circle.addListener('click', () => {
          infoWindow.setPosition({ lat: item.lat, lng: item.lng });
          infoWindow.open(map);
        });

        markers.push(circle);
      });
    }

    // æ€§åˆ¥ã‚°ãƒ©ãƒ•è¡¨ç¤º
    function displayGenderChart(byGender) {
      const data = google.visualization.arrayToDataTable([
        ['æ€§åˆ¥', 'äººæ•°'],
        ...Object.entries(byGender)
      ]);

      const options = {
        pieHole: 0.4,
        colors: ['#667eea', '#764ba2'],
        legend: { position: 'bottom' },
        chartArea: { width: '90%', height: '70%' }
      };

      const chart = new google.visualization.PieChart(document.getElementById('genderChart'));
      chart.draw(data, options);
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    window.onload = init;
  </script>
</body>
</html>

<!-- ===== HeatMap.html ===== -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>å¸Œæœ›å‹¤å‹™åœ°ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=visualization"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
    }
    .container {
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 350px;
      background: white;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    .map-container {
      flex: 1;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    h2 {
      color: #667eea;
      font-size: 20px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .stats-label {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 5px;
    }
    .stats-value {
      font-size: 28px;
      font-weight: bold;
    }
    .controls {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .control-label {
      font-size: 13px;
      font-weight: bold;
      color: #666;
      margin-bottom: 10px;
      display: block;
    }
    .slider-container {
      margin-bottom: 15px;
    }
    .slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #ddd;
      outline: none;
      -webkit-appearance: none;
    }
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
    }
    .slider-value {
      font-size: 12px;
      color: #667eea;
      font-weight: bold;
      margin-top: 5px;
    }
    .top10-list {
      list-style: none;
      margin-top: 10px;
    }
    .top10-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      margin-bottom: 5px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 13px;
    }
    .top10-rank {
      font-weight: bold;
      color: #667eea;
      margin-right: 10px;
    }
    .top10-prefecture {
      flex: 1;
    }
    .top10-count {
      font-weight: bold;
      color: #333;
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      font-size: 18px;
      color: #667eea;
    }
    .error {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      padding: 30px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 400px;
    }
    .error-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    .error-message {
      color: #721c24;
      font-size: 14px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h2>ğŸ“Š çµ±è¨ˆæƒ…å ±</h2>

      <div class="stats-card">
        <div class="stats-label">ç·æ±‚è·è€…æ•°</div>
        <div class="stats-value" id="totalCount">-</div>
      </div>

      <div class="stats-card">
        <div class="stats-label">å¹³å‡å¹´é½¢</div>
        <div class="stats-value" id="avgAge">-</div>
      </div>

      <h2>âš™ï¸ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—è¨­å®š</h2>
      <div class="controls">
        <div class="slider-container">
          <label class="control-label">å¼·åº¦ï¼ˆIntensityï¼‰</label>
          <input type="range" min="1" max="100" value="50" class="slider" id="intensitySlider">
          <div class="slider-value" id="intensityValue">50</div>
        </div>

        <div class="slider-container">
          <label class="control-label">åŠå¾„ï¼ˆRadiusï¼‰</label>
          <input type="range" min="10" max="50" value="25" class="slider" id="radiusSlider">
          <div class="slider-value" id="radiusValue">25 px</div>
        </div>
      </div>

      <h2>ğŸ“ å¸Œæœ›å‹¤å‹™åœ° TOP10</h2>
      <ul class="top10-list" id="top10List"></ul>
    </div>

    <div class="map-container">
      <div class="loading" id="loading">
        ğŸ”„ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
      </div>
      <div id="map"></div>
    </div>
  </div>

  <script>
    let map;
    let heatmap;
    let heatmapData = [];

    // Google Chartsèª­ã¿è¾¼ã¿
    google.charts.load('current', {'packages':['corechart']});

    // åˆæœŸåŒ–
    function init() {
      // æ—¥æœ¬ä¸­å¿ƒã®åœ°å›³ã‚’åˆæœŸåŒ–
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 36.5, lng: 138.0 },
        zoom: 6,
        mapTypeId: 'roadmap'
      });

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      loadData();

      // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
      setupControls();
    }

    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¨­å®š
    function setupControls() {
      const intensitySlider = document.getElementById('intensitySlider');
      const radiusSlider = document.getElementById('radiusSlider');

      intensitySlider.addEventListener('input', (e) => {
        document.getElementById('intensityValue').textContent = e.target.value;
        updateHeatmap();
      });

      radiusSlider.addEventListener('input', (e) => {
        document.getElementById('radiusValue').textContent = e.target.value + ' px';
        updateHeatmap();
      });
    }

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadData() {
      document.getElementById('loading').style.display = 'block';

      Promise.all([
        callGAS('getMapMetricsData'),
        callGAS('getApplicantsStats'),
        callGAS('getDesiredWorkTop10')
      ]).then(([mapData, stats, top10]) => {
        document.getElementById('loading').style.display = 'none';

        // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
        displayStats(stats);

        // TOP10è¡¨ç¤º
        displayTop10(top10);

        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿æº–å‚™
        prepareHeatmapData(mapData);

        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—è¡¨ç¤º
        displayHeatmap();

      }).catch(error => {
        document.getElementById('loading').innerHTML = `
          <div class="error">
            <div class="error-icon">âš ï¸</div>
            <div class="error-message">
              <strong>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</strong><br><br>
              ${error.message}
            </div>
          </div>
        `;
      });
    }

    // GASé–¢æ•°å‘¼ã³å‡ºã—ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function callGAS(functionName) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          [functionName]();
      });
    }

    // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
    function displayStats(stats) {
      document.getElementById('totalCount').textContent = stats.total.toLocaleString();
      document.getElementById('avgAge').textContent = stats.avgAge + 'æ­³';
    }

    // TOP10è¡¨ç¤º
    function displayTop10(top10) {
      const listEl = document.getElementById('top10List');
      listEl.innerHTML = '';

      top10.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'top10-item';
        li.innerHTML = `
          <span class="top10-rank">${index + 1}</span>
          <span class="top10-prefecture">${item.prefecture}</span>
          <span class="top10-count">${item.count.toLocaleString()}äºº</span>
        `;
        listEl.appendChild(li);
      });
    }

    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿æº–å‚™
    function prepareHeatmapData(data) {
      heatmapData = data.map(item => ({
        location: new google.maps.LatLng(item.lat, item.lng),
        weight: item.count
      }));
    }

    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—è¡¨ç¤º
    function displayHeatmap() {
      if (heatmap) {
        heatmap.setMap(null);
      }

      heatmap = new google.maps.visualization.HeatmapLayer({
        data: heatmapData,
        map: map
      });

      updateHeatmap();
    }

    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—æ›´æ–°
    function updateHeatmap() {
      if (!heatmap) return;

      const intensity = parseInt(document.getElementById('intensitySlider').value) / 100;
      const radius = parseInt(document.getElementById('radiusSlider').value);

      heatmap.setOptions({
        radius: radius,
        opacity: intensity,
        gradient: [
          'rgba(0, 255, 255, 0)',
          'rgba(0, 255, 255, 1)',
          'rgba(0, 191, 255, 1)',
          'rgba(0, 127, 255, 1)',
          'rgba(0, 63, 255, 1)',
          'rgba(0, 0, 255, 1)',
          'rgba(0, 0, 223, 1)',
          'rgba(0, 0, 191, 1)',
          'rgba(0, 0, 159, 1)',
          'rgba(0, 0, 127, 1)',
          'rgba(63, 0, 91, 1)',
          'rgba(127, 0, 63, 1)',
          'rgba(191, 0, 31, 1)',
          'rgba(255, 0, 0, 1)'
        ]
      });
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    window.onload = init;
  </script>
</body>
</html>

<!-- ===== MapComplete.html ===== -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>æ±‚è·è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Yu Gothic', 'Hiragino Kaku Gothic Pro', Meiryo, sans-serif; height: 100vh; overflow: hidden; }
    .container { display: flex; height: 100vh; }
    #map { flex: 1; height: 100%; }
    .sidebar { width: 360px; background: #2d2d5f; color: #ffffff; padding: 20px; overflow-y: auto; box-shadow: -5px 0 20px rgba(0,0,0,0.3); }
    .sidebar-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #ffe082; }
    .stat-card { background: rgba(255,255,255,0.08); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .stat-card.highlight { border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 0 10px rgba(255,255,255,0.1); }
    .stat-label { font-size: 12px; color: rgba(255,255,255,0.65); margin-bottom: 6px; display: block; }
    .stat-value { font-size: 24px; font-weight: bold; color: #ffe082; }
    .region-title { font-size: 16px; font-weight: bold; margin-bottom: 8px; color: #ffffff; }
    .region-stat { font-size: 13px; margin-bottom: 6px; }
    .region-stat .label { color: rgba(255,255,255,0.7); margin-right: 6px; }
    .chart-container { background: rgba(255,255,255,0.08); border-radius: 8px; padding: 16px; margin-bottom: 16px; height: 200px; }
    .control-group { margin-bottom: 16px; }
    .control-label { font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 6px; display: block; }
    select { width: 100%; padding: 10px; border-radius: 4px; border: none; background: rgba(255,255,255,0.95); color: #2d2d5f; font-size: 13px; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1); }
    select:focus { outline: none; box-shadow: 0 0 0 2px rgba(255,255,255,0.6); }
    .top10-list { list-style: none; max-height: 220px; overflow-y: auto; padding-right: 4px; }
    .top10-item { display: flex; justify-content: space-between; padding: 8px 10px; margin-bottom: 6px; background: rgba(255,255,255,0.08); border-radius: 4px; cursor: pointer; transition: background 0.2s ease; }
    .top10-item:hover { background: rgba(255,255,255,0.18); }
    .top10-rank { font-weight: bold; color: #ffe082; margin-right: 10px; }
    .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #ffffff; color: #2d2d5f; padding: 28px 36px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 9999; font-weight: bold; }
    canvas { background: transparent; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
  </style>
</head>
<body>
  <div class="loading" id="loading">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>
  <div class="container">
    <div id="map"></div>
    <div class="sidebar">
      <div class="sidebar-title">æ±‚è·è€…ãƒãƒƒãƒ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
      <div class="stat-card">
        <span class="stat-label">ç·æ±‚è·è€…æ•°</span>
        <span class="stat-value" id="totalCount">-</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">å¹³å‡å¹´é½¢</span>
        <span class="stat-value" id="avgAge">-</span>
      </div>
      <div class="control-group">
        <label class="control-label">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</label>
        <select id="displayMode" onchange="changeDisplayMode()">
          <option value="markers">å€‹åˆ¥ãƒãƒ¼ã‚«ãƒ¼</option>
          <option value="cluster">ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼</option>
          <option value="heatmap">ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</option>
        </select>
      </div>
      <div class="control-group">
        <label class="control-label">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
        <select id="dataFilter" onchange="applyFilter()">
          <option value="all">å…¨ãƒ‡ãƒ¼ã‚¿</option>
          <option value="male">ç”·æ€§ã®ã¿</option>
          <option value="female">å¥³æ€§ã®ã¿</option>
          <option value="young">20-39æ­³</option>
          <option value="middle">40-59æ­³</option>
          <option value="senior">60æ­³ä»¥ä¸Š</option>
        </select>
      </div>
      <div class="stat-card highlight" id="regionDetailCard" style="display:none;">
        <div class="region-title" id="regionDetailTitle"></div>
        <div class="region-stat"><span class="label">æ±‚è·è€…æ•°:</span> <span id="regionTotal"></span></div>
        <div class="region-stat" id="regionFilterNote" style="display:none;"><span class="label">é©ç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</span> <span id="regionFilterText"></span></div>
        <div class="region-stat"><span class="label">å¹³å‡å¹´é½¢:</span> <span id="regionAvgAge"></span></div>
        <div class="region-stat"><span class="label">ç”·å¥³æ¯”:</span> ç”·æ€§ <span id="regionMale"></span> / å¥³æ€§ <span id="regionFemale"></span></div>
        <div class="region-stat"><span class="label">å¹³å‡è³‡æ ¼æ•°:</span> <span id="regionQualifications"></span></div>
      </div>
      <div class="stat-card">
        <span class="stat-label">å¸Œæœ›å‹¤å‹™åœ° TOP10</span>
        <ul class="top10-list" id="top10List"></ul>
      </div>
      <div class="chart-container">
        <canvas id="genderChart"></canvas>
      </div>
    </div>
  </div>
  <script>
    let map;
    let markers = [];
    let markerCluster;
    let heatLayer = null;
    let allData = { mapMetrics: [], applicants: [], desiredWork: [], aggDesired: [] };
    let activeFilter = 'all';
    let filteredMapData = [];
    let selectedRegionKey = null;

    const COL_MAP = {
      prefecture: ['éƒ½é“åºœçœŒ', 'prefecture'],
      municipality: ['å¸‚åŒºç”ºæ‘', 'municipality'],
      location_key: ['ã‚­ãƒ¼', 'location_key'],
      count: ['ã‚«ã‚¦ãƒ³ãƒˆ', 'applicant_count', 'count'],
      male_count: ['ç”·æ€§æ•°', 'male_count'],
      female_count: ['å¥³æ€§æ•°', 'female_count'],
      avg_age: ['å¹³å‡å¹´é½¢', 'avg_age'],
      avg_qualifications: ['å¹³å‡è³‡æ ¼æ•°', 'avg_qualifications'],
      latitude: ['ç·¯åº¦', 'latitude'],
      longitude: ['çµŒåº¦', 'longitude'],
      age: ['å¹´é½¢', 'age'],
      gender: ['æ€§åˆ¥', 'gender']
    };

    const FILTER_LABELS = {
      all: 'å…¨ãƒ‡ãƒ¼ã‚¿',
      male: 'ç”·æ€§',
      female: 'å¥³æ€§',
      young: '20-39æ­³å¸¯',
      middle: '40-59æ­³å¸¯',
      senior: '60æ­³ä»¥ä¸Š'
    };

    function getVal(row, key) {
      if (!row) return undefined;
      const candidates = COL_MAP[key] || [key];
      for (const candidate of candidates) {
        if (row[candidate] !== undefined && row[candidate] !== null) {
          return row[candidate];
        }
      }
      return undefined;
    }

    function getNumber(row, key) {
      const value = getVal(row, key);
      const num = typeof value === 'number' ? value : parseFloat(value);
      return Number.isFinite(num) ? num : 0;
    }

    function getCountForRow(row) {
      if (row && row.__filteredCount !== undefined && row.__filteredCount !== null) {
        return row.__filteredCount;
      }
      return row ? row.__baseCount || getNumber(row, 'count') : 0;
    }

    function initMap() {
      map = L.map('map', { center: [35.0116, 135.7681], zoom: 10 });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap',
        maxZoom: 18
      }).addTo(map);

      markerCluster = L.markerClusterGroup({ chunkedLoading: true, maxClusterRadius: 60 });
      map.addLayer(markerCluster);
    }

    function loadData() {
      google.script.run
        .withSuccessHandler(function(data) {
          allData = data || { mapMetrics: [], applicants: [], desiredWork: [], aggDesired: [] };
          document.getElementById('loading').style.display = 'none';
          refreshView();
        })
        .withFailureHandler(function(error) {
          alert('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
          document.getElementById('loading').style.display = 'none';
        })
        .getAllVisualizationData();
    }

    function refreshView() {
      filteredMapData = buildFilteredDataset(activeFilter);
      updateStats(activeFilter);
      renderMap();
      updateTop10();
      updateGenderChart();

      if (selectedRegionKey) {
        const preserved = filteredMapData.find(row => row.__key === selectedRegionKey);
        if (preserved) {
          updateRegionDetail(preserved);
        } else {
          resetRegionDetail();
        }
      } else {
        resetRegionDetail();
      }
    }

    function buildFilteredDataset(filterType) {
      const baseRows = (allData.mapMetrics || []).map(function(row) {
        const clone = Object.assign({}, row);
        clone.__prefecture = getVal(clone, 'prefecture') || '';
        clone.__municipality = getVal(clone, 'municipality') || '';
        clone.__key = getVal(clone, 'location_key') || (clone.__prefecture + ':' + clone.__municipality);
        clone.__baseCount = getNumber(clone, 'count');
        clone.__male = getNumber(clone, 'male_count');
        clone.__female = getNumber(clone, 'female_count');
        clone.__avgAge = getNumber(clone, 'avg_age');
        clone.__avgQualifications = getNumber(clone, 'avg_qualifications');
        clone.__latitude = getNumber(clone, 'latitude');
        clone.__longitude = getNumber(clone, 'longitude');
        return clone;
      }).filter(row => row.__baseCount > 0 && row.__latitude && row.__longitude);

      return baseRows.map(function(row) {
        row.__filteredCount = null;
        row.__filterLabel = null;
        switch (filterType) {
          case 'male':
            row.__filteredCount = row.__male;
            row.__filterLabel = 'ç”·æ€§';
            return row.__filteredCount > 0 ? row : null;
          case 'female':
            row.__filteredCount = row.__female;
            row.__filterLabel = 'å¥³æ€§';
            return row.__filteredCount > 0 ? row : null;
          case 'young':
            return (row.__avgAge >= 20 && row.__avgAge < 40) ? row : null;
          case 'middle':
            return (row.__avgAge >= 40 && row.__avgAge < 60) ? row : null;
          case 'senior':
            return (row.__avgAge >= 60) ? row : null;
          default:
            return row;
        }
      }).filter(Boolean);
    }

    function renderMap() {
      const mode = document.getElementById('displayMode').value;
      clearMap();

      if (mode === 'heatmap') {
        displayHeatmap(filteredMapData);
        return;
      }

      if (mode === 'cluster') {
        displayClusters(filteredMapData);
      } else {
        displayMarkers(filteredMapData);
      }
    }

    function displayMarkers(data) {
      data.forEach(function(row) {
        const marker = L.marker([row.__latitude, row.__longitude]);
        marker.bindPopup(buildPopupContent(row));
        marker.on('click', function() { handleRegionSelection(row); });
        marker.addTo(map);
        markers.push(marker);
      });
    }

    function displayClusters(data) {
      data.forEach(function(row) {
        const marker = L.marker([row.__latitude, row.__longitude]);
        marker.bindPopup(buildPopupContent(row));
        marker.on('click', function() { handleRegionSelection(row); });
        markerCluster.addLayer(marker);
      });
    }

    function displayHeatmap(data) {
      const heatData = data.map(function(row) {
        return [row.__latitude, row.__longitude, getCountForRow(row)];
      });

      if (heatLayer) {
        heatLayer.remove();
        heatLayer = null;
      }

      heatLayer = L.heatLayer(heatData, { radius: 25, blur: 15, maxZoom: 17 }).addTo(map);
    }

    function buildPopupContent(row) {
      const count = getCountForRow(row);
      const total = row.__baseCount;
      const filterLabel = FILTER_LABELS[activeFilter];

      let countLabel = `${formatNumber(count)}äºº`;
      if (activeFilter !== 'all' && count !== total) {
        countLabel += ` / å…¨ä½“ ${formatNumber(total)}äºº`;
      }

      const parts = [
        `<strong>${row.__municipality || row.__prefecture || 'ä¸æ˜'}</strong>`,
        `æ±‚è·è€…æ•°: ${countLabel}`,
        `å¹³å‡å¹´é½¢: ${formatDecimal(row.__avgAge)}æ­³`
      ];

      if (row.__male || row.__female) {
        parts.push(`ç”·æ€§ ${formatNumber(row.__male)} / å¥³æ€§ ${formatNumber(row.__female)}`);
      }

      if (activeFilter !== 'all') {
        parts.push(`ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼: ${filterLabel}`);
      }

      return parts.join('<br>');
    }

    function clearMap() {
      markers.forEach(function(marker) { marker.remove(); });
      markers = [];
      markerCluster.clearLayers();
      if (heatLayer) {
        heatLayer.remove();
        heatLayer = null;
      }
    }

    function handleRegionSelection(row) {
      selectedRegionKey = row.__key;
      updateRegionDetail(row);
      google.script.run
        .withFailureHandler(function(error) { console.error('saveSelectedRegion failed', error); })
        .saveSelectedRegion(row.__prefecture || null, row.__municipality || null);
    }

    function updateRegionDetail(row) {
      const card = document.getElementById('regionDetailCard');
      if (!row) {
        resetRegionDetail();
        return;
      }

      card.style.display = 'block';
      document.getElementById('regionDetailTitle').textContent = row.__municipality ? `${row.__prefecture} / ${row.__municipality}` : (row.__prefecture || 'åœ°åŸŸæœªé¸æŠ');

      const count = getCountForRow(row);
      const total = row.__baseCount;
      let totalLabel = `${formatNumber(count)}äºº`;
      if (activeFilter !== 'all' && count !== total) {
        totalLabel += `ï¼ˆå…¨ä½“ ${formatNumber(total)}äººï¼‰`;
      }
      document.getElementById('regionTotal').textContent = totalLabel;

      const filterNote = document.getElementById('regionFilterNote');
      if (activeFilter !== 'all') {
        filterNote.style.display = 'block';
        document.getElementById('regionFilterText').textContent = FILTER_LABELS[activeFilter] || 'ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ä¸­';
      } else {
        filterNote.style.display = 'none';
      }

      document.getElementById('regionAvgAge').textContent = `${formatDecimal(row.__avgAge)}æ­³`;
      document.getElementById('regionMale').textContent = `${formatNumber(row.__male)}äºº`;
      document.getElementById('regionFemale').textContent = `${formatNumber(row.__female)}äºº`;
      document.getElementById('regionQualifications').textContent = formatDecimal(row.__avgQualifications);
    }

    function resetRegionDetail() {
      document.getElementById('regionDetailCard').style.display = 'none';
    }

    function updateTop10() {
      const listEl = document.getElementById('top10List');
      listEl.innerHTML = '';

      const ranking = filteredMapData
        .slice()
        .sort(function(a, b) { return getCountForRow(b) - getCountForRow(a); })
        .slice(0, 10);

      ranking.forEach(function(row, index) {
        const municipality = row.__municipality || row.__prefecture || 'ä¸æ˜';
        const countLabel = `${formatNumber(getCountForRow(row))}äºº`;
        const li = document.createElement('li');
        li.className = 'top10-item';
        li.innerHTML = `<span><span class="top10-rank">${index + 1}</span>${municipality}</span><span><strong>${countLabel}</strong></span>`;
        li.addEventListener('click', function() {
          map.setView([row.__latitude, row.__longitude], Math.max(map.getZoom(), 11));
          handleRegionSelection(row);
        });
        listEl.appendChild(li);
      });
    }

    function updateGenderChart() {
      const ctx = document.getElementById('genderChart');
      if (!ctx) return;

      const applicants = filterApplicants(activeFilter);
      const genderCounts = applicants.reduce(function(acc, row) {
        const gender = normalizeGender(getVal(row, 'gender')) || 'ä¸æ˜';
        acc[gender] = (acc[gender] || 0) + 1;
        return acc;
      }, {});

      const labels = Object.keys(genderCounts);
      const data = Object.values(genderCounts);

      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: ['rgba(102, 126, 234, 0.85)', 'rgba(255, 99, 132, 0.85)', 'rgba(255, 206, 86, 0.85)', 'rgba(156, 204, 101, 0.85)']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#ffffff' }
            }
          }
        }
      });
    }

    function updateStats(filterType) {
      const applicants = filterApplicants(filterType);
      const total = applicants.length;
      document.getElementById('totalCount').textContent = total > 0 ? total.toLocaleString() : '-';

      let ageSum = 0;
      let ageCount = 0;
      applicants.forEach(function(row) {
        const age = parseFloat(getVal(row, 'age'));
        if (Number.isFinite(age) && age > 0) {
          ageSum += age;
          ageCount++;
        }
      });
      const avgAge = ageCount > 0 ? (ageSum / ageCount) : 0;
      document.getElementById('avgAge').textContent = ageCount > 0 ? `${avgAge.toFixed(1)}æ­³` : '-';
    }

    function changeDisplayMode() {
      renderMap();
    }

    function applyFilter() {
      activeFilter = document.getElementById('dataFilter').value;
      selectedRegionKey = null;
      refreshView();
    }

    function filterApplicants(filterType) {
      const base = allData.applicants || [];
      return base.filter(function(row) {
        const gender = normalizeGender(getVal(row, 'gender'));
        const age = parseFloat(getVal(row, 'age')) || 0;
        switch (filterType) {
          case 'male':
            return gender === 'ç”·æ€§';
          case 'female':
            return gender === 'å¥³æ€§';
          case 'young':
            return age >= 20 && age < 40;
          case 'middle':
            return age >= 40 && age < 60;
          case 'senior':
            return age >= 60;
          default:
            return true;
        }
      });
    }

    function normalizeGender(value) {
      if (!value) return undefined;
      const str = String(value).toLowerCase();
      if (str.includes('ç”·') || str === 'male' || str === 'm') return 'ç”·æ€§';
      if (str.includes('å¥³') || str === 'female' || str === 'f') return 'å¥³æ€§';
      return value;
    }

    function formatNumber(value) {
      const num = Number(value) || 0;
      return num.toLocaleString();
    }

    function formatDecimal(value) {
      const num = Number(value);
      return Number.isFinite(num) ? num.toFixed(1) : '-';
    }

    window.addEventListener('DOMContentLoaded', function() {
      try {
        initMap();
        loadData();
      } catch (error) {
        alert('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    });
  </script>
</body>
</html>

<!-- ===== MapComplete_v2.html ===== -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>æ±‚è·è€…ãƒ‡ãƒ¼ã‚¿åˆ†æãƒãƒƒãƒ—</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Leaflet Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Yu Gothic', 'Hiragino Kaku Gothic Pro', Meiryo, sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    #map {
      flex: 1;
      height: 100%;
    }

    .sidebar {
      width: 350px;
      background: #2d2d5f;
      color: white;
      padding: 20px;
      overflow-y: auto;
      box-shadow: -5px 0 20px rgba(0,0,0,0.3);
    }

    .sidebar-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
      color: #667eea;
    }

    .stat-card {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .stat-label {
      font-size: 12px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }

    .chart-container {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      height: 200px;
    }

    .control-group {
      margin-bottom: 15px;
    }

    .control-label {
      font-size: 12px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 8px;
      display: block;
    }

    select {
      width: 100%;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 13px;
    }

    .top10-list {
      list-style: none;
      max-height: 250px;
      overflow-y: auto;
    }

    .top10-item {
      display: flex;
      justify-content: space-between;
      padding: 8px;
      margin-bottom: 5px;
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }

    .top10-rank {
      font-weight: bold;
      color: #667eea;
      margin-right: 10px;
    }

    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 9999;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
  </div>

  <div class="container">
    <div id="map"></div>

    <div class="sidebar">
      <div class="sidebar-title">æ±‚è·è€…åˆ†æ</div>

      <div class="stat-card">
        <div class="stat-label">ç·æ±‚è·è€…æ•°</div>
        <div class="stat-value" id="totalCount">-</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">å¹³å‡å¹´é½¢</div>
        <div class="stat-value" id="avgAge">-</div>
      </div>

      <div class="control-group">
        <label class="control-label">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</label>
        <select id="displayMode" onchange="changeDisplayMode()">
          <option value="markers">å€‹åˆ¥ãƒãƒ¼ã‚«ãƒ¼</option>
          <option value="cluster">ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼</option>
          <option value="heatmap">ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</option>
        </select>
      </div>

      <div class="control-group">
        <label class="control-label">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
        <select id="dataFilter" onchange="applyFilter()">
          <option value="all">å…¨ãƒ‡ãƒ¼ã‚¿</option>
          <option value="male">ç”·æ€§ã®ã¿</option>
          <option value="female">å¥³æ€§ã®ã¿</option>
          <option value="young">20-30ä»£</option>
          <option value="middle">40-50ä»£</option>
          <option value="senior">60ä»£ä»¥ä¸Š</option>
        </select>
      </div>

      <div class="stat-card">
        <div class="stat-label">å¸Œæœ›å‹¤å‹™åœ° TOP10</div>
        <ul class="top10-list" id="top10List"></ul>
      </div>

      <div class="chart-container">
        <canvas id="genderChart"></canvas>
      </div>
    </div>
  </div>

  <script>

<!-- ===== PersonaDifficultyCheckerUI.html ===== -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
      margin: 0;
    }

    h2 {
      color: #1976d2;
      margin-bottom: 20px;
      text-align: center;
    }

    .filter-panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-label {
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
    }

    select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      background: white;
    }

    select[multiple] {
      min-height: 120px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    button {
      padding: 10px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #1976d2;
      color: white;
    }

    .btn-primary:hover {
      background: #1565c0;
    }

    .btn-secondary {
      background: #757575;
      color: white;
    }

    .btn-secondary:hover {
      background: #616161;
    }

    .stats-panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
    }

    .stat-card {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 4px;
      text-align: center;
    }

    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #1976d2;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    .persona-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .persona-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .persona-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .difficulty-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      color: white;
    }

    .difficulty-S { background: #d32f2f; }
    .difficulty-A { background: #f57c00; }
    .difficulty-B { background: #fbc02d; }
    .difficulty-C { background: #7cb342; }
    .difficulty-D { background: #66bb6a; }
    .difficulty-E { background: #81c784; }

    .persona-header {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }

    .persona-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }

    .persona-subtitle {
      font-size: 14px;
      color: #666;
    }

    .persona-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .metric-item {
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
    }

    .metric-label {
      font-size: 11px;
      color: #666;
      margin-bottom: 3px;
    }

    .metric-value {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }

    .persona-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .category-tag {
      padding: 4px 10px;
      background: #e0e0e0;
      border-radius: 12px;
      font-size: 11px;
      color: #333;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .no-results {
      text-align: center;
      padding: 60px;
      color: #999;
      font-size: 18px;
    }

    .help-text {
      font-size: 12px;
      color: #666;
      font-style: italic;
      margin-top: 5px;
    }

    .score-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }

    .score-fill {
      height: 100%;
      background: linear-gradient(90deg, #81c784 0%, #fbc02d 50%, #d32f2f 100%);
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <h2>ğŸ¯ ãƒšãƒ«ã‚½ãƒŠé›£æ˜“åº¦ç¢ºèª</h2>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒãƒ« -->
  <div class="filter-panel">
    <h3 style="margin-top: 0; color: #1976d2;">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</h3>

    <!-- å¸‚ç”ºæ‘é¸æŠï¼ˆæœ€å„ªå…ˆï¼‰ -->
    <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 2px solid #1976d2;">
      <div class="filter-label" style="font-size: 16px; margin-bottom: 10px;">ğŸ“ å¸‚ç”ºæ‘é¸æŠï¼ˆå¿…é ˆï¼‰</div>
      <select id="municipalityFilter" style="width: 100%; min-height: 40px;">
        <option value="">--- å¸‚ç”ºæ‘ã‚’é¸æŠã—ã¦ãã ã•ã„ ---</option>
      </select>
      <div class="help-text">å¸Œæœ›å‹¤å‹™åœ°ã¨ã—ã¦ç™»éŒ²ã—ã¦ã„ã‚‹æ±‚è·è€…ã‚’åˆ†æã—ã¾ã™</div>
    </div>

    <div class="filter-grid">
      <!-- é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ« -->
      <div class="filter-group">
        <div class="filter-label">é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ«</div>
        <select id="difficultyFilter" multiple>
          <option value="Sç´šï¼ˆæœ€é›£ï¼‰">Sç´šï¼ˆæœ€é›£ï¼‰</option>
          <option value="Aç´šï¼ˆé›£ï¼‰">Aç´šï¼ˆé›£ï¼‰</option>
          <option value="Bç´šï¼ˆã‚„ã‚„é›£ï¼‰">Bç´šï¼ˆã‚„ã‚„é›£ï¼‰</option>
          <option value="Cç´šï¼ˆæ™®é€šï¼‰">Cç´šï¼ˆæ™®é€šï¼‰</option>
          <option value="Dç´šï¼ˆã‚„ã‚„æ˜“ï¼‰">Dç´šï¼ˆã‚„ã‚„æ˜“ï¼‰</option>
          <option value="Eç´šï¼ˆæ˜“ï¼‰">Eç´šï¼ˆæ˜“ï¼‰</option>
        </select>
        <div class="help-text">æ¡ç”¨é›£æ˜“åº¦ãƒ©ãƒ³ã‚¯</div>
      </div>

      <!-- å¹´é½¢ã‚°ãƒ«ãƒ¼ãƒ— -->
      <div class="filter-group">
        <div class="filter-label">å¹´é½¢å±¤</div>
        <select id="ageGroupFilter" multiple>
          <option value="æ–°å’å±¤ï¼ˆï½24æ­³ï¼‰">æ–°å’å±¤ï¼ˆï½24æ­³ï¼‰</option>
          <option value="è‹¥æ‰‹å±¤ï¼ˆ25ï½29æ­³ï¼‰">è‹¥æ‰‹å±¤ï¼ˆ25ï½29æ­³ï¼‰</option>
          <option value="è‹¥æ‰‹ä¸­å …å±¤ï¼ˆ30ï½34æ­³ï¼‰">è‹¥æ‰‹ä¸­å …å±¤ï¼ˆ30ï½34æ­³ï¼‰</option>
          <option value="ä¸­å …å±¤ï¼ˆ35ï½39æ­³ï¼‰">ä¸­å …å±¤ï¼ˆ35ï½39æ­³ï¼‰</option>
          <option value="ãƒŸãƒ‰ãƒ«å±¤ï¼ˆ40ï½44æ­³ï¼‰">ãƒŸãƒ‰ãƒ«å±¤ï¼ˆ40ï½44æ­³ï¼‰</option>
          <option value="ã‚·ãƒ‹ã‚¢ãƒŸãƒ‰ãƒ«å±¤ï¼ˆ45ï½49æ­³ï¼‰">ã‚·ãƒ‹ã‚¢ãƒŸãƒ‰ãƒ«å±¤ï¼ˆ45ï½49æ­³ï¼‰</option>
          <option value="ãƒ—ãƒ¬ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ50ï½54æ­³ï¼‰">ãƒ—ãƒ¬ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ50ï½54æ­³ï¼‰</option>
          <option value="ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ55ï½59æ­³ï¼‰">ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ55ï½59æ­³ï¼‰</option>
          <option value="ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ60ï½64æ­³ï¼‰">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ60ï½64æ­³ï¼‰</option>
          <option value="é«˜é½¢å±¤ï¼ˆ65æ­³ï½ï¼‰">é«˜é½¢å±¤ï¼ˆ65æ­³ï½ï¼‰</option>
        </select>
        <div class="help-text">å¹³å‡å¹´é½¢ã«ã‚ˆã‚‹ã‚°ãƒ«ãƒ¼ãƒ—åˆ†é¡</div>
      </div>

      <!-- è³‡æ ¼ãƒ¬ãƒ™ãƒ« -->
      <div class="filter-group">
        <div class="filter-label">è³‡æ ¼ä¿æœ‰ãƒ¬ãƒ™ãƒ«</div>
        <select id="qualificationFilter" multiple>
          <option value="è¶…é«˜è³‡æ ¼å±¤ï¼ˆ5å€‹ä»¥ä¸Šï¼‰">è¶…é«˜è³‡æ ¼å±¤ï¼ˆ5å€‹ä»¥ä¸Šï¼‰</option>
          <option value="é«˜è³‡æ ¼å±¤ï¼ˆ3ï½4å€‹ï¼‰">é«˜è³‡æ ¼å±¤ï¼ˆ3ï½4å€‹ï¼‰</option>
          <option value="ä¸­è³‡æ ¼å±¤ï¼ˆ2ï½3å€‹ï¼‰">ä¸­è³‡æ ¼å±¤ï¼ˆ2ï½3å€‹ï¼‰</option>
          <option value="ä½è³‡æ ¼å±¤ï¼ˆ1ï½2å€‹ï¼‰">ä½è³‡æ ¼å±¤ï¼ˆ1ï½2å€‹ï¼‰</option>
          <option value="å¾®è³‡æ ¼å±¤ï¼ˆ0.5ï½1å€‹ï¼‰">å¾®è³‡æ ¼å±¤ï¼ˆ0.5ï½1å€‹ï¼‰</option>
          <option value="ç„¡è³‡æ ¼å±¤ï¼ˆ0.5å€‹æœªæº€ï¼‰">ç„¡è³‡æ ¼å±¤ï¼ˆ0.5å€‹æœªæº€ï¼‰</option>
        </select>
        <div class="help-text">å¹³å‡è³‡æ ¼ä¿æœ‰æ•°</div>
      </div>

      <!-- ç§»å‹•æ€§ãƒ¬ãƒ™ãƒ« -->
      <div class="filter-group">
        <div class="filter-label">å¸Œæœ›å‹¤å‹™åœ°ã®åºƒã•</div>
        <select id="mobilityFilter" multiple>
          <option value="è¶…åºƒåŸŸå¸Œæœ›ï¼ˆ10ç®‡æ‰€ä»¥ä¸Šï¼‰">è¶…åºƒåŸŸå¸Œæœ›ï¼ˆ10ç®‡æ‰€ä»¥ä¸Šï¼‰</option>
          <option value="åºƒåŸŸå¸Œæœ›ï¼ˆ6ï½9ç®‡æ‰€ï¼‰">åºƒåŸŸå¸Œæœ›ï¼ˆ6ï½9ç®‡æ‰€ï¼‰</option>
          <option value="ä¸­åŸŸå¸Œæœ›ï¼ˆ4ï½5ç®‡æ‰€ï¼‰">ä¸­åŸŸå¸Œæœ›ï¼ˆ4ï½5ç®‡æ‰€ï¼‰</option>
          <option value="ç‹­åŸŸå¸Œæœ›ï¼ˆ2.5ï½3.5ç®‡æ‰€ï¼‰">ç‹­åŸŸå¸Œæœ›ï¼ˆ2.5ï½3.5ç®‡æ‰€ï¼‰</option>
          <option value="é™å®šå¸Œæœ›ï¼ˆ1.5ï½2.5ç®‡æ‰€ï¼‰">é™å®šå¸Œæœ›ï¼ˆ1.5ï½2.5ç®‡æ‰€ï¼‰</option>
          <option value="å›ºå®šå¸Œæœ›ï¼ˆ1.5ç®‡æ‰€æœªæº€ï¼‰">å›ºå®šå¸Œæœ›ï¼ˆ1.5ç®‡æ‰€æœªæº€ï¼‰</option>
        </select>
        <div class="help-text">å¸Œæœ›å‹¤å‹™åœ°æ•°ã«ã‚ˆã‚‹æŸ”è»Ÿæ€§</div>
      </div>

      <!-- æ€§åˆ¥ã‚«ãƒ†ã‚´ãƒª -->
      <div class="filter-group">
        <div class="filter-label">æ€§åˆ¥æ§‹æˆ</div>
        <select id="genderFilter" multiple>
          <option value="å¥³æ€§ç‰¹åŒ–å±¤ï¼ˆ90%ä»¥ä¸Šï¼‰">å¥³æ€§ç‰¹åŒ–å±¤ï¼ˆ90%ä»¥ä¸Šï¼‰</option>
          <option value="å¥³æ€§å„ªå‹¢å±¤ï¼ˆ70ï½89%ï¼‰">å¥³æ€§å„ªå‹¢å±¤ï¼ˆ70ï½89%ï¼‰</option>
          <option value="å¥³æ€§ã‚„ã‚„å¤šå±¤ï¼ˆ55ï½69%ï¼‰">å¥³æ€§ã‚„ã‚„å¤šå±¤ï¼ˆ55ï½69%ï¼‰</option>
          <option value="ç”·å¥³å‡è¡¡å±¤ï¼ˆ45ï½54%ï¼‰">ç”·å¥³å‡è¡¡å±¤ï¼ˆ45ï½54%ï¼‰</option>
          <option value="ç”·æ€§ã‚„ã‚„å¤šå±¤ï¼ˆ31ï½44%ï¼‰">ç”·æ€§ã‚„ã‚„å¤šå±¤ï¼ˆ31ï½44%ï¼‰</option>
          <option value="ç”·æ€§å„ªå‹¢å±¤ï¼ˆ11ï½30%ï¼‰">ç”·æ€§å„ªå‹¢å±¤ï¼ˆ11ï½30%ï¼‰</option>
          <option value="ç”·æ€§ç‰¹åŒ–å±¤ï¼ˆ10%ä»¥ä¸‹ï¼‰">ç”·æ€§ç‰¹åŒ–å±¤ï¼ˆ10%ä»¥ä¸‹ï¼‰</option>
        </select>
        <div class="help-text">å¥³æ€§æ¯”ç‡ã«ã‚ˆã‚‹åˆ†é¡</div>
      </div>

      <!-- å¸‚å ´è¦æ¨¡ -->
      <div class="filter-group">
        <div class="filter-label">å¸‚å ´è¦æ¨¡</div>
        <select id="marketSizeFilter" multiple>
          <option value="è¶…å¤§è¦æ¨¡ï¼ˆ20%ä»¥ä¸Šï¼‰">è¶…å¤§è¦æ¨¡ï¼ˆ20%ä»¥ä¸Šï¼‰</option>
          <option value="å¤§è¦æ¨¡ï¼ˆ15ï½19%ï¼‰">å¤§è¦æ¨¡ï¼ˆ15ï½19%ï¼‰</option>
          <option value="ä¸­è¦æ¨¡ï¼ˆ10ï½14%ï¼‰">ä¸­è¦æ¨¡ï¼ˆ10ï½14%ï¼‰</option>
          <option value="ã‚„ã‚„å°è¦æ¨¡ï¼ˆ7ï½9%ï¼‰">ã‚„ã‚„å°è¦æ¨¡ï¼ˆ7ï½9%ï¼‰</option>
          <option value="å°è¦æ¨¡ï¼ˆ4ï½6%ï¼‰">å°è¦æ¨¡ï¼ˆ4ï½6%ï¼‰</option>
          <option value="è¶…å°è¦æ¨¡ï¼ˆ2ï½3%ï¼‰">è¶…å°è¦æ¨¡ï¼ˆ2ï½3%ï¼‰</option>
          <option value="ãƒ‹ãƒƒãƒï¼ˆ2%æœªæº€ï¼‰">ãƒ‹ãƒƒãƒï¼ˆ2%æœªæº€ï¼‰</option>
        </select>
        <div class="help-text">å…¨ä½“ã«å ã‚ã‚‹å‰²åˆ</div>
      </div>
    </div>

    <div class="button-group">
      <button class="btn-primary" onclick="applyFilters()">çµã‚Šè¾¼ã¿å®Ÿè¡Œ</button>
      <button class="btn-secondary" onclick="resetFilters()">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <!-- çµ±è¨ˆãƒ‘ãƒãƒ« -->
  <div class="stats-panel" id="statsPanel" style="display: none;">
    <h3 style="margin-top: 0; color: #1976d2;">çµ±è¨ˆã‚µãƒãƒªãƒ¼</h3>
    <div class="stats-grid" id="statsGrid"></div>
  </div>

  <!-- ãƒšãƒ«ã‚½ãƒŠè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div id="personaContainer" class="loading">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>

  <script>
    let allPersonas = [];
    let selectedMunicipality = '';

    // åˆæœŸãƒ­ãƒ¼ãƒ‰ï¼šå¸‚ç”ºæ‘ãƒªã‚¹ãƒˆã‚’å–å¾—
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          const municipalityFilter = document.getElementById('municipalityFilter');
          result.municipalities.forEach(function(municipality) {
            const option = document.createElement('option');
            option.value = municipality;
            option.text = municipality;
            municipalityFilter.appendChild(option);
          });

          // å¸‚ç”ºæ‘é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
          municipalityFilter.addEventListener('change', function() {
            selectedMunicipality = this.value;
            if (selectedMunicipality) {
              loadPersonaDataByMunicipality(selectedMunicipality);
            } else {
              document.getElementById('personaContainer').innerHTML =
                '<div class="no-results">å¸‚ç”ºæ‘ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
              document.getElementById('statsPanel').style.display = 'none';
            }
          });

          // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          document.getElementById('personaContainer').innerHTML =
            '<div class="no-results">ğŸ“ å¸‚ç”ºæ‘ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
        } else {
          document.getElementById('personaContainer').innerHTML =
            '<div class="no-results">ã‚¨ãƒ©ãƒ¼: ' + result.message + '</div>';
        }
      })
      .withFailureHandler(function(error) {
        document.getElementById('personaContainer').innerHTML =
          '<div class="no-results">ã‚¨ãƒ©ãƒ¼: ' + error + '</div>';
      })
      .getMunicipalityList();

    // å¸‚ç”ºæ‘åˆ¥ãƒšãƒ«ã‚½ãƒŠãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
    function loadPersonaDataByMunicipality(municipality) {
      document.getElementById('personaContainer').innerHTML =
        '<div class="loading">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>';

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            allPersonas = result.personas;
            displayPersonas(allPersonas);
            loadStatisticsMunicipality(result.municipality, result.totalInMunicipality);
          } else {
            document.getElementById('personaContainer').innerHTML =
              '<div class="no-results">ã‚¨ãƒ©ãƒ¼: ' + result.message + '</div>';
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('personaContainer').innerHTML =
            '<div class="no-results">ã‚¨ãƒ©ãƒ¼: ' + error + '</div>';
        })
        .getPersonaDataByMunicipality(municipality);
    }

    // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ï¼ˆå¸‚ç”ºæ‘åˆ¥ï¼‰
    function loadStatisticsMunicipality(municipality, totalInMunicipality) {
      const statsGrid = document.getElementById('statsGrid');
      const totalPersonas = allPersonas.length;
      const avgDifficultyScore = allPersonas.reduce((sum, p) => sum + p.difficultyScore, 0) / totalPersonas;
      const difficultyLevels = {};
      allPersonas.forEach(p => {
        difficultyLevels[p.difficultyLevel] = (difficultyLevels[p.difficultyLevel] || 0) + 1;
      });

      statsGrid.innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${municipality}</div>
          <div class="stat-label">é¸æŠä¸­ã®å¸‚ç”ºæ‘</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${totalInMunicipality.toLocaleString()}äºº</div>
          <div class="stat-label">å¸‚ç”ºæ‘å†…ã®ç·å¸Œæœ›è€…æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${totalPersonas}</div>
          <div class="stat-label">ãƒšãƒ«ã‚½ãƒŠç¨®é¡æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${avgDifficultyScore.toFixed(1)}</div>
          <div class="stat-label">å¹³å‡é›£æ˜“åº¦ã‚¹ã‚³ã‚¢</div>
        </div>
      `;
      document.getElementById('statsPanel').style.display = 'block';
    }

    // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
    function loadStatistics() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
              <div class="stat-card">
                <div class="stat-value">${result.totalPersonas}</div>
                <div class="stat-label">ãƒšãƒ«ã‚½ãƒŠæ•°</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${result.totalCount.toLocaleString()}</div>
                <div class="stat-label">ç·æ±‚è·è€…æ•°</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${result.avgDifficultyScore.toFixed(1)}</div>
                <div class="stat-label">å¹³å‡é›£æ˜“åº¦</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${Object.keys(result.difficultyDistribution).length}</div>
                <div class="stat-label">é›£æ˜“åº¦ç¨®é¡</div>
              </div>
            `;
            document.getElementById('statsPanel').style.display = 'block';
          }
        })
        .getPersonaDifficultyStatistics();
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
    function applyFilters() {
      const filters = {
        difficultyLevels: getSelectedValues('difficultyFilter'),
        ageGroups: getSelectedValues('ageGroupFilter'),
        qualificationLevels: getSelectedValues('qualificationFilter'),
        mobilityLevels: getSelectedValues('mobilityFilter'),
        genderCategories: getSelectedValues('genderFilter'),
        marketSizeCategories: getSelectedValues('marketSizeFilter')
      };

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            displayPersonas(result.personas);
          }
        })
        .filterPersonasByConditions(filters);
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
    function resetFilters() {
      document.querySelectorAll('select[multiple]').forEach(select => {
        select.selectedIndex = -1;
      });
      displayPersonas(allPersonas);
    }

    // é¸æŠå€¤å–å¾—
    function getSelectedValues(selectId) {
      const select = document.getElementById(selectId);
      return Array.from(select.selectedOptions).map(opt => opt.value);
    }

    // ãƒšãƒ«ã‚½ãƒŠè¡¨ç¤º
    function displayPersonas(personas) {
      const container = document.getElementById('personaContainer');

      if (personas.length === 0) {
        container.innerHTML = '<div class="no-results">è©²å½“ã™ã‚‹ãƒšãƒ«ã‚½ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        return;
      }

      container.innerHTML = '';
      container.className = 'persona-grid';

      personas.forEach(function(p) {
        const difficultyClass = 'difficulty-' + p.difficultyLevel.charAt(0);
        const scorePercent = p.difficultyScore;

        const card = document.createElement('div');
        card.className = 'persona-card';
        card.innerHTML = `
          <div class="difficulty-badge ${difficultyClass}">
            ${p.difficultyLevel} (${p.difficultyScore}ç‚¹)
          </div>

          <div class="persona-header">
            <div class="persona-title">${p.segmentName}</div>
            <div class="persona-subtitle">
              ã‚»ã‚°ãƒ¡ãƒ³ãƒˆID: ${p.segmentId} | ${p.count.toLocaleString()}äºº (${p.percentage.toFixed(1)}%)
            </div>
          </div>

          <div class="persona-metrics">
            <div class="metric-item">
              <div class="metric-label">å¹³å‡å¹´é½¢</div>
              <div class="metric-value">${p.avgAge.toFixed(1)}æ­³</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">å¥³æ€§æ¯”ç‡</div>
              <div class="metric-value">${(p.femaleRatio * 100).toFixed(1)}%</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">å¹³å‡è³‡æ ¼æ•°</div>
              <div class="metric-value">${p.avgQualifications.toFixed(2)}å€‹</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">å¸Œæœ›å‹¤å‹™åœ°æ•°</div>
              <div class="metric-value">${p.avgDesiredLocations.toFixed(1)}ç®‡æ‰€</div>
            </div>
          </div>

          <div class="score-bar">
            <div class="score-fill" style="width: ${scorePercent}%"></div>
          </div>

          <div class="persona-categories" style="margin-top: 15px;">
            <div class="category-tag">${p.ageGroup}</div>
            <div class="category-tag">${p.qualificationLevel}</div>
            <div class="category-tag">${p.mobilityLevel}</div>
            <div class="category-tag">${p.genderCategory}</div>
            <div class="category-tag">${p.marketSizeCategory}</div>
          </div>
        `;

        container.appendChild(card);
      });
    }
  </script>
</body>
</html>

<!-- ===== Phase7BatchUpload.html ===== -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 650px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      padding: 30px;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 24px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 25px;
      font-size: 14px;
    }
    .upload-area {
      border: 3px dashed #ddd;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      background: #f9f9f9;
      margin-bottom: 20px;
      transition: all 0.3s;
    }
    .upload-area.dragover {
      border-color: #667eea;
      background: #f0f0ff;
    }
    .upload-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    .upload-text {
      font-size: 16px;
      color: #666;
      margin-bottom: 10px;
    }
    .upload-subtext {
      font-size: 13px;
      color: #999;
    }
    #fileInput {
      display: none;
    }
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: transform 0.2s;
      margin: 5px;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    .file-list {
      margin-top: 20px;
    }
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      margin-bottom: 8px;
      background: #f5f5f5;
      border-radius: 6px;
      font-size: 14px;
    }
    .file-item.success {
      background: #d4edda;
      color: #155724;
    }
    .file-item.error {
      background: #f8d7da;
      color: #721c24;
    }
    .file-name {
      flex: 1;
      font-weight: 500;
    }
    .file-status {
      font-size: 12px;
      margin-left: 10px;
    }
    .progress-container {
      margin-top: 20px;
      display: none;
    }
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #f0f0f0;
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
      width: 0%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }
    .expected-files {
      background: #fff3cd;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #856404;
    }
    .expected-files h3 {
      font-size: 14px;
      margin-bottom: 10px;
    }
    .expected-files ul {
      margin-left: 20px;
    }
    .expected-files li {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¤ Phase 7ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h1>
    <p class="subtitle">run_complete.py ã§ç”Ÿæˆã•ã‚ŒãŸå…¨7ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™</p>

    <div class="expected-files">
      <h3>ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ7ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰:</h3>
      <ul>
        <li>SupplyDensityMap.csv</li>
        <li>QualificationDistribution.csv</li>
        <li>AgeGenderCrossAnalysis.csv</li>
        <li>MobilityScore.csv</li>
        <li>DetailedPersonaProfile.csv</li>
        <li>PersonaMapData.csv</li>
        <li>PersonaMobilityCross.csv</li>
      </ul>
    </div>

    <div class="upload-area" id="dropZone">
      <div class="upload-icon">ğŸ“</div>
      <div class="upload-text">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
      <div class="upload-subtext">ã¾ãŸã¯</div>
      <button class="btn" onclick="document.getElementById('fileInput').click()">
        ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
      </button>
      <input type="file" id="fileInput" multiple accept=".csv">
    </div>

    <div class="file-list" id="fileList"></div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill">0%</div>
      </div>
      <div id="statusText" style="text-align: center; color: #666; font-size: 14px;"></div>
    </div>

    <div style="text-align: center; margin-top: 20px;">
      <button class="btn btn-secondary" id="uploadBtn" disabled onclick="uploadFiles()">
        ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹
      </button>
      <button class="btn" onclick="google.script.host.close()">
        é–‰ã˜ã‚‹
      </button>
    </div>
  </div>

  <script>
    let selectedFiles = [];

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const uploadBtn = document.getElementById('uploadBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const statusText = document.getElementById('statusText');

    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
    function handleFiles(files) {
      selectedFiles = Array.from(files).filter(file => file.name.endsWith('.csv'));

      if (selectedFiles.length === 0) {
        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      displayFileList();
      uploadBtn.disabled = false;
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆè¡¨ç¤º
    function displayFileList() {
      fileList.innerHTML = '<h3 style="margin-bottom: 10px;">é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:</h3>';

      selectedFiles.forEach(file => {
        const item = document.createElement('div');
        item.className = 'file-item';
        item.innerHTML = `
          <span class="file-name">ğŸ“„ ${file.name}</span>
          <span class="file-status">${formatFileSize(file.size)}</span>
        `;
        fileList.appendChild(item);
      });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
    async function uploadFiles() {
      if (selectedFiles.length === 0) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      uploadBtn.disabled = true;
      progressContainer.style.display = 'block';
      fileList.innerHTML = '';

      let successCount = 0;
      let errorCount = 0;

      for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        const progress = Math.round(((i + 1) / selectedFiles.length) * 100);

        // é€²æ—æ›´æ–°
        progressFill.style.width = progress + '%';
        progressFill.textContent = progress + '%';
        statusText.textContent = `å‡¦ç†ä¸­: ${file.name} (${i + 1}/${selectedFiles.length})`;

        try {
          // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
          const fileData = await readFileAsBase64(file);

          // GASã«é€ä¿¡
          const result = await new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .processPhase7Upload({
                name: file.name,
                data: fileData
              });
          });

          // çµæœè¡¨ç¤º
          const item = document.createElement('div');
          if (result.success) {
            item.className = 'file-item success';
            item.innerHTML = `
              <span class="file-name">âœ“ ${result.fileName}</span>
              <span class="file-status">${result.rows}è¡Œ Ã— ${result.cols}åˆ—</span>
            `;
            successCount++;
          } else {
            item.className = 'file-item error';
            item.innerHTML = `
              <span class="file-name">âœ— ${result.fileName}</span>
              <span class="file-status">${result.error}</span>
            `;
            errorCount++;
          }
          fileList.appendChild(item);

        } catch (error) {
          const item = document.createElement('div');
          item.className = 'file-item error';
          item.innerHTML = `
            <span class="file-name">âœ— ${file.name}</span>
            <span class="file-status">${error.message || 'ã‚¨ãƒ©ãƒ¼'}</span>
          `;
          fileList.appendChild(item);
          errorCount++;
        }
      }

      // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      progressFill.style.width = '100%';
      progressFill.textContent = 'å®Œäº†!';
      statusText.textContent = `æˆåŠŸ: ${successCount}ä»¶ / å¤±æ•—: ${errorCount}ä»¶`;

      if (successCount > 0 && errorCount === 0) {
        setTimeout(() => {
          alert(`å…¨${successCount}ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒPhase 7é«˜åº¦åˆ†æã€ã®å„æ©Ÿèƒ½ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚`);
        }, 500);
      }

      uploadBtn.disabled = false;
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã¨ã—ã¦èª­ã¿è¾¼ã¿
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>

<!-- ===== Phase7Upload.html ===== -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      padding: 30px;
    }
    h2 {
      color: #667eea;
      margin-top: 0;
      text-align: center;
      font-size: 28px;
    }
    .upload-zone {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin: 30px 0;
    }
    .file-drop {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 20px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      min-height: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .file-drop:hover {
      border-color: #667eea;
      background: #f5f5ff;
    }
    .file-drop.dragover {
      border-color: #667eea;
      background: #e8e8ff;
      transform: scale(1.05);
    }
    .file-drop.uploaded {
      border-color: #34A853;
      background: #e6f4ea;
    }
    .file-drop-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    .file-drop-label {
      font-size: 11px;
      font-weight: bold;
      color: #666;
      margin-bottom: 5px;
    }
    .file-drop-status {
      font-size: 10px;
      color: #999;
    }
    .file-drop-filename {
      font-size: 9px;
      color: #34A853;
      margin-top: 5px;
      font-weight: bold;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .file-input {
      display: none;
    }
    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }
    .button {
      padding: 12px 30px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .button-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .button-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .button-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .button-secondary {
      background: #6c757d;
      color: white;
    }
    .button-secondary:hover {
      background: #5a6268;
    }
    .status {
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      display: none;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
    }
    .progress-container {
      width: 100%;
      height: 40px;
      background: #f0f0f0;
      border-radius: 20px;
      margin: 20px 0;
      overflow: hidden;
      display: none;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      font-weight: bold;
    }
    .file-summary {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #dee2e6;
    }
    .summary-item:last-child {
      border-bottom: none;
    }
    .summary-label {
      font-weight: bold;
      color: #666;
    }
    .summary-value {
      color: #667eea;
      font-weight: bold;
    }
    .instructions {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    .instructions-title {
      font-weight: bold;
      color: #856404;
      margin-bottom: 10px;
    }
    .instructions-list {
      font-size: 14px;
      color: #856404;
      margin: 5px 0;
      padding-left: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ“ˆ Phase 7é«˜åº¦åˆ†æ - ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>

    <div class="instructions">
      <div class="instructions-title">ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ‰‹é †</div>
      <div class="instructions-list">
        1. Pythonã§ <code>run_complete.py</code> ã‚’å®Ÿè¡Œ<br>
        2. <code>gas_output_phase7</code> ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰7ã¤ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ<br>
        3. ã€Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
        4. å®Œäº†å¾Œã€å¯è¦–åŒ–æ©Ÿèƒ½ãŒä½¿ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™
      </div>
    </div>

    <div class="upload-zone">
      <!-- 1. äººæä¾›çµ¦å¯†åº¦ãƒãƒƒãƒ— -->
      <div class="file-drop" id="drop-supply" onclick="selectFile('supply')">
        <div class="file-drop-icon">ğŸ—ºï¸</div>
        <div class="file-drop-label">äººæä¾›çµ¦<br>å¯†åº¦ãƒãƒƒãƒ—</div>
        <div class="file-drop-status" id="status-supply">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-drop-filename" id="filename-supply"></div>
      </div>
      <input type="file" id="file-supply" class="file-input" accept=".csv" onchange="handleFile('supply')">

      <!-- 2. è³‡æ ¼åˆ¥äººæåˆ†å¸ƒ -->
      <div class="file-drop" id="drop-qualification" onclick="selectFile('qualification')">
        <div class="file-drop-icon">ğŸ“</div>
        <div class="file-drop-label">è³‡æ ¼åˆ¥<br>äººæåˆ†å¸ƒ</div>
        <div class="file-drop-status" id="status-qualification">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-drop-filename" id="filename-qualification"></div>
      </div>
      <input type="file" id="file-qualification" class="file-input" accept=".csv" onchange="handleFile('qualification')">

      <!-- 3. å¹´é½¢å±¤Ã—æ€§åˆ¥ã‚¯ãƒ­ã‚¹åˆ†æ -->
      <div class="file-drop" id="drop-agegender" onclick="selectFile('agegender')">
        <div class="file-drop-icon">ğŸ‘¥</div>
        <div class="file-drop-label">å¹´é½¢Ã—æ€§åˆ¥<br>ã‚¯ãƒ­ã‚¹åˆ†æ</div>
        <div class="file-drop-status" id="status-agegender">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-drop-filename" id="filename-agegender"></div>
      </div>
      <input type="file" id="file-agegender" class="file-input" accept=".csv" onchange="handleFile('agegender')">

      <!-- 4. ç§»å‹•è¨±å®¹åº¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚° -->
      <div class="file-drop" id="drop-mobility" onclick="selectFile('mobility')">
        <div class="file-drop-icon">ğŸš—</div>
        <div class="file-drop-label">ç§»å‹•è¨±å®¹åº¦<br>ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°</div>
        <div class="file-drop-status" id="status-mobility">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-drop-filename" id="filename-mobility"></div>
      </div>
      <input type="file" id="file-mobility" class="file-input" accept=".csv" onchange="handleFile('mobility')">

      <!-- 5. ãƒšãƒ«ã‚½ãƒŠè©³ç´°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ« -->
      <div class="file-drop" id="drop-persona" onclick="selectFile('persona')">
        <div class="file-drop-icon">ğŸ“Š</div>
        <div class="file-drop-label">ãƒšãƒ«ã‚½ãƒŠè©³ç´°<br>ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</div>
        <div class="file-drop-status" id="status-persona">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-drop-filename" id="filename-persona"></div>
      </div>
      <input type="file" id="file-persona" class="file-input" accept=".csv" onchange="handleFile('persona')">

      <!-- 6. ãƒšãƒ«ã‚½ãƒŠåœ°å›³ãƒ‡ãƒ¼ã‚¿ -->
      <div class="file-drop" id="drop-personamap" onclick="selectFile('personamap')">
        <div class="file-drop-icon">ğŸ—ºï¸</div>
        <div class="file-drop-label">ãƒšãƒ«ã‚½ãƒŠ<br>åœ°å›³ãƒ‡ãƒ¼ã‚¿</div>
        <div class="file-drop-status" id="status-personamap">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-drop-filename" id="filename-personamap"></div>
      </div>
      <input type="file" id="file-personamap" class="file-input" accept=".csv" onchange="handleFile('personamap')">

      <!-- 7. ãƒšãƒ«ã‚½ãƒŠÃ—ç§»å‹•è¨±å®¹åº¦ã‚¯ãƒ­ã‚¹ -->
      <div class="file-drop" id="drop-personamobility" onclick="selectFile('personamobility')">
        <div class="file-drop-icon">ğŸš—</div>
        <div class="file-drop-label">ãƒšãƒ«ã‚½ãƒŠÃ—<br>ç§»å‹•è¨±å®¹åº¦</div>
        <div class="file-drop-status" id="status-personamobility">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-drop-filename" id="filename-personamobility"></div>
      </div>
      <input type="file" id="file-personamobility" class="file-input" accept=".csv" onchange="handleFile('personamobility')">
    </div>

    <div class="file-summary" id="fileSummary">
      <div class="summary-item">
        <span class="summary-label">é¸æŠæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«</span>
        <span class="summary-value" id="selectedCount">0 / 7</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">åˆè¨ˆã‚µã‚¤ã‚º</span>
        <span class="summary-value" id="totalSize">0 KB</span>
      </div>
    </div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div class="status" id="status"></div>

    <div class="button-group">
      <button class="button button-primary" id="uploadButton" disabled onclick="uploadFiles()">
        ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹
      </button>
      <button class="button button-secondary" onclick="clearAll()">
        ğŸ”„ ã‚¯ãƒªã‚¢
      </button>
      <button class="button button-secondary" onclick="google.script.host.close()">
        âœ–ï¸ é–‰ã˜ã‚‹
      </button>
    </div>
  </div>

<script>
// ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
const files = {
  supply: { file: null, name: 'SupplyDensityMap.csv', sheetName: 'Phase7_SupplyDensity' },
  qualification: { file: null, name: 'QualificationDistribution.csv', sheetName: 'Phase7_QualificationDist' },
  agegender: { file: null, name: 'AgeGenderCrossAnalysis.csv', sheetName: 'Phase7_AgeGenderCross' },
  mobility: { file: null, name: 'MobilityScore.csv', sheetName: 'Phase7_MobilityScore' },
  persona: { file: null, name: 'DetailedPersonaProfile.csv', sheetName: 'Phase7_PersonaProfile' },
  personamap: { file: null, name: 'PersonaMapData.csv', sheetName: 'PersonaMapData' },
  personamobility: { file: null, name: 'PersonaMobilityCross.csv', sheetName: 'PersonaMobilityCross' }
};

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
Object.keys(files).forEach(key => {
  const dropZone = document.getElementById('drop-' + key);

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');

    if (e.dataTransfer.files.length > 0) {
      const file = e.dataTransfer.files[0];
      if (file.name.endsWith('.csv')) {
        files[key].file = file;
        updateFileStatus(key);
      } else {
        showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
      }
    }
  });
});

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
function selectFile(type) {
  document.getElementById('file-' + type).click();
}

function handleFile(type) {
  const input = document.getElementById('file-' + type);
  if (input.files.length > 0) {
    files[type].file = input.files[0];
    updateFileStatus(type);
  }
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
function updateFileStatus(type) {
  const file = files[type].file;
  const dropZone = document.getElementById('drop-' + type);
  const statusElement = document.getElementById('status-' + type);
  const filenameElement = document.getElementById('filename-' + type);

  if (file) {
    dropZone.classList.add('uploaded');
    statusElement.textContent = 'âœ… é¸æŠæ¸ˆã¿';
    filenameElement.textContent = file.name;
  } else {
    dropZone.classList.remove('uploaded');
    statusElement.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ';
    filenameElement.textContent = '';
  }

  updateSummary();
}

// ã‚µãƒãƒªãƒ¼æ›´æ–°
function updateSummary() {
  const selectedFiles = Object.values(files).filter(f => f.file !== null);
  const selectedCount = selectedFiles.length;
  const totalSize = selectedFiles.reduce((sum, f) => sum + f.file.size, 0);

  document.getElementById('selectedCount').textContent = `${selectedCount} / 7`;
  document.getElementById('totalSize').textContent = (totalSize / 1024).toFixed(2) + ' KB';

  if (selectedCount > 0) {
    document.getElementById('fileSummary').style.display = 'block';
  }

  // å…¨ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆä»»æ„ã§å¤‰æ›´å¯èƒ½ï¼‰
  document.getElementById('uploadButton').disabled = selectedCount === 0;
}

// ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
async function uploadFiles() {
  const selectedFiles = Object.entries(files).filter(([key, data]) => data.file !== null);

  if (selectedFiles.length === 0) {
    showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    return;
  }

  showStatus(`${selectedFiles.length}ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™...`, 'info');
  showProgress(0);

  let successCount = 0;
  let errorCount = 0;

  for (let i = 0; i < selectedFiles.length; i++) {
    const [key, data] = selectedFiles[i];
    const progress = ((i + 1) / selectedFiles.length) * 100;

    try {
      showStatus(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­: ${data.name} (${i + 1}/${selectedFiles.length})`, 'info');

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
      const content = await readFileAsText(data.file);

      // CSVãƒ‘ãƒ¼ã‚¹
      const csvData = parseCSV(content);

      // GASã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
      await uploadToSheet(data.sheetName, csvData);

      successCount++;
      showProgress(progress);

    } catch (error) {
      console.error(`Error uploading ${data.name}:`, error);
      errorCount++;
    }
  }

  showProgress(100);

  if (errorCount === 0) {
    showStatus(`âœ… ${successCount}ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼`, 'success');
    setTimeout(() => {
      google.script.host.close();
    }, 2000);
  } else {
    showStatus(`âš ï¸ ${successCount}ãƒ•ã‚¡ã‚¤ãƒ«æˆåŠŸã€${errorCount}ãƒ•ã‚¡ã‚¤ãƒ«å¤±æ•—`, 'error');
  }
}

// ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
function readFileAsText(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.onerror = (e) => reject(e);
    reader.readAsText(file, 'UTF-8');
  });
}

// CSVãƒ‘ãƒ¼ã‚¹
function parseCSV(text) {
  // BOMé™¤å»
  const cleanText = text.replace(/^\uFEFF/, '');

  // è¡Œåˆ†å‰²
  const lines = cleanText.split(/\r?\n/).filter(line => line.trim());

  // CSVè§£æ
  const result = lines.map(line => {
    // ç°¡æ˜“CSVãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆã‚¯ã‚©ãƒ¼ãƒˆå‡¦ç†ã¯çœç•¥ï¼‰
    return line.split(',').map(cell => cell.trim());
  });

  return result;
}

// GASã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
function uploadToSheet(sheetName, csvData) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .importPhase7CSV(sheetName, csvData);
  });
}

// UIé–¢æ•°
function showStatus(message, type) {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = 'status ' + type;
  status.style.display = 'block';
}

function showProgress(percent) {
  const container = document.getElementById('progressContainer');
  const bar = document.getElementById('progressBar');

  container.style.display = 'block';
  bar.style.width = percent + '%';
  bar.textContent = Math.round(percent) + '%';
}

function clearAll() {
  Object.keys(files).forEach(key => {
    files[key].file = null;
    updateFileStatus(key);
  });

  document.getElementById('fileSummary').style.display = 'none';
  document.getElementById('progressContainer').style.display = 'none';
  document.getElementById('status').style.display = 'none';
  document.getElementById('uploadButton').disabled = true;
}
</script>
</body>
</html>

<!-- ===== PhaseUpload.html ===== -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      padding: 30px;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    h2 {
      color: #667eea;
      font-size: 28px;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      font-size: 14px;
    }
    .instructions {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    .instructions-title {
      font-weight: bold;
      color: #856404;
      margin-bottom: 10px;
    }
    .instructions-list {
      font-size: 13px;
      color: #856404;
      line-height: 1.6;
    }
    .upload-zone {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 30px 0;
    }
    .file-drop {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 20px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      min-height: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .file-drop:hover {
      border-color: #667eea;
      background: #f5f5ff;
    }
    .file-drop.dragover {
      border-color: #667eea;
      background: #e8e8ff;
      transform: scale(1.05);
    }
    .file-drop.uploaded {
      border-color: #34A853;
      background: #e6f4ea;
    }
    .file-drop-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    .file-drop-label {
      font-size: 12px;
      font-weight: bold;
      color: #666;
      margin-bottom: 5px;
      text-align: center;
    }
    .file-drop-status {
      font-size: 10px;
      color: #999;
    }
    .file-drop-filename {
      font-size: 9px;
      color: #34A853;
      margin-top: 5px;
      font-weight: bold;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .file-input {
      display: none;
    }
    .file-summary {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #dee2e6;
    }
    .summary-item:last-child {
      border-bottom: none;
    }
    .summary-label {
      font-weight: bold;
      color: #666;
    }
    .summary-value {
      color: #667eea;
      font-weight: bold;
    }
    .progress-container {
      width: 100%;
      height: 40px;
      background: #f0f0f0;
      border-radius: 20px;
      margin: 20px 0;
      overflow: hidden;
      display: none;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      font-weight: bold;
    }
    .status {
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      display: none;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
    }
    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }
    .button {
      padding: 12px 30px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .button-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .button-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .button-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .button-secondary {
      background: #6c757d;
      color: white;
    }
    .button-secondary:hover {
      background: #5a6268;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2><?= phaseIcon ?> <?= phaseName ?> - ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
      <div class="subtitle">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
    </div>

    <div class="instructions">
      <div class="instructions-title">ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ‰‹é †</div>
      <div class="instructions-list">
        1. å„ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚‚å¯èƒ½ï¼‰<br>
        2. å…¨ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå¾Œã€ã€Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
        3. å®Œäº†å¾Œã€è‡ªå‹•ã§ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã™
      </div>
    </div>

    <div class="upload-zone" id="uploadZone">
      <!-- å‹•çš„ç”Ÿæˆ -->
    </div>

    <div class="file-summary" id="fileSummary">
      <div class="summary-item">
        <span class="summary-label">é¸æŠæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«</span>
        <span class="summary-value" id="selectedCount">0 / 0</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">åˆè¨ˆã‚µã‚¤ã‚º</span>
        <span class="summary-value" id="totalSize">0 KB</span>
      </div>
    </div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div class="status" id="status"></div>

    <div class="button-group">
      <button class="button button-primary" id="uploadButton" disabled onclick="uploadFiles()">
        ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹
      </button>
      <button class="button button-secondary" onclick="clearAll()">
        ğŸ”„ ã‚¯ãƒªã‚¢
      </button>
      <button class="button button-secondary" onclick="google.script.host.close()">
        âœ–ï¸ é–‰ã˜ã‚‹
      </button>
    </div>
  </div>

<script>
// Phaseè¨­å®šï¼ˆGASå´ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ï¼‰
const phaseId = '<?= phaseId ?>';
const phaseName = '<?= phaseName ?>';
const phaseIcon = '<?= phaseIcon ?>';
const filesConfig = <?!= files ?>;

// ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
const files = {};

// åˆæœŸåŒ–
function init() {
  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒªã‚¢ã‚’å‹•çš„ç”Ÿæˆ
  const uploadZone = document.getElementById('uploadZone');

  filesConfig.forEach((fileConfig, index) => {
    const key = `file${index}`;
    files[key] = {
      file: null,
      config: fileConfig
    };

    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ä½œæˆ
    const dropDiv = document.createElement('div');
    dropDiv.className = 'file-drop';
    dropDiv.id = `drop-${key}`;
    dropDiv.onclick = () => selectFile(key);
    dropDiv.innerHTML = `
      <div class="file-drop-icon">ğŸ“„</div>
      <div class="file-drop-label">${fileConfig.label}</div>
      <div style="font-size: 10px; color: #999; margin-bottom: 5px;">ğŸ“ ${fileConfig.name}</div>
      <div class="file-drop-status" id="status-${key}">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
      <div class="file-drop-filename" id="filename-${key}"></div>
    `;

    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
    dropDiv.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropDiv.classList.add('dragover');
    });

    dropDiv.addEventListener('dragleave', () => {
      dropDiv.classList.remove('dragover');
    });

    dropDiv.addEventListener('drop', (e) => {
      e.preventDefault();
      dropDiv.classList.remove('dragover');

      if (e.dataTransfer.files.length > 0) {
        const file = e.dataTransfer.files[0];
        if (file.name.endsWith('.csv')) {
          files[key].file = file;
          updateFileStatus(key);
        } else {
          showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        }
      }
    });

    uploadZone.appendChild(dropDiv);

    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¦ç´ ä½œæˆ
    const input = document.createElement('input');
    input.type = 'file';
    input.id = `input-${key}`;
    input.className = 'file-input';
    input.accept = '.csv';
    input.onchange = () => handleFile(key);
    uploadZone.appendChild(input);
  });

  // ã‚µãƒãƒªãƒ¼æ›´æ–°
  updateSummary();
}

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
function selectFile(key) {
  document.getElementById(`input-${key}`).click();
}

function handleFile(key) {
  const input = document.getElementById(`input-${key}`);
  if (input.files.length > 0) {
    files[key].file = input.files[0];
    updateFileStatus(key);
  }
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
function updateFileStatus(key) {
  const file = files[key].file;
  const dropZone = document.getElementById(`drop-${key}`);
  const statusElement = document.getElementById(`status-${key}`);
  const filenameElement = document.getElementById(`filename-${key}`);

  if (file) {
    dropZone.classList.add('uploaded');
    statusElement.textContent = 'âœ… é¸æŠæ¸ˆã¿';
    filenameElement.textContent = file.name;
  } else {
    dropZone.classList.remove('uploaded');
    statusElement.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ';
    filenameElement.textContent = '';
  }

  updateSummary();
}

// ã‚µãƒãƒªãƒ¼æ›´æ–°
function updateSummary() {
  const selectedFiles = Object.values(files).filter(f => f.file !== null);
  const selectedCount = selectedFiles.length;
  const totalSize = selectedFiles.reduce((sum, f) => sum + f.file.size, 0);
  const totalFiles = Object.keys(files).length;

  document.getElementById('selectedCount').textContent = `${selectedCount} / ${totalFiles}`;
  document.getElementById('totalSize').textContent = (totalSize / 1024).toFixed(2) + ' KB';

  if (selectedCount > 0) {
    document.getElementById('fileSummary').style.display = 'block';
  }

  // å…¨ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆä»»æ„ã§å¤‰æ›´å¯èƒ½ï¼‰
  document.getElementById('uploadButton').disabled = selectedCount === 0;
}

// ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
async function uploadFiles() {
  const selectedFiles = Object.entries(files).filter(([key, data]) => data.file !== null);

  if (selectedFiles.length === 0) {
    showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    return;
  }

  showStatus(`${selectedFiles.length}ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™...`, 'info');
  showProgress(0);

  let successCount = 0;
  let errorCount = 0;

  for (let i = 0; i < selectedFiles.length; i++) {
    const [key, data] = selectedFiles[i];
    const progress = ((i + 1) / selectedFiles.length) * 100;

    try {
      showStatus(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­: ${data.config.label} (${i + 1}/${selectedFiles.length})`, 'info');

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
      const content = await readFileAsText(data.file);

      // CSVãƒ‘ãƒ¼ã‚¹
      const csvData = parseCSV(content);

      // GASã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
      await uploadToSheet(data.config.sheetName, csvData);

      successCount++;
      showProgress(progress);

    } catch (error) {
      console.error(`Error uploading ${data.config.label}:`, error);
      errorCount++;
    }
  }

  showProgress(100);

  if (errorCount === 0) {
    showStatus(`âœ… ${successCount}ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼`, 'success');
    setTimeout(() => {
      google.script.host.close();
    }, 2000);
  } else {
    showStatus(`âš ï¸ ${successCount}ãƒ•ã‚¡ã‚¤ãƒ«æˆåŠŸã€${errorCount}ãƒ•ã‚¡ã‚¤ãƒ«å¤±æ•—`, 'error');
  }
}

// ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
function readFileAsText(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.onerror = (e) => reject(e);
    reader.readAsText(file, 'UTF-8');
  });
}

// CSVãƒ‘ãƒ¼ã‚¹
function parseCSV(text) {
  // BOMé™¤å»
  const cleanText = text.replace(/^\uFEFF/, '');

  // è¡Œåˆ†å‰²
  const lines = cleanText.split(/\r?\n/).filter(line => line.trim());

  // CSVè§£æ
  const result = lines.map(line => {
    // ç°¡æ˜“CSVãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆã‚¯ã‚©ãƒ¼ãƒˆå‡¦ç†ã¯çœç•¥ï¼‰
    return line.split(',').map(cell => cell.trim());
  });

  return result;
}

// GASã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
function uploadToSheet(sheetName, csvData) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .importCSVToSheet(sheetName, csvData);
  });
}

// UIé–¢æ•°
function showStatus(message, type) {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = 'status ' + type;
  status.style.display = 'block';
}

function showProgress(percent) {
  const container = document.getElementById('progressContainer');
  const bar = document.getElementById('progressBar');

  container.style.display = 'block';
  bar.style.width = percent + '%';
  bar.textContent = Math.round(percent) + '%';
}

function clearAll() {
  Object.keys(files).forEach(key => {
    files[key].file = null;
    updateFileStatus(key);
  });

  document.getElementById('fileSummary').style.display = 'none';
  document.getElementById('progressContainer').style.display = 'none';
  document.getElementById('status').style.display = 'none';
  document.getElementById('uploadButton').disabled = true;
}

// åˆæœŸåŒ–å®Ÿè¡Œ
init();
</script>
</body>
</html>

<!-- ===== QualityFlagDemoUI.html ===== -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>å“è³ªãƒ•ãƒ©ã‚°å¯è¦–åŒ–ãƒ‡ãƒ¢</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      color: #1a73e8;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }

    h2 {
      color: #333;
      margin-top: 30px;
      border-left: 4px solid #1a73e8;
      padding-left: 10px;
    }

    .section {
      margin: 20px 0;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 5px;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 15px 0;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .color-box {
      width: 20px;
      height: 20px;
      border: 1px solid #ccc;
      display: inline-block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }

    table th {
      background-color: #1a73e8;
      color: white;
      padding: 10px;
      text-align: left;
    }

    table td {
      padding: 8px;
      border: 1px solid #ddd;
    }

    table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .quality-sufficient {
      background-color: #ccffcc;
    }

    .quality-marginal {
      background-color: #ffffcc;
    }

    .quality-insufficient {
      background-color: #ffcccc;
    }

    .warning-icon {
      font-size: 18px;
    }

    .summary-box {
      background-color: #e8f0fe;
      padding: 15px;
      border-left: 4px solid #1a73e8;
      margin: 15px 0;
    }

    .summary-box h4 {
      margin-top: 0;
      color: #1a73e8;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 10px 0;
    }

    .stat-item {
      background-color: white;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #1a73e8;
    }

    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }

    button:hover {
      background-color: #1557b0;
    }

    .dropdown {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>å“è³ªãƒ•ãƒ©ã‚°å¯è¦–åŒ–ãƒ‡ãƒ¢</h1>
    <p>ã‚ªãƒ—ã‚·ãƒ§ãƒ³C: å®Œå…¨çµ±åˆ - ãƒ‡ãƒ¼ã‚¿å“è³ªãƒ•ãƒ©ã‚°ã®å¯è¦–åŒ–æ©Ÿèƒ½ã®ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</p>

    <!-- Section 1: ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºåŒºåˆ†ã®è‰²åˆ†ã‘ -->
    <h2>1. ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºåŒºåˆ†ã«ã‚ˆã‚‹è‰²åˆ†ã‘ï¼ˆAggDesired.csvï¼‰</h2>
    <div class="section">
      <h3>è‰²åˆ†ã‘å‡¡ä¾‹</h3>
      <div class="legend">
        <div class="legend-item">
          <span class="color-box" style="background-color: #00cc00;"></span>
          <span>LARGEï¼ˆ100ä»¶ä»¥ä¸Šï¼‰</span>
        </div>
        <div class="legend-item">
          <span class="color-box" style="background-color: #ffcc00;"></span>
          <span>MEDIUMï¼ˆ30-99ä»¶ï¼‰</span>
        </div>
        <div class="legend-item">
          <span class="color-box" style="background-color: #ff9900;"></span>
          <span>SMALLï¼ˆ10-29ä»¶ï¼‰</span>
        </div>
        <div class="legend-item">
          <span class="color-box" style="background-color: #ff0000;"></span>
          <span>VERY_SMALLï¼ˆ1-9ä»¶ï¼‰</span>
        </div>
      </div>

      <h3>ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿</h3>
      <table>
        <thead>
          <tr>
            <th>å¸‚åŒºç”ºæ‘</th>
            <th>ä»¶æ•°</th>
            <th>ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºåŒºåˆ†</th>
            <th>è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
          </tr>
        </thead>
        <tbody>
          <tr style="background-color: #ccffcc;">
            <td>äº¬éƒ½å¸‚ä¼è¦‹åŒº</td>
            <td>1,748</td>
            <td>LARGE</td>
            <td>ãªã—ï¼ˆè¦³å¯Ÿçš„è¨˜è¿°ï¼‰</td>
          </tr>
          <tr style="background-color: #ffffcc;">
            <td>äº€å²¡å¸‚</td>
            <td>50</td>
            <td>MEDIUM</td>
            <td>ãªã—ï¼ˆè¦³å¯Ÿçš„è¨˜è¿°ï¼‰</td>
          </tr>
          <tr style="background-color: #ffeecc;">
            <td>â—‹â—‹ç”º</td>
            <td>15</td>
            <td>SMALL</td>
            <td>ãªã—ï¼ˆè¦³å¯Ÿçš„è¨˜è¿°ï¼‰</td>
          </tr>
          <tr style="background-color: #ffcccc;">
            <td>â—‹â—‹æ‘</td>
            <td>1</td>
            <td>VERY_SMALL</td>
            <td>ãªã—ï¼ˆè¦³å¯Ÿçš„è¨˜è¿°ï¼‰</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Section 2: ã‚¯ãƒ­ã‚¹é›†è¨ˆã‚»ãƒ«å“è³ªã®è‰²åˆ†ã‘ -->
    <h2>2. ã‚¯ãƒ­ã‚¹é›†è¨ˆã‚»ãƒ«å“è³ªã«ã‚ˆã‚‹è‰²åˆ†ã‘</h2>
    <div class="section">
      <h3>è‰²åˆ†ã‘å‡¡ä¾‹</h3>
      <div class="legend">
        <div class="legend-item">
          <span class="color-box" style="background-color: #ccffcc;"></span>
          <span>SUFFICIENTï¼ˆ30ä»¶ä»¥ä¸Šï¼‰</span>
        </div>
        <div class="legend-item">
          <span class="color-box" style="background-color: #ffffcc;"></span>
          <span>MARGINALï¼ˆ5-29ä»¶ï¼‰âš ï¸</span>
        </div>
        <div class="legend-item">
          <span class="color-box" style="background-color: #ffcccc;"></span>
          <span>INSUFFICIENTï¼ˆ0-4ä»¶ï¼‰ğŸš«</span>
        </div>
      </div>

      <h3>ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆå­¦æ­´ Ã— å¹´é½¢å±¤ï¼‰</h3>
      <table>
        <thead>
          <tr>
            <th>å­¦æ­´</th>
            <th>å¹´é½¢å±¤</th>
            <th>ä»¶æ•°</th>
            <th>å“è³ª</th>
            <th>è­¦å‘Š</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>é«˜æ ¡</td>
            <td>20ä»£</td>
            <td class="quality-sufficient">45</td>
            <td>SUFFICIENT</td>
            <td>ãªã—</td>
          </tr>
          <tr>
            <td>é«˜æ ¡</td>
            <td>30ä»£</td>
            <td class="quality-marginal">12 <span class="warning-icon">âš ï¸</span></td>
            <td>MARGINAL</td>
            <td>ã‚»ãƒ«æ•°ä¸è¶³ï¼ˆn=12 < 30ï¼‰</td>
          </tr>
          <tr>
            <td>å°‚é–€</td>
            <td>40ä»£</td>
            <td class="quality-insufficient">3 <span class="warning-icon">ğŸš«</span></td>
            <td>INSUFFICIENT</td>
            <td>ã‚»ãƒ«æ•°ä¸è¶³ï¼ˆn=3 < 5ï¼‰</td>
          </tr>
          <tr>
            <td>å¤§å­¦</td>
            <td>20ä»£</td>
            <td class="quality-sufficient">73</td>
            <td>SUFFICIENT</td>
            <td>ãªã—</td>
          </tr>
          <tr>
            <td>å¤§å­¦é™¢</td>
            <td>20ä»£</td>
            <td class="quality-insufficient">2 <span class="warning-icon">ğŸš«</span></td>
            <td>INSUFFICIENT</td>
            <td>ã‚»ãƒ«æ•°ä¸è¶³ï¼ˆn=2 < 5ï¼‰</td>
          </tr>
          <tr>
            <td>å¤§å­¦é™¢</td>
            <td>30ä»£</td>
            <td class="quality-marginal">5 <span class="warning-icon">âš ï¸</span></td>
            <td>MARGINAL</td>
            <td>ã‚»ãƒ«æ•°ä¸è¶³ï¼ˆn=5 < 30ï¼‰</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Section 3: å“è³ªçµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
    <h2>3. å“è³ªçµ±è¨ˆã‚µãƒãƒªãƒ¼</h2>
    <div class="section">
      <div class="summary-box">
        <h4>AggDesired.csv å“è³ªã‚µãƒãƒªãƒ¼</h4>
        <div class="summary-stats">
          <div class="stat-item">
            <div class="stat-label">ç·ä»¶æ•°</div>
            <div class="stat-value">898</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">å¹³å‡ã‚«ã‚¦ãƒ³ãƒˆ</div>
            <div class="stat-value">27</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">LARGE</div>
            <div class="stat-value" style="color: #00cc00;">245</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">MEDIUM</div>
            <div class="stat-value" style="color: #ffcc00;">123</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">SMALL</div>
            <div class="stat-value" style="color: #ff9900;">298</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">VERY_SMALL</div>
            <div class="stat-value" style="color: #ff0000;">232</div>
          </div>
        </div>
      </div>

      <div class="summary-box">
        <h4>ã‚¯ãƒ­ã‚¹é›†è¨ˆ å“è³ªã‚µãƒãƒªãƒ¼</h4>
        <div class="summary-stats">
          <div class="stat-item">
            <div class="stat-label">ç·ã‚»ãƒ«æ•°</div>
            <div class="stat-value">35</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">å¹³å‡ã‚«ã‚¦ãƒ³ãƒˆ</div>
            <div class="stat-value">214</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">SUFFICIENT</div>
            <div class="stat-value" style="color: #00cc00;">24</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">MARGINAL</div>
            <div class="stat-value" style="color: #ffcc00;">6</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">INSUFFICIENT</div>
            <div class="stat-value" style="color: #ff0000;">5</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">è­¦å‘Šã‚ã‚Š</div>
            <div class="stat-value" style="color: #ff9900;">11</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 4: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ‡ãƒ¢ï¼ˆä»®ï¼‰ -->
    <h2>4. ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠãƒ‡ãƒ¢ï¼ˆä»®ï¼‰</h2>
    <div class="section">
      <h3>å¸‚åŒºç”ºæ‘é¸æŠï¼ˆå“è³ªãƒ•ãƒ©ã‚°ä»˜ãï¼‰</h3>
      <select class="dropdown" id="municipalityDropdown">
        <option value="">å¸‚åŒºç”ºæ‘ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="kyoto_fushimi" style="background-color: #ccffcc;">äº¬éƒ½å¸‚ä¼è¦‹åŒºï¼ˆ1,748ä»¶ï¼‰</option>
        <option value="kameoka" style="background-color: #ffffcc;">äº€å²¡å¸‚ï¼ˆ50ä»¶ï¼‰</option>
        <option value="town" style="background-color: #ffeecc;">â—‹â—‹ç”ºï¼ˆ15ä»¶ï¼‰</option>
        <option value="village" style="background-color: #ffcccc;">â—‹â—‹æ‘ï¼ˆ1ä»¶ï¼‰</option>
      </select>

      <div id="selectionInfo" style="margin-top: 10px; padding: 10px; background-color: #f0f0f0; display: none;">
        <p><strong>é¸æŠã•ã‚ŒãŸåœ°åŸŸ:</strong> <span id="selectedName"></span></p>
        <p><strong>ä»¶æ•°:</strong> <span id="selectedCount"></span></p>
        <p><strong>å“è³ª:</strong> <span id="selectedQuality"></span></p>
      </div>
    </div>

    <!-- Section 5: GASçµ±åˆã‚¬ã‚¤ãƒ‰ -->
    <h2>5. GASçµ±åˆã‚¬ã‚¤ãƒ‰</h2>
    <div class="section">
      <h3>å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½</h3>
      <ul>
        <li>âœ… ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºåŒºåˆ†ã«ã‚ˆã‚‹è‰²åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ<code>getMarkerColor()</code>ï¼‰</li>
        <li>âœ… ã‚»ãƒ«å“è³ªã«ã‚ˆã‚‹è‰²åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ<code>getCellBackgroundColor()</code>ï¼‰</li>
        <li>âœ… ãƒãƒ¼ã‚«ãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆ<code>createMarkersWithQualityFlags()</code>ï¼‰</li>
        <li>âœ… ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆï¼ˆ<code>createDropdownOptionsWithQualityFlags()</code>ï¼‰</li>
        <li>âœ… ã‚¯ãƒ­ã‚¹é›†è¨ˆHTMLãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆï¼ˆ<code>renderCrossTabTableWithQualityFlags()</code>ï¼‰</li>
        <li>âœ… å“è³ªçµ±è¨ˆã‚µãƒãƒªãƒ¼ç”Ÿæˆï¼ˆ<code>generateQualitySummary()</code>ï¼‰</li>
      </ul>

      <h3>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h3>
      <ol>
        <li>æ—¢å­˜ã®åœ°å›³è¡¨ç¤ºæ©Ÿèƒ½ã«<code>QualityFlagVisualization.gs</code>ã‚’çµ±åˆ</li>
        <li>AggDesired.csvã‚’èª­ã¿è¾¼ã¿æ™‚ã«å“è³ªãƒ•ãƒ©ã‚°ã‚’è‡ªå‹•é©ç”¨</li>
        <li>ã‚¯ãƒ­ã‚¹é›†è¨ˆè¡¨ç¤ºæ©Ÿèƒ½ã«å“è³ªãƒ•ãƒ©ã‚°HTMLãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµ±åˆ</li>
        <li>GAS E2Eãƒ†ã‚¹ãƒˆã§å‹•ä½œç¢ºèª</li>
      </ol>

      <h3>ä½¿ç”¨æ–¹æ³•</h3>
      <pre style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto;">
// 1. AggDesired.csvãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‰²ä»˜ããƒãƒ¼ã‚«ãƒ¼ã‚’ç”Ÿæˆ
const aggDesiredData = loadAggDesiredData();  // æ—¢å­˜ã®èª­ã¿è¾¼ã¿é–¢æ•°
const markers = createMarkersWithQualityFlags(aggDesiredData);

// 2. Google Mapsã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
markers.forEach(function(marker) {
  const mapMarker = new google.maps.Marker({
    position: { lat: marker.lat, lng: marker.lng },
    map: map,
    title: marker.title,
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      fillColor: marker.color,  // å“è³ªãƒ•ãƒ©ã‚°ã«ã‚ˆã‚‹è‰²
      fillOpacity: 0.7,
      strokeWeight: 1,
      scale: 8
    }
  });
});

// 3. ã‚¯ãƒ­ã‚¹é›†è¨ˆã‚’HTMLãƒ†ãƒ¼ãƒ–ãƒ«ã§è¡¨ç¤º
const crossTabData = loadCrossTabData();  // æ—¢å­˜ã®èª­ã¿è¾¼ã¿é–¢æ•°
const tableHTML = renderCrossTabTableWithQualityFlags(
  crossTabData,
  'education_level',
  'å¹´é½¢å±¤'
);
document.getElementById('crosstab-container').innerHTML = tableHTML;
      </pre>
    </div>

    <div style="text-align: center; margin-top: 30px;">
      <button onclick="google.script.host.close()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <script>
    // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('municipalityDropdown').addEventListener('change', function() {
      const selectedValue = this.value;
      const selectedText = this.options[this.selectedIndex].text;

      if (selectedValue) {
        document.getElementById('selectionInfo').style.display = 'block';
        document.getElementById('selectedName').textContent = selectedText.split('ï¼ˆ')[0];
        document.getElementById('selectedCount').textContent = selectedText.match(/\d+/)[0];

        // å“è³ªåˆ¤å®š
        const count = parseInt(selectedText.match(/\d+/)[0]);
        let quality = '';
        if (count >= 100) {
          quality = 'LARGEï¼ˆçµ±è¨ˆçš„æ¨è«–ã«ååˆ†ï¼‰';
        } else if (count >= 30) {
          quality = 'MEDIUMï¼ˆå‚¾å‘åˆ†æå¯èƒ½ï¼‰';
        } else if (count >= 10) {
          quality = 'SMALLï¼ˆå‚è€ƒãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰';
        } else {
          quality = 'VERY_SMALLï¼ˆæ¨è«–ã«ã¯ä½¿ç”¨ä¸å¯ï¼‰';
        }
        document.getElementById('selectedQuality').textContent = quality;
      } else {
        document.getElementById('selectionInfo').style.display = 'none';
      }
    });
  </script>
</body>
</html>

<!-- ===== RegionalDashboard.html ===== -->
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>åœ°åŸŸåˆ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <style>
      :root {
        --bg: #f5f7fb;
        --surface: #ffffff;
        --primary: #1a73e8;
        --primary-light: #e8f0fe;
        --border: #dfe4ea;
        --text: #202124;
        --muted: #5f6368;
        --warn: #c5221f;
        --accent: #34a853;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 32px 24px 48px;
      }

      h1 {
        margin: 0;
        font-size: 26px;
        font-weight: 600;
      }

      .description {
        margin-top: 6px;
        color: var(--muted);
      }

      .region-controls {
        margin-top: 28px;
        display: grid;
        grid-template-columns: 1fr 1fr auto;
        gap: 12px;
        align-items: end;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      label {
        font-size: 13px;
        color: var(--muted);
      }

      select {
        height: 40px;
        border-radius: 8px;
        border: 1px solid var(--border);
        padding: 0 12px;
        font-size: 14px;
        background: var(--surface);
        transition: border 0.2s ease;
      }

      select:focus {
        border-color: var(--primary);
        outline: none;
      }

      button.primary {
        height: 40px;
        min-width: 120px;
        border: none;
        border-radius: 8px;
        background: var(--primary);
        color: #fff;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      button.primary:disabled {
        background: #aac7f6;
        cursor: default;
      }

      button.primary:hover:not(:disabled) {
        background: #1557b0;
      }

      .tabs {
        margin-top: 32px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .tab-button {
        padding: 10px 18px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--muted);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .tab-button.active {
        background: var(--primary);
        border-color: var(--primary);
        color: #fff;
        box-shadow: 0 6px 16px rgba(26, 115, 232, 0.25);
      }

      .tab-button:disabled {
        opacity: 0.7;
        cursor: default;
      }

      .panel {
        margin-top: 24px;
        padding: 24px;
        border-radius: 16px;
        background: var(--surface);
        box-shadow: 0 12px 24px rgba(32, 33, 36, 0.08);
      }

      .filters {
        margin-bottom: 12px;
        display: none;
        gap: 12px;
        flex-wrap: wrap;
      }

      .filters.active {
        display: flex;
      }

      .filters select {
        min-width: 220px;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 16px;
      }

      .summary-card {
        padding: 18px;
        border-radius: 14px;
        background: var(--primary-light);
        border: 1px solid #d2e3fc;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .summary-card .label {
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .summary-card .value {
        font-size: 20px;
        font-weight: 700;
        color: var(--primary);
      }

      .summary-card .note {
        font-size: 12px;
        color: var(--muted);
      }

      .warnings {
        margin-top: 24px;
        padding: 16px 20px;
        border-radius: 12px;
        border: 1px solid rgba(197, 34, 31, 0.35);
        background: rgba(197, 34, 31, 0.08);
        color: var(--warn);
        display: none;
        gap: 8px;
        flex-direction: column;
      }

      .warnings.visible {
        display: flex;
      }

      .warning-title {
        font-weight: 600;
      }

      .table-group {
        margin-top: 28px;
      }

      .table-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: inset 0 0 0 1px var(--border);
        background: var(--surface);
      }

      th,
      td {
        padding: 10px 14px;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
        text-align: left;
      }

      th {
        background: #f1f4f9;
        font-weight: 600;
      }

      tr:last-child td {
        border-bottom: none;
      }

      .empty-placeholder {
        padding: 18px;
        border-radius: 12px;
        background: #f8f9fb;
        color: var(--muted);
        font-size: 13px;
      }

      .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .loading-overlay.visible {
        display: flex;
      }

      .spinner {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 4px solid rgba(26, 115, 232, 0.15);
        border-top-color: var(--primary);
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .toast {
        position: fixed;
        right: 24px;
        top: 24px;
        padding: 14px 18px;
        background: rgba(32, 33, 36, 0.9);
        color: #fff;
        border-radius: 10px;
        font-size: 13px;
        display: none;
        z-index: 1100;
      }

      .toast.visible {
        display: block;
      }

      @media (max-width: 720px) {
        .region-controls {
          grid-template-columns: 1fr;
        }
        .tabs {
          overflow-x: auto;
        }
        .tab-button {
          white-space: nowrap;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>åœ°åŸŸåˆ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <p class="description">
          éƒ½é“åºœçœŒãƒ»å¸‚åŒºç”ºæ‘ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã€Phase1 / 2 / 3 / 7 / 8 / 10 ã®ä¸»è¦æŒ‡æ¨™ã¨å“è³ªæƒ…å ±ã‚’æ¨ªæ–­çš„ã«ç¢ºèªã§ãã¾ã™ã€‚
        </p>
      </header>

      <section class="region-controls">
        <div class="field">
          <label for="prefectureSelect">éƒ½é“åºœçœŒ</label>
          <select id="prefectureSelect" disabled>
            <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
          </select>
        </div>
        <div class="field">
          <label for="municipalitySelect">å¸‚åŒºç”ºæ‘</label>
          <select id="municipalitySelect" disabled>
            <option value="">éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        <button class="primary" id="refreshButton" disabled>æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</button>
      </section>

      <nav class="tabs" id="phaseTabs"></nav>

      <section class="panel">
        <div class="filters" id="filterPanel"></div>
        <div class="summary-grid" id="summaryGrid"></div>
        <div class="warnings" id="warningsBox">
          <div class="warning-title">âš ï¸ æ³¨æ„äº‹é …</div>
          <div class="warning-list" id="warningList"></div>
        </div>
        <div id="tablesContainer"></div>
      </section>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
    </div>
    <div class="toast" id="toast"></div>

    <script>
      const PHASE_CONFIG = [
        {
          id: "phase1",
          label: "Phase 1 åŸºç¤é›†è¨ˆ",
          fetch: "fetchPhase1Metrics",
          hasFilters: false,
          summaryLabels: {
            applicantCount: "å¿œå‹Ÿè€…æ•°",
            mapRecords: "MapMetrics è¡Œæ•°",
            aggDesiredRecords: "AggDesired è¡Œæ•°"
          }
        },
        {
          id: "phase2",
          label: "Phase 2 çµ±è¨ˆè§£æ",
          fetch: "fetchPhase2Stats",
          hasFilters: false,
          summaryLabels: {
            chiSquareTests: "ã‚«ã‚¤äºŒä¹—æ¤œå®š",
            anovaTests: "ANOVAæ¤œå®š"
          }
        },
        {
          id: "phase3",
          label: "Phase 3 ãƒšãƒ«ã‚½ãƒŠåˆ†æ",
          fetch: "fetchPhase3Persona",
          hasFilters: true,
          summaryLabels: {
            personaSegments: "ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°",
            averageDifficultyScore: "å¹³å‡é›£æ˜“åº¦ã‚¹ã‚³ã‚¢",
            topDifficultyLevel: "æœ€é›£ãƒ©ãƒ³ã‚¯"
          }
        },
        {
          id: "phase7",
          label: "Phase 7 é«˜åº¦åˆ†æ",
          fetch: "fetchPhase7Supply",
          hasFilters: false,
          summaryLabels: {
            supplyRecords: "ä¾›çµ¦å¯†åº¦ãƒ¬ã‚³ãƒ¼ãƒ‰",
            qualificationRecords: "è³‡æ ¼åˆ†å¸ƒãƒ¬ã‚³ãƒ¼ãƒ‰",
            mobilityRecords: "ç§»å‹•è¨±å®¹åº¦ãƒ¬ã‚³ãƒ¼ãƒ‰"
          }
        },
        {
          id: "phase8",
          label: "Phase 8 å­¦æ­´ãƒ»ã‚­ãƒ£ãƒªã‚¢",
          fetch: "fetchPhase8Education",
          hasFilters: false,
          summaryLabels: {
            educationBuckets: "å­¦æ­´ç¨®åˆ¥",
            graduationBuckets: "å’æ¥­å¹´åˆ†å¸ƒ"
          }
        },
        {
          id: "phase10",
          label: "Phase 10 è»¢è·æ„æ¬²",
          fetch: "fetchPhase10Urgency",
          hasFilters: false,
          summaryLabels: {
            urgencyRecords: "ç·Šæ€¥åº¦åˆ†å¸ƒ",
            ageCrossRecords: "å¹´é½¢ã‚¯ãƒ­ã‚¹é›†è¨ˆ",
            employmentCrossRecords: "é›‡ç”¨å½¢æ…‹ã‚¯ãƒ­ã‚¹"
          }
        }
      ];

      const RESERVED_ALIAS_KEYS = new Set([
        "prefecture",
        "municipality",
        "regionKey",
        "latitude",
        "longitude",
        "count",
        "ratio",
        "score",
        "urgencyLevel",
        "urgencyScore",
        "segmentId",
        "segmentName"
      ]);

      const state = {
        region: {
          prefecture: null,
          municipality: null,
          key: null
        },
        municipalities: [],
        activePhase: "phase1",
        phaseCache: {},
        phase3Filters: {
          segmentId: "",
          difficultyLevel: ""
        }
      };

      const dom = {
        prefSelect: document.getElementById("prefectureSelect"),
        muniSelect: document.getElementById("municipalitySelect"),
        refreshButton: document.getElementById("refreshButton"),
        tabs: document.getElementById("phaseTabs"),
        filterPanel: document.getElementById("filterPanel"),
        summaryGrid: document.getElementById("summaryGrid"),
        warningsBox: document.getElementById("warningsBox"),
        warningList: document.getElementById("warningList"),
        tablesContainer: document.getElementById("tablesContainer"),
        loadingOverlay: document.getElementById("loadingOverlay"),
        toast: document.getElementById("toast")
      };

      function showToast(message, timeout = 3500) {
        dom.toast.textContent = message;
        dom.toast.classList.add("visible");
        setTimeout(() => dom.toast.classList.remove("visible"), timeout);
      }

      function setLoading(isLoading) {
        dom.loadingOverlay.classList.toggle("visible", isLoading);
        dom.refreshButton.disabled = isLoading;
        dom.prefSelect.disabled = isLoading;
        dom.muniSelect.disabled = isLoading;
      }

      function initialize() {
        setLoading(true);
        google.script.run
          .withSuccessHandler(handleInitialOptions)
          .withFailureHandler(handleError)
          .getRegionOptions();
      }

      function handleInitialOptions(payload) {
        state.region = payload.state || state.region;
        populatePrefectures(payload.prefectures || []);
        populateMunicipalities(payload.municipalities || []);
        renderTabs();
        registerEvents();
        setLoading(false);
        activatePhase(state.activePhase);
      }

      function populatePrefectures(prefectures) {
        const select = dom.prefSelect;
        select.innerHTML = "";

        if (!prefectures.length) {
          select.innerHTML = '<option value="">åˆ©ç”¨å¯èƒ½ãªéƒ½é“åºœçœŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</option>';
          select.disabled = true;
          return;
        }

        prefectures.forEach(pref => {
          const option = document.createElement("option");
          option.value = pref;
          option.textContent = pref;
          if (pref === state.region.prefecture) {
            option.selected = true;
          }
          select.append(option);
        });

        select.disabled = false;
      }

      function populateMunicipalities(municipalities) {
        state.municipalities = municipalities;
        const select = dom.muniSelect;
        select.innerHTML = "";

        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = municipalities.length ? "å¸‚åŒºç”ºæ‘ã‚’é¸æŠï¼ˆä»»æ„ï¼‰" : "è©²å½“ã™ã‚‹å¸‚åŒºç”ºæ‘ãŒã‚ã‚Šã¾ã›ã‚“";
        select.append(placeholder);

        municipalities.forEach(muni => {
          const option = document.createElement("option");
          option.value = muni;
          option.textContent = muni;
          if (muni === state.region.municipality) {
            option.selected = true;
          }
          select.append(option);
        });

        select.disabled = false;
      }

      function renderTabs() {
        dom.tabs.innerHTML = "";
        PHASE_CONFIG.forEach(phase => {
          const button = document.createElement("button");
          button.type = "button";
          button.className = "tab-button" + (phase.id === state.activePhase ? " active" : "");
          button.textContent = phase.label;
          button.dataset.phase = phase.id;
          dom.tabs.append(button);
        });
      }

      function registerEvents() {
        dom.prefSelect.addEventListener("change", handlePrefectureChange);
        dom.muniSelect.addEventListener("change", handleMunicipalityChange);
        dom.refreshButton.addEventListener("click", () => refreshPhase(state.activePhase, { force: true }));
        dom.tabs.addEventListener("click", evt => {
          const target = evt.target.closest(".tab-button");
          if (!target) return;
          const phaseId = target.dataset.phase;
          activatePhase(phaseId);
        });
      }

      function handlePrefectureChange() {
        const selectedPref = dom.prefSelect.value || null;
        if (!selectedPref) {
          return;
        }

        setLoading(true);
        google.script.run
          .withSuccessHandler(municipalities => {
            populateMunicipalities(municipalities || []);
            const selectedMuni = municipalities.includes(state.region.municipality)
              ? state.region.municipality
              : municipalities[0] || null;
            saveRegion(selectedPref, selectedMuni, true);
          })
          .withFailureHandler(handleError)
          .getMunicipalitiesForPrefecture(selectedPref);
      }

      function handleMunicipalityChange() {
        const selectedMuni = dom.muniSelect.value || null;
        saveRegion(state.region.prefecture, selectedMuni, true);
      }

      function saveRegion(prefecture, municipality, refreshAfter = false) {
        setLoading(true);
        google.script.run
          .withSuccessHandler(updated => {
            state.region = updated;
            state.phaseCache = {};
            setLoading(false);
            if (refreshAfter) {
              refreshPhase(state.activePhase, { force: true });
            }
          })
          .withFailureHandler(handleError)
          .saveSelectedRegion(prefecture, municipality);
      }

      function activatePhase(phaseId) {
        if (!phaseId) return;
        state.activePhase = phaseId;
        Array.from(dom.tabs.querySelectorAll(".tab-button")).forEach(button => {
          button.classList.toggle("active", button.dataset.phase === phaseId);
        });
        refreshPhase(phaseId);
      }

      function refreshPhase(phaseId, options = {}) {
        const phase = PHASE_CONFIG.find(p => p.id === phaseId);
        if (!phase) return;

        const useCache = !options.force && state.phaseCache[phaseId];
        if (useCache) {
          renderPhaseData(phase, state.phaseCache[phaseId], { fromCache: true });
          return;
        }

        setLoading(true);
        const args = buildPhaseArgs(phaseId);

        let runner = google.script.run
          .withSuccessHandler(data => {
            state.phaseCache[phaseId] = data;
            renderPhaseData(phase, data, { fromCache: false });
            setLoading(false);
            if (!options.fromFilter && phaseId === "phase3") {
              updatePhase3Filters(data);
            }
          })
          .withFailureHandler(handleError);

        runner = runner[phase.fetch];
        runner.apply(null, args);
      }

      function buildPhaseArgs(phaseId) {
        const base = [state.region.prefecture, state.region.municipality];
        if (phaseId === "phase3") {
          return [
            ...base,
            {
              segmentId: state.phase3Filters.segmentId || "",
              difficultyLevel: state.phase3Filters.difficultyLevel || ""
            }
          ];
        }
        return base;
      }

      function renderPhaseData(phase, data, meta) {
        renderSummary(phase, data.summary || {});
        renderWarnings(data.warnings || []);
        renderTables(data.tables || {});
        renderFilters(phase, data);
        if (meta.fromCache) {
          showToast("ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸçµæœã‚’è¡¨ç¤ºä¸­ï¼ˆæœ€æ–°ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ãªå ´åˆã¯æ›´æ–°ã—ã¦ãã ã•ã„ï¼‰", 2500);
        }
      }

      function renderSummary(phase, summary) {
        dom.summaryGrid.innerHTML = "";
        const labels = phase.summaryLabels || {};
        const entries = Object.entries(summary || {});

        if (!entries.length) {
          const placeholder = document.createElement("div");
          placeholder.className = "empty-placeholder";
          placeholder.textContent = "ã“ã®ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯è¡¨ç¤ºå¯èƒ½ãªã‚µãƒãƒªãƒ¼æŒ‡æ¨™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
          dom.summaryGrid.append(placeholder);
          return;
        }

        entries.forEach(([key, value]) => {
          const card = document.createElement("div");
          card.className = "summary-card";

          const label = document.createElement("div");
          label.className = "label";
          label.textContent = labels[key] || key;

          const val = document.createElement("div");
          val.className = "value";
          val.textContent = formatValue(value);

          card.append(label, val);
          dom.summaryGrid.append(card);
        });
      }

      function renderWarnings(warnings) {
        if (!warnings || !warnings.length) {
          dom.warningsBox.classList.remove("visible");
          dom.warningList.innerHTML = "";
          return;
        }

        dom.warningsBox.classList.add("visible");
        dom.warningList.innerHTML = "";
        warnings.forEach(message => {
          const row = document.createElement("div");
          row.textContent = message;
          dom.warningList.append(row);
        });
      }

      function renderTables(tables) {
        dom.tablesContainer.innerHTML = "";
        const entries = Object.entries(tables || {});
        if (!entries.length) {
          const placeholder = document.createElement("div");
          placeholder.className = "empty-placeholder";
          placeholder.textContent = "è¡¨ç¤ºã§ãã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
          dom.tablesContainer.append(placeholder);
          return;
        }

        entries.forEach(([tableKey, rows]) => {
          const group = document.createElement("section");
          group.className = "table-group";

          const title = document.createElement("div");
          title.className = "table-title";
          title.textContent = deriveTableTitle(tableKey);

          group.append(title);
          if (!Array.isArray(rows) || !rows.length) {
            const placeholder = document.createElement("div");
            placeholder.className = "empty-placeholder";
            placeholder.textContent = "è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
            group.append(placeholder);
          } else {
            const sanitized = sanitizeRecords(rows);
            const table = buildTableElement(sanitized);
            group.append(table);
          }
          dom.tablesContainer.append(group);
        });
      }

      function deriveTableTitle(key) {
        const map = {
          mapMetrics: "MapMetrics",
          aggDesired: "AggDesired",
          quality: "å“è³ªãƒ¬ãƒãƒ¼ãƒˆ",
          chiSquare: "ChiSquareTests",
          anova: "ANOVATests",
          personaSummary: "PersonaSummary",
          personaDetails: "PersonaDetails",
          supplyDensity: "SupplyDensityMap",
          qualificationDistribution: "QualificationDistribution",
          ageGenderCross: "AgeGenderCrossAnalysis",
          mobilityScore: "MobilityScore",
          personaProfile: "DetailedPersonaProfile",
          educationDistribution: "EducationDistribution",
          educationCross: "EducationAgeCross",
          graduationDistribution: "GraduationYearDistribution",
          urgencyDistribution: "UrgencyDistribution",
          ageCross: "UrgencyAgeCross",
          employmentCross: "UrgencyEmploymentCross",
          desiredWorkCross: "UrgencyDesiredWorkCross"
        };
        return map[key] || key;
      }

      function sanitizeRecords(records) {
        return records.map(record => {
          const cleaned = {};
          Object.keys(record).forEach(key => {
            if (key === "__normalized") return;
            if (RESERVED_ALIAS_KEYS.has(key)) return;
            cleaned[key] = record[key];
          });
          if (!Object.keys(cleaned).length) {
            Object.keys(record).forEach(key => {
              if (key !== "__normalized" && !cleaned.hasOwnProperty(key)) {
                cleaned[key] = record[key];
              }
            });
          }
          return cleaned;
        });
      }

      function buildTableElement(records) {
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const tbody = document.createElement("tbody");

        const columns = deriveColumns(records);
        const headerRow = document.createElement("tr");
        columns.forEach(col => {
          const th = document.createElement("th");
          th.textContent = col;
          headerRow.append(th);
        });
        thead.append(headerRow);

        records.forEach(record => {
          const row = document.createElement("tr");
          columns.forEach(col => {
            const td = document.createElement("td");
            td.textContent = formatValue(record[col]);
            row.append(td);
          });
          tbody.append(row);
        });

        table.append(thead, tbody);
        return table;
      }

      function deriveColumns(records) {
        if (!records.length) return [];
        const ordered = Object.keys(records[0]);
        const seen = new Set();
        return ordered.filter(col => {
          if (seen.has(col)) return false;
          seen.add(col);
          return true;
        });
      }

      function formatValue(value) {
        if (value === null || value === undefined || value === "") {
          return "-";
        }
        if (typeof value === "number") {
          return Number.isInteger(value) ? value.toLocaleString("ja-JP") : Number(value).toLocaleString("ja-JP", { maximumFractionDigits: 3 });
        }
        if (typeof value === "boolean") {
          return value ? "ã¯ã„" : "ã„ã„ãˆ";
        }
        return String(value);
      }

      function renderFilters(phase, data) {
        if (!phase.hasFilters) {
          dom.filterPanel.classList.remove("active");
          dom.filterPanel.innerHTML = "";
          return;
        }

        dom.filterPanel.classList.add("active");
        dom.filterPanel.innerHTML = "";

        if (phase.id === "phase3") {
          const { personaSummary = [] } = data.tables || {};
          const segmentOptions = personaSummary
            .map(record => {
              const id = record.segment_id ?? record.segmentId;
              const name = record.segment_name ?? record.segmentName ?? id;
              if (id === undefined || id === null || id === "") return null;
              return { id: String(id), name: String(name) };
            })
            .filter(Boolean);

          const difficultyOptions = personaSummary
            .map(record => record.difficulty_level ?? record.difficultyLevel)
            .filter(level => level && level !== "");

          const uniqueSegments = [];
          const seenSegments = new Set();
          segmentOptions.forEach(option => {
            if (seenSegments.has(option.id)) return;
            seenSegments.add(option.id);
            uniqueSegments.push(option);
          });

          const uniqueDifficulties = Array.from(new Set(difficultyOptions));

          const segmentWrapper = document.createElement("div");
          segmentWrapper.className = "field";

          const segmentLabel = document.createElement("label");
          segmentLabel.textContent = "ãƒšãƒ«ã‚½ãƒŠ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ";
          segmentLabel.htmlFor = "segmentFilter";

          const segmentSelect = document.createElement("select");
          segmentSelect.id = "segmentFilter";
          segmentSelect.innerHTML = '<option value="">å…¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</option>';

          uniqueSegments.forEach(option => {
            const opt = document.createElement("option");
            opt.value = option.id;
            opt.textContent = `${option.id}: ${option.name}`;
            if (option.id === state.phase3Filters.segmentId) {
              opt.selected = true;
            }
            segmentSelect.append(opt);
          });

          segmentSelect.addEventListener("change", () => {
            state.phase3Filters.segmentId = segmentSelect.value;
            state.phaseCache.phase3 = null;
            refreshPhase("phase3", { force: true, fromFilter: true });
          });

          segmentWrapper.append(segmentLabel, segmentSelect);
          dom.filterPanel.append(segmentWrapper);

          const difficultyWrapper = document.createElement("div");
          difficultyWrapper.className = "field";

          const difficultyLabel = document.createElement("label");
          difficultyLabel.textContent = "é›£æ˜“åº¦ãƒ©ãƒ³ã‚¯";
          difficultyLabel.htmlFor = "difficultyFilter";

          const difficultySelect = document.createElement("select");
          difficultySelect.id = "difficultyFilter";
          difficultySelect.innerHTML = '<option value="">å…¨ãƒ©ãƒ³ã‚¯</option>';

          uniqueDifficulties.forEach(level => {
            const opt = document.createElement("option");
            opt.value = level;
            opt.textContent = level;
            if (level === state.phase3Filters.difficultyLevel) {
              opt.selected = true;
            }
            difficultySelect.append(opt);
          });

          difficultySelect.addEventListener("change", () => {
            state.phase3Filters.difficultyLevel = difficultySelect.value;
            state.phaseCache.phase3 = null;
            refreshPhase("phase3", { force: true, fromFilter: true });
          });

          difficultyWrapper.append(difficultyLabel, difficultySelect);
          dom.filterPanel.append(difficultyWrapper);
        }
      }

      function updatePhase3Filters(data) {
        if (state.activePhase !== "phase3") return;
        renderFilters(PHASE_CONFIG.find(p => p.id === "phase3"), data);
      }

      function handleError(error) {
        setLoading(false);
        console.error(error);
        const message = error && error.message ? error.message : "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
        showToast(message);
      }

      document.addEventListener("DOMContentLoaded", initialize);
    </script>
  </body>
</html>

<!-- ===== Upload_Enhanced.html ===== -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <style>
    body{font-family:Arial,sans-serif;padding:20px;max-width:1200px;margin:0 auto}
    .upload-area{border:2px dashed #ccc;border-radius:8px;padding:40px;text-align:center;margin:20px 0;cursor:pointer;transition:0.3s}
    .upload-area:hover{border-color:#4285f4;background:#f8f9ff}
    .upload-area.dragover{background:#e3f2fd;border-color:#2196f3}
    #fileInput{display:none}
    .button{background:#4285f4;color:#fff;padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-size:14px;margin:5px;transition:0.3s}
    .button:hover{background:#357ae8}
    .button:disabled{background:#ccc;cursor:not-allowed}
    .button.secondary{background:#6c757d}
    .button.secondary:hover{background:#5a6268}
    .button.danger{background:#dc3545}
    .button.danger:hover{background:#c82333}
    .button.success{background:#28a745}
    .button.success:hover{background:#218838}
    .status{margin:10px 0;padding:12px;border-radius:4px;display:none}
    .status.success{background:#d4edda;color:#155724;border-left:4px solid #28a745}
    .status.error{background:#f8d7da;color:#721c24;border-left:4px solid #dc3545}
    .status.info{background:#d1ecf1;color:#0c5460;border-left:4px solid #17a2b8}
    .status.warning{background:#fff3cd;color:#856404;border-left:4px solid #ffc107}
    .file-list{margin:20px 0;max-height:400px;overflow-y:auto}
    .phase-group{margin:15px 0;border:1px solid #dee2e6;border-radius:8px;overflow:hidden}
    .phase-header{background:#f8f9fa;padding:12px 15px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #dee2e6}
    .phase-header h4{margin:0;color:#333;font-size:16px}
    .phase-badge{background:#4285f4;color:white;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:bold}
    .file-item{padding:10px 15px;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center}
    .file-item:last-child{border-bottom:none}
    .file-item:hover{background:#f8f9fa}
    .file-name{font-size:14px;color:#333;flex:1}
    .file-size{font-size:12px;color:#666;margin-left:10px}
    .file-remove{color:#dc3545;cursor:pointer;padding:4px 8px;border-radius:4px;transition:0.3s}
    .file-remove:hover{background:#f8d7da}
    .progress-container{width:100%;height:30px;background:#f0f0f0;border-radius:15px;margin:20px 0;overflow:hidden;display:none}
    .progress-bar{height:100%;background:linear-gradient(90deg,#4285f4,#66a6ff);transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:white;font-size:14px;font-weight:bold}
    .tabs{display:flex;gap:10px;margin:20px 0;border-bottom:2px solid #dee2e6}
    .tab{padding:12px 20px;background:transparent;border:none;cursor:pointer;transition:0.3s;border-bottom:3px solid transparent;color:#666;font-size:14px;font-weight:500}
    .tab.active{color:#4285f4;border-bottom-color:#4285f4}
    .tab:hover{color:#4285f4}
    .tab-content{display:none;margin:20px 0}
    .tab-content.active{display:block}
    .phase-selector{margin:20px 0}
    .phase-checkbox{display:flex;align-items:center;padding:10px;margin:5px 0;background:#f8f9fa;border-radius:4px;cursor:pointer}
    .phase-checkbox:hover{background:#e9ecef}
    .phase-checkbox input{margin-right:10px}
    .empty-state{text-align:center;padding:40px;color:#999}
    .empty-state-icon{font-size:48px;margin-bottom:10px}
    .stats-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:20px 0}
    .stat-card{padding:15px;background:white;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);text-align:center}
    .stat-value{font-size:24px;font-weight:bold;color:#4285f4}
    .stat-label{font-size:12px;color:#666;margin-top:5px}
  </style>
</head>
<body>
  <h3>ğŸ“¥ Phaseåˆ¥CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆè¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ä¸€æ‹¬å¯¾å¿œï¼‰</h3>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('upload')">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</div>
    <div class="tab" onclick="switchTab('files')">ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ</div>
    <div class="tab" onclick="switchTab('options')">âš™ï¸ ã‚ªãƒ—ã‚·ãƒ§ãƒ³</div>
  </div>

  <!-- ã‚¿ãƒ–1: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
  <div class="tab-content active" id="upload-tab">
    <div class="upload-area" id="uploadArea">
      <div class="empty-state-icon">ğŸ“‚</div>
      <p><strong>è¤‡æ•°ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</strong><br>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„</p>
      <p style="font-size:12px;color:#666;">Phase 1, 2, 3, 6, 7, 8, 10ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾å¿œ</p>
    </div>
    <input type="file" id="fileInput" accept=".csv" multiple/>

    <div class="status" id="status"></div>

    <div style="text-align:center;margin-top:20px;">
      <button class="button success" id="uploadAllButton" disabled onclick="uploadAll()">ğŸ“¤ å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
      <button class="button" id="uploadByPhaseButton" disabled onclick="uploadByPhase()">ğŸ“Š Phaseåˆ¥ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
      <button class="button secondary" onclick="clearAll()">ğŸ”„ ã‚¯ãƒªã‚¢</button>
      <button class="button secondary" onclick="google.script.host.close()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- ã‚¿ãƒ–2: ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ -->
  <div class="tab-content" id="files-tab">
    <div class="stats-summary" id="statsSummary">
      <div class="stat-card">
        <div class="stat-value" id="totalFilesCount">0</div>
        <div class="stat-label">ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalSizeCount">0 MB</div>
        <div class="stat-label">åˆè¨ˆã‚µã‚¤ã‚º</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="phaseCount">0</div>
        <div class="stat-label">æ¤œå‡ºPhaseæ•°</div>
      </div>
    </div>

    <div class="file-list" id="fileList">
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“­</div>
        <p>ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
      </div>
    </div>
  </div>

  <!-- ã‚¿ãƒ–3: ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
  <div class="tab-content" id="options-tab">
    <h4>ğŸ“Š ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯¾è±¡Phaseé¸æŠ</h4>
    <div class="phase-selector" id="phaseSelector">
      <label class="phase-checkbox">
        <input type="checkbox" value="Phase1" checked> Phase 1ï¼ˆåŸºç¤é›†è¨ˆï¼‰
      </label>
      <label class="phase-checkbox">
        <input type="checkbox" value="Phase2" checked> Phase 2ï¼ˆçµ±è¨ˆåˆ†æï¼‰
      </label>
      <label class="phase-checkbox">
        <input type="checkbox" value="Phase3" checked> Phase 3ï¼ˆãƒšãƒ«ã‚½ãƒŠåˆ†æï¼‰
      </label>
      <label class="phase-checkbox">
        <input type="checkbox" value="Phase6" checked> Phase 6ï¼ˆãƒ•ãƒ­ãƒ¼åˆ†æï¼‰
      </label>
      <label class="phase-checkbox">
        <input type="checkbox" value="Phase7" checked> Phase 7ï¼ˆé«˜åº¦åˆ†æï¼‰
      </label>
      <label class="phase-checkbox">
        <input type="checkbox" value="Phase8" checked> Phase 8ï¼ˆã‚­ãƒ£ãƒªã‚¢ãƒ»å­¦æ­´åˆ†æï¼‰
      </label>
      <label class="phase-checkbox">
        <input type="checkbox" value="Phase10" checked> Phase 10ï¼ˆè»¢è·æ„æ¬²ãƒ»ç·Šæ€¥åº¦åˆ†æï¼‰
      </label>
    </div>

    <div style="text-align:center;margin-top:20px;">
      <button class="button" onclick="selectAllPhases()">âœ… å…¨ã¦é¸æŠ</button>
      <button class="button secondary" onclick="deselectAllPhases()">âŒ å…¨ã¦è§£é™¤</button>
    </div>
  </div>

  <div class="progress-container" id="progressContainer">
    <div class="progress-bar" id="progressBar">0%</div>
  </div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
var selectedFiles = [];
var phaseFileMap = {};

// Phaseåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«åãƒãƒƒãƒ”ãƒ³ã‚°
const PHASE_FILE_MAP = {
  'Phase1': [
    'Phase1_MapMetrics.csv', 'MapMetrics.csv',
    'Phase1_Applicants.csv', 'Applicants.csv',
    'Phase1_DesiredWork.csv', 'DesiredWork.csv',
    'Phase1_AggDesired.csv', 'AggDesired.csv',
    'P1_QualityReport.csv', 'QualityReport.csv',
    'P1_QualityReport_Descriptive.csv', 'QualityReport_Descriptive.csv', 'P1_QualityDesc.csv'
  ],
  'Phase2': [
    'Phase2_ChiSquare.csv', 'ChiSquareTests.csv',
    'Phase2_ANOVA.csv', 'ANOVATests.csv',
    'P2_QualityReport_Inferential.csv', 'QualityReport_Inferential.csv'
  ],
  'Phase3': [
    'Phase3_PersonaSummary.csv', 'PersonaSummary.csv',
    'Phase3_PersonaDetails.csv', 'PersonaDetails.csv',
    'Phase3_PersonaByMunicipality.csv', 'PersonaSummaryByMunicipality.csv',
    'P3_QualityReport_Inferential.csv', 'QualityReport_Inferential.csv'
  ],
  'Phase6': [
    'Phase6_FlowEdges.csv', 'MunicipalityFlowEdges.csv',
    'Phase6_FlowNodes.csv', 'MunicipalityFlowNodes.csv',
    'Phase6_Proximity.csv', 'ProximityAnalysis.csv',
    'P6_QualityReport_Inferential.csv', 'QualityReport_Inferential.csv'
  ],
  'Phase7': [
    'Phase7_SupplyDensity.csv', 'SupplyDensityMap.csv',
    'Phase7_QualificationDist.csv', 'QualificationDistribution.csv',
    'Phase7_AgeGenderCross.csv', 'AgeGenderCrossAnalysis.csv',
    'Phase7_MobilityScore.csv', 'MobilityScore.csv',
    'Phase7_PersonaProfile.csv', 'DetailedPersonaProfile.csv',
    'Phase7_PersonaMapData.csv', 'PersonaMapData.csv',
    'Phase7_PersonaMobilityCross.csv', 'PersonaMobilityCross.csv',
    'P7_QualityReport_Inferential.csv', 'QualityReport_Inferential.csv'
  ],
  'Phase8': [
    'Phase8_EducationDist.csv', 'EducationDistribution.csv',
    'Phase8_EduAgeCross.csv', 'EducationAgeCross.csv',
    'Phase8_EduAgeMatrix.csv', 'EducationAgeCross_Matrix.csv',
    'Phase8_GradYearDist.csv', 'GraduationYearDistribution.csv',
    'Phase8_CareerDistribution.csv', 'CareerDistribution.csv',
    'Phase8_CareerAgeCross.csv', 'CareerAgeCross.csv',
    'Phase8_CareerAgeMatrix.csv', 'CareerAgeCross_Matrix.csv',
    'P8_QualityReport.csv', 'QualityReport.csv',
    'P8_QualityReport_Inferential.csv', 'QualityReport_Inferential.csv'
  ],
  'Phase10': [
    'Phase10_UrgencyDist.csv', 'UrgencyDistribution.csv',
    'Phase10_UrgencyAge.csv', 'UrgencyAgeCross.csv',
    'Phase10_UrgencyAge_Matrix.csv', 'UrgencyAgeCross_Matrix.csv',
    'Phase10_UrgencyEmployment.csv', 'UrgencyEmploymentCross.csv',
    'Phase10_UrgencyEmployment_Matrix.csv', 'UrgencyEmploymentCross_Matrix.csv',
    'Phase10_UrgencyByMunicipality.csv', 'UrgencyByMunicipality.csv',
    'Phase10_UrgencyAge_ByMunicipality.csv', 'UrgencyAgeCross_ByMunicipality.csv',
    'Phase10_UrgencyEmployment_ByMunicipality.csv', 'UrgencyEmploymentCross_ByMunicipality.csv',
    'P10_QualityReport.csv', 'QualityReport.csv',
    'P10_QualityReport_Inferential.csv', 'QualityReport_Inferential.csv'
  ]
};


// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.getElementById('uploadArea').addEventListener('click', function() {
  document.getElementById('fileInput').click();
});

document.getElementById('uploadArea').addEventListener('dragover', function(e) {
  e.preventDefault();
  e.stopPropagation();
  this.classList.add('dragover');
});

document.getElementById('uploadArea').addEventListener('dragleave', function(e) {
  e.preventDefault();
  e.stopPropagation();
  this.classList.remove('dragover');
});

document.getElementById('uploadArea').addEventListener('drop', function(e) {
  e.preventDefault();
  e.stopPropagation();
  this.classList.remove('dragover');

  if (e.dataTransfer.files.length > 0) {
    handleFiles(e.dataTransfer.files);
  }
});

document.getElementById('fileInput').addEventListener('change', function(e) {
  if (e.target.files.length > 0) {
    handleFiles(e.target.files);
  }
});

// è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
function handleFiles(files) {
  const newFiles = Array.from(files).filter(file => file.name.endsWith('.csv'));

  if (newFiles.length === 0) {
    showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    return;
  }

  // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒãƒ¼ã‚¸ï¼ˆé‡è¤‡æ’é™¤ï¼‰
  newFiles.forEach(file => {
    const exists = selectedFiles.some(f => f.name === file.name);
    if (!exists) {
      selectedFiles.push(file);
    }
  });

  // Phaseåˆ¥ã«åˆ†é¡
  categorizeFiles();

  // UIã‚’æ›´æ–°
  updateFileList();
  updateStats();

  // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
  document.getElementById('uploadAllButton').disabled = false;
  document.getElementById('uploadByPhaseButton').disabled = false;

  showStatus(`${selectedFiles.length}å€‹ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');

  // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
  switchTab('files');
}

// Phaseåˆ¤åˆ¥
function detectPhase(filename) {
  for (const [phase, files] of Object.entries(PHASE_FILE_MAP)) {
    if (files.includes(filename)) {
      return phase;
    }
  }
  return 'Unknown';
}

// Phaseåˆ¥ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†é¡
function categorizeFiles() {
  phaseFileMap = {};

  selectedFiles.forEach(file => {
    const phase = detectPhase(file.name);
    if (!phaseFileMap[phase]) {
      phaseFileMap[phase] = [];
    }
    phaseFileMap[phase].push(file);
  });
}

// ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆè¡¨ç¤º
function updateFileList() {
  const fileListDiv = document.getElementById('fileList');

  if (selectedFiles.length === 0) {
    fileListDiv.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“­</div>
        <p>ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
      </div>
    `;
    return;
  }

  let html = '';

  // Phaseé †ã§ã‚½ãƒ¼ãƒˆ
  const sortedPhases = Object.keys(phaseFileMap).sort();

  sortedPhases.forEach(phase => {
    const files = phaseFileMap[phase];
    const phaseLabel = phase === 'Unknown' ? 'ä¸æ˜ãªPhase' : phase;
    const phaseBadgeColor = phase === 'Unknown' ? '#dc3545' : '#4285f4';

    html += `
      <div class="phase-group">
        <div class="phase-header">
          <h4>${phaseLabel}</h4>
          <span class="phase-badge" style="background:${phaseBadgeColor}">${files.length}ãƒ•ã‚¡ã‚¤ãƒ«</span>
        </div>
    `;

    files.forEach((file, index) => {
      const sizeKB = (file.size / 1024).toFixed(2);
      html += `
        <div class="file-item">
          <span class="file-name">ğŸ“„ ${file.name}</span>
          <span class="file-size">${sizeKB} KB</span>
          <span class="file-remove" onclick="removeFile('${phase}', ${index})">ğŸ—‘ï¸</span>
        </div>
      `;
    });

    html += '</div>';
  });

  fileListDiv.innerHTML = html;
}

// çµ±è¨ˆæƒ…å ±æ›´æ–°
function updateStats() {
  document.getElementById('totalFilesCount').textContent = selectedFiles.length;

  const totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
  document.getElementById('totalSizeCount').textContent = (totalSize / 1024 / 1024).toFixed(2) + ' MB';

  const phaseKeys = Object.keys(phaseFileMap).filter(p => p !== 'Unknown');
  document.getElementById('phaseCount').textContent = phaseKeys.length;
}

// ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
function removeFile(phase, index) {
  const file = phaseFileMap[phase][index];
  selectedFiles = selectedFiles.filter(f => f.name !== file.name);

  categorizeFiles();
  updateFileList();
  updateStats();

  if (selectedFiles.length === 0) {
    document.getElementById('uploadAllButton').disabled = true;
    document.getElementById('uploadByPhaseButton').disabled = true;
  }

  showStatus(`${file.name}ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'info');
}

// å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
function uploadAll() {
  if (selectedFiles.length === 0) {
    showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
    return;
  }

  showStatus('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æº–å‚™ä¸­...', 'info');
  showProgress(0);

  // FileReaderã§å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
  const promises = selectedFiles.map(file => readFileAsText(file));

  Promise.all(promises)
    .then(results => {
      const fileDataMap = {};

      results.forEach((content, index) => {
        const file = selectedFiles[index];
        const phase = detectPhase(file.name);

        if (!fileDataMap[phase]) {
          fileDataMap[phase] = {};
        }

        fileDataMap[phase][file.name] = {
          content: content,
          size: file.size
        };
      });

      showProgress(50);

      // GASã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
      google.script.run
        .withSuccessHandler(onUploadSuccess)
        .withFailureHandler(onUploadFailure)
        .importMultiplePhaseCSVs(fileDataMap);

      showProgress(100);
    })
    .catch(error => {
      showStatus('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    });
}

// Phaseåˆ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
function uploadByPhase() {
  if (selectedFiles.length === 0) {
    showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
    return;
  }

  // é¸æŠã•ã‚ŒãŸPhaseã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  const selectedPhases = getSelectedPhases();

  if (selectedPhases.length === 0) {
    showStatus('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯¾è±¡ã®Phaseã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
    switchTab('options');
    return;
  }

  showStatus(`${selectedPhases.length}å€‹ã®Phaseã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...`, 'info');
  showProgress(0);

  // é¸æŠã•ã‚ŒãŸPhaseã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿èª­ã¿è¾¼ã¿
  const filesToUpload = selectedFiles.filter(file => {
    const phase = detectPhase(file.name);
    return selectedPhases.includes(phase);
  });

  if (filesToUpload.length === 0) {
    showStatus('é¸æŠã•ã‚ŒãŸPhaseã«è©²å½“ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
    return;
  }

  const promises = filesToUpload.map(file => readFileAsText(file));

  Promise.all(promises)
    .then(results => {
      const fileDataMap = {};

      results.forEach((content, index) => {
        const file = filesToUpload[index];
        const phase = detectPhase(file.name);

        if (!fileDataMap[phase]) {
          fileDataMap[phase] = {};
        }

        fileDataMap[phase][file.name] = {
          content: content,
          size: file.size
        };
      });

      showProgress(50);

      // GASã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
      google.script.run
        .withSuccessHandler(onUploadSuccess)
        .withFailureHandler(onUploadFailure)
        .importMultiplePhaseCSVs(fileDataMap);

      showProgress(100);
    })
    .catch(error => {
      showStatus('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    });
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã¿
function readFileAsText(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      resolve(e.target.result);
    };
    reader.onerror = function(e) {
      reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—: ' + file.name));
    };
    reader.readAsText(file, 'UTF-8');
  });
}

// ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ
function onUploadSuccess(result) {
  showProgress(0);
  showStatus(`âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼${result.totalFiles}ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`, 'success');

  setTimeout(function() {
    google.script.host.close();
  }, 2000);
}

// ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—
function onUploadFailure(error) {
  showProgress(0);
  showStatus('âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
}

// é¸æŠã•ã‚ŒãŸPhaseã‚’å–å¾—
function getSelectedPhases() {
  const checkboxes = document.querySelectorAll('#phaseSelector input[type="checkbox"]:checked');
  return Array.from(checkboxes).map(cb => cb.value);
}

// Phaseå…¨é¸æŠ
function selectAllPhases() {
  document.querySelectorAll('#phaseSelector input[type="checkbox"]').forEach(cb => {
    cb.checked = true;
  });
  showStatus('å…¨Phaseã‚’é¸æŠã—ã¾ã—ãŸ', 'info');
}

// Phaseå…¨è§£é™¤
function deselectAllPhases() {
  document.querySelectorAll('#phaseSelector input[type="checkbox"]').forEach(cb => {
    cb.checked = false;
  });
  showStatus('å…¨Phaseã®é¸æŠã‚’è§£é™¤ã—ã¾ã—ãŸ', 'info');
}

// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function switchTab(tabName) {
  // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‹ã‚‰ active ã‚’å‰Šé™¤
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });

  // tabNameã«å¯¾å¿œã™ã‚‹ã‚¿ãƒ–ã‚’ active ã«ã™ã‚‹
  const tabs = document.querySelectorAll('.tab');
  const tabNames = ['upload', 'files', 'options'];
  const index = tabNames.indexOf(tabName);
  if (index >= 0 && index < tabs.length) {
    tabs[index].classList.add('active');
  }

  document.getElementById(tabName + '-tab').classList.add('active');
}

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
function showStatus(message, type) {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = 'status ' + type;
  status.style.display = 'block';

  setTimeout(function() {
    status.style.display = 'none';
  }, 5000);
}

// ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤º
function showProgress(percent) {
  const container = document.getElementById('progressContainer');
  const bar = document.getElementById('progressBar');

  if (percent > 0) {
    container.style.display = 'block';
    bar.style.width = percent + '%';
    bar.textContent = Math.round(percent) + '%';
  } else {
    container.style.display = 'none';
  }
}

// ã‚¯ãƒªã‚¢
function clearAll() {
  selectedFiles = [];
  phaseFileMap = {};

  updateFileList();
  updateStats();

  document.getElementById('uploadAllButton').disabled = true;
  document.getElementById('uploadByPhaseButton').disabled = true;
  document.getElementById('status').style.display = 'none';
  document.getElementById('progressContainer').style.display = 'none';

  switchTab('upload');
  showStatus('ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
}
</script>
</body>
</html>
