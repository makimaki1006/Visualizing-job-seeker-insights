<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>å¸Œæœ›å‹¤å‹™åœ°ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=visualization"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
    }
    .container {
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 350px;
      background: white;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    .map-container {
      flex: 1;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    h2 {
      color: #667eea;
      font-size: 20px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .stats-label {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 5px;
    }
    .stats-value {
      font-size: 28px;
      font-weight: bold;
    }
    .controls {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .control-label {
      font-size: 13px;
      font-weight: bold;
      color: #666;
      margin-bottom: 10px;
      display: block;
    }
    .slider-container {
      margin-bottom: 15px;
    }
    .slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #ddd;
      outline: none;
      -webkit-appearance: none;
    }
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
    }
    .slider-value {
      font-size: 12px;
      color: #667eea;
      font-weight: bold;
      margin-top: 5px;
    }
    .top10-list {
      list-style: none;
      margin-top: 10px;
    }
    .top10-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      margin-bottom: 5px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 13px;
    }
    .top10-rank {
      font-weight: bold;
      color: #667eea;
      margin-right: 10px;
    }
    .top10-prefecture {
      flex: 1;
    }
    .top10-count {
      font-weight: bold;
      color: #333;
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      font-size: 18px;
      color: #667eea;
    }
    .error {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      padding: 30px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 400px;
    }
    .error-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    .error-message {
      color: #721c24;
      font-size: 14px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h2>ğŸ“Š çµ±è¨ˆæƒ…å ±</h2>

      <div class="stats-card">
        <div class="stats-label">ç·æ±‚è·è€…æ•°</div>
        <div class="stats-value" id="totalCount">-</div>
      </div>

      <div class="stats-card">
        <div class="stats-label">å¹³å‡å¹´é½¢</div>
        <div class="stats-value" id="avgAge">-</div>
      </div>

      <h2>âš™ï¸ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—è¨­å®š</h2>
      <div class="controls">
        <div class="slider-container">
          <label class="control-label">å¼·åº¦ï¼ˆIntensityï¼‰</label>
          <input type="range" min="1" max="100" value="50" class="slider" id="intensitySlider">
          <div class="slider-value" id="intensityValue">50</div>
        </div>

        <div class="slider-container">
          <label class="control-label">åŠå¾„ï¼ˆRadiusï¼‰</label>
          <input type="range" min="10" max="50" value="25" class="slider" id="radiusSlider">
          <div class="slider-value" id="radiusValue">25 px</div>
        </div>
      </div>

      <h2>ğŸ“ å¸Œæœ›å‹¤å‹™åœ° TOP10</h2>
      <ul class="top10-list" id="top10List"></ul>
    </div>

    <div class="map-container">
      <div class="loading" id="loading">
        ğŸ”„ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
      </div>
      <div id="map"></div>
    </div>
  </div>

  <script>
    let map;
    let heatmap;
    let heatmapData = [];

    // Google Chartsèª­ã¿è¾¼ã¿
    google.charts.load('current', {'packages':['corechart']});

    // åˆæœŸåŒ–
    function init() {
      // æ—¥æœ¬ä¸­å¿ƒã®åœ°å›³ã‚’åˆæœŸåŒ–
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 36.5, lng: 138.0 },
        zoom: 6,
        mapTypeId: 'roadmap'
      });

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      loadData();

      // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
      setupControls();
    }

    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¨­å®š
    function setupControls() {
      const intensitySlider = document.getElementById('intensitySlider');
      const radiusSlider = document.getElementById('radiusSlider');

      intensitySlider.addEventListener('input', (e) => {
        document.getElementById('intensityValue').textContent = e.target.value;
        updateHeatmap();
      });

      radiusSlider.addEventListener('input', (e) => {
        document.getElementById('radiusValue').textContent = e.target.value + ' px';
        updateHeatmap();
      });
    }

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadData() {
      document.getElementById('loading').style.display = 'block';

      Promise.all([
        callGAS('getMapMetricsData'),
        callGAS('getApplicantsStats'),
        callGAS('getDesiredWorkTop10')
      ]).then(([mapData, stats, top10]) => {
        document.getElementById('loading').style.display = 'none';

        // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
        displayStats(stats);

        // TOP10è¡¨ç¤º
        displayTop10(top10);

        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿æº–å‚™
        prepareHeatmapData(mapData);

        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—è¡¨ç¤º
        displayHeatmap();

      }).catch(error => {
        document.getElementById('loading').innerHTML = `
          <div class="error">
            <div class="error-icon">âš ï¸</div>
            <div class="error-message">
              <strong>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</strong><br><br>
              ${error.message}
            </div>
          </div>
        `;
      });
    }

    // GASé–¢æ•°å‘¼ã³å‡ºã—ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function callGAS(functionName) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          [functionName]();
      });
    }

    // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
    function displayStats(stats) {
      document.getElementById('totalCount').textContent = stats.total.toLocaleString();
      document.getElementById('avgAge').textContent = stats.avgAge + 'æ­³';
    }

    // TOP10è¡¨ç¤º
    function displayTop10(top10) {
      const listEl = document.getElementById('top10List');
      listEl.innerHTML = '';

      top10.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'top10-item';
        li.innerHTML = `
          <span class="top10-rank">${index + 1}</span>
          <span class="top10-prefecture">${item.prefecture}</span>
          <span class="top10-count">${item.count.toLocaleString()}äºº</span>
        `;
        listEl.appendChild(li);
      });
    }

    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿æº–å‚™
    function prepareHeatmapData(data) {
      heatmapData = data.map(item => ({
        location: new google.maps.LatLng(item.lat, item.lng),
        weight: item.count
      }));
    }

    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—è¡¨ç¤º
    function displayHeatmap() {
      if (heatmap) {
        heatmap.setMap(null);
      }

      heatmap = new google.maps.visualization.HeatmapLayer({
        data: heatmapData,
        map: map
      });

      updateHeatmap();
    }

    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—æ›´æ–°
    function updateHeatmap() {
      if (!heatmap) return;

      const intensity = parseInt(document.getElementById('intensitySlider').value) / 100;
      const radius = parseInt(document.getElementById('radiusSlider').value);

      heatmap.setOptions({
        radius: radius,
        opacity: intensity,
        gradient: [
          'rgba(0, 255, 255, 0)',
          'rgba(0, 255, 255, 1)',
          'rgba(0, 191, 255, 1)',
          'rgba(0, 127, 255, 1)',
          'rgba(0, 63, 255, 1)',
          'rgba(0, 0, 255, 1)',
          'rgba(0, 0, 223, 1)',
          'rgba(0, 0, 191, 1)',
          'rgba(0, 0, 159, 1)',
          'rgba(0, 0, 127, 1)',
          'rgba(63, 0, 91, 1)',
          'rgba(127, 0, 63, 1)',
          'rgba(191, 0, 31, 1)',
          'rgba(255, 0, 0, 1)'
        ]
      });
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    window.onload = init;
  </script>
</body>
</html>
