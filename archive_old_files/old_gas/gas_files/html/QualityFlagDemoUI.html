<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>å“è³ªãƒ•ãƒ©ã‚°å¯è¦–åŒ–ãƒ‡ãƒ¢</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      color: #1a73e8;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }

    h2 {
      color: #333;
      margin-top: 30px;
      border-left: 4px solid #1a73e8;
      padding-left: 10px;
    }

    .section {
      margin: 20px 0;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 5px;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 15px 0;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .color-box {
      width: 20px;
      height: 20px;
      border: 1px solid #ccc;
      display: inline-block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }

    table th {
      background-color: #1a73e8;
      color: white;
      padding: 10px;
      text-align: left;
    }

    table td {
      padding: 8px;
      border: 1px solid #ddd;
    }

    table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .quality-sufficient {
      background-color: #ccffcc;
    }

    .quality-marginal {
      background-color: #ffffcc;
    }

    .quality-insufficient {
      background-color: #ffcccc;
    }

    .warning-icon {
      font-size: 18px;
    }

    .summary-box {
      background-color: #e8f0fe;
      padding: 15px;
      border-left: 4px solid #1a73e8;
      margin: 15px 0;
    }

    .summary-box h4 {
      margin-top: 0;
      color: #1a73e8;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 10px 0;
    }

    .stat-item {
      background-color: white;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #1a73e8;
    }

    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }

    button:hover {
      background-color: #1557b0;
    }

    .dropdown {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>å“è³ªãƒ•ãƒ©ã‚°å¯è¦–åŒ–ãƒ‡ãƒ¢</h1>
    <p>ã‚ªãƒ—ã‚·ãƒ§ãƒ³C: å®Œå…¨çµ±åˆ - ãƒ‡ãƒ¼ã‚¿å“è³ªãƒ•ãƒ©ã‚°ã®å¯è¦–åŒ–æ©Ÿèƒ½ã®ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</p>

    <!-- Section 1: ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºåŒºåˆ†ã®è‰²åˆ†ã‘ -->
    <h2>1. ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºåŒºåˆ†ã«ã‚ˆã‚‹è‰²åˆ†ã‘ï¼ˆAggDesired.csvï¼‰</h2>
    <div class="section">
      <h3>è‰²åˆ†ã‘å‡¡ä¾‹</h3>
      <div class="legend">
        <div class="legend-item">
          <span class="color-box" style="background-color: #00cc00;"></span>
          <span>LARGEï¼ˆ100ä»¶ä»¥ä¸Šï¼‰</span>
        </div>
        <div class="legend-item">
          <span class="color-box" style="background-color: #ffcc00;"></span>
          <span>MEDIUMï¼ˆ30-99ä»¶ï¼‰</span>
        </div>
        <div class="legend-item">
          <span class="color-box" style="background-color: #ff9900;"></span>
          <span>SMALLï¼ˆ10-29ä»¶ï¼‰</span>
        </div>
        <div class="legend-item">
          <span class="color-box" style="background-color: #ff0000;"></span>
          <span>VERY_SMALLï¼ˆ1-9ä»¶ï¼‰</span>
        </div>
      </div>

      <h3>ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿</h3>
      <table>
        <thead>
          <tr>
            <th>å¸‚åŒºç”ºæ‘</th>
            <th>ä»¶æ•°</th>
            <th>ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºåŒºåˆ†</th>
            <th>è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
          </tr>
        </thead>
        <tbody>
          <tr style="background-color: #ccffcc;">
            <td>äº¬éƒ½å¸‚ä¼è¦‹åŒº</td>
            <td>1,748</td>
            <td>LARGE</td>
            <td>ãªã—ï¼ˆè¦³å¯Ÿçš„è¨˜è¿°ï¼‰</td>
          </tr>
          <tr style="background-color: #ffffcc;">
            <td>äº€å²¡å¸‚</td>
            <td>50</td>
            <td>MEDIUM</td>
            <td>ãªã—ï¼ˆè¦³å¯Ÿçš„è¨˜è¿°ï¼‰</td>
          </tr>
          <tr style="background-color: #ffeecc;">
            <td>â—‹â—‹ç”º</td>
            <td>15</td>
            <td>SMALL</td>
            <td>ãªã—ï¼ˆè¦³å¯Ÿçš„è¨˜è¿°ï¼‰</td>
          </tr>
          <tr style="background-color: #ffcccc;">
            <td>â—‹â—‹æ‘</td>
            <td>1</td>
            <td>VERY_SMALL</td>
            <td>ãªã—ï¼ˆè¦³å¯Ÿçš„è¨˜è¿°ï¼‰</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Section 2: ã‚¯ãƒ­ã‚¹é›†è¨ˆã‚»ãƒ«å“è³ªã®è‰²åˆ†ã‘ -->
    <h2>2. ã‚¯ãƒ­ã‚¹é›†è¨ˆã‚»ãƒ«å“è³ªã«ã‚ˆã‚‹è‰²åˆ†ã‘</h2>
    <div class="section">
      <h3>è‰²åˆ†ã‘å‡¡ä¾‹</h3>
      <div class="legend">
        <div class="legend-item">
          <span class="color-box" style="background-color: #ccffcc;"></span>
          <span>SUFFICIENTï¼ˆ30ä»¶ä»¥ä¸Šï¼‰</span>
        </div>
        <div class="legend-item">
          <span class="color-box" style="background-color: #ffffcc;"></span>
          <span>MARGINALï¼ˆ5-29ä»¶ï¼‰âš ï¸</span>
        </div>
        <div class="legend-item">
          <span class="color-box" style="background-color: #ffcccc;"></span>
          <span>INSUFFICIENTï¼ˆ0-4ä»¶ï¼‰ğŸš«</span>
        </div>
      </div>

      <h3>ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆå­¦æ­´ Ã— å¹´é½¢å±¤ï¼‰</h3>
      <table>
        <thead>
          <tr>
            <th>å­¦æ­´</th>
            <th>å¹´é½¢å±¤</th>
            <th>ä»¶æ•°</th>
            <th>å“è³ª</th>
            <th>è­¦å‘Š</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>é«˜æ ¡</td>
            <td>20ä»£</td>
            <td class="quality-sufficient">45</td>
            <td>SUFFICIENT</td>
            <td>ãªã—</td>
          </tr>
          <tr>
            <td>é«˜æ ¡</td>
            <td>30ä»£</td>
            <td class="quality-marginal">12 <span class="warning-icon">âš ï¸</span></td>
            <td>MARGINAL</td>
            <td>ã‚»ãƒ«æ•°ä¸è¶³ï¼ˆn=12 < 30ï¼‰</td>
          </tr>
          <tr>
            <td>å°‚é–€</td>
            <td>40ä»£</td>
            <td class="quality-insufficient">3 <span class="warning-icon">ğŸš«</span></td>
            <td>INSUFFICIENT</td>
            <td>ã‚»ãƒ«æ•°ä¸è¶³ï¼ˆn=3 < 5ï¼‰</td>
          </tr>
          <tr>
            <td>å¤§å­¦</td>
            <td>20ä»£</td>
            <td class="quality-sufficient">73</td>
            <td>SUFFICIENT</td>
            <td>ãªã—</td>
          </tr>
          <tr>
            <td>å¤§å­¦é™¢</td>
            <td>20ä»£</td>
            <td class="quality-insufficient">2 <span class="warning-icon">ğŸš«</span></td>
            <td>INSUFFICIENT</td>
            <td>ã‚»ãƒ«æ•°ä¸è¶³ï¼ˆn=2 < 5ï¼‰</td>
          </tr>
          <tr>
            <td>å¤§å­¦é™¢</td>
            <td>30ä»£</td>
            <td class="quality-marginal">5 <span class="warning-icon">âš ï¸</span></td>
            <td>MARGINAL</td>
            <td>ã‚»ãƒ«æ•°ä¸è¶³ï¼ˆn=5 < 30ï¼‰</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Section 3: å“è³ªçµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
    <h2>3. å“è³ªçµ±è¨ˆã‚µãƒãƒªãƒ¼</h2>
    <div class="section">
      <div class="summary-box">
        <h4>AggDesired.csv å“è³ªã‚µãƒãƒªãƒ¼</h4>
        <div class="summary-stats">
          <div class="stat-item">
            <div class="stat-label">ç·ä»¶æ•°</div>
            <div class="stat-value">898</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">å¹³å‡ã‚«ã‚¦ãƒ³ãƒˆ</div>
            <div class="stat-value">27</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">LARGE</div>
            <div class="stat-value" style="color: #00cc00;">245</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">MEDIUM</div>
            <div class="stat-value" style="color: #ffcc00;">123</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">SMALL</div>
            <div class="stat-value" style="color: #ff9900;">298</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">VERY_SMALL</div>
            <div class="stat-value" style="color: #ff0000;">232</div>
          </div>
        </div>
      </div>

      <div class="summary-box">
        <h4>ã‚¯ãƒ­ã‚¹é›†è¨ˆ å“è³ªã‚µãƒãƒªãƒ¼</h4>
        <div class="summary-stats">
          <div class="stat-item">
            <div class="stat-label">ç·ã‚»ãƒ«æ•°</div>
            <div class="stat-value">35</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">å¹³å‡ã‚«ã‚¦ãƒ³ãƒˆ</div>
            <div class="stat-value">214</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">SUFFICIENT</div>
            <div class="stat-value" style="color: #00cc00;">24</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">MARGINAL</div>
            <div class="stat-value" style="color: #ffcc00;">6</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">INSUFFICIENT</div>
            <div class="stat-value" style="color: #ff0000;">5</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">è­¦å‘Šã‚ã‚Š</div>
            <div class="stat-value" style="color: #ff9900;">11</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 4: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ‡ãƒ¢ï¼ˆä»®ï¼‰ -->
    <h2>4. ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠãƒ‡ãƒ¢ï¼ˆä»®ï¼‰</h2>
    <div class="section">
      <h3>å¸‚åŒºç”ºæ‘é¸æŠï¼ˆå“è³ªãƒ•ãƒ©ã‚°ä»˜ãï¼‰</h3>
      <select class="dropdown" id="municipalityDropdown">
        <option value="">å¸‚åŒºç”ºæ‘ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="kyoto_fushimi" style="background-color: #ccffcc;">äº¬éƒ½å¸‚ä¼è¦‹åŒºï¼ˆ1,748ä»¶ï¼‰</option>
        <option value="kameoka" style="background-color: #ffffcc;">äº€å²¡å¸‚ï¼ˆ50ä»¶ï¼‰</option>
        <option value="town" style="background-color: #ffeecc;">â—‹â—‹ç”ºï¼ˆ15ä»¶ï¼‰</option>
        <option value="village" style="background-color: #ffcccc;">â—‹â—‹æ‘ï¼ˆ1ä»¶ï¼‰</option>
      </select>

      <div id="selectionInfo" style="margin-top: 10px; padding: 10px; background-color: #f0f0f0; display: none;">
        <p><strong>é¸æŠã•ã‚ŒãŸåœ°åŸŸ:</strong> <span id="selectedName"></span></p>
        <p><strong>ä»¶æ•°:</strong> <span id="selectedCount"></span></p>
        <p><strong>å“è³ª:</strong> <span id="selectedQuality"></span></p>
      </div>
    </div>

    <!-- Section 5: GASçµ±åˆã‚¬ã‚¤ãƒ‰ -->
    <h2>5. GASçµ±åˆã‚¬ã‚¤ãƒ‰</h2>
    <div class="section">
      <h3>å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½</h3>
      <ul>
        <li>âœ… ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºåŒºåˆ†ã«ã‚ˆã‚‹è‰²åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ<code>getMarkerColor()</code>ï¼‰</li>
        <li>âœ… ã‚»ãƒ«å“è³ªã«ã‚ˆã‚‹è‰²åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ<code>getCellBackgroundColor()</code>ï¼‰</li>
        <li>âœ… ãƒãƒ¼ã‚«ãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆ<code>createMarkersWithQualityFlags()</code>ï¼‰</li>
        <li>âœ… ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆï¼ˆ<code>createDropdownOptionsWithQualityFlags()</code>ï¼‰</li>
        <li>âœ… ã‚¯ãƒ­ã‚¹é›†è¨ˆHTMLãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆï¼ˆ<code>renderCrossTabTableWithQualityFlags()</code>ï¼‰</li>
        <li>âœ… å“è³ªçµ±è¨ˆã‚µãƒãƒªãƒ¼ç”Ÿæˆï¼ˆ<code>generateQualitySummary()</code>ï¼‰</li>
      </ul>

      <h3>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h3>
      <ol>
        <li>æ—¢å­˜ã®åœ°å›³è¡¨ç¤ºæ©Ÿèƒ½ã«<code>QualityFlagVisualization.gs</code>ã‚’çµ±åˆ</li>
        <li>AggDesired.csvã‚’èª­ã¿è¾¼ã¿æ™‚ã«å“è³ªãƒ•ãƒ©ã‚°ã‚’è‡ªå‹•é©ç”¨</li>
        <li>ã‚¯ãƒ­ã‚¹é›†è¨ˆè¡¨ç¤ºæ©Ÿèƒ½ã«å“è³ªãƒ•ãƒ©ã‚°HTMLãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµ±åˆ</li>
        <li>GAS E2Eãƒ†ã‚¹ãƒˆã§å‹•ä½œç¢ºèª</li>
      </ol>

      <h3>ä½¿ç”¨æ–¹æ³•</h3>
      <pre style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto;">
// 1. AggDesired.csvãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‰²ä»˜ããƒãƒ¼ã‚«ãƒ¼ã‚’ç”Ÿæˆ
const aggDesiredData = loadAggDesiredData();  // æ—¢å­˜ã®èª­ã¿è¾¼ã¿é–¢æ•°
const markers = createMarkersWithQualityFlags(aggDesiredData);

// 2. Google Mapsã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
markers.forEach(function(marker) {
  const mapMarker = new google.maps.Marker({
    position: { lat: marker.lat, lng: marker.lng },
    map: map,
    title: marker.title,
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      fillColor: marker.color,  // å“è³ªãƒ•ãƒ©ã‚°ã«ã‚ˆã‚‹è‰²
      fillOpacity: 0.7,
      strokeWeight: 1,
      scale: 8
    }
  });
});

// 3. ã‚¯ãƒ­ã‚¹é›†è¨ˆã‚’HTMLãƒ†ãƒ¼ãƒ–ãƒ«ã§è¡¨ç¤º
const crossTabData = loadCrossTabData();  // æ—¢å­˜ã®èª­ã¿è¾¼ã¿é–¢æ•°
const tableHTML = renderCrossTabTableWithQualityFlags(
  crossTabData,
  'education_level',
  'å¹´é½¢å±¤'
);
document.getElementById('crosstab-container').innerHTML = tableHTML;
      </pre>
    </div>

    <div style="text-align: center; margin-top: 30px;">
      <button onclick="google.script.host.close()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <script>
    // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('municipalityDropdown').addEventListener('change', function() {
      const selectedValue = this.value;
      const selectedText = this.options[this.selectedIndex].text;

      if (selectedValue) {
        document.getElementById('selectionInfo').style.display = 'block';
        document.getElementById('selectedName').textContent = selectedText.split('ï¼ˆ')[0];
        document.getElementById('selectedCount').textContent = selectedText.match(/\d+/)[0];

        // å“è³ªåˆ¤å®š
        const count = parseInt(selectedText.match(/\d+/)[0]);
        let quality = '';
        if (count >= 100) {
          quality = 'LARGEï¼ˆçµ±è¨ˆçš„æ¨è«–ã«ååˆ†ï¼‰';
        } else if (count >= 30) {
          quality = 'MEDIUMï¼ˆå‚¾å‘åˆ†æå¯èƒ½ï¼‰';
        } else if (count >= 10) {
          quality = 'SMALLï¼ˆå‚è€ƒãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰';
        } else {
          quality = 'VERY_SMALLï¼ˆæ¨è«–ã«ã¯ä½¿ç”¨ä¸å¯ï¼‰';
        }
        document.getElementById('selectedQuality').textContent = quality;
      } else {
        document.getElementById('selectionInfo').style.display = 'none';
      }
    });
  </script>
</body>
</html>
