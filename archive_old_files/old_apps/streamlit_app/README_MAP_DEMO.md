# Streamlit地図表示デモ版

**作成日**: 2025年11月12日
**目的**: Foliumによる地図表示機能のイメージを掴む

---

## 実行方法

### 1. 依存関係インストール

```bash
cd "C:\Users\fuji1\OneDrive\Pythonスクリプト保管\job_medley_project\streamlit_app"
pip install -r requirements.txt
```

**新規追加ライブラリ**:
- `folium>=0.14.0` - インタラクティブ地図ライブラリ
- `streamlit-folium>=0.15.0` - Streamlit×Folium統合

### 2. Streamlit起動

```bash
streamlit run streamlit_dashboard_with_map.py
```

### 3. ブラウザで表示

自動的にブラウザが開きます（通常 http://localhost:8501）

---

## 地図表示機能

### 🗺️ Tab 1: バブルマップ

**特徴**:
- 円のサイズ = 申請者数
- クリックでポップアップ表示（市区町村名、申請者数、平均年齢、男性比率）
- ズーム・パン操作可能
- OpenStreetMap使用

**表示例**（京都府）:
```
🔴 京都市 - 1,500人（半径30px）
🔴 宇治市 - 620人（半径12px）
🔴 八幡市 - 384人（半径8px）
```

### 🔥 Tab 2: ヒートマップ

**特徴**:
- 色の濃さ = 申請者密度
- 赤色が濃い = 申請者が多い
- ヒートマップレイヤー（Folium HeatMap Plugin）

**色の意味**:
- 🔴 赤（濃い） - 高密度エリア
- 🟡 黄色 - 中密度エリア
- 🔵 青（薄い） - 低密度エリア

---

## 既存タブ（3-8）

### 📊 Tab 3: サマリー
- 申請者数、平均年齢、男性・女性比率（4つのメトリック）

### 👥 Tab 4: 年齢×性別
- 年齢層×性別のクロス集計（棒グラフ）

### 🌊 Tab 5: フロー分析
- 流入・流出・純流入（3つのメトリック + サンキー図）

### 📈 Tab 6: 需給ギャップ
- 需要・供給・ギャップ（3つのメトリック + 棒グラフ）

### 🎯 Tab 7: ペルソナ分析（実装予定）

### 💼 Tab 8: キャリア×年齢（実装予定）

---

## 地図表示の制限事項

### ⚠️ 現在の制限

1. **座標がランダム生成**:
   - 実際のジオコーディング未実装
   - 都道府県中心から±0.2度のランダムオフセット
   - 実際の市区町村位置とは異なる

2. **全市区町村の座標データ未整備**:
   - 主要47都道府県の中心座標のみ
   - 市区町村レベルの正確な座標は未実装

### ✅ 完全版での解決策

1. **ジオコーディング実装**:
   - 既存の `geocache.json`（1,901件）を活用
   - Google Maps APIまたはNominatim（無料）で座標取得
   - 市区町村名 → 緯度経度変換

2. **正確な地図表示**:
   - 実際の市区町村位置にマーカー表示
   - 市区町村境界線の表示（GeoJSON）
   - ポリゴン塗り分け（コロプレス）

---

## デモ版と完全版の違い

| 項目 | デモ版 | 完全版 |
|------|--------|--------|
| **地図座標** | ランダム生成 | ジオコーディング（正確） |
| **市区町村位置** | 不正確 | 正確 |
| **バブルマップ** | ✅ あり | ✅ あり（正確） |
| **ヒートマップ** | ✅ あり | ✅ あり（正確） |
| **境界線表示** | ❌ なし | ✅ あり（GeoJSON） |
| **Phase 7高度分析** | ❌ なし | ✅ あり（5機能） |
| **データダウンロード** | ❌ なし | ✅ あり（CSV/Excel） |

---

## イメージの確認ポイント

### 1. 地図のインタラクティブ性

- ✅ ズーム・パン操作できるか
- ✅ マーカークリックでポップアップ表示されるか
- ✅ ヒートマップの色が直感的か

### 2. データ表示の正確性

- ⚠️ 座標はランダムのため、実際の位置とは異なる
- ✅ 申請者数は正確（CSVデータから取得）
- ✅ バブルサイズは申請者数に比例

### 3. パフォーマンス

- ✅ 地図生成は約1-2秒（高速）
- ✅ CSVロードは約2秒（20,590行）
- ✅ タブ切り替えは瞬時

---

## よくある質問

### Q1: 座標が正確でないのはなぜ？

**A**: デモ版ではジオコーディング（住所→座標変換）を省略しています。完全版では既存の`geocache.json`を活用し、正確な座標を使用します。

### Q2: GASの地図表示と比べてどう？

**A**:
- **パフォーマンス**: Streamlit（2秒） vs GAS（98秒）→ 50倍速い
- **インタラクティブ性**: Folium（高） vs Google Charts（中）→ より直感的
- **カスタマイズ性**: Streamlit（自由） vs GAS（制約あり）→ より柔軟

### Q3: 完全版ではどこまで再現できる？

**A**: GAS統合ダッシュボードの**全機能100%再現可能**です。
- 地図表示（バブル・ヒート・境界線）✅
- Phase 1-6全分析 ✅
- Phase 7高度分析（5機能）✅
- データダウンロード ✅
- 複数地域比較 ✅

---

## 次のステップ

### Option 1: デモ版で確認のみ

イメージを掴んだら、GASの修正版をデプロイして統合ダッシュボードを完成させる。

### Option 2: 完全版を開発

1. ジオコーディング実装（geocache.json活用）
2. Phase 7高度分析追加（5機能）
3. 境界線表示（GeoJSON）
4. データダウンロード機能
5. Renderへデプロイ

**所要時間**: 約2-3時間

---

## トラブルシューティング

### エラー: `ModuleNotFoundError: No module named 'folium'`

**解決方法**:
```bash
pip install folium streamlit-folium
```

### 地図が表示されない

**解決方法**:
1. ブラウザのコンソールでエラー確認
2. インターネット接続確認（OpenStreetMapタイル取得のため）
3. Streamlitを再起動

### CSVファイルが見つからない

**解決方法**:
1. ブラウザでドラッグ&ドロップしてアップロード
2. または、`python_scripts/data/output_v2/mapcomplete_complete_sheets/MapComplete_Complete_All_FIXED.csv` に配置

---

## まとめ

### ✅ デモ版で確認できること

1. **地図のインタラクティブ性**: ズーム・パン・クリック
2. **バブルマップ**: 申請者数に応じた円サイズ
3. **ヒートマップ**: 申請者密度の可視化
4. **パフォーマンス**: GASの50倍速い（2秒 vs 98秒）

### ⚠️ デモ版の制限

1. **座標がランダム**: 実際の市区町村位置とは異なる
2. **Phase 7未実装**: 高度分析5機能は未実装

### 🚀 完全版で追加される機能

1. **正確な座標**: ジオコーディングで実際の位置を表示
2. **Phase 7**: 人材供給密度、資格別分布、年齢×性別、移動許容度、ペルソナ詳細
3. **境界線表示**: GeoJSONで市区町村境界を表示
4. **データダウンロード**: CSV/Excelで任意のデータをダウンロード
5. **複数地域比較**: 最大5地域の同時比較

---

**イメージは掴めましたか？完全版の開発を進めますか？**
