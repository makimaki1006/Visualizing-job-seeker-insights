/**
 * Phase 7ãƒ¡ãƒ‹ãƒ¥ãƒ¼çµ±åˆ
 *
 * æ—¢å­˜ã®GASãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«Phase 7æ©Ÿèƒ½ã‚’çµ±åˆã—ã¾ã™ã€‚
 */

/**
 * Phase 7ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ—¢å­˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¿½åŠ 
 * æ³¨æ„: æ—¢å­˜ã®MenuIntegration.gsã®onOpené–¢æ•°ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
 */
function addPhase7Menu(menu) {
  const phase7Menu = SpreadsheetApp.getUi().createMenu('ğŸ“ˆ Phase 7é«˜åº¦åˆ†æ');

  phase7Menu
    .addItem('ğŸ“¥ Phase 7ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿', 'importPhase7Data')
    .addSeparator()
    .addItem('ğŸ—ºï¸ äººæä¾›çµ¦å¯†åº¦ãƒãƒƒãƒ—', 'showSupplyDensityMap')
    .addItem('ğŸš— ç§»å‹•è¨±å®¹åº¦åˆ†æ', 'showMobilityScoreAnalysis')
    .addItem('ğŸ”€ ãƒšãƒ«ã‚½ãƒŠÃ—ç§»å‹•è¨±å®¹åº¦ã‚¯ãƒ­ã‚¹åˆ†æ', 'showPersonaMobilityCrossAnalysis')
    .addSeparator()
    .addItem('âœ… ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼', 'validatePhase7Data')
    .addItem('ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒªãƒ¼', 'showPhase7DataSummary')
    .addSeparator()
    .addItem('ğŸ“¤ ãƒ©ãƒ³ã‚¯åˆ¥å†…è¨³ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ', 'exportRankBreakdownToSheet');

  // ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«Phase 7ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 
  menu.addSubMenu(phase7Menu);

  return menu;
}


/**
 * ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½œæˆï¼ˆã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ç‰ˆï¼‰
 * æ³¨æ„: æ—¢å­˜ã®onOpené–¢æ•°ã¨çµ±åˆã™ã‚‹å ´åˆã¯ã€ã“ã®é–¢æ•°ã¯ä¸è¦ã§ã™
 */
function onOpen_Phase7() {
  const ui = SpreadsheetApp.getUi();

  // ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼å–å¾—ã¾ãŸã¯ä½œæˆ
  let menu = ui.createMenu('ğŸ“Š ãƒ‡ãƒ¼ã‚¿å‡¦ç†');

  // Phase 7ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ 
  menu = addPhase7Menu(menu);

  menu.addToUi();
}


/**
 * çµ±åˆç‰ˆonOpené–¢æ•°ï¼ˆæ—¢å­˜MenuIntegration.gsã¨çµ±åˆã™ã‚‹å ´åˆã®ã‚µãƒ³ãƒ—ãƒ«ï¼‰
 *
 * ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’æ—¢å­˜ã®MenuIntegration.gsã®onOpené–¢æ•°ã«è¿½åŠ ã—ã¦ãã ã•ã„ï¼š
 *
 * function onOpen() {
 *   const ui = SpreadsheetApp.getUi();
 *   let menu = ui.createMenu('ğŸ“Š ãƒ‡ãƒ¼ã‚¿å‡¦ç†');
 *
 *   // æ—¢å­˜ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®...
 *   menu.addItem('âš¡ é«˜é€ŸCSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆæ¨å¥¨ï¼‰', 'showEnhancedUploadDialog');
 *   // ... ä»–ã®æ—¢å­˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›® ...
 *
 *   // Phase 7ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ ï¼ˆNEWï¼‰
 *   const phase7Menu = ui.createMenu('ğŸ“ˆ Phase 7é«˜åº¦åˆ†æ')
 *     .addItem('ğŸ“¥ Phase 7ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿', 'importPhase7Data')
 *     .addSeparator()
 *     .addItem('ğŸ—ºï¸ äººæä¾›çµ¦å¯†åº¦ãƒãƒƒãƒ—', 'showSupplyDensityMap')
 *     .addItem('ğŸš— ç§»å‹•è¨±å®¹åº¦åˆ†æ', 'showMobilityScoreAnalysis')
 *     .addSeparator()
 *     .addItem('âœ… ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼', 'validatePhase7Data')
 *     .addItem('ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒªãƒ¼', 'showPhase7DataSummary')
 *     .addSeparator()
 *     .addItem('ğŸ“¤ ãƒ©ãƒ³ã‚¯åˆ¥å†…è¨³ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ', 'exportRankBreakdownToSheet');
 *
 *   menu.addSubMenu(phase7Menu);
 *
 *   menu.addToUi();
 * }
 */


/**
 * Phase 7ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚¬ã‚¤ãƒ‰è¡¨ç¤º
 */
function showPhase7QuickStart() {
  const ui = SpreadsheetApp.getUi();

  const message = `
Phase 7 é«˜åº¦åˆ†ææ©Ÿèƒ½ - ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚¬ã‚¤ãƒ‰

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ã‚¹ãƒ†ãƒƒãƒ—1ã€‘Pythonã§ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Pythonå®Ÿè¡Œç’°å¢ƒã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ:
   python run_complete.py

2. CSVãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼ˆGUIãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼‰

3. Phase 7å‡ºåŠ›ç¢ºèª:
   gas_output_phase7/ ãƒ•ã‚©ãƒ«ãƒ€ã«7ã¤ã®CSVãŒç”Ÿæˆã•ã‚Œã¾ã™
   - SupplyDensityMap.csv
   - QualificationDistribution.csv
   - AgeGenderCrossAnalysis.csv
   - MobilityScore.csv
   - DetailedPersonaProfile.csv
   - PersonaMobilityCross.csvï¼ˆGASæ”¹è‰¯æ©Ÿèƒ½ï¼‰
   - PersonaMapData.csvï¼ˆGASæ”¹è‰¯æ©Ÿèƒ½ï¼‰

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ã‚¹ãƒ†ãƒƒãƒ—2ã€‘GASã«ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. ãƒ¡ãƒ‹ãƒ¥ãƒ¼: ğŸ“Š ãƒ‡ãƒ¼ã‚¿å‡¦ç† > ğŸ“ˆ Phase 7é«˜åº¦åˆ†æ > ğŸ“¥ Phase 7ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿

2. 5ã¤ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
   â€» æ³¨æ„: ç¾åœ¨ã®å®Ÿè£…ã§ã¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

3. ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼:
   ãƒ¡ãƒ‹ãƒ¥ãƒ¼: ğŸ“ˆ Phase 7é«˜åº¦åˆ†æ > âœ… ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ã‚¹ãƒ†ãƒƒãƒ—3ã€‘å¯è¦–åŒ–æ©Ÿèƒ½ã‚’ä½¿ç”¨
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. äººæä¾›çµ¦å¯†åº¦ãƒãƒƒãƒ—:
   ãƒ¡ãƒ‹ãƒ¥ãƒ¼: ğŸ“ˆ Phase 7é«˜åº¦åˆ†æ > ğŸ—ºï¸ äººæä¾›çµ¦å¯†åº¦ãƒãƒƒãƒ—
   - ãƒãƒ–ãƒ«ãƒãƒ£ãƒ¼ãƒˆï¼ˆæ±‚è·è€…æ•°Ã—ç·åˆã‚¹ã‚³ã‚¢ï¼‰
   - ãƒ©ãƒ³ã‚¯åˆ¥çµ±è¨ˆã‚«ãƒ¼ãƒ‰
   - åœ°åŸŸåˆ¥è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«

2. ç§»å‹•è¨±å®¹åº¦åˆ†æ:
   ãƒ¡ãƒ‹ãƒ¥ãƒ¼: ğŸ“ˆ Phase 7é«˜åº¦åˆ†æ > ğŸš— ç§»å‹•è¨±å®¹åº¦åˆ†æ
   - ã‚¹ã‚³ã‚¢åˆ†å¸ƒãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ 
   - ãƒ¬ãƒ™ãƒ«åˆ¥å††ã‚°ãƒ©ãƒ•
   - å¸Œæœ›åœ°æ•°Ã—ç§»å‹•è·é›¢æ•£å¸ƒå›³
   - å±…ä½åœ°åˆ¥å¹³å‡ã‚¹ã‚³ã‚¢TOP10

3. ãƒšãƒ«ã‚½ãƒŠÃ—ç§»å‹•è¨±å®¹åº¦ã‚¯ãƒ­ã‚¹åˆ†æï¼ˆNEWï¼‰:
   ãƒ¡ãƒ‹ãƒ¥ãƒ¼: ğŸ“ˆ Phase 7é«˜åº¦åˆ†æ > ğŸ”€ ãƒšãƒ«ã‚½ãƒŠÃ—ç§»å‹•è¨±å®¹åº¦ã‚¯ãƒ­ã‚¹åˆ†æ
   - ç©ã¿ä¸Šã’æ£’ã‚°ãƒ©ãƒ•ï¼ˆäººæ•°ï¼‰
   - 100%ç©ã¿ä¸Šã’æ£’ã‚°ãƒ©ãƒ•ï¼ˆæ¯”ç‡ï¼‰
   - è©³ç´°ã‚¯ãƒ­ã‚¹é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«
   - ä¸»è¦æ´å¯Ÿã®è‡ªå‹•ç”Ÿæˆ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€è¿½åŠ æ©Ÿèƒ½ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒªãƒ¼:
   Phase 7ã®å…¨ãƒ‡ãƒ¼ã‚¿æ¦‚è¦ã‚’ç¢ºèª

ğŸ“¤ ãƒ©ãƒ³ã‚¯åˆ¥å†…è¨³ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ:
   äººæä¾›çµ¦å¯†åº¦ãƒãƒƒãƒ—ã®ãƒ©ãƒ³ã‚¯åˆ¥è©³ç´°ã‚’ã‚·ãƒ¼ãƒˆå‡ºåŠ›

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Q: ã€Œã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€ã‚¨ãƒ©ãƒ¼
A: å…ˆã«ã€ŒPhase 7ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„

Q: ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œãªã„
A: ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚’å®Ÿè¡Œã—ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚’ç¢ºèªã—ã¦ãã ã•ã„

Q: ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒã§ããªã„
A: Phase7DataImporter.gs ã® importPhase7File é–¢æ•°ã«
   å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ãƒ“ã‚¸ãƒã‚¹æ´»ç”¨ä¾‹ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ“ äººæä¾›çµ¦å¯†åº¦ãƒãƒƒãƒ— â†’ åºƒå‘Šäºˆç®—é…åˆ†ã®æ„æ€æ±ºå®š
âœ“ ç§»å‹•è¨±å®¹åº¦åˆ†æ â†’ ãƒªãƒ¢ãƒ¼ãƒˆæ±‚äººæˆ¦ç•¥ã®ç«‹æ¡ˆ
âœ“ ãƒ©ãƒ³ã‚¯åˆ¥å†…è¨³ â†’ å–¶æ¥­ææ¡ˆè³‡æ–™ã®ä½œæˆ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  `;

  ui.alert('Phase 7 ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚¬ã‚¤ãƒ‰', message, ui.ButtonSet.OK);
}


/**
 * Phase 7çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆçµ±åˆãƒ“ãƒ¥ãƒ¼ï¼‰
 * â€» å°†æ¥å®Ÿè£…äºˆå®š
 */
function showPhase7IntegratedDashboard() {
  const ui = SpreadsheetApp.getUi();

  ui.alert(
    'çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',
    'Phase 7çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™ã€‚\n\n' +
    'ç¾åœ¨ã¯ä»¥ä¸‹ã®å€‹åˆ¥æ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„ï¼š\n' +
    '- ğŸ—ºï¸ äººæä¾›çµ¦å¯†åº¦ãƒãƒƒãƒ—\n' +
    '- ğŸš— ç§»å‹•è¨±å®¹åº¦åˆ†æ',
    ui.ButtonSet.OK
  );
}


/**
 * Phase 7å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
 */
function clearAllPhase7Data() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'Phase 7ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢',
    'å…¨ã¦ã®Phase 7ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n' +
    'ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    ui.alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
    return;
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const phase7Sheets = [
    'Phase7_SupplyDensity',
    'Phase7_QualificationDist',
    'Phase7_AgeGenderCross',
    'Phase7_MobilityScore',
    'Phase7_PersonaProfile',
    'Phase7_PersonaMobilityCross',
    'Phase7_PersonaMapData',
    'Phase7_DensityRankBreakdown'
  ];

  let deletedCount = 0;

  phase7Sheets.forEach(sheetName => {
    const sheet = ss.getSheetByName(sheetName);
    if (sheet) {
      ss.deleteSheet(sheet);
      deletedCount++;
      Logger.log(`å‰Šé™¤: ${sheetName}`);
    }
  });

  ui.alert(
    'ã‚¯ãƒªã‚¢å®Œäº†',
    `${deletedCount}å€‹ã®Phase 7ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`,
    ui.ButtonSet.OK
  );
}
