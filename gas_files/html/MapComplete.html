<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>求職者ダッシュボード</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Yu Gothic', 'Hiragino Kaku Gothic Pro', Meiryo, sans-serif; height: 100vh; overflow: hidden; }
    .container { display: flex; height: 100vh; }
    #map { flex: 1; height: 100%; }
    .sidebar { width: 360px; background: #2d2d5f; color: #ffffff; padding: 20px; overflow-y: auto; box-shadow: -5px 0 20px rgba(0,0,0,0.3); }
    .sidebar-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #ffe082; }
    .stat-card { background: rgba(255,255,255,0.08); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .stat-card.highlight { border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 0 10px rgba(255,255,255,0.1); }
    .stat-label { font-size: 12px; color: rgba(255,255,255,0.65); margin-bottom: 6px; display: block; }
    .stat-value { font-size: 24px; font-weight: bold; color: #ffe082; }
    .region-title { font-size: 16px; font-weight: bold; margin-bottom: 8px; color: #ffffff; }
    .region-stat { font-size: 13px; margin-bottom: 6px; }
    .region-stat .label { color: rgba(255,255,255,0.7); margin-right: 6px; }
    .chart-container { background: rgba(255,255,255,0.08); border-radius: 8px; padding: 16px; margin-bottom: 16px; height: 200px; }
    .control-group { margin-bottom: 16px; }
    .control-label { font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 6px; display: block; }
    select { width: 100%; padding: 10px; border-radius: 4px; border: none; background: rgba(255,255,255,0.95); color: #2d2d5f; font-size: 13px; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1); }
    select:focus { outline: none; box-shadow: 0 0 0 2px rgba(255,255,255,0.6); }
    .top10-list { list-style: none; max-height: 220px; overflow-y: auto; padding-right: 4px; }
    .top10-item { display: flex; justify-content: space-between; padding: 8px 10px; margin-bottom: 6px; background: rgba(255,255,255,0.08); border-radius: 4px; cursor: pointer; transition: background 0.2s ease; }
    .top10-item:hover { background: rgba(255,255,255,0.18); }
    .top10-rank { font-weight: bold; color: #ffe082; margin-right: 10px; }
    .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #ffffff; color: #2d2d5f; padding: 28px 36px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 9999; font-weight: bold; }
    canvas { background: transparent; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
  </style>
</head>
<body>
  <div class="loading" id="loading">データ読み込み中...</div>
  <div class="container">
    <div id="map"></div>
    <div class="sidebar">
      <div class="sidebar-title">求職者マップダッシュボード</div>
      <div class="stat-card">
        <span class="stat-label">総求職者数</span>
        <span class="stat-value" id="totalCount">-</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">平均年齢</span>
        <span class="stat-value" id="avgAge">-</span>
      </div>
      <div class="control-group">
        <label class="control-label">表示モード</label>
        <select id="displayMode" onchange="changeDisplayMode()">
          <option value="markers">個別マーカー</option>
          <option value="cluster">クラスター</option>
          <option value="heatmap">ヒートマップ</option>
        </select>
      </div>
      <div class="control-group">
        <label class="control-label">フィルター</label>
        <select id="dataFilter" onchange="applyFilter()">
          <option value="all">全データ</option>
          <option value="male">男性のみ</option>
          <option value="female">女性のみ</option>
          <option value="young">20-39歳</option>
          <option value="middle">40-59歳</option>
          <option value="senior">60歳以上</option>
        </select>
      </div>
      <div class="stat-card highlight" id="regionDetailCard" style="display:none;">
        <div class="region-title" id="regionDetailTitle"></div>
        <div class="region-stat"><span class="label">求職者数:</span> <span id="regionTotal"></span></div>
        <div class="region-stat" id="regionFilterNote" style="display:none;"><span class="label">適用フィルター:</span> <span id="regionFilterText"></span></div>
        <div class="region-stat"><span class="label">平均年齢:</span> <span id="regionAvgAge"></span></div>
        <div class="region-stat"><span class="label">男女比:</span> 男性 <span id="regionMale"></span> / 女性 <span id="regionFemale"></span></div>
        <div class="region-stat"><span class="label">平均資格数:</span> <span id="regionQualifications"></span></div>
      </div>
      <div class="stat-card">
        <span class="stat-label">希望勤務地 TOP10</span>
        <ul class="top10-list" id="top10List"></ul>
      </div>
      <div class="chart-container">
        <canvas id="genderChart"></canvas>
      </div>
    </div>
  </div>
  <script>
    let map;
    let markers = [];
    let markerCluster;
    let heatLayer = null;
    let allData = { mapMetrics: [], applicants: [], desiredWork: [], aggDesired: [] };
    let activeFilter = 'all';
    let filteredMapData = [];
    let selectedRegionKey = null;

    const COL_MAP = {
      prefecture: ['都道府県', 'prefecture'],
      municipality: ['市区町村', 'municipality'],
      location_key: ['キー', 'location_key'],
      count: ['カウント', 'applicant_count', 'count'],
      male_count: ['男性数', 'male_count'],
      female_count: ['女性数', 'female_count'],
      avg_age: ['平均年齢', 'avg_age'],
      avg_qualifications: ['平均資格数', 'avg_qualifications'],
      latitude: ['緯度', 'latitude'],
      longitude: ['経度', 'longitude'],
      age: ['年齢', 'age'],
      gender: ['性別', 'gender']
    };

    const FILTER_LABELS = {
      all: '全データ',
      male: '男性',
      female: '女性',
      young: '20-39歳帯',
      middle: '40-59歳帯',
      senior: '60歳以上'
    };

    function getVal(row, key) {
      if (!row) return undefined;
      const candidates = COL_MAP[key] || [key];
      for (const candidate of candidates) {
        if (row[candidate] !== undefined && row[candidate] !== null) {
          return row[candidate];
        }
      }
      return undefined;
    }

    function getNumber(row, key) {
      const value = getVal(row, key);
      const num = typeof value === 'number' ? value : parseFloat(value);
      return Number.isFinite(num) ? num : 0;
    }

    function getCountForRow(row) {
      if (row && row.__filteredCount !== undefined && row.__filteredCount !== null) {
        return row.__filteredCount;
      }
      return row ? row.__baseCount || getNumber(row, 'count') : 0;
    }

    function initMap() {
      map = L.map('map', { center: [35.0116, 135.7681], zoom: 10 });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap',
        maxZoom: 18
      }).addTo(map);

      markerCluster = L.markerClusterGroup({ chunkedLoading: true, maxClusterRadius: 60 });
      map.addLayer(markerCluster);
    }

    function loadData() {
      google.script.run
        .withSuccessHandler(function(data) {
          allData = data || { mapMetrics: [], applicants: [], desiredWork: [], aggDesired: [] };
          document.getElementById('loading').style.display = 'none';
          refreshView();
        })
        .withFailureHandler(function(error) {
          alert('データ読み込みエラー: ' + error.message);
          document.getElementById('loading').style.display = 'none';
        })
        .getAllVisualizationData();
    }

    function refreshView() {
      filteredMapData = buildFilteredDataset(activeFilter);
      updateStats(activeFilter);
      renderMap();
      updateTop10();
      updateGenderChart();

      if (selectedRegionKey) {
        const preserved = filteredMapData.find(row => row.__key === selectedRegionKey);
        if (preserved) {
          updateRegionDetail(preserved);
        } else {
          resetRegionDetail();
        }
      } else {
        resetRegionDetail();
      }
    }

    function buildFilteredDataset(filterType) {
      const baseRows = (allData.mapMetrics || []).map(function(row) {
        const clone = Object.assign({}, row);
        clone.__prefecture = getVal(clone, 'prefecture') || '';
        clone.__municipality = getVal(clone, 'municipality') || '';
        clone.__key = getVal(clone, 'location_key') || (clone.__prefecture + ':' + clone.__municipality);
        clone.__baseCount = getNumber(clone, 'count');
        clone.__male = getNumber(clone, 'male_count');
        clone.__female = getNumber(clone, 'female_count');
        clone.__avgAge = getNumber(clone, 'avg_age');
        clone.__avgQualifications = getNumber(clone, 'avg_qualifications');
        clone.__latitude = getNumber(clone, 'latitude');
        clone.__longitude = getNumber(clone, 'longitude');
        return clone;
      }).filter(row => row.__baseCount > 0 && row.__latitude && row.__longitude);

      return baseRows.map(function(row) {
        row.__filteredCount = null;
        row.__filterLabel = null;
        switch (filterType) {
          case 'male':
            row.__filteredCount = row.__male;
            row.__filterLabel = '男性';
            return row.__filteredCount > 0 ? row : null;
          case 'female':
            row.__filteredCount = row.__female;
            row.__filterLabel = '女性';
            return row.__filteredCount > 0 ? row : null;
          case 'young':
            return (row.__avgAge >= 20 && row.__avgAge < 40) ? row : null;
          case 'middle':
            return (row.__avgAge >= 40 && row.__avgAge < 60) ? row : null;
          case 'senior':
            return (row.__avgAge >= 60) ? row : null;
          default:
            return row;
        }
      }).filter(Boolean);
    }

    function renderMap() {
      const mode = document.getElementById('displayMode').value;
      clearMap();

      if (mode === 'heatmap') {
        displayHeatmap(filteredMapData);
        return;
      }

      if (mode === 'cluster') {
        displayClusters(filteredMapData);
      } else {
        displayMarkers(filteredMapData);
      }
    }

    function displayMarkers(data) {
      data.forEach(function(row) {
        const marker = L.marker([row.__latitude, row.__longitude]);
        marker.bindPopup(buildPopupContent(row));
        marker.on('click', function() { handleRegionSelection(row); });
        marker.addTo(map);
        markers.push(marker);
      });
    }

    function displayClusters(data) {
      data.forEach(function(row) {
        const marker = L.marker([row.__latitude, row.__longitude]);
        marker.bindPopup(buildPopupContent(row));
        marker.on('click', function() { handleRegionSelection(row); });
        markerCluster.addLayer(marker);
      });
    }

    function displayHeatmap(data) {
      const heatData = data.map(function(row) {
        return [row.__latitude, row.__longitude, getCountForRow(row)];
      });

      if (heatLayer) {
        heatLayer.remove();
        heatLayer = null;
      }

      heatLayer = L.heatLayer(heatData, { radius: 25, blur: 15, maxZoom: 17 }).addTo(map);
    }

    function buildPopupContent(row) {
      const count = getCountForRow(row);
      const total = row.__baseCount;
      const filterLabel = FILTER_LABELS[activeFilter];

      let countLabel = `${formatNumber(count)}人`;
      if (activeFilter !== 'all' && count !== total) {
        countLabel += ` / 全体 ${formatNumber(total)}人`;
      }

      const parts = [
        `<strong>${row.__municipality || row.__prefecture || '不明'}</strong>`,
        `求職者数: ${countLabel}`,
        `平均年齢: ${formatDecimal(row.__avgAge)}歳`
      ];

      if (row.__male || row.__female) {
        parts.push(`男性 ${formatNumber(row.__male)} / 女性 ${formatNumber(row.__female)}`);
      }

      if (activeFilter !== 'all') {
        parts.push(`フィルター: ${filterLabel}`);
      }

      return parts.join('<br>');
    }

    function clearMap() {
      markers.forEach(function(marker) { marker.remove(); });
      markers = [];
      markerCluster.clearLayers();
      if (heatLayer) {
        heatLayer.remove();
        heatLayer = null;
      }
    }

    function handleRegionSelection(row) {
      selectedRegionKey = row.__key;
      updateRegionDetail(row);
      google.script.run
        .withFailureHandler(function(error) { console.error('saveSelectedRegion failed', error); })
        .saveSelectedRegion(row.__prefecture || null, row.__municipality || null);
    }

    function updateRegionDetail(row) {
      const card = document.getElementById('regionDetailCard');
      if (!row) {
        resetRegionDetail();
        return;
      }

      card.style.display = 'block';
      document.getElementById('regionDetailTitle').textContent = row.__municipality ? `${row.__prefecture} / ${row.__municipality}` : (row.__prefecture || '地域未選択');

      const count = getCountForRow(row);
      const total = row.__baseCount;
      let totalLabel = `${formatNumber(count)}人`;
      if (activeFilter !== 'all' && count !== total) {
        totalLabel += `（全体 ${formatNumber(total)}人）`;
      }
      document.getElementById('regionTotal').textContent = totalLabel;

      const filterNote = document.getElementById('regionFilterNote');
      if (activeFilter !== 'all') {
        filterNote.style.display = 'block';
        document.getElementById('regionFilterText').textContent = FILTER_LABELS[activeFilter] || 'フィルター適用中';
      } else {
        filterNote.style.display = 'none';
      }

      document.getElementById('regionAvgAge').textContent = `${formatDecimal(row.__avgAge)}歳`;
      document.getElementById('regionMale').textContent = `${formatNumber(row.__male)}人`;
      document.getElementById('regionFemale').textContent = `${formatNumber(row.__female)}人`;
      document.getElementById('regionQualifications').textContent = formatDecimal(row.__avgQualifications);
    }

    function resetRegionDetail() {
      document.getElementById('regionDetailCard').style.display = 'none';
    }

    function updateTop10() {
      const listEl = document.getElementById('top10List');
      listEl.innerHTML = '';

      const ranking = filteredMapData
        .slice()
        .sort(function(a, b) { return getCountForRow(b) - getCountForRow(a); })
        .slice(0, 10);

      ranking.forEach(function(row, index) {
        const municipality = row.__municipality || row.__prefecture || '不明';
        const countLabel = `${formatNumber(getCountForRow(row))}人`;
        const li = document.createElement('li');
        li.className = 'top10-item';
        li.innerHTML = `<span><span class="top10-rank">${index + 1}</span>${municipality}</span><span><strong>${countLabel}</strong></span>`;
        li.addEventListener('click', function() {
          map.setView([row.__latitude, row.__longitude], Math.max(map.getZoom(), 11));
          handleRegionSelection(row);
        });
        listEl.appendChild(li);
      });
    }

    function updateGenderChart() {
      const ctx = document.getElementById('genderChart');
      if (!ctx) return;

      const applicants = filterApplicants(activeFilter);
      const genderCounts = applicants.reduce(function(acc, row) {
        const gender = normalizeGender(getVal(row, 'gender')) || '不明';
        acc[gender] = (acc[gender] || 0) + 1;
        return acc;
      }, {});

      const labels = Object.keys(genderCounts);
      const data = Object.values(genderCounts);

      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: ['rgba(102, 126, 234, 0.85)', 'rgba(255, 99, 132, 0.85)', 'rgba(255, 206, 86, 0.85)', 'rgba(156, 204, 101, 0.85)']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#ffffff' }
            }
          }
        }
      });
    }

    function updateStats(filterType) {
      const applicants = filterApplicants(filterType);
      const total = applicants.length;
      document.getElementById('totalCount').textContent = total > 0 ? total.toLocaleString() : '-';

      let ageSum = 0;
      let ageCount = 0;
      applicants.forEach(function(row) {
        const age = parseFloat(getVal(row, 'age'));
        if (Number.isFinite(age) && age > 0) {
          ageSum += age;
          ageCount++;
        }
      });
      const avgAge = ageCount > 0 ? (ageSum / ageCount) : 0;
      document.getElementById('avgAge').textContent = ageCount > 0 ? `${avgAge.toFixed(1)}歳` : '-';
    }

    function changeDisplayMode() {
      renderMap();
    }

    function applyFilter() {
      activeFilter = document.getElementById('dataFilter').value;
      selectedRegionKey = null;
      refreshView();
    }

    function filterApplicants(filterType) {
      const base = allData.applicants || [];
      return base.filter(function(row) {
        const gender = normalizeGender(getVal(row, 'gender'));
        const age = parseFloat(getVal(row, 'age')) || 0;
        switch (filterType) {
          case 'male':
            return gender === '男性';
          case 'female':
            return gender === '女性';
          case 'young':
            return age >= 20 && age < 40;
          case 'middle':
            return age >= 40 && age < 60;
          case 'senior':
            return age >= 60;
          default:
            return true;
        }
      });
    }

    function normalizeGender(value) {
      if (!value) return undefined;
      const str = String(value).toLowerCase();
      if (str.includes('男') || str === 'male' || str === 'm') return '男性';
      if (str.includes('女') || str === 'female' || str === 'f') return '女性';
      return value;
    }

    function formatNumber(value) {
      const num = Number(value) || 0;
      return num.toLocaleString();
    }

    function formatDecimal(value) {
      const num = Number(value);
      return Number.isFinite(num) ? num.toFixed(1) : '-';
    }

    window.addEventListener('DOMContentLoaded', function() {
      try {
        initMap();
        loadData();
      } catch (error) {
        alert('初期化エラー: ' + error.message);
      }
    });
  </script>
</body>
</html>
