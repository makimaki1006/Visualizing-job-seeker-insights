<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      padding: 30px;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    h2 {
      color: #667eea;
      font-size: 28px;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      font-size: 14px;
    }
    .instructions {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    .instructions-title {
      font-weight: bold;
      color: #856404;
      margin-bottom: 10px;
    }
    .instructions-list {
      font-size: 13px;
      color: #856404;
      line-height: 1.6;
    }
    .upload-zone {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 30px 0;
    }
    .file-drop {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 20px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      min-height: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .file-drop:hover {
      border-color: #667eea;
      background: #f5f5ff;
    }
    .file-drop.dragover {
      border-color: #667eea;
      background: #e8e8ff;
      transform: scale(1.05);
    }
    .file-drop.uploaded {
      border-color: #34A853;
      background: #e6f4ea;
    }
    .file-drop-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    .file-drop-label {
      font-size: 12px;
      font-weight: bold;
      color: #666;
      margin-bottom: 5px;
      text-align: center;
    }
    .file-drop-status {
      font-size: 10px;
      color: #999;
    }
    .file-drop-filename {
      font-size: 9px;
      color: #34A853;
      margin-top: 5px;
      font-weight: bold;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .file-input {
      display: none;
    }
    .file-summary {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #dee2e6;
    }
    .summary-item:last-child {
      border-bottom: none;
    }
    .summary-label {
      font-weight: bold;
      color: #666;
    }
    .summary-value {
      color: #667eea;
      font-weight: bold;
    }
    .progress-container {
      width: 100%;
      height: 40px;
      background: #f0f0f0;
      border-radius: 20px;
      margin: 20px 0;
      overflow: hidden;
      display: none;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      font-weight: bold;
    }
    .status {
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      display: none;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
    }
    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }
    .button {
      padding: 12px 30px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .button-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .button-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .button-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .button-secondary {
      background: #6c757d;
      color: white;
    }
    .button-secondary:hover {
      background: #5a6268;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2><?= phaseIcon ?> <?= phaseName ?> - ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
      <div class="subtitle">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
    </div>

    <div class="instructions">
      <div class="instructions-title">ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ‰‹é †</div>
      <div class="instructions-list">
        1. å„ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚‚å¯èƒ½ï¼‰<br>
        2. å…¨ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå¾Œã€ã€Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
        3. å®Œäº†å¾Œã€è‡ªå‹•ã§ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã™
      </div>
    </div>

    <div class="upload-zone" id="uploadZone">
      <!-- å‹•çš„ç”Ÿæˆ -->
    </div>

    <div class="file-summary" id="fileSummary">
      <div class="summary-item">
        <span class="summary-label">é¸æŠæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«</span>
        <span class="summary-value" id="selectedCount">0 / 0</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">åˆè¨ˆã‚µã‚¤ã‚º</span>
        <span class="summary-value" id="totalSize">0 KB</span>
      </div>
    </div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div class="status" id="status"></div>

    <div class="button-group">
      <button class="button button-primary" id="uploadButton" disabled onclick="uploadFiles()">
        ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹
      </button>
      <button class="button button-secondary" onclick="clearAll()">
        ğŸ”„ ã‚¯ãƒªã‚¢
      </button>
      <button class="button button-secondary" onclick="google.script.host.close()">
        âœ–ï¸ é–‰ã˜ã‚‹
      </button>
    </div>
  </div>

<script>
// Phaseè¨­å®šï¼ˆGASå´ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ï¼‰
const phaseId = '<?= phaseId ?>';
const phaseName = '<?= phaseName ?>';
const phaseIcon = '<?= phaseIcon ?>';
const filesConfig = <?!= files ?>;

// ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
const files = {};

// åˆæœŸåŒ–
function init() {
  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒªã‚¢ã‚’å‹•çš„ç”Ÿæˆ
  const uploadZone = document.getElementById('uploadZone');

  filesConfig.forEach((fileConfig, index) => {
    const key = `file${index}`;
    files[key] = {
      file: null,
      config: fileConfig
    };

    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ä½œæˆ
    const dropDiv = document.createElement('div');
    dropDiv.className = 'file-drop';
    dropDiv.id = `drop-${key}`;
    dropDiv.onclick = () => selectFile(key);
    dropDiv.innerHTML = `
      <div class="file-drop-icon">ğŸ“„</div>
      <div class="file-drop-label">${fileConfig.label}</div>
      <div style="font-size: 10px; color: #999; margin-bottom: 5px;">ğŸ“ ${fileConfig.name}</div>
      <div class="file-drop-status" id="status-${key}">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
      <div class="file-drop-filename" id="filename-${key}"></div>
    `;

    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
    dropDiv.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropDiv.classList.add('dragover');
    });

    dropDiv.addEventListener('dragleave', () => {
      dropDiv.classList.remove('dragover');
    });

    dropDiv.addEventListener('drop', (e) => {
      e.preventDefault();
      dropDiv.classList.remove('dragover');

      if (e.dataTransfer.files.length > 0) {
        const file = e.dataTransfer.files[0];
        if (file.name.endsWith('.csv')) {
          files[key].file = file;
          updateFileStatus(key);
        } else {
          showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        }
      }
    });

    uploadZone.appendChild(dropDiv);

    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¦ç´ ä½œæˆ
    const input = document.createElement('input');
    input.type = 'file';
    input.id = `input-${key}`;
    input.className = 'file-input';
    input.accept = '.csv';
    input.onchange = () => handleFile(key);
    uploadZone.appendChild(input);
  });

  // ã‚µãƒãƒªãƒ¼æ›´æ–°
  updateSummary();
}

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
function selectFile(key) {
  document.getElementById(`input-${key}`).click();
}

function handleFile(key) {
  const input = document.getElementById(`input-${key}`);
  if (input.files.length > 0) {
    files[key].file = input.files[0];
    updateFileStatus(key);
  }
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
function updateFileStatus(key) {
  const file = files[key].file;
  const dropZone = document.getElementById(`drop-${key}`);
  const statusElement = document.getElementById(`status-${key}`);
  const filenameElement = document.getElementById(`filename-${key}`);

  if (file) {
    dropZone.classList.add('uploaded');
    statusElement.textContent = 'âœ… é¸æŠæ¸ˆã¿';
    filenameElement.textContent = file.name;
  } else {
    dropZone.classList.remove('uploaded');
    statusElement.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ';
    filenameElement.textContent = '';
  }

  updateSummary();
}

// ã‚µãƒãƒªãƒ¼æ›´æ–°
function updateSummary() {
  const selectedFiles = Object.values(files).filter(f => f.file !== null);
  const selectedCount = selectedFiles.length;
  const totalSize = selectedFiles.reduce((sum, f) => sum + f.file.size, 0);
  const totalFiles = Object.keys(files).length;

  document.getElementById('selectedCount').textContent = `${selectedCount} / ${totalFiles}`;
  document.getElementById('totalSize').textContent = (totalSize / 1024).toFixed(2) + ' KB';

  if (selectedCount > 0) {
    document.getElementById('fileSummary').style.display = 'block';
  }

  // å…¨ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆä»»æ„ã§å¤‰æ›´å¯èƒ½ï¼‰
  document.getElementById('uploadButton').disabled = selectedCount === 0;
}

// ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
async function uploadFiles() {
  const selectedFiles = Object.entries(files).filter(([key, data]) => data.file !== null);

  if (selectedFiles.length === 0) {
    showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    return;
  }

  showStatus(`${selectedFiles.length}ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™...`, 'info');
  showProgress(0);

  let successCount = 0;
  let errorCount = 0;

  for (let i = 0; i < selectedFiles.length; i++) {
    const [key, data] = selectedFiles[i];
    const progress = ((i + 1) / selectedFiles.length) * 100;

    try {
      showStatus(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­: ${data.config.label} (${i + 1}/${selectedFiles.length})`, 'info');

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
      const content = await readFileAsText(data.file);

      // CSVãƒ‘ãƒ¼ã‚¹
      const csvData = parseCSV(content);

      // GASã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
      await uploadToSheet(data.config.sheetName, csvData);

      successCount++;
      showProgress(progress);

    } catch (error) {
      console.error(`Error uploading ${data.config.label}:`, error);
      errorCount++;
    }
  }

  showProgress(100);

  if (errorCount === 0) {
    showStatus(`âœ… ${successCount}ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼`, 'success');
    setTimeout(() => {
      google.script.host.close();
    }, 2000);
  } else {
    showStatus(`âš ï¸ ${successCount}ãƒ•ã‚¡ã‚¤ãƒ«æˆåŠŸã€${errorCount}ãƒ•ã‚¡ã‚¤ãƒ«å¤±æ•—`, 'error');
  }
}

// ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
function readFileAsText(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.onerror = (e) => reject(e);
    reader.readAsText(file, 'UTF-8');
  });
}

// CSVãƒ‘ãƒ¼ã‚¹
function parseCSV(text) {
  // BOMé™¤å»
  const cleanText = text.replace(/^\uFEFF/, '');

  // è¡Œåˆ†å‰²
  const lines = cleanText.split(/\r?\n/).filter(line => line.trim());

  // CSVè§£æ
  const result = lines.map(line => {
    // ç°¡æ˜“CSVãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆã‚¯ã‚©ãƒ¼ãƒˆå‡¦ç†ã¯çœç•¥ï¼‰
    return line.split(',').map(cell => cell.trim());
  });

  return result;
}

// GASã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
function uploadToSheet(sheetName, csvData) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .importCSVToSheet(sheetName, csvData);
  });
}

// UIé–¢æ•°
function showStatus(message, type) {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = 'status ' + type;
  status.style.display = 'block';
}

function showProgress(percent) {
  const container = document.getElementById('progressContainer');
  const bar = document.getElementById('progressBar');

  container.style.display = 'block';
  bar.style.width = percent + '%';
  bar.textContent = Math.round(percent) + '%';
}

function clearAll() {
  Object.keys(files).forEach(key => {
    files[key].file = null;
    updateFileStatus(key);
  });

  document.getElementById('fileSummary').style.display = 'none';
  document.getElementById('progressContainer').style.display = 'none';
  document.getElementById('status').style.display = 'none';
  document.getElementById('uploadButton').disabled = true;
}

// åˆæœŸåŒ–å®Ÿè¡Œ
init();
</script>
</body>
</html>
