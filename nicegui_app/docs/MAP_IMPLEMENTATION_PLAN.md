# 地図機能実装計画（採用版）

**作成日**: 2025-12-28
**採用機能**: 3機能
**総工数**: 約4.5時間

---

## 採用機能一覧

| # | 機能名 | 説明 | 工数 |
|---|--------|------|------|
| 1 | 流入元可視化 | 選択地域への希望勤務地流入を色分け + フィルタ | 2h |
| 2 | 流出/流入バランス | 市区町村ごとに優劣を色分け | 1h |
| 3 | 競合地域可視化 | 同じ求職者が希望する他地域を表示 | 1.5h |

---

## Step 1: フィルタUI追加（30分）

**目標**: 地図タブにフィルタプルダウンを追加

### UI設計
```
┌───────────────────────────────────────────────────┐
│ 雇用区分: [全て ▼]  年代: [全て ▼]  性別: [全て ▼] │
│ 表示モード: ○流入元 ○流出/流入 ○競合地域          │
└───────────────────────────────────────────────────┘
```

### フィルタオプション
- **雇用区分**: 全て / 正職員 / パート / その他
- **年代**: 全て / 20代 / 30代 / 40代 / 50代以上
- **性別**: 全て / 男性 / 女性
- **表示モード**: 流入元 / 流出/流入バランス / 競合地域

### 実装タスク
- [ ] main.py: フィルタUIコンポーネント追加
- [ ] state管理: フィルタ値の保持
- [ ] フィルタ変更時のコールバック

---

## Step 2: 流入元可視化（1.5時間）

**目標**: 選択した市区町村への流入元を色分け表示

### 動作フロー
1. 地図上で市区町村をクリック（または選択）
2. その市区町村を「希望勤務地」としている人の「居住地」を取得
3. 居住地を色分けして地図に表示
4. フィルタで雇用区分/年代/性別を絞り込み

### データ取得関数
```python
def get_inflow_sources(
    target_prefecture: str,
    target_municipality: str,
    workstyle: str = None,   # 正職員/パート/その他
    age_group: str = None,   # 20代/30代/40代/50代以上
    gender: str = None       # 男性/女性
) -> list:
    """
    Returns: [
        {
            "source_pref": "東京都",
            "source_muni": "渋谷区",
            "count": 50,
            "lat": 35.66,
            "lng": 139.70
        },
        ...
    ]
    """
```

### データソース
- `RESIDENCE_FLOW`: 居住地→希望勤務地のフロー
- `DESIRED_AREA_PATTERN`: 希望勤務地パターン（フィルタ用）

### カラースケール
| 人数 | 色 | 意味 |
|------|-----|------|
| 上位10% | 赤 | 主要流入元 |
| 上位30% | オレンジ | 重要流入元 |
| 上位60% | 黄 | 中程度 |
| それ以外 | 薄灰 | 少数 |

### 実装タスク
- [ ] db_helper.py: get_inflow_sources() 追加
- [ ] main.py: クリック選択機能
- [ ] main.py: 流入元マーカー色分け表示
- [ ] main.py: 選択地域ハイライト

---

## Step 3: 流出/流入バランス（1時間）

**目標**: 市区町村ごとに「人材集中」「人材流出」を色分け

### 計算ロジック
```python
# 流入比率 = 流入 / (流入 + 流出)
inflow_ratio = inflow / (inflow + outflow) if (inflow + outflow) > 0 else 0.5

# 純流入 = 流入 - 流出
net_flow = inflow - outflow
```

### データ取得関数
```python
def get_flow_balance(
    prefecture: str = None,
    workstyle: str = None,
    age_group: str = None,
    gender: str = None
) -> list:
    """
    Returns: [
        {
            "prefecture": "東京都",
            "municipality": "渋谷区",
            "inflow": 500,
            "outflow": 300,
            "net_flow": 200,
            "ratio": 0.625,  # 流入優位
            "lat": 35.66,
            "lng": 139.70
        },
        ...
    ]
    """
```

### カラースケール
| ratio | 色 | 意味 |
|-------|-----|------|
| > 0.65 | 濃い青 | 強い流入優位（人材が集まる） |
| 0.55-0.65 | 薄い青 | やや流入優位 |
| 0.45-0.55 | 白/灰 | バランス |
| 0.35-0.45 | 薄い赤 | やや流出優位 |
| < 0.35 | 濃い赤 | 強い流出優位（人材が出ていく） |

### 実装タスク
- [ ] db_helper.py: get_flow_balance() 追加
- [ ] main.py: バランス表示モード
- [ ] main.py: サークルマーカーで色分け表示
- [ ] main.py: 凡例追加

---

## Step 4: 競合地域可視化（1.5時間）

**目標**: 選択地域の求職者が他にどこを希望しているか表示

### 動作フロー
1. 地図上で市区町村をクリック（居住地として選択）
2. その市区町村に住んでいる人の「希望勤務地」を取得
3. 希望勤務地を色分けして地図に表示
4. 「この地域の求職者は、こちらも希望している」がわかる

### データ取得関数
```python
def get_competing_areas(
    source_prefecture: str,
    source_municipality: str,
    workstyle: str = None,
    age_group: str = None,
    gender: str = None
) -> list:
    """
    Returns: [
        {
            "target_pref": "東京都",
            "target_muni": "新宿区",
            "count": 80,  # この地域も希望している人数
            "percentage": 15.2,  # 全希望者に占める割合
            "lat": 35.69,
            "lng": 139.70
        },
        ...
    ]
    """
```

### ビジネス活用
- 「渋谷区の求職者の30%は新宿区も希望」→ 両方に求人が必要
- 競合が少ない地域 = 独占できる可能性

### カラースケール
| 割合 | 色 | 意味 |
|------|-----|------|
| > 20% | 赤 | 強い競合（多くの人が両方希望） |
| 10-20% | オレンジ | 中程度の競合 |
| 5-10% | 黄 | 弱い競合 |
| < 5% | 薄灰 | ほぼ競合なし |

### 実装タスク
- [ ] db_helper.py: get_competing_areas() 追加
- [ ] main.py: 競合地域表示モード
- [ ] main.py: 選択地域からの線を表示（オプション）
- [ ] main.py: 競合度ランキングパネル

---

## 実装順序

```
Step 1: フィルタUI追加 (30分)
    ↓
Step 2: 流入元可視化 (1.5時間)
    ↓
Step 3: 流出/流入バランス (1時間)
    ↓
Step 4: 競合地域可視化 (1.5時間)
```

**合計**: 約4.5時間

---

## ファイル変更一覧

| ファイル | 変更内容 |
|----------|----------|
| db_helper.py | get_inflow_sources(), get_flow_balance(), get_competing_areas() 追加 |
| main.py | 人材地図タブのUI拡張（フィルタ、表示モード切替、色分け） |

---

## UI完成イメージ

```
┌─────────────────────────────────────────────────────────┐
│ 人材地図                                                │
├─────────────────────────────────────────────────────────┤
│ 雇用区分: [全て ▼]  年代: [全て ▼]  性別: [全て ▼]      │
│                                                         │
│ 表示モード:                                             │
│ ● 流入元（どこから希望が来ているか）                    │
│ ○ 流出/流入バランス                                    │
│ ○ 競合地域（どこも希望しているか）                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│            ┌──────────────────────┐                    │
│            │                      │                    │
│            │    [地図表示エリア]   │                    │
│            │                      │                    │
│            │  クリックで選択      │                    │
│            │                      │                    │
│            └──────────────────────┘                    │
│                                                         │
├─────────────────────────────────────────────────────────┤
│ 凡例: ■赤=多い ■オレンジ=中 ■黄=少 ■灰=なし           │
│                                                         │
│ 選択中: 東京都渋谷区                                    │
│ 流入元TOP3: 1.世田谷区(120人) 2.目黒区(85人) 3.新宿区   │
└─────────────────────────────────────────────────────────┘
```

---

## 次のアクション

Step 1から実装を開始しますか？
