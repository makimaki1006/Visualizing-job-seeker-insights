# 地図機能拡張計画 V2

**作成日**: 2025-12-28
**目的**: ユーザー要望 + 追加提案を統合した地図機能ロードマップ

---

## 機能一覧

### ユーザー要望

| # | 機能 | 説明 | データソース |
|---|------|------|-------------|
| 1 | 流入元可視化 | 選択地域への希望勤務地流入を色分け | RESIDENCE_FLOW |
| 2 | 雇用区分フィルタ | 正職員/パート/その他で切替 | WORKSTYLE_MOBILITY |
| 3 | 年齢・性別フィルタ | プルダウンで切替 | AGE_GENDER |
| 4 | 流出/流入バランス | 市区町村ごとに優劣を色分け | FLOW (inflow/outflow) |

### 追加提案

| # | 機能 | 説明 | データソース |
|---|------|------|-------------|
| 5 | 競合地域可視化 | 同じ求職者が希望する他地域 | DESIRED_AREA_PATTERN |
| 6 | 資格別人材分布 | 国家資格保持者の集中エリア | QUALIFICATION_PERSONA |
| 7 | 緊急度ヒートマップ | 「今すぐ転職」希望者の分布 | URGENCY_DISTRIBUTION |
| 8 | 採用効率スコア | 供給過多×低競争×高緊急度 | GAP, COMPETITION, URGENCY |

---

## 実装フェーズ

### Phase A: フィルタ基盤（1時間）

**目標**: 地図にフィルタUI追加

```
┌─────────────────────────────────────┐
│ 雇用区分: [全て ▼]  年代: [全て ▼]  │
│ 性別: [全て ▼]  表示: [流入 ▼]      │
└─────────────────────────────────────┘
```

**タスク**:
- [ ] 雇用区分プルダウン（全て/正職員/パート/その他）
- [ ] 年代プルダウン（全て/20代/30代/40代/50代以上）
- [ ] 性別プルダウン（全て/男性/女性）
- [ ] フィルタ変更時に地図を更新

---

### Phase B: 流入元可視化（1.5時間）

**目標**: 選択した市区町村への流入元を色分け表示

**UI**:
1. 地図上で市区町村をクリック
2. その市区町村を希望勤務地としている人の居住地を色分け
3. 色の濃さ = 人数

**データ処理**:
```python
# 選択した市区町村を希望勤務地としている人の居住地
def get_inflow_sources(target_municipality: str, filters: dict) -> list:
    """
    Returns: [
        {"source_pref": "東京都", "source_muni": "渋谷区", "count": 50, "lat": ..., "lng": ...},
        ...
    ]
    """
```

**カラースケール**:
- 赤: 多い（上位20%）
- オレンジ: 中程度
- 黄: 少ない
- 灰色: なし

---

### Phase C: 流出/流入バランス（1時間）

**目標**: 市区町村ごとに「流入優位」「流出優位」を色分け

**計算式**:
```
net_flow = inflow - outflow
ratio = inflow / (inflow + outflow)
```

**カラースケール**:
- 青（濃）: 流入優位（ratio > 0.6）= 人材が集まる
- 青（薄）: やや流入優位（0.5-0.6）
- 白: バランス（0.4-0.6）
- 赤（薄）: やや流出優位（0.4-0.5）
- 赤（濃）: 流出優位（ratio < 0.4）= 人材が出ていく

**データソース**: `FLOW` row_type
- inflow: 流入数
- outflow: 流出数
- net_flow: 純流入

---

### Phase D: 競合地域可視化（1時間）

**目標**: 「この地域の求職者は他にどこを希望しているか」

**UI**:
1. 市区町村を選択
2. その市区町村に住んでいる人が希望する他の勤務地を表示
3. 色の濃さ = 希望人数

**ビジネス価値**:
- 求人を出す際の競合エリアがわかる
- 「渋谷区の求職者は新宿区も希望している」→ 両方に求人が必要

---

### Phase E: 資格別人材分布（45分）

**目標**: 国家資格保持者の集中エリアをヒートマップ表示

**フィルタ**:
- 資格種別: 介護福祉士/看護師/理学療法士など
- 表示: 人数 or 割合

**カラースケール**:
- 緑（濃）: 有資格者が多い
- 緑（薄）: やや多い
- 白: 平均
- 灰色: 少ない

---

### Phase F: 緊急度ヒートマップ（45分）

**目標**: 「今すぐ転職したい」人の分布

**データソース**: `URGENCY_DISTRIBUTION`
- category1: 緊急度（今すぐ/1ヶ月以内/3ヶ月以内/...）

**カラースケール**:
- 赤: 緊急度高い人が多い
- オレンジ: 中程度
- 黄: 低め
- 灰色: データなし

---

### Phase G: 採用効率スコア（1時間）

**目標**: 複合指標で「採用しやすいエリア」を自動算出

**計算式**:
```
採用効率スコア =
    (供給過多度 × 0.4) +      # GAP
    (低競争度 × 0.3) +        # 1 - COMPETITION
    (高緊急度 × 0.3)          # URGENCY
```

**表示**:
- 総合スコアでランキング表示
- 地図上に色分け表示
- クリックで詳細内訳

---

## 優先順位

| 優先度 | Phase | 機能 | 工数 | ビジネス価値 |
|--------|-------|------|------|-------------|
| ★★★ | B | 流入元可視化 | 1.5h | 採用戦略の基盤 |
| ★★★ | C | 流出/流入バランス | 1h | 人材動向の把握 |
| ★★☆ | A | フィルタ基盤 | 1h | 全機能の前提 |
| ★★☆ | G | 採用効率スコア | 1h | 意思決定支援 |
| ★★☆ | D | 競合地域 | 1h | 求人戦略 |
| ★☆☆ | E | 資格別分布 | 45m | 専門職採用 |
| ★☆☆ | F | 緊急度ヒートマップ | 45m | 即戦力採用 |

**推奨実装順序**: A → B → C → G → D → E → F

---

## 技術要件

### 必要なdb_helper関数

```python
# Phase B: 流入元可視化
def get_inflow_sources(target_muni: str, workstyle: str = None, age: str = None, gender: str = None) -> list

# Phase C: 流出/流入バランス
def get_flow_balance(prefecture: str = None) -> list

# Phase D: 競合地域
def get_competing_areas(source_muni: str) -> list

# Phase E: 資格別分布
def get_qualification_distribution(qualification: str = None) -> list

# Phase G: 採用効率スコア
def get_recruitment_efficiency_score(prefecture: str = None) -> list
```

### UIコンポーネント

- プルダウンフィルタ（雇用区分/年代/性別）
- カラースケール凡例
- クリック選択 + 詳細パネル
- 表示モード切替（流入/流出/バランス/効率）

---

## 次のステップ

1. Phase A（フィルタ基盤）を実装
2. Phase B（流入元可視化）を実装
3. Phase C（流出/流入バランス）を実装
4. 動作確認後、残りを順次実装
