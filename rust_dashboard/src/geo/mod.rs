pub mod choropleth;

use serde_json::Value;
use std::collections::HashMap;
use std::path::Path;

/// 都道府県名→コードのマッピング
pub fn pref_name_to_code() -> HashMap<&'static str, &'static str> {
    let mut m = HashMap::new();
    let names = [
        ("北海道", "01"), ("青森県", "02"), ("岩手県", "03"), ("宮城県", "04"),
        ("秋田県", "05"), ("山形県", "06"), ("福島県", "07"), ("茨城県", "08"),
        ("栃木県", "09"), ("群馬県", "10"), ("埼玉県", "11"), ("千葉県", "12"),
        ("東京都", "13"), ("神奈川県", "14"), ("新潟県", "15"), ("富山県", "16"),
        ("石川県", "17"), ("福井県", "18"), ("山梨県", "19"), ("長野県", "20"),
        ("岐阜県", "21"), ("静岡県", "22"), ("愛知県", "23"), ("三重県", "24"),
        ("滋賀県", "25"), ("京都府", "26"), ("大阪府", "27"), ("兵庫県", "28"),
        ("奈良県", "29"), ("和歌山県", "30"), ("鳥取県", "31"), ("島根県", "32"),
        ("岡山県", "33"), ("広島県", "34"), ("山口県", "35"), ("徳島県", "36"),
        ("香川県", "37"), ("愛媛県", "38"), ("高知県", "39"), ("福岡県", "40"),
        ("佐賀県", "41"), ("長崎県", "42"), ("熊本県", "43"), ("大分県", "44"),
        ("宮崎県", "45"), ("鹿児島県", "46"), ("沖縄県", "47"),
    ];
    for (name, code) in names {
        m.insert(name, code);
    }
    m
}

/// 都道府県の中心座標
pub fn pref_center(pref: &str) -> (f64, f64) {
    match pref {
        "北海道" => (43.06, 141.35), "青森県" => (40.82, 140.74),
        "岩手県" => (39.70, 141.15), "宮城県" => (38.27, 140.87),
        "秋田県" => (39.72, 140.10), "山形県" => (38.24, 140.34),
        "福島県" => (37.75, 140.47), "茨城県" => (36.34, 140.45),
        "栃木県" => (36.57, 139.88), "群馬県" => (36.39, 139.06),
        "埼玉県" => (35.86, 139.65), "千葉県" => (35.60, 140.12),
        "東京都" => (35.68, 139.69), "神奈川県" => (35.45, 139.64),
        "新潟県" => (37.90, 139.02), "富山県" => (36.70, 137.21),
        "石川県" => (36.59, 136.63), "福井県" => (36.07, 136.22),
        "山梨県" => (35.66, 138.57), "長野県" => (36.23, 138.18),
        "岐阜県" => (35.39, 136.72), "静岡県" => (34.98, 138.38),
        "愛知県" => (35.18, 136.91), "三重県" => (34.73, 136.51),
        "滋賀県" => (35.00, 135.87), "京都府" => (35.02, 135.76),
        "大阪府" => (34.69, 135.52), "兵庫県" => (34.69, 135.18),
        "奈良県" => (34.69, 135.83), "和歌山県" => (34.23, 135.17),
        "鳥取県" => (35.50, 134.24), "島根県" => (35.47, 133.05),
        "岡山県" => (34.66, 133.93), "広島県" => (34.40, 132.46),
        "山口県" => (34.19, 131.47), "徳島県" => (34.07, 134.56),
        "香川県" => (34.34, 134.04), "愛媛県" => (33.84, 132.77),
        "高知県" => (33.56, 133.53), "福岡県" => (33.61, 130.42),
        "佐賀県" => (33.25, 130.30), "長崎県" => (32.74, 129.87),
        "熊本県" => (32.79, 130.74), "大分県" => (33.24, 131.61),
        "宮崎県" => (31.91, 131.42), "鹿児島県" => (31.56, 130.56),
        "沖縄県" => (26.34, 127.68),
        _ => (36.5, 138.0), // 日本中心
    }
}

/// GeoJSONファイルを読み込む
pub fn load_geojson(geojson_dir: &str, pref_name: &str) -> Result<Value, String> {
    let code_map = pref_name_to_code();
    let code = code_map
        .get(pref_name)
        .ok_or_else(|| format!("Unknown prefecture: {pref_name}"))?;

    // ファイル名パターン: 01_hokkaido.json
    let pattern = format!("{code}_");
    let dir = Path::new(geojson_dir);
    if !dir.exists() {
        return Err(format!("GeoJSON directory not found: {geojson_dir}"));
    }

    for entry in std::fs::read_dir(dir).map_err(|e| format!("Read dir failed: {e}"))? {
        let entry = entry.map_err(|e| format!("Dir entry error: {e}"))?;
        let name = entry.file_name().to_string_lossy().to_string();
        if name.starts_with(&pattern) && name.ends_with(".json") {
            let content =
                std::fs::read_to_string(entry.path()).map_err(|e| format!("Read file error: {e}"))?;
            let geojson: Value =
                serde_json::from_str(&content).map_err(|e| format!("Parse GeoJSON error: {e}"))?;
            return Ok(geojson);
        }
    }

    Err(format!("GeoJSON file not found for: {pref_name}"))
}
