<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - æ±‚è·è€…ãƒ‡ãƒ¼ã‚¿åˆ†æ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { navy: { 900: '#0d1525', 800: '#0f172a', 700: '#1e293b' } } } }
        }
    </script>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body class="bg-navy-900 text-slate-100 min-h-screen">
    <header class="bg-navy-800 border-b border-slate-700 px-6 py-3 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <h1 class="text-lg font-bold text-white">job_ap_analyzer_gui</h1>
            <span class="text-slate-400 text-sm">ğŸ”§</span>
            <select id="job-type-select"
                class="bg-navy-700 border border-slate-600 rounded-lg px-3 py-1.5 text-sm text-white">
                {{JOB_OPTIONS}}
            </select>
            <span class="text-slate-400 text-sm">ğŸ“</span>
            <select id="pref-select"
                class="bg-navy-700 border border-slate-600 rounded-lg px-3 py-1.5 text-sm text-white">
                <option value="">å…¨å›½</option>
                {{PREF_OPTIONS}}
            </select>
            <select id="muni-select"
                class="bg-navy-700 border border-slate-600 rounded-lg px-3 py-1.5 text-sm text-white">
                <option value="">ã™ã¹ã¦</option>
                {{MUNI_OPTIONS}}
            </select>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-slate-400 text-sm">ãƒ­ã‚°ã‚¤ãƒ³: {{USER_EMAIL}}</span>
            <a href="/logout" class="text-slate-400 hover:text-white text-sm transition">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
        </div>
    </header>

    {{TURSO_WARNING}}

    <nav class="bg-navy-800 border-b border-slate-700 px-6 flex gap-1 overflow-x-auto">
        <button class="tab-btn active" hx-get="/tab/overview" hx-target="#content" hx-swap="innerHTML"
            onclick="setActiveTab(this)">ğŸ“Š å¸‚å ´æ¦‚æ³</button>
        <button class="tab-btn" hx-get="/tab/demographics" hx-target="#content" hx-swap="innerHTML"
            onclick="setActiveTab(this)">ğŸ‘¥ äººæå±æ€§</button>
        <button class="tab-btn" hx-get="/tab/mobility" hx-target="#content" hx-swap="innerHTML"
            onclick="setActiveTab(this)">ğŸ—ºï¸ åœ°åŸŸãƒ»ç§»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³</button>
        <button class="tab-btn" hx-get="/tab/balance" hx-target="#content" hx-swap="innerHTML"
            onclick="setActiveTab(this)">âš–ï¸ éœ€çµ¦ãƒãƒ©ãƒ³ã‚¹</button>
        <button class="tab-btn" hx-get="/tab/workstyle" hx-target="#content" hx-swap="innerHTML"
            onclick="setActiveTab(this)">ğŸ“ˆ é›‡ç”¨å½¢æ…‹åˆ†æ</button>
        <button class="tab-btn" hx-get="/tab/jobmap" hx-target="#content" hx-swap="innerHTML"
            onclick="setActiveTab(this)">ğŸ—ºï¸ æ±‚äººåœ°å›³</button>
        <button class="tab-btn" hx-get="/tab/talentmap" hx-target="#content" hx-swap="innerHTML"
            onclick="setActiveTab(this)">ğŸ“ äººæåœ°å›³</button>
        <button class="tab-btn" hx-get="/tab/competitive" hx-target="#content" hx-swap="innerHTML"
            onclick="setActiveTab(this)">ğŸ” ç«¶åˆèª¿æŸ»</button>
        <button class="tab-btn" hx-get="/tab/segment" hx-target="#content" hx-swap="innerHTML"
            onclick="setActiveTab(this)">ğŸ¯ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†æ</button>
    </nav>

    <main id="content" class="p-6">
        <div class="text-center text-slate-400 py-20">
            <p class="text-lg">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    </main>

    <script src="/static/js/app.js"></script>
    <script src="/static/js/charts.js"></script>
    <script src="/static/js/maps.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            htmx.ajax('GET', '/tab/overview', {target: '#content', swap: 'innerHTML'});

            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–å†èª­ã¿è¾¼ã¿å…±é€šé–¢æ•°
            function reloadActiveTab() {
                var activeBtn = document.querySelector('.tab-btn.active');
                if (activeBtn) {
                    var url = activeBtn.getAttribute('hx-get');
                    htmx.ajax('GET', url, {target: '#content', swap: 'innerHTML'});
                }
            }

            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³å®‰å…¨æ›´æ–°ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚Œã‚‹optionè¦ç´ ã®ã¿è¨±å¯ï¼‰
            function safeSetOptions(selectEl, optionHtml, defaultOption) {
                while (selectEl.options.length > 0) { selectEl.remove(0); }
                var def = document.createElement('option');
                def.value = '';
                def.textContent = defaultOption;
                selectEl.appendChild(def);
                if (optionHtml) {
                    var tmp = document.createElement('select');
                    tmp.insertAdjacentHTML('afterbegin', optionHtml);
                    while (tmp.firstChild) { selectEl.appendChild(tmp.firstChild); }
                }
                selectEl.selectedIndex = 0;
            }

            // è·ç¨®åˆ‡ã‚Šæ›¿ãˆ
            var jobSelect = document.getElementById('job-type-select');
            if (jobSelect) {
                jobSelect.addEventListener('change', function() {
                    var jt = this.value;
                    fetch('/api/set_job_type', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: 'job_type=' + encodeURIComponent(jt)
                    }).then(function() {
                        return fetch('/api/prefectures?job_type=' + encodeURIComponent(jt));
                    }).then(function(r) { return r.text(); }).then(function(html) {
                        safeSetOptions(document.getElementById('pref-select'), html, 'å…¨å›½');
                        safeSetOptions(document.getElementById('muni-select'), '', 'ã™ã¹ã¦');
                        reloadActiveTab();
                    });
                });
            }

            // éƒ½é“åºœçœŒåˆ‡ã‚Šæ›¿ãˆ
            var prefSelect = document.getElementById('pref-select');
            if (prefSelect) {
                prefSelect.addEventListener('change', function() {
                    var pref = this.value;
                    fetch('/api/set_prefecture', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: 'prefecture=' + encodeURIComponent(pref)
                    }).then(function() {
                        if (pref) {
                            return fetch('/api/municipalities_cascade?prefecture=' + encodeURIComponent(pref));
                        } else {
                            return Promise.resolve({ text: function() { return ''; } });
                        }
                    }).then(function(r) { return r.text(); }).then(function(html) {
                        safeSetOptions(document.getElementById('muni-select'), html, 'ã™ã¹ã¦');
                        reloadActiveTab();
                    });
                });
            }

            // å¸‚åŒºç”ºæ‘åˆ‡ã‚Šæ›¿ãˆ
            var muniSelect = document.getElementById('muni-select');
            if (muniSelect) {
                muniSelect.addEventListener('change', function() {
                    var muni = this.value;
                    fetch('/api/set_municipality', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: 'municipality=' + encodeURIComponent(muni)
                    }).then(function() {
                        reloadActiveTab();
                    });
                });
            }
        });
        function setActiveTab(el) {
            document.querySelectorAll('.tab-btn').forEach(function(btn) { btn.classList.remove('active'); });
            el.classList.add('active');
        }
    </script>
</body>
</html>
