<!-- ã‚¿ãƒ–8: ç«¶åˆèª¿æŸ» ãƒ‘ãƒ¼ã‚·ãƒ£ãƒ«HTML -->
<div class="space-y-6">
    <h2 class="text-xl font-bold text-white">ğŸ” ç«¶åˆèª¿æŸ» <span class="text-blue-400 text-base font-normal">{{JOB_TYPE}}</span></h2>

    <!-- KPIã‚«ãƒ¼ãƒ‰ -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="stat-card">
            <div class="text-sm text-slate-400">è©²å½“ä»¶æ•°</div>
            <div class="text-3xl font-bold text-emerald-400">{{TOTAL_POSTINGS}}</div>
        </div>
        <div class="stat-card">
            <div class="text-sm text-slate-400">æ–½è¨­æ•°</div>
            <div class="text-3xl font-bold text-cyan-400">{{TOTAL_FACILITIES}}</div>
        </div>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
    <div class="stat-card">
        <h3 class="text-sm text-slate-400 mb-3">æ±‚äººæ¤œç´¢</h3>
        <div class="flex flex-wrap gap-3 items-end">
            <div>
                <label class="block text-xs text-slate-400 mb-1">éƒ½é“åºœçœŒ</label>
                <select id="comp-pref"
                    class="bg-navy-700 border border-slate-600 rounded px-2 py-1.5 text-sm text-white"
                    hx-get="/api/competitive/municipalities"
                    hx-target="#comp-muni"
                    hx-swap="innerHTML"
                    hx-include="[name='prefecture']"
                    name="prefecture"
                    onchange="updateFacilityTypes(this.value)">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    {{PREF_OPTIONS}}
                </select>
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1">å¸‚åŒºç”ºæ‘</label>
                <select id="comp-muni" name="municipality"
                    class="bg-navy-700 border border-slate-600 rounded px-2 py-1.5 text-sm text-white">
                    <option value="">å…¨ã¦</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1">é›‡ç”¨å½¢æ…‹</label>
                <select id="comp-emp" name="employment_type"
                    class="bg-navy-700 border border-slate-600 rounded px-2 py-1.5 text-sm text-white">
                    <option value="">å…¨ã¦</option>
                    <option value="æ­£è·å“¡">æ­£è·å“¡</option>
                    <option value="å¥‘ç´„è·å“¡">å¥‘ç´„è·å“¡</option>
                    <option value="ãƒ‘ãƒ¼ãƒˆãƒ»ãƒã‚¤ãƒˆ">ãƒ‘ãƒ¼ãƒˆãƒ»ãƒã‚¤ãƒˆ</option>
                </select>
            </div>
            <!-- æ–½è¨­å½¢æ…‹: 2éšå±¤é¸æŠï¼ˆå¤§ã‚«ãƒ†ã‚´ãƒªâ†’ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªï¼‰ -->
            <div class="relative" id="ftype-dropdown-container">
                <label class="block text-xs text-slate-400 mb-1">æ–½è¨­å½¢æ…‹</label>
                <button type="button" onclick="toggleFtypeDropdown()" id="ftype-btn"
                    class="bg-navy-700 border border-slate-600 rounded px-2 py-1.5 text-sm text-white text-left min-w-[160px] flex items-center gap-1">
                    <span id="ftype-btn-text">å…¨ã¦</span>
                    <svg class="w-3 h-3 ml-auto text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div id="ftype-panel" class="hidden absolute z-50 mt-1 bg-navy-700 border border-slate-600 rounded-lg shadow-lg max-h-96 overflow-y-auto p-2" style="min-width:340px;">
                    <div class="flex justify-between items-center mb-2 border-b border-slate-600 pb-1">
                        <span class="text-xs text-slate-400">æ–½è¨­å½¢æ…‹ã‚’é¸æŠï¼ˆå±•é–‹ã§ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªè¡¨ç¤ºï¼‰</span>
                        <button type="button" onclick="clearFtypes()" class="text-xs text-blue-400 hover:text-blue-300">å…¨ã¦è§£é™¤</button>
                    </div>
                    <div id="ftype-list">
                        {{FTYPE_CHECKBOXES}}
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <label class="flex items-center gap-1 text-sm text-slate-300">
                    <input type="checkbox" id="comp-nearby" class="rounded">
                    è¿‘è¾ºã‚¨ãƒªã‚¢ã‚‚å«ã‚ã‚‹
                </label>
                <select id="comp-radius"
                    class="bg-navy-700 border border-slate-600 rounded px-2 py-1.5 text-sm text-white">
                    <option value="10">10km</option>
                    <option value="20">20km</option>
                    <option value="50">50km</option>
                </select>
            </div>
            <button onclick="searchCompetitive()"
                class="px-4 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-sm rounded-lg transition">
                æ¤œç´¢
            </button>
        </div>
        <p class="text-xs text-slate-500 mt-2">â€» å¸‚åŒºç”ºæ‘ã‚’é¸æŠã—ãªã„å ´åˆã€éƒ½é“åºœçœŒå…¨ä½“ã§æ¤œç´¢ã—ã¾ã™</p>
    </div>

    <!-- æ¤œç´¢çµæœï¼ˆHTMXã§å‹•çš„æ›´æ–°ï¼‰ -->
    <div id="comp-results">
        <p class="text-slate-400 text-sm">éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</p>
    </div>

    <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†æï¼ˆç‹¬ç«‹ã‚¿ãƒ–ã¸ç§»å‹•ï¼‰ -->
    <div class="stat-card">
        <div class="flex items-center justify-between">
            <h3 class="text-sm text-slate-400">æ±‚äººã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†æ</h3>
            <button hx-get="/tab/segment" hx-target="#content" hx-swap="innerHTML"
                onclick="document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.querySelectorAll('.tab-btn')[8].classList.add('active')"
                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm rounded-lg transition flex items-center gap-2">
                ğŸ¯ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†æã‚¿ãƒ–ã¸ â†’
            </button>
        </div>
        <p class="text-slate-500 text-sm mt-2">5è»¸åˆ†å¸ƒãƒ»Tier3ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ»ã‚¿ã‚°åˆ†æãƒ»ãƒ†ã‚­ã‚¹ãƒˆç‰¹å¾´ãƒ»çµ¦ä¸æ¯”è¼ƒãƒ»ä»•äº‹å†…å®¹åˆ†æã¯å°‚ç”¨ã‚¿ãƒ–ã«ç§»å‹•ã—ã¾ã—ãŸ</p>
    </div>

    <!-- æ±‚äººãƒ‡ãƒ¼ã‚¿åˆ†æãƒ‘ãƒãƒ« -->
    <div class="stat-card">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm text-slate-400">æ±‚äººãƒ‡ãƒ¼ã‚¿åˆ†æ</h3>
            <div class="flex gap-2 items-center">
                <button onclick="loadAnalysis()"
                    class="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 text-white text-sm rounded-lg transition">
                    å…¨å›½ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æ
                </button>
                <button onclick="loadAnalysisFiltered()"
                    class="px-3 py-1.5 bg-teal-600 hover:bg-teal-500 text-white text-sm rounded-lg transition">
                    é¸æŠåœ°åŸŸã§åˆ†æ
                </button>
            </div>
        </div>
        <div id="comp-analysis">
            <p class="text-slate-500 text-sm">ã€Œå…¨å›½ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã€ã¾ãŸã¯åœ°åŸŸã‚’é¸æŠã—ã¦ã€Œé¸æŠåœ°åŸŸã§åˆ†æã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
        </div>
    </div>

    <div class="grid-charts">
        <!-- éƒ½é“åºœçœŒåˆ¥æ±‚äººæ•°ãƒãƒ£ãƒ¼ãƒˆ -->
        <div class="stat-card">
            <h3 class="text-sm text-slate-400 mb-3">éƒ½é“åºœçœŒåˆ¥ æ±‚äººæ•°ï¼ˆä¸Šä½15ï¼‰</h3>
            <div class="echart" style="height:400px;" data-chart-config='{
                "tooltip": {"trigger": "axis", "axisPointer": {"type": "shadow"}},
                "xAxis": {"type": "value"},
                "yAxis": {"type": "category", "data": {{PREF_LABELS}}, "inverse": true},
                "series": [{"type": "bar", "data": {{PREF_VALUES}}, "itemStyle": {"color": "#D55E00", "borderRadius": [0,4,4,0]}, "barWidth": "60%"}],
                "grid": {"left": "25%", "right": "5%"}
            }'></div>
        </div>

        <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="stat-card">
            <h3 class="text-sm text-slate-400 mb-3">éƒ½é“åºœçœŒåˆ¥ æ±‚äººæ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
            <div style="overflow-x:auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="text-center" style="width:50px">é †ä½</th>
                            <th>éƒ½é“åºœçœŒ</th>
                            <th class="text-right">æ±‚äººæ•°</th>
                        </tr>
                    </thead>
                    <tbody>{{PREF_ROWS}}</tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// --- 2éšå±¤æ–½è¨­å½¢æ…‹ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆ¶å¾¡ ---

function toggleFtypeDropdown() {
    document.getElementById('ftype-panel').classList.toggle('hidden');
}

function clearFtypes() {
    document.querySelectorAll('.ftype-major-cb, .ftype-sub-cb').forEach(function(cb) { cb.checked = false; });
    updateFtypeLabel();
}

// ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªå±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
function toggleSubTypes(groupId) {
    var panel = document.getElementById('sub-' + groupId);
    var arrow = document.getElementById('arrow-' + groupId);
    if (panel) {
        panel.classList.toggle('hidden');
        if (arrow) arrow.classList.toggle('rotate-90');
    }
}

// å¤§ã‚«ãƒ†ã‚´ãƒªãƒã‚§ãƒƒã‚¯æ™‚: ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚’å…¨OFFï¼ˆå¤§ã‚«ãƒ†ã‚´ãƒªå…¨ä½“ã§æ¤œç´¢ï¼‰
function onMajorToggle(majorCb) {
    var group = majorCb.getAttribute('data-group');
    if (group) {
        document.querySelectorAll('.ftype-sub-cb[data-group="' + group + '"]').forEach(function(cb) { cb.checked = false; });
    }
    updateFtypeLabel();
}

// ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒã‚§ãƒƒã‚¯æ™‚: å¤§ã‚«ãƒ†ã‚´ãƒªã‚’OFF
function onSubToggle(subCb) {
    var group = subCb.getAttribute('data-group');
    if (group) {
        var majorCb = document.querySelector('.ftype-major-cb[data-group="' + group + '"]');
        if (majorCb && subCb.checked) majorCb.checked = false;
    }
    updateFtypeLabel();
}

function updateFtypeLabel() {
    var majorChecked = document.querySelectorAll('.ftype-major-cb:checked');
    var subChecked = document.querySelectorAll('.ftype-sub-cb:checked');
    var btn = document.getElementById('ftype-btn-text');
    var total = majorChecked.length + subChecked.length;
    if (total === 0) {
        btn.textContent = 'å…¨ã¦';
    } else if (majorChecked.length > 0 && subChecked.length === 0) {
        if (majorChecked.length === 1) {
            var span = majorChecked[0].parentElement.querySelector('span.flex-1');
            btn.textContent = span ? span.textContent.trim() : '1ã‚«ãƒ†ã‚´ãƒª';
        } else {
            btn.textContent = majorChecked.length + 'ã‚«ãƒ†ã‚´ãƒª';
        }
    } else {
        btn.textContent = subChecked.length + 'ç¨®åˆ¥é¸æŠ';
    }
}

// é¸æŠã•ã‚ŒãŸãƒ•ã‚£ãƒ«ã‚¿å€¤ã‚’å–å¾—ï¼ˆå¤§ã‚«ãƒ†ã‚´ãƒª or ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªï¼‰
function getSelectedFtypes() {
    var vals = [];
    document.querySelectorAll('.ftype-major-cb:checked').forEach(function(cb) { vals.push(cb.value); });
    document.querySelectorAll('.ftype-sub-cb:checked').forEach(function(cb) { vals.push(cb.value); });
    return vals.join(',');
}

// ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.addEventListener('click', function(e) {
    var container = document.getElementById('ftype-dropdown-container');
    if (container && !container.contains(e.target)) {
        document.getElementById('ftype-panel').classList.add('hidden');
    }
});

// éƒ½é“åºœçœŒå¤‰æ›´æ™‚ã«æ–½è¨­å½¢æ…‹ã‚’2éšå±¤ã§å†å–å¾—ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°HTMLï¼‰
function updateFacilityTypes(pref) {
    fetch('/api/competitive/facility_types?prefecture=' + encodeURIComponent(pref))
        .then(function(r) { return r.text(); })
        .then(function(responseHtml) {
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ä¿¡é ¼æ¸ˆã¿HTMLã‚’DOMParserã§å®‰å…¨ã«ãƒ‘ãƒ¼ã‚¹
            var parser = new DOMParser();
            var doc = parser.parseFromString(responseHtml, 'text/html');
            var container = document.getElementById('ftype-list');
            // æ—¢å­˜ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã€ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸãƒãƒ¼ãƒ‰ã‚’ç§»æ¤
            while (container.firstChild) container.removeChild(container.firstChild);
            var nodes = doc.body.childNodes;
            while (nodes.length > 0) {
                container.appendChild(document.adoptNode(nodes[0]));
            }
            updateFtypeLabel();
        });
}

// --- æ¤œç´¢ãƒ»åˆ†æ ---

function searchCompetitive() {
    var pref = document.getElementById('comp-pref').value;
    var muni = document.getElementById('comp-muni').value;
    var emp = document.getElementById('comp-emp').value;
    var ftype = getSelectedFtypes();
    var nearby = document.getElementById('comp-nearby').checked;
    var radius = document.getElementById('comp-radius').value;

    if (!pref) {
        var el = document.getElementById('comp-results');
        el.textContent = '';
        var p = document.createElement('p');
        p.className = 'text-amber-400 text-sm';
        p.textContent = 'éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„';
        el.appendChild(p);
        return;
    }

    var url = '/api/competitive/filter?prefecture=' + encodeURIComponent(pref)
        + '&municipality=' + encodeURIComponent(muni)
        + '&employment_type=' + encodeURIComponent(emp)
        + '&facility_type=' + encodeURIComponent(ftype)
        + '&nearby=' + nearby
        + '&radius_km=' + radius;

    htmx.ajax('GET', url, {target: '#comp-results', swap: 'innerHTML'});
}

function loadAnalysis() {
    htmx.ajax('GET', '/api/competitive/analysis', {
        target: '#comp-analysis',
        swap: 'innerHTML'
    });
}

function loadAnalysisFiltered() {
    var pref = document.getElementById('comp-pref').value;
    var muni = document.getElementById('comp-muni').value;
    var url = '/api/competitive/analysis/filter?prefecture=' + encodeURIComponent(pref)
        + '&municipality=' + encodeURIComponent(muni);
    htmx.ajax('GET', url, {
        target: '#comp-analysis',
        swap: 'innerHTML'
    });
}
</script>
