<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <style>
    body{font-family:Arial,sans-serif;padding:20px}
    .upload-area{border:2px dashed #ccc;border-radius:4px;padding:30px;text-align:center;margin:20px 0;cursor:pointer}
    .upload-area:hover{border-color:#4285f4}
    .upload-area.dragover{background:#f5f7ff}
    #fileInput{display:none}
    .button{background:#4285f4;color:#fff;padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-size:14px;margin:5px}
    .button:disabled{background:#ccc;cursor:not-allowed}
    .button.secondary{background:#6c757d}
    .status{margin:10px 0;padding:10px;border-radius:4px;display:none}
    .status.success{background:#d4edda;color:#155724}
    .status.error{background:#f8d7da;color:#721c24}
    .status.info{background:#d1ecf1;color:#0c5460}
    .status.warning{background:#fff3cd;color:#856404}
    .file-info{margin:10px 0;padding:10px;background:#f5f5f5;border-radius:4px;display:none;font-size:14px}
    .progress-container{width:100%;height:30px;background:#f0f0f0;border-radius:15px;margin:20px 0;overflow:hidden;display:none}
    .progress-bar{height:100%;background:linear-gradient(90deg,#4285f4,#66a6ff);transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:white;font-size:14px}
    .analysis-results{margin:20px 0;padding:15px;background:#f8f9fa;border-radius:8px;display:none}
    .result-item{margin:10px 0;padding:8px;background:white;border-radius:4px;border-left:4px solid #4285f4}
    .tabs{display:flex;gap:10px;margin:20px 0}
    .tab{padding:8px 16px;background:#e0e0e0;border-radius:4px;cursor:pointer;transition:0.3s}
    .tab.active{background:#4285f4;color:white}
    .tab-content{display:none;margin:20px 0}
    .tab-content.active{display:block}
    h4{color:#333;margin-top:20px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:15px 0}
    .stat-card{padding:15px;background:white;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);text-align:center}
    .stat-value{font-size:24px;font-weight:bold;color:#4285f4}
    .stat-label{font-size:12px;color:#666;margin-top:5px}
  </style>
</head>
<body>
  <h3>ğŸš€ é«˜é€ŸCSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆPythonå‡¦ç†ã‚¨ãƒ³ã‚¸ãƒ³æ­è¼‰ï¼‰</h3>
  
  <div class="tabs">
    <div class="tab active" onclick="switchTab('import')">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
    <div class="tab" onclick="switchTab('analysis')">åˆ†æçµæœ</div>
    <div class="tab" onclick="switchTab('settings')">è¨­å®š</div>
  </div>
  
  <div class="tab-content active" id="import-tab">
    <div class="upload-area" id="uploadArea">
      <p>ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
    </div>
    <input type="file" id="fileInput" accept=".csv" multiple/>
    <div class="file-info" id="fileInfo"></div>
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>
    <div class="status" id="status"></div>
    
    <div style="text-align:center;margin-top:20px;">
      <button class="button" id="analyzeButton" disabled onclick="analyzeCSV()">ğŸ” é«˜é€Ÿåˆ†æ</button>
      <button class="button" id="importButton" disabled onclick="importToSheets()">ğŸ“Š ã‚·ãƒ¼ãƒˆã«å±•é–‹</button>
      <button class="button secondary" onclick="clearAll()">ğŸ”„ ã‚¯ãƒªã‚¢</button>
      <button class="button secondary" onclick="google.script.host.close()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  
  <div class="tab-content" id="analysis-tab">
    <div class="analysis-results" id="analysisResults">
      <h4>ğŸ“ˆ åˆ†æçµæœã‚µãƒãƒªãƒ¼</h4>
      <div class="stats-grid" id="statsGrid"></div>
      
      <h4>ğŸ¯ æ¤œå‡ºã•ã‚ŒãŸå¸Œæœ›å‹¤å‹™åœ°ã‚«ãƒ©ãƒ </h4>
      <div id="desiredColumns"></div>
      
      <h4>ğŸ“ å¸Œæœ›å‹¤å‹™åœ°TOP10</h4>
      <div id="topLocations"></div>
      
      <h4>ğŸ‘¥ äººå£çµ±è¨ˆ</h4>
      <div id="demographics"></div>
      
      <h4>ğŸ’¡ ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h4>
      <div id="insights"></div>
    </div>
  </div>
  
  <div class="tab-content" id="settings-tab">
    <h4>âš™ï¸ å‡¦ç†è¨­å®š</h4>
    <div class="result-item">
      <label><input type="checkbox" id="fullScan" checked> å…¨è¡Œã‚¹ã‚­ãƒ£ãƒ³ï¼ˆç²¾åº¦å„ªå…ˆï¼‰</label>
    </div>
    <div class="result-item">
      <label><input type="checkbox" id="autoGeocode"> è‡ªå‹•ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</label>
    </div>
    <div class="result-item">
      <label>ã‚µãƒ³ãƒ—ãƒ«è¡Œæ•°: <input type="number" id="sampleSize" value="1000" min="100" max="10000"></label>
    </div>
  </div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
var selectedFile = null;
var csvData = null;
var analysisResult = null;
var processedData = null;

// éƒ½é“åºœçœŒåº§æ¨™ãƒ‡ãƒ¼ã‚¿
const prefectureCoords = {
  'åŒ—æµ·é“': {lat: 43.0642, lng: 141.3469},
  'é’æ£®çœŒ': {lat: 40.8244, lng: 140.7400},
  'å²©æ‰‹çœŒ': {lat: 39.7036, lng: 141.1527},
  'å®®åŸçœŒ': {lat: 38.2682, lng: 140.8694},
  'ç§‹ç”°çœŒ': {lat: 39.7186, lng: 140.1024},
  'å±±å½¢çœŒ': {lat: 38.2405, lng: 140.3634},
  'ç¦å³¶çœŒ': {lat: 37.7503, lng: 140.4676},
  'èŒ¨åŸçœŒ': {lat: 36.3418, lng: 140.4468},
  'æ ƒæœ¨çœŒ': {lat: 36.5657, lng: 139.8836},
  'ç¾¤é¦¬çœŒ': {lat: 36.3907, lng: 139.0604},
  'åŸ¼ç‰çœŒ': {lat: 35.8570, lng: 139.6489},
  'åƒè‘‰çœŒ': {lat: 35.6050, lng: 140.1233},
  'æ±äº¬éƒ½': {lat: 35.6762, lng: 139.6503},
  'ç¥å¥ˆå·çœŒ': {lat: 35.4478, lng: 139.6425},
  'æ–°æ½ŸçœŒ': {lat: 37.9022, lng: 139.0235},
  'å¯Œå±±çœŒ': {lat: 36.6953, lng: 137.2113},
  'çŸ³å·çœŒ': {lat: 36.5946, lng: 136.6256},
  'ç¦äº•çœŒ': {lat: 36.0652, lng: 136.2216},
  'å±±æ¢¨çœŒ': {lat: 35.6640, lng: 138.5684},
  'é•·é‡çœŒ': {lat: 36.6513, lng: 138.1810},
  'å²é˜œçœŒ': {lat: 35.3912, lng: 136.7223},
  'é™å²¡çœŒ': {lat: 34.9769, lng: 138.3831},
  'æ„›çŸ¥çœŒ': {lat: 35.1802, lng: 136.9066},
  'ä¸‰é‡çœŒ': {lat: 34.7303, lng: 136.5086},
  'æ»‹è³€çœŒ': {lat: 35.0045, lng: 135.8685},
  'äº¬éƒ½åºœ': {lat: 35.0116, lng: 135.7681},
  'å¤§é˜ªåºœ': {lat: 34.6862, lng: 135.5200},
  'å…µåº«çœŒ': {lat: 34.6913, lng: 135.1830},
  'å¥ˆè‰¯çœŒ': {lat: 34.6851, lng: 135.8327},
  'å’Œæ­Œå±±çœŒ': {lat: 34.2260, lng: 135.1675},
  'é³¥å–çœŒ': {lat: 35.5039, lng: 134.2378},
  'å³¶æ ¹çœŒ': {lat: 35.4723, lng: 133.0505},
  'å²¡å±±çœŒ': {lat: 34.6618, lng: 133.9345},
  'åºƒå³¶çœŒ': {lat: 34.3966, lng: 132.4596},
  'å±±å£çœŒ': {lat: 34.1860, lng: 131.4705},
  'å¾³å³¶çœŒ': {lat: 34.0658, lng: 134.5593},
  'é¦™å·çœŒ': {lat: 34.3401, lng: 134.0434},
  'æ„›åª›çœŒ': {lat: 33.8416, lng: 132.7658},
  'é«˜çŸ¥çœŒ': {lat: 33.5597, lng: 133.5311},
  'ç¦å²¡çœŒ': {lat: 33.6064, lng: 130.4183},
  'ä½è³€çœŒ': {lat: 33.2494, lng: 130.2988},
  'é•·å´çœŒ': {lat: 32.7448, lng: 129.8737},
  'ç†Šæœ¬çœŒ': {lat: 32.7898, lng: 130.7417},
  'å¤§åˆ†çœŒ': {lat: 33.2382, lng: 131.6126},
  'å®®å´çœŒ': {lat: 31.9111, lng: 131.4239},
  'é¹¿å…å³¶çœŒ': {lat: 31.5602, lng: 130.5581},
  'æ²–ç¸„çœŒ': {lat: 26.2124, lng: 127.6809}
};

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.getElementById('uploadArea').addEventListener('click', () => {
  document.getElementById('fileInput').click();
});

document.getElementById('uploadArea').addEventListener('dragover', (e) => {
  e.preventDefault();
  e.target.classList.add('dragover');
});

document.getElementById('uploadArea').addEventListener('dragleave', (e) => {
  e.target.classList.remove('dragover');
});

document.getElementById('uploadArea').addEventListener('drop', (e) => {
  e.preventDefault();
  e.target.classList.remove('dragover');
  if (e.dataTransfer.files.length) {
    handleFile(e.dataTransfer.files[0]);
  }
});

document.getElementById('fileInput').addEventListener('change', (e) => {
  if (e.target.files.length) {
    handleFile(e.target.files[0]);
  }
});

// ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
function handleFile(file) {
  if (!file.name.endsWith('.csv')) {
    showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    return;
  }
  
  selectedFile = file;
  document.getElementById('fileInfo').textContent = 
    `ğŸ“„ ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
  document.getElementById('fileInfo').style.display = 'block';
  document.getElementById('analyzeButton').disabled = false;
  showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸ', 'info');
}

// CSVåˆ†æï¼ˆPythonãƒ­ã‚¸ãƒƒã‚¯ã®ç§»æ¤ï¼‰
async function analyzeCSV() {
  if (!selectedFile) return;
  
  showStatus('åˆ†æã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...', 'info');
  showProgress(0);
  
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      // CSVãƒ‘ãƒ¼ã‚¹
      csvData = parseCSV(e.target.result);
      showProgress(20);
      
      // ã‚«ãƒ©ãƒ æ¤œå‡º
      analysisResult = await detectColumns(csvData);
      showProgress(40);
      
      // ãƒ‡ãƒ¼ã‚¿å‡¦ç†
      processedData = await processData(csvData, analysisResult);
      showProgress(60);
      
      // çµ±è¨ˆåˆ†æ
      const stats = await analyzeStatistics(processedData);
      showProgress(80);
      
      // çµæœè¡¨ç¤º
      displayAnalysisResults(analysisResult, stats);
      showProgress(100);
      
      showStatus('åˆ†æå®Œäº†ï¼ã€Œã‚·ãƒ¼ãƒˆã«å±•é–‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜ã§ãã¾ã™', 'success');
      document.getElementById('importButton').disabled = false;
      
      // åˆ†æã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
      switchTab('analysis');
      
    } catch (error) {
      showStatus('åˆ†æã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      console.error(error);
    }
  };
  
  reader.readAsText(selectedFile, 'UTF-8');
}

// CSVãƒ‘ãƒ¼ã‚¹
function parseCSV(text) {
  const lines = text.split(/\r?\n/);
  const result = [];
  
  for (let line of lines) {
    if (line.trim()) {
      // ç°¡æ˜“CSVãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
      const row = line.split(',').map(cell => cell.trim());
      result.push(row);
    }
  }
  
  return result;
}

// ã‚«ãƒ©ãƒ æ¤œå‡ºï¼ˆPythonãƒ­ã‚¸ãƒƒã‚¯ç§»æ¤ï¼‰
async function detectColumns(data) {
  const headers = data[0];
  const dataRows = headers[0].includes('u-fw-bold') ? data.slice(1) : data;
  
  const result = {
    headers: headers,
    hasHTMLHeaders: headers[0].includes('u-fw-bold'),
    desiredColumns: [],
    totalRows: dataRows.length,
    totalColumns: headers.length
  };
  
  // o-line__itemã‚«ãƒ©ãƒ ã®æ¤œå‡º
  const oLineItems = [];
  headers.forEach((header, idx) => {
    if (header.includes('o-line__item')) {
      oLineItems.push(idx);
    }
  });
  
  showStatus(`${oLineItems.length}å€‹ã® o-line__item ã‚«ãƒ©ãƒ ã‚’æ¤œå‡ºä¸­...`, 'info');
  
  // å…¨è¡Œã‚¹ã‚­ãƒ£ãƒ³ã¾ãŸã¯ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
  const fullScan = document.getElementById('fullScan').checked;
  const sampleSize = fullScan ? dataRows.length : 
                     Math.min(parseInt(document.getElementById('sampleSize').value), dataRows.length);
  
  // å¸Œæœ›å‹¤å‹™åœ°ã‚«ãƒ©ãƒ ã®åˆ¤å®š
  for (let colIdx of oLineItems) {
    if (colIdx === 3 || colIdx >= 13) {
      let addressCount = 0;
      const checkRows = Math.min(sampleSize, dataRows.length);
      
      for (let i = 0; i < checkRows; i++) {
        if (dataRows[i][colIdx]) {
          const val = String(dataRows[i][colIdx]);
          // éƒ½é“åºœçœŒãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
          if (/[éƒ½é“åºœçœŒ].+[å¸‚åŒºç”ºæ‘]/.test(val)) {
            addressCount++;
          }
        }
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
        if (i % 100 === 0) {
          const progress = 20 + (20 * (oLineItems.indexOf(colIdx) + 1) / oLineItems.length);
          showProgress(progress);
        }
      }
      
      // 0.1%ä»¥ä¸Šã§æ¡ç”¨ï¼ˆã‚¹ãƒ‘ãƒ¼ã‚¹å¯¾å¿œï¼‰
      if (addressCount > checkRows * 0.001) {
        result.desiredColumns.push({
          index: colIdx,
          count: addressCount,
          ratio: (addressCount / checkRows * 100).toFixed(2)
        });
      }
    }
  }
  
  return result;
}

// ãƒ‡ãƒ¼ã‚¿å‡¦ç†
async function processData(data, analysis) {
  const processedRows = [];
  const dataRows = analysis.hasHTMLHeaders ? data.slice(1) : data;
  const locationCounts = {};
  
  for (let i = 0; i < dataRows.length; i++) {
    const row = dataRows[i];
    const processed = {
      id: i + 1,
      age: null,
      gender: null,
      residence: null,
      desiredLocations: []
    };
    
    // å¹´é½¢ãƒ»æ€§åˆ¥ã®æŠ½å‡ºï¼ˆ3åˆ—ç›®ã¨ä»®å®šï¼‰
    if (row[2]) {
      const ageGenderMatch = row[2].match(/(\d+)æ­³.*([ç”·å¥³])æ€§/);
      if (ageGenderMatch) {
        processed.age = parseInt(ageGenderMatch[1]);
        processed.gender = ageGenderMatch[2] === 'ç”·' ? 'ç”·æ€§' : 'å¥³æ€§';
      }
    }
    
    // å±…ä½åœ°ï¼ˆ2åˆ—ç›®ã¨ä»®å®šï¼‰
    if (row[1]) {
      processed.residence = extractPrefecture(row[1]);
    }
    
    // å¸Œæœ›å‹¤å‹™åœ°ã®æŠ½å‡º
    for (let colInfo of analysis.desiredColumns) {
      if (row[colInfo.index]) {
        const pref = extractPrefecture(row[colInfo.index]);
        if (pref) {
          processed.desiredLocations.push(pref);
          locationCounts[pref] = (locationCounts[pref] || 0) + 1;
        }
      }
    }
    
    processedRows.push(processed);
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
    if (i % 100 === 0) {
      showProgress(60 + (20 * i / dataRows.length));
    }
  }
  
  return {
    rows: processedRows,
    locationCounts: locationCounts
  };
}

// éƒ½é“åºœçœŒæŠ½å‡º
function extractPrefecture(address) {
  if (!address) return null;
  
  const prefectures = Object.keys(prefectureCoords);
  for (let pref of prefectures) {
    if (address.includes(pref)) {
      return pref;
    }
  }
  return null;
}

// çµ±è¨ˆåˆ†æ
async function analyzeStatistics(data) {
  const stats = {
    totalApplicants: data.rows.length,
    avgAge: 0,
    genderRatio: {},
    topLocations: [],
    insights: []
  };
  
  // å¹´é½¢çµ±è¨ˆ
  const ages = data.rows.map(r => r.age).filter(a => a);
  if (ages.length > 0) {
    stats.avgAge = (ages.reduce((a, b) => a + b, 0) / ages.length).toFixed(1);
  }
  
  // æ€§åˆ¥çµ±è¨ˆ
  const genders = data.rows.map(r => r.gender).filter(g => g);
  stats.genderRatio = {
    male: genders.filter(g => g === 'ç”·æ€§').length,
    female: genders.filter(g => g === 'å¥³æ€§').length
  };
  
  // TOP10å¸Œæœ›å‹¤å‹™åœ°
  const sorted = Object.entries(data.locationCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);
  stats.topLocations = sorted.map(([pref, count]) => ({pref, count}));
  
  // ã‚¤ãƒ³ã‚µã‚¤ãƒˆç”Ÿæˆ
  if (stats.topLocations.length > 0) {
    const topPref = stats.topLocations[0];
    const concentration = (topPref.count / data.rows.length * 100).toFixed(1);
    if (concentration > 20) {
      stats.insights.push({
        type: 'concentration',
        message: `${topPref.pref}ã¸ã®é›†ä¸­å‚¾å‘ï¼ˆ${concentration}%ï¼‰ãŒè¦‹ã‚‰ã‚Œã¾ã™`
      });
    }
  }
  
  if (stats.avgAge > 45) {
    stats.insights.push({
      type: 'age',
      message: `å¹³å‡å¹´é½¢${stats.avgAge}æ­³ã€‚ä¸­é«˜å¹´å±¤ãŒä¸»åŠ›ã§ã™`
    });
  }
  
  return stats;
}

// åˆ†æçµæœè¡¨ç¤º
function displayAnalysisResults(analysis, stats) {
  // çµ±è¨ˆã‚°ãƒªãƒƒãƒ‰
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${stats.totalApplicants.toLocaleString()}</div>
      <div class="stat-label">ç·æ±‚è·è€…æ•°</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${analysis.desiredColumns.length}</div>
      <div class="stat-label">å¸Œæœ›å‹¤å‹™åœ°ã‚«ãƒ©ãƒ </div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.avgAge || '-'}</div>
      <div class="stat-label">å¹³å‡å¹´é½¢</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.genderRatio.male || 0}/${stats.genderRatio.female || 0}</div>
      <div class="stat-label">ç”·æ€§/å¥³æ€§</div>
    </div>
  `;
  
  // å¸Œæœ›å‹¤å‹™åœ°ã‚«ãƒ©ãƒ 
  let columnsHTML = '<div style="max-height:200px;overflow-y:auto;">';
  analysis.desiredColumns.forEach(col => {
    columnsHTML += `<div class="result-item">åˆ—${col.index}: ${col.count}ä»¶ (${col.ratio}%)</div>`;
  });
  columnsHTML += '</div>';
  document.getElementById('desiredColumns').innerHTML = columnsHTML;
  
  // TOP10å¸Œæœ›å‹¤å‹™åœ°
  let locationsHTML = '';
  stats.topLocations.forEach((loc, idx) => {
    locationsHTML += `<div class="result-item">${idx + 1}. ${loc.pref}: ${loc.count}äºº</div>`;
  });
  document.getElementById('topLocations').innerHTML = locationsHTML;
  
  // ã‚¤ãƒ³ã‚µã‚¤ãƒˆ
  let insightsHTML = '';
  stats.insights.forEach(insight => {
    insightsHTML += `<div class="result-item">ğŸ’¡ ${insight.message}</div>`;
  });
  document.getElementById('insights').innerHTML = insightsHTML || '<div class="result-item">ãƒ‡ãƒ¼ã‚¿åˆ†æä¸­...</div>';
  
  document.getElementById('analysisResults').style.display = 'block';
}

// ã‚·ãƒ¼ãƒˆã¸ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
function importToSheets() {
  if (!processedData) {
    showStatus('å…ˆã«åˆ†æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'warning');
    return;
  }
  
  showStatus('ã‚·ãƒ¼ãƒˆã«å±•é–‹ä¸­...', 'info');
  
  // GASå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
  const mapMetrics = prepareMapMetrics(processedData);
  const applicants = prepareApplicants(processedData);
  const desiredWork = prepareDesiredWork(processedData);
  
  // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
  google.script.run
    .withSuccessHandler((result) => {
      showStatus('ã‚·ãƒ¼ãƒˆã¸ã®å±•é–‹ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
      setTimeout(() => {
        google.script.host.close();
      }, 2000);
    })
    .withFailureHandler((error) => {
      showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    })
    .importProcessedData({
      mapMetrics: mapMetrics,
      applicants: applicants,
      desiredWork: desiredWork,
      metadata: {
        fileName: selectedFile.name,
        processedAt: new Date().toISOString(),
        totalRows: processedData.rows.length,
        desiredColumns: analysisResult.desiredColumns.length
      }
    });
}

// MapMetricsãƒ‡ãƒ¼ã‚¿æº–å‚™
function prepareMapMetrics(data) {
  const metrics = [];
  
  Object.entries(data.locationCounts).forEach(([pref, count]) => {
    if (prefectureCoords[pref]) {
      metrics.push([
        pref,
        '',  // å¸‚åŒºç”ºæ‘
        pref,  // ã‚­ãƒ¼
        count,
        prefectureCoords[pref].lat,
        prefectureCoords[pref].lng
      ]);
    }
  });
  
  return metrics;
}

// Applicantsãƒ‡ãƒ¼ã‚¿æº–å‚™
function prepareApplicants(data) {
  return data.rows.map(row => [
    'ID_' + row.id,
    row.gender || '',
    row.age || '',
    getAgeBucket(row.age),
    row.residence || '',
    ''  // å¸‚åŒºç”ºæ‘
  ]);
}

// DesiredWorkãƒ‡ãƒ¼ã‚¿æº–å‚™
function prepareDesiredWork(data) {
  const desired = [];
  
  data.rows.forEach(row => {
    row.desiredLocations.forEach(loc => {
      desired.push([
        'ID_' + row.id,
        loc,
        '',  // å¸‚åŒºç”ºæ‘
        loc  // ã‚­ãƒ¼
      ]);
    });
  });
  
  return desired;
}

// å¹´é½¢ãƒã‚±ãƒƒãƒˆ
function getAgeBucket(age) {
  if (!age) return '';
  if (age < 30) return '20ä»£';
  if (age < 40) return '30ä»£';
  if (age < 50) return '40ä»£';
  if (age < 60) return '50ä»£';
  if (age < 70) return '60ä»£';
  return '70ä»£ä»¥ä¸Š';
}

// UIé–¢æ•°
function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  
  event.target.classList.add('active');
  document.getElementById(tabName + '-tab').classList.add('active');
}

function showStatus(message, type) {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = 'status ' + type;
  status.style.display = 'block';
}

function showProgress(percent) {
  const container = document.getElementById('progressContainer');
  const bar = document.getElementById('progressBar');
  
  container.style.display = 'block';
  bar.style.width = percent + '%';
  bar.textContent = Math.round(percent) + '%';
}

function clearAll() {
  selectedFile = null;
  csvData = null;
  analysisResult = null;
  processedData = null;
  
  document.getElementById('fileInfo').style.display = 'none';
  document.getElementById('progressContainer').style.display = 'none';
  document.getElementById('status').style.display = 'none';
  document.getElementById('analysisResults').style.display = 'none';
  document.getElementById('analyzeButton').disabled = true;
  document.getElementById('importButton').disabled = true;
  
  switchTab('import');
}
</script>
</body>
</html>