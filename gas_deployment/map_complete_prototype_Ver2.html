<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>求職者分析ダッシュボード | MapComplete（右サイドバー版 / GAS連携 / 旧配色適用）</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- Leaflet.PolylineDecorator (矢印フロー表示用) -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.min.js"></script>
  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      /* ==== 前システム配色（Talent Insight）を踏襲 ==== */
      color-scheme: light dark;
      --bg: #0d1525;                           /* 深いネイビー基調 */
      --panel-bg: rgba(12, 20, 37, 0.95);      /* サイドバー：半透明濃紺 */
      --card: rgba(15, 23, 42, 0.82);          /* カード背景 */
      --text: #f8fafc;                         /* 文字 */
      --muted: rgba(226, 232, 240, 0.75);      /* 補助文字 */
      --border: rgba(148, 163, 184, 0.22);     /* 枠線 */
      --accent: #38bdf8;                       /* メインアクセント（青） */
      --accent-2: #f97316;                     /* オレンジ */
      --accent-3: #a855f7;                     /* 紫 */
      --accent-4: #22c55e;                     /* 緑 */
      --accent-5: #facc15;                     /* 黄 */
      --accent-6: #ec4899;                     /* ピンク */
      --shadow: -18px 0 40px rgba(10, 20, 40, 0.35);
      --chart-h: 320px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:'Noto Sans JP','Yu Gothic',Meiryo,system-ui;
      background: radial-gradient(circle at top left, #0f172a 0%, #1e293b 65%);
      color:var(--text);
      overflow:hidden;
    }
    #app{position:relative;width:100%;height:100%}

    /* マップは最背面 */
    #map{position:absolute;inset:0;z-index:0}

    /* 右サイドバー（リサイズ対応 / 旧配色） */
    .sidebar{
      position:absolute;top:0;right:0;bottom:0;
      width:440px;min-width:280px;max-width:calc(100vw - 40px);
      background:var(--panel-bg);
      border-left:1px solid rgba(148, 163, 184, 0.24);
      display:flex;flex-direction:column;gap:18px;
      padding:24px 24px 20px 28px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
      z-index:1200;
    }
    .sidebar.resizing, body.resizing, body.resizing *{cursor:col-resize!important;user-select:none}

    /* リサイズハンドル（少し内側に配置し確実につかめる） */
    .resize-handle{
      position:absolute;top:0;bottom:0;left:-6px;width:14px;
      cursor:col-resize;touch-action:none;z-index:1300;
      background: linear-gradient(180deg, rgba(56,189,248,0.40), rgba(148,163,184,0.30));
      border-left: 1px solid rgba(148, 163, 184, 0.35);
      border-right: 1px solid rgba(148, 163, 184, 0.25);
      border-top-left-radius:8px;border-bottom-left-radius:8px;
    }

    /* ヘッダ */
    header.app{
      display:grid;
      gap:14px;
    }
    .app-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .app-title{font-size:12px;letter-spacing:.08em;}
    .app-controls{
      display:grid;
      grid-template-columns:minmax(0,180px) minmax(0,220px) minmax(0,1fr);
      gap:12px;
      align-items:stretch;
    }
    .badge{
      padding:6px 14px;border-radius:999px;
      border:1px solid rgba(56,189,248,0.40);
      background: rgba(56,189,248,0.18);
      color: var(--accent);font-size:11px;
    }

    /* セレクタ・サマリ（旧配色の質感） */
    .selector{display:grid;gap:6px}
    .selector label{font-size:11px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase}
    select{
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(148,163,184,0.35);
      background: rgba(17, 27, 44, 0.92);
      color:var(--text);font-size:13px
    }
    .summary{
      border-radius:16px;
      border:1px solid rgba(56,189,248,0.28);
      background: linear-gradient(135deg, rgba(56,189,248,0.24), rgba(18,26,44,0.55));
      padding:12px 16px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:16px;
    }
    .summary-main{display:flex;flex-direction:column;gap:4px;min-width:0;}
    .summary h1{font-size:18px;font-weight:600}
    .summary p{font-size:12px;color:var(--muted);letter-spacing:.03em;margin-top:2px}
    .summary-actions{display:flex;align-items:center;gap:8px;}
    @media (max-width:1080px){
      .app-controls{grid-template-columns:1fr;}
    }
    .quality-badge{
      margin-top:0;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(56,189,248,0.45);
      background: rgba(56,189,248,0.18);
      color:var(--text);
    }
    .quality-badge[hidden]{display:none!important}

    /* タブ（旧の発光感とコントラスト） */
    .tabbar{display:grid;grid-template-columns:repeat(6, minmax(0,1fr));gap:8px}
    .tab{
      padding:12px 0;border-radius:12px;
      border:1px solid rgba(148,163,184,0.32);
      background: rgba(17, 27, 44, 0.90);
      color: var(--muted);font-size:13px;letter-spacing:.05em;
      cursor:pointer;transition:0.2s ease;
    }
    .tab.active{
      background: var(--accent);
      color:#021321;
      border-color:transparent;
      box-shadow:0 10px 24px rgba(56, 189, 248, 0.22);
    }

    /* コンテンツパネル */
    .panels{flex:1 1 auto;min-height:0;overflow:auto;padding-right:6px;display:grid;gap:16px}
    .panel{
      display:none;gap:18px;
      border-radius:18px;border:1px solid var(--border);
      background: rgba(8, 15, 28, 0.78);
      padding:20px;
    }
    .panel.active{display:grid}

    /* KPI・セクション（旧配色） */
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px}
    .kpi{
      border-radius:16px;border:1px solid rgba(148, 163, 184, 0.24);
      background: rgba(12, 20, 37, 0.86);
      padding:16px;display:grid;gap:6px;
    }
    .kpi .label{font-size:12px;letter-spacing:.08em;color:var(--muted)}
    .kpi .value{font-size:24px;font-weight:600}
    .section{
      border-radius:16px;border:1px solid rgba(148, 163, 184, 0.22);
      background: rgba(10, 18, 34, 0.82);
      padding:18px;display:grid;gap:12px;
    }
    .section h2{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
    .stats{display:grid;gap:10px;font-size:13px}
    .row{display:flex;justify-content:space-between;gap:12px}
    .chip-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    .chip{
      border-radius:14px;
      border:1px solid rgba(56,189,248,0.28);
      background: rgba(17, 27, 44, 0.85);
      padding:12px 16px;
      display:grid;
      gap:6px;
    }
    .chip-label{font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
    .chip strong{font-size:18px;font-weight:600}
    .chip-sub{font-size:12px;color:var(--muted)}

    /* チャートカード（旧配色） */
    .chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
    @media (max-width:1200px){.chart-grid{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}}
    .chart-card{
      border-radius:14px;border:1px solid rgba(148, 163, 184, 0.18);
      background: rgba(5, 12, 26, 0.88);
      padding:14px 16px;display:flex;flex-direction:column;gap:10px;
      height:var(--chart-h);min-height:var(--chart-h);flex:0 0 auto;contain:content;overflow:hidden;
    }
    .chart-card header{font-size:13px;letter-spacing:.06em;color:var(--muted);text-transform:uppercase}
    .chart-card canvas{
      width:100%!important;
      height:auto!important;
      flex:1 1 auto;
      min-height:0;
      display:block;
      background-color: rgba(12, 20, 37, 0.92);
    }

    /* 行列表 */
    .matrix{
      overflow-x:auto;border-radius:12px;
      border:1px solid rgba(148,163,184,0.20);
      background: rgba(8, 15, 28, 0.78);
    }
    .matrix table{width:100%;border-collapse:collapse;min-width:420px;font-size:13px}
    .matrix th,.matrix td{
      padding:12px 14px;border-bottom:1px solid rgba(148,163,184,0.16);text-align:left;color:var(--text)
    }
    .matrix th{color:var(--muted);font-weight:500;letter-spacing:.04em}
    .matrix tbody tr:last-child td{border-bottom:none}
    .data-table{width:100%;border-collapse:collapse;font-size:13px}
    .data-table thead th{background:rgba(15,23,42,0.85);color:var(--muted);padding:10px 12px;text-align:left;font-weight:500;border-bottom:1px solid rgba(148,163,184,0.22)}
    .data-table tbody td{padding:10px 12px;border-bottom:1px solid rgba(148,163,184,0.16)}
    .data-table tbody tr:nth-child(odd){background:rgba(15,23,42,0.28)}
    .section .table-wrap{overflow:auto;border-radius:12px;border:1px solid rgba(148,163,184,0.20);background:rgba(8,15,28,0.78)}

    /* スクロールバー */
    ::-webkit-scrollbar{width:8px}
    ::-webkit-scrollbar-track{background:rgba(255,255,255,0.04)}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.25);border-radius:6px}
  </style>
  <style>
    /* overrides to stabilize chart layout */
    .chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;}
    @media (max-width:1200px){.chart-grid{grid-template-columns:repeat(auto-fit,minmax(240px,1fr));}}
    .chart-grid.supply-qualification-grid{grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
    .chart-card{
      border-radius:14px;border:1px solid rgba(148,163,184,0.18);
      background:rgba(5,12,26,0.88);
      padding:14px 16px;
      display:flex;flex-direction:column;gap:10px;
      height:320px;min-height:320px;
      overflow:hidden;
    }
    .chart-card.chart-card--tight{height:240px;min-height:240px;}
    .chart-card header{font-size:13px;letter-spacing:.06em;color:var(--muted);text-transform:uppercase;margin-bottom:4px;}
    .chart-card .chart-body{flex:1 1 auto;display:flex;position:relative;min-height:0;}
    .chart-card .chart-body canvas{flex:1 1 auto;width:100%!important;height:100%!important;min-height:0;}

    /* ========== Dashboard Tab Styles ========== */
    .dashboard-container{padding:20px}
    .phase-tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px}
    .phase-tab-btn{
      padding:10px 18px;border-radius:999px;border:1px solid var(--border);
      background:var(--card);color:var(--muted);font-size:13px;font-weight:600;cursor:pointer;
      transition:all 0.2s ease
    }
    .phase-tab-btn.active{background:var(--accent);border-color:var(--accent);color:var(--text);box-shadow:0 6px 16px rgba(56,189,248,0.25)}
    .summary-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;margin-bottom:20px}
    .summary-card{padding:18px;border-radius:14px;background:var(--card);border:1px solid var(--border);display:flex;flex-direction:column;gap:6px}
    .summary-card .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em}
    .summary-card .value{font-size:20px;font-weight:700;color:var(--accent)}
    .table-group{margin-top:28px}
    .table-title{font-size:16px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px;color:var(--text)}
    .empty-placeholder{padding:18px;border-radius:12px;background:rgba(148,163,184,0.1);color:var(--muted);font-size:13px}

    /* ========== Persona Difficulty Styles ========== */
    .persona-filter-panel{background:var(--card);padding:20px;border-radius:12px;margin-bottom:20px;border:1px solid var(--border)}
    .filter-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:20px}
    .filter-group{display:flex;flex-direction:column}
    .filter-label{font-weight:bold;margin-bottom:8px;color:var(--text);font-size:14px}
    .filter-group select{
      padding:8px 12px;border:1px solid var(--border);border-radius:4px;font-size:14px;
      background:rgba(15,23,42,0.6);color:var(--text)
    }
    .filter-group select[multiple]{min-height:120px}
    .persona-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-top:20px}
    .persona-card{
      background:var(--card);padding:20px;border-radius:12px;border:1px solid var(--border);
      position:relative;transition:transform 0.2s,box-shadow 0.2s
    }
    .persona-card:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(56,189,248,0.15)}
    .difficulty-badge{
      position:absolute;top:15px;right:15px;padding:6px 12px;border-radius:20px;
      font-size:12px;font-weight:bold;color:white
    }
    .difficulty-S{background:#d32f2f}
    .difficulty-A{background:#f57c00}
    .difficulty-B{background:#fbc02d}
    .difficulty-C{background:#7cb342}
    .difficulty-D{background:#66bb6a}
    .difficulty-E{background:#81c784}
    .persona-header{margin-bottom:15px;padding-bottom:15px;border-bottom:2px solid var(--border)}
    .persona-title{font-size:18px;font-weight:bold;color:var(--text);margin-bottom:5px}
    .persona-subtitle{font-size:14px;color:var(--muted)}
    .persona-metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px}
    .metric-item{padding:10px;background:rgba(148,163,184,0.1);border-radius:4px}
    .metric-label{font-size:11px;color:var(--muted);margin-bottom:3px}
    .metric-value{font-size:16px;font-weight:bold;color:var(--text)}
    .persona-categories{display:flex;flex-wrap:wrap;gap:6px}
    .category-tag{padding:4px 10px;background:rgba(148,163,184,0.2);border-radius:12px;font-size:11px;color:var(--text)}
    .score-bar{height:8px;background:rgba(148,163,184,0.2);border-radius:4px;overflow:hidden;margin-top:10px}
    .score-fill{height:100%;background:linear-gradient(90deg,#81c784 0%,#fbc02d 50%,#d32f2f 100%);transition:width 0.3s}

    /* フィルターボタン */
    .btn-filter-apply, .btn-filter-reset{
      padding:10px 24px;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.3s
    }
    .btn-filter-apply{background:var(--accent);color:var(--text)}
    .btn-filter-apply:hover{background:rgba(56,189,248,0.8);transform:translateY(-1px)}
    .btn-filter-reset{background:rgba(148,163,184,0.3);color:var(--text)}
    .btn-filter-reset:hover{background:rgba(148,163,184,0.4)}

  </style>
</head>
<body>
  <div id="app">
    <div id="map" aria-label="地図"></div>
    <aside id="sidebar" class="sidebar" aria-label="MapComplete 右サイドバー">
      <div id="resizeHandle" class="resize-handle" role="separator" aria-label="サイドバーの幅を調整"></div>
      <header class="app">
        <div class="app-head">
          <span class="app-title">求職者分析ダッシュボード</span>
          <span class="badge">MapComplete プロトタイプ</span>
        </div>
        <div class="app-controls">
          <div class="selector">
            <label for="prefectureSelect">都道府県</label>
            <select id="prefectureSelect"></select>
          </div>
          <div class="selector">
            <label for="municipalitySelect">市区町村</label>
            <select id="municipalitySelect"></select>
          </div>
          <div class="summary">
            <div class="summary-main">
              <h1 id="cityName">-</h1>
              <p id="cityMeta">-</p>
            </div>
            <div class="summary-actions">
              <div id="qualityBadge" class="quality-badge" hidden>品質未評価</div>
            </div>
          </div>
        </div>
      </header>

      <nav class="tabbar" id="tabbar"></nav>

      <div class="panels">
        <section class="panel active" data-panel="overview"></section>
        <section class="panel" data-panel="supply"></section>
        <section class="panel" data-panel="career"></section>
        <section class="panel" data-panel="urgency"></section>
        <section class="panel" data-panel="persona"></section>
        <section class="panel" data-panel="cross"></section>
        <section class="panel" data-panel="flow"></section>
        <section class="panel" data-panel="dashboard"></section>
      </div>
    </aside>
  </div>

  <!-- サンプルデータ（ローカル確認用） -->
  <script type="application/json" id="embeddedData">
{
  "regionOptions": {
    "prefectures": ["京都府", "大阪府", "東京都"],
    "state": {"prefecture": "京都府", "municipality": "京都市伏見区"}
  },
  "availableRegions": [
    {"key": "kyoto-fushimi", "prefecture": "京都府", "municipality": "京都市伏見区", "label": "京都府 京都市伏見区"},
    {"key": "kyoto-nakagyo", "prefecture": "京都府", "municipality": "京都市中京区", "label": "京都府 京都市中京区"},
    {"key": "osaka-kita", "prefecture": "大阪府", "municipality": "大阪市北区", "label": "大阪府 大阪市北区"},
    {"key": "osaka-chuo", "prefecture": "大阪府", "municipality": "大阪市中央区", "label": "大阪府 大阪市中央区"},
    {"key": "tokyo-shibuya", "prefecture": "東京都", "municipality": "渋谷区", "label": "東京都 渋谷区"}
  ],
  "selectedRegion": {"key": "kyoto-fushimi", "prefecture": "京都府", "municipality": "京都市伏見区"},
  "cities": [
  {
    "id": "kyoto-fushimi",
    "name": "京都府 京都市伏見区",
    "region": {"key": "kyoto-fushimi", "prefecture": "京都府", "municipality": "京都市伏見区"},
    "center": [
      34.935,
      135.76
    ],
    "updated": "2025-10-31",
    "overview": {
      "kpis": [
        {
          "label": "求職者数",
          "value": 1748,
          "unit": "人"
        },
        {
          "label": "平均年齢",
          "value": 48.7,
          "unit": "歳"
        },
        {
          "label": "男女比 (男性/女性)",
          "labels": [
            "男性",
            "女性"
          ],
          "values": [
            628,
            1120
          ],
          "unit": "人"
        }
      ],
      "age_gender": {
        "age_labels": [
          "20代",
          "30代",
          "40代",
          "50代",
          "60代",
          "70歳以上"
        ],
        "age_totals": [
          250,
          242,
          323,
          497,
          329,
          107
        ],
        "gender_labels": [
          "男性",
          "女性"
        ],
        "gender_totals": [
          628,
          1120
        ]
      },
      "averages": {
        "希望勤務地数": 5.27,
        "保有資格数": 1.72
      }
    },
    "supply": {
      "status_counts": {
        "就業中": 1121,
        "離職中": 550,
        "在学中": 77
      },
      "qualification_buckets": [
        {
          "label": "資格なし",
          "value": 370
        },
        {
          "label": "1資格",
          "value": 533
        },
        {
          "label": "2資格",
          "value": 440
        },
        {
          "label": "3資格以上",
          "value": 405
        }
      ],
      "national_license_count": 47,
      "avg_qualifications": 1.72,
      "mobility_matrix": {
        "rows": [
          "30代女性就業中",
          "40代女性就業中"
        ],
        "columns": [
          "30分以内",
          "60分以内"
        ],
        "values": [
          [
            80,
            40
          ],
          [
            60,
            30
          ]
        ],
        "row_totals": [
          120,
          90
        ],
        "column_totals": [
          140,
          70
        ],
        "total": 210
      },
      "mobility_scores": [
        {
          "mobility_level": "30分以内",
          "count": 140,
          "avg_distance": 18
        },
        {
          "mobility_level": "60分以内",
          "count": 70,
          "avg_distance": 32
        }
      ]
    },
    "career": {
      "summary": {
        "平均保有資格数": 1.72,
        "平均希望勤務地数": 5.27,
        "国家資格保有率": 0.0269
      },
      "employment_age": {
        "age_labels": [
          "20代",
          "30代",
          "40代",
          "50代",
          "60代",
          "70歳以上"
        ],
        "rows": [
          {
            "status": "就業中",
            "counts": [
              114,
              159,
              229,
              351,
              218,
              50
            ]
          },
          {
            "status": "離職中",
            "counts": [
              79,
              76,
              88,
              142,
              109,
              56
            ]
          },
          {
            "status": "在学中",
            "counts": [
              57,
              7,
              6,
              4,
              2,
              1
            ]
          }
        ]
      },
      "matrices": {
        "education": {
          "rows": [
            "大学",
            "専門"
          ],
          "columns": [
            "20代",
            "30代",
            "40代"
          ],
          "values": [
            [
              35,
              58,
              42
            ],
            [
              28,
              46,
              39
            ]
          ],
          "row_totals": [
            135,
            113
          ],
          "column_totals": [
            63,
            104,
            81
          ],
          "total": 248
        },
        "career": {
          "rows": [
            "介護職",
            "看護職"
          ],
          "columns": [
            "20代",
            "30代",
            "40代"
          ],
          "values": [
            [
              20,
              45,
              38
            ],
            [
              18,
              32,
              27
            ]
          ],
          "row_totals": [
            103,
            77
          ],
          "column_totals": [
            38,
            77,
            65
          ],
          "total": 180
        }
      },
      "distributions": {
        "career": [
          {
            "career": "介護職",
            "count": 120
          },
          {
            "career": "看護職",
            "count": 80
          }
        ],
        "graduation": [
          {
            "year": "2000年",
            "count": 60
          },
          {
            "year": "2005年",
            "count": 75
          }
        ]
      }
    },
    "urgency": {
      "summary": {
        "対象人数": 1748,
        "平均スコア": 4.1
      },
      "by_age": [
        {
          "age_group": "20代",
          "count": 250,
          "avg_score": 3.48
        },
        {
          "age_group": "30代",
          "count": 242,
          "avg_score": 4.21
        },
        {
          "age_group": "40代",
          "count": 323,
          "avg_score": 4.38
        }
      ],
      "by_employment": [
        {
          "status": "就業中",
          "count": 1121,
          "avg_score": 3.9
        },
        {
          "status": "離職中",
          "count": 550,
          "avg_score": 4.81
        }
      ],
      "matrices": {
        "age": {
          "rows": [
            "20代",
            "30代",
            "40代"
          ],
          "columns": [
            "A:高い",
            "B:中",
            "C:低"
          ],
          "values": [
            [
              30,
              40,
              20
            ],
            [
              25,
              60,
              35
            ],
            [
              18,
              50,
              42
            ]
          ],
          "row_totals": [
            90,
            120,
            110
          ],
          "column_totals": [
            73,
            150,
            97
          ],
          "total": 340
        },
        "employment": {
          "rows": [
            "就業中",
            "離職中",
            "在学中"
          ],
          "columns": [
            "A:高い",
            "B:中",
            "C:低"
          ],
          "values": [
            [
              60,
              120,
              80
            ],
            [
              35,
              55,
              45
            ],
            [
              10,
              12,
              8
            ]
          ],
          "row_totals": [
            260,
            135,
            30
          ],
          "column_totals": [
            105,
            187,
            133
          ],
          "total": 428
        }
      },
      "municipality": [
        {
          "municipality": "京都市伏見区",
          "urgency_score": 4.1,
          "count": 1748
        }
      ]
    },
    "persona": {
      "top": [
        {
          "label": "50代 × 女性 × 就業中",
          "count": 256,
          "share": 0.1465
        },
        {
          "label": "40代 × 女性 × 就業中",
          "count": 150,
          "share": 0.0858
        }
      ],
      "summary": [
        {
          "persona": "30代女性就業中",
          "difficulty_level": "高",
          "count": 220,
          "difficulty_score": 4.5
        }
      ],
      "details": [
        {
          "persona": "30代女性就業中",
          "attribute": "介護福祉士",
          "count": 120
        },
        {
          "persona": "40代女性就業中",
          "attribute": "主任経験",
          "count": 85
        }
      ],
      "mobility_matrix": {
        "rows": [
          "30代女性就業中",
          "40代女性就業中"
        ],
        "columns": [
          "30分以内",
          "60分以内"
        ],
        "values": [
          [
            80,
            40
          ],
          [
            60,
            30
          ]
        ],
        "row_totals": [
          120,
          90
        ],
        "column_totals": [
          140,
          70
        ],
        "total": 210
      },
      "map_data": [
        {
          "persona": "30代女性就業中",
          "latitude": 34.935,
          "longitude": 135.76,
          "count": 120
        }
      ],
      "qualification_summary": [
        {
          "persona": "30代女性×常勤",
          "avg_qualifications": 2.4,
          "top_bucket": "2資格",
          "count": 148
        },
        {
          "persona": "40代女性×常勤",
          "avg_qualifications": 2.1,
          "top_bucket": "2資格",
          "count": 112
        },
        {
          "persona": "30代男性×常勤",
          "avg_qualifications": 1.6,
          "top_bucket": "1資格",
          "count": 96
        }
      ],
      "personaSummaryByMunicipality": [
        {
          "municipality": "京都市伏見区",
          "persona": "30代女性×常勤",
          "count": 148,
          "share": 0.085
        },
        {
          "municipality": "京都市伏見区",
          "persona": "40代女性×常勤",
          "count": 112,
          "share": 0.064
        },
        {
          "municipality": "京都市伏見区",
          "persona": "30代男性×常勤",
          "count": 96,
          "share": 0.055
        }
      ]
    },
    "cross_insights": {
      "personaDifficulty": {
        "summary": {
          "averageDifficultyScore": 4.2
        },
        "table": [
          {
            "persona": "30代女性就業中",
            "difficulty_level": "高",
            "count": 220
          }
        ]
      },
      "educationMatrix": {
        "rows": [
          "大学",
          "専門"
        ],
        "columns": [
          "20代",
          "30代",
          "40代"
        ],
        "values": [
          [
            35,
            58,
            42
          ],
          [
            28,
            46,
            39
          ]
        ],
        "row_totals": [
          135,
          113
        ],
        "column_totals": [
          63,
          104,
          81
        ],
        "total": 248
      },
      "careerMatrix": {
        "rows": [
          "介護職",
          "看護職"
        ],
        "columns": [
          "20代",
          "30代",
          "40代"
        ],
        "values": [
          [
            20,
            45,
            38
          ],
          [
            18,
            32,
            27
          ]
        ],
        "row_totals": [
          103,
          77
        ],
        "column_totals": [
          38,
          77,
          65
        ],
        "total": 180
      },
      "urgencyAgeMatrix": {
        "rows": [
          "20代",
          "30代",
          "40代"
        ],
        "columns": [
          "A:高い",
          "B:中",
          "C:低"
        ],
        "values": [
          [
            30,
            40,
            20
          ],
          [
            25,
            60,
            35
          ],
          [
            18,
            50,
            42
          ]
        ],
        "row_totals": [
          90,
          120,
          110
        ],
        "column_totals": [
          73,
          150,
          97
        ],
        "total": 340
      },
      "urgencyEmploymentMatrix": {
        "rows": [
          "就業中",
          "離職中",
          "在学中"
        ],
        "columns": [
          "A:高い",
          "B:中",
          "C:低"
        ],
        "values": [
          [
            60,
            120,
            80
          ],
          [
            35,
            55,
            45
          ],
          [
            10,
            12,
            8
          ]
        ],
        "row_totals": [
          260,
          135,
          30
        ],
        "column_totals": [
          105,
          187,
          133
        ],
        "total": 428
      }
    }
  },
  {
    "id": "yokohama-naka",
    "name": "神奈川県 横浜市中区",
    "center": [
      35.44,
      139.64
    ],
    "updated": "2025-10-31",
    "overview": {
      "kpis": [
        {
          "label": "求職者数",
          "value": 58,
          "unit": "人"
        },
        {
          "label": "平均年齢",
          "value": 42.8,
          "unit": "歳"
        },
        {
          "label": "男女比 (男性/女性)",
          "labels": [
            "男性",
            "女性"
          ],
          "values": [
            24,
            34
          ],
          "unit": "人"
        }
      ],
      "age_gender": {
        "age_labels": [
          "20代",
          "30代",
          "40代",
          "50代",
          "60代",
          "70歳以上"
        ],
        "age_totals": [
          9,
          12,
          14,
          10,
          9,
          4
        ],
        "gender_labels": [
          "男性",
          "女性"
        ],
        "gender_totals": [
          24,
          34
        ]
      },
      "averages": {
        "希望勤務地数": 6.8,
        "保有資格数": 2.9
      }
    },
    "supply": {
      "status_counts": {
        "就業中": 28,
        "離職中": 20,
        "在学中": 10
      },
      "qualification_buckets": [
        {
          "label": "資格なし",
          "value": 6
        },
        {
          "label": "1資格",
          "value": 18
        },
        {
          "label": "2資格",
          "value": 20
        },
        {
          "label": "3資格以上",
          "value": 14
        }
      ],
      "national_license_count": 5,
      "avg_qualifications": 2.9,
      "mobility_matrix": {
        "rows": [
          "30代女性就業中",
          "40代女性離職中"
        ],
        "columns": [
          "20分以内",
          "40分以内"
        ],
        "values": [
          [
            12,
            8
          ],
          [
            7,
            6
          ]
        ],
        "row_totals": [
          20,
          13
        ],
        "column_totals": [
          19,
          14
        ],
        "total": 33
      },
      "mobility_scores": [
        {
          "mobility_level": "20分以内",
          "count": 19,
          "avg_distance": 12
        },
        {
          "mobility_level": "40分以内",
          "count": 14,
          "avg_distance": 24
        }
      ]
    },
    "career": {
      "summary": {
        "平均保有資格数": 2.9,
        "平均希望勤務地数": 6.8,
        "国家資格保有率": 0.12
      },
      "employment_age": {
        "age_labels": [
          "20代",
          "30代",
          "40代",
          "50代",
          "60代",
          "70歳以上"
        ],
        "rows": [
          {
            "status": "就業中",
            "counts": [
              2,
              5,
              4,
              3,
              3,
              1
            ]
          },
          {
            "status": "離職中",
            "counts": [
              1,
              2,
              3,
              2,
              2,
              1
            ]
          },
          {
            "status": "在学中",
            "counts": [
              1,
              1,
              1,
              0,
              0,
              0
            ]
          }
        ]
      },
      "matrices": {
        "education": {
          "rows": [
            "大学",
            "専門"
          ],
          "columns": [
            "20代",
            "30代",
            "40代"
          ],
          "values": [
            [
              6,
              8,
              5
            ],
            [
              5,
              6,
              4
            ]
          ],
          "row_totals": [
            19,
            15
          ],
          "column_totals": [
            11,
            14,
            9
          ],
          "total": 34
        },
        "career": {
          "rows": [
            "介護職",
            "看護職"
          ],
          "columns": [
            "20代",
            "30代",
            "40代"
          ],
          "values": [
            [
              4,
              6,
              4
            ],
            [
              3,
              5,
              3
            ]
          ],
          "row_totals": [
            14,
            11
          ],
          "column_totals": [
            7,
            11,
            7
          ],
          "total": 25
        }
      },
      "distributions": {
        "career": [
          {
            "career": "介護職",
            "count": 32
          },
          {
            "career": "看護職",
            "count": 26
          }
        ],
        "graduation": [
          {
            "year": "2008年",
            "count": 12
          },
          {
            "year": "2012年",
            "count": 18
          }
        ]
      }
    },
    "urgency": {
      "summary": {
        "対象人数": 58,
        "平均スコア": 5.1
      },
      "by_age": [
        {
          "age_group": "20代",
          "count": 9,
          "avg_score": 4.8
        },
        {
          "age_group": "30代",
          "count": 12,
          "avg_score": 5.4
        }
      ],
      "by_employment": [
        {
          "status": "就業中",
          "count": 28,
          "avg_score": 5.0
        },
        {
          "status": "離職中",
          "count": 20,
          "avg_score": 5.6
        }
      ],
      "matrices": {
        "age": {
          "rows": [
            "20代",
            "30代",
            "40代"
          ],
          "columns": [
            "A:高い",
            "B:中",
            "C:低"
          ],
          "values": [
            [
              5,
              3,
              1
            ],
            [
              6,
              4,
              2
            ],
            [
              4,
              3,
              2
            ]
          ],
          "row_totals": [
            9,
            12,
            9
          ],
          "column_totals": [
            15,
            10,
            5
          ],
          "total": 30
        },
        "employment": {
          "rows": [
            "就業中",
            "離職中",
            "在学中"
          ],
          "columns": [
            "A:高い",
            "B:中",
            "C:低"
          ],
          "values": [
            [
              8,
              12,
              8
            ],
            [
              6,
              8,
              6
            ],
            [
              1,
              3,
              4
            ]
          ],
          "row_totals": [
            28,
            20,
            8
          ],
          "column_totals": [
            15,
            23,
            18
          ],
          "total": 56
        }
      },
      "municipality": [
        {
          "municipality": "横浜市中区",
          "urgency_score": 5.1,
          "count": 58
        }
      ]
    },
    "persona": {
      "top": [
        {
          "label": "30代 × 女性 × 就業中",
          "count": 12,
          "share": 0.2069
        },
        {
          "label": "40代 × 男性 × 離職中",
          "count": 6,
          "share": 0.1034
        }
      ],
      "summary": [
        {
          "persona": "30代女性就業中",
          "difficulty_level": "中",
          "count": 12,
          "difficulty_score": 3.8
        }
      ],
      "details": [
        {
          "persona": "30代女性就業中",
          "attribute": "訪問介護経験",
          "count": 7
        }
      ],
      "mobility_matrix": {
        "rows": [
          "30代女性就業中",
          "40代男性離職中"
        ],
        "columns": [
          "20分以内",
          "40分以内"
        ],
        "values": [
          [
            7,
            5
          ],
          [
            4,
            3
          ]
        ],
        "row_totals": [
          12,
          7
        ],
        "column_totals": [
          11,
          8
        ],
        "total": 19
      },
      "map_data": [
        {
          "persona": "30代女性就業中",
          "latitude": 35.44,
          "longitude": 139.64,
          "count": 12
        }
      ],
      "qualification_summary": [
        {
          "persona": "30代女性×常勤",
          "avg_qualifications": 2.0,
          "top_bucket": "2資格",
          "count": 34
        },
        {
          "persona": "40代女性×常勤",
          "avg_qualifications": 1.8,
          "top_bucket": "1資格",
          "count": 28
        },
        {
          "persona": "30代男性×常勤",
          "avg_qualifications": 1.4,
          "top_bucket": "1資格",
          "count": 24
        }
      ],
      "personaSummaryByMunicipality": [
        {
          "municipality": "札幌市中央区",
          "persona": "30代女性×常勤",
          "count": 34,
          "share": 0.092
        },
        {
          "municipality": "札幌市中央区",
          "persona": "40代女性×常勤",
          "count": 28,
          "share": 0.076
        },
        {
          "municipality": "札幌市中央区",
          "persona": "30代男性×常勤",
          "count": 24,
          "share": 0.065
        }
      ]
    },
    "cross_insights": {
      "personaDifficulty": {
        "summary": {
          "averageDifficultyScore": 3.9
        },
        "table": [
          {
            "persona": "30代女性就業中",
            "difficulty_level": "中",
            "count": 12
          }
        ]
      },
      "educationMatrix": {
        "rows": [
          "大学",
          "専門"
        ],
        "columns": [
          "20代",
          "30代",
          "40代"
        ],
        "values": [
          [
            6,
            8,
            5
          ],
          [
            5,
            6,
            4
          ]
        ],
        "row_totals": [
          19,
          15
        ],
        "column_totals": [
          11,
          14,
          9
        ],
        "total": 34
      },
      "careerMatrix": {
        "rows": [
          "介護職",
          "看護職"
        ],
        "columns": [
          "20代",
          "30代",
          "40代"
        ],
        "values": [
          [
            4,
            6,
            4
          ],
          [
            3,
            5,
            3
          ]
        ],
        "row_totals": [
          14,
          11
        ],
        "column_totals": [
          7,
          11,
          7
        ],
        "total": 25
      },
      "urgencyAgeMatrix": {
        "rows": [
          "20代",
          "30代",
          "40代"
        ],
        "columns": [
          "A:高い",
          "B:中",
          "C:低"
        ],
        "values": [
          [
            5,
            3,
            1
          ],
          [
            6,
            4,
            2
          ],
          [
            4,
            3,
            2
          ]
        ],
        "row_totals": [
          9,
          12,
          9
        ],
        "column_totals": [
          15,
          10,
          5
        ],
        "total": 30
      },
      "urgencyEmploymentMatrix": {
        "rows": [
          "就業中",
          "離職中",
          "在学中"
        ],
        "columns": [
          "A:高い",
          "B:中",
          "C:低"
        ],
        "values": [
          [
            8,
            12,
            8
          ],
          [
            6,
            8,
            6
          ],
          [
            1,
            3,
            4
          ]
        ],
        "row_totals": [
          28,
          20,
          8
        ],
        "column_totals": [
          15,
          23,
          18
        ],
        "total": 56
      }
    },
    "flow": {
      "nearby_regions": [
        {"prefecture": "京都府", "municipality": "京都市中京区", "lat": 35.0116, "lng": 135.7681, "key": "kyoto-nakagyo", "type": "inflow", "flow_count": 89},
        {"prefecture": "京都府", "municipality": "京都市南区", "lat": 34.9803, "lng": 135.7477, "key": "kyoto-minami", "type": "inflow", "flow_count": 76},
        {"prefecture": "大阪府", "municipality": "大阪市北区", "lat": 34.7024, "lng": 135.5023, "key": "osaka-kita", "type": "outflow", "flow_count": 124},
        {"prefecture": "大阪府", "municipality": "大阪市中央区", "lat": 34.6851, "lng": 135.5207, "key": "osaka-chuo", "type": "outflow", "flow_count": 98}
      ]
    }
  },
  {
    "id": "kyoto-nakagyo",
    "name": "京都府 京都市中京区",
    "region": {"key": "kyoto-nakagyo", "prefecture": "京都府", "municipality": "京都市中京区"},
    "center": [35.0116, 135.7681],
    "updated": "2025-10-31",
    "overview": {
      "kpis": [
        {"label": "求職者数", "value": 892, "unit": "人"},
        {"label": "平均年齢", "value": 45.3, "unit": "歳"},
        {"label": "男女比 (男性/女性)", "labels": ["男性", "女性"], "values": [320, 572], "unit": "人"}
      ],
      "age_gender": {
        "age_labels": ["20代", "30代", "40代", "50代", "60代", "70歳以上"],
        "age_totals": [128, 156, 198, 245, 132, 33],
        "gender_labels": ["男性", "女性"],
        "gender_totals": [320, 572]
      },
      "averages": {"希望勤務地数": 4.82, "保有資格数": 1.58}
    },
    "flow": {
      "nearby_regions": [
        {"prefecture": "京都府", "municipality": "京都市伏見区", "lat": 34.935, "lng": 135.76, "key": "kyoto-fushimi", "type": "inflow", "flow_count": 65},
        {"prefecture": "京都府", "municipality": "京都市東山区", "lat": 35.0036, "lng": 135.7736, "key": "kyoto-higashiyama", "type": "inflow", "flow_count": 52},
        {"prefecture": "大阪府", "municipality": "大阪市北区", "lat": 34.7024, "lng": 135.5023, "key": "osaka-kita", "type": "outflow", "flow_count": 143},
        {"prefecture": "大阪府", "municipality": "大阪市中央区", "lat": 34.6851, "lng": 135.5207, "key": "osaka-chuo", "type": "outflow", "flow_count": 87}
      ]
    }
  },
  {
    "id": "osaka-kita",
    "name": "大阪府 大阪市北区",
    "region": {"key": "osaka-kita", "prefecture": "大阪府", "municipality": "大阪市北区"},
    "center": [34.7024, 135.5023],
    "updated": "2025-10-31",
    "overview": {
      "kpis": [
        {"label": "求職者数", "value": 2156, "unit": "人"},
        {"label": "平均年齢", "value": 47.1, "unit": "歳"},
        {"label": "男女比 (男性/女性)", "labels": ["男性", "女性"], "values": [789, 1367], "unit": "人"}
      ],
      "age_gender": {
        "age_labels": ["20代", "30代", "40代", "50代", "60代", "70歳以上"],
        "age_totals": [312, 398, 445, 589, 298, 114],
        "gender_labels": ["男性", "女性"],
        "gender_totals": [789, 1367]
      },
      "averages": {"希望勤務地数": 6.15, "保有資格数": 1.89}
    },
    "flow": {
      "nearby_regions": [
        {"prefecture": "大阪府", "municipality": "豊中市", "lat": 34.7816, "lng": 135.4695, "key": "osaka-toyonaka", "type": "inflow", "flow_count": 186},
        {"prefecture": "大阪府", "municipality": "吹田市", "lat": 34.7615, "lng": 135.5155, "key": "osaka-suita", "type": "inflow", "flow_count": 142},
        {"prefecture": "大阪府", "municipality": "大阪市中央区", "lat": 34.6851, "lng": 135.5207, "key": "osaka-chuo", "type": "outflow", "flow_count": 162},
        {"prefecture": "大阪府", "municipality": "大阪市西区", "lat": 34.6781, "lng": 135.4867, "key": "osaka-nishi", "type": "outflow", "flow_count": 142}
      ]
    }
  },
  {
    "id": "osaka-chuo",
    "name": "大阪府 大阪市中央区",
    "region": {"key": "osaka-chuo", "prefecture": "大阪府", "municipality": "大阪市中央区"},
    "center": [34.6851, 135.5207],
    "updated": "2025-10-31",
    "overview": {
      "kpis": [
        {"label": "求職者数", "value": 1534, "unit": "人"},
        {"label": "平均年齢", "value": 46.8, "unit": "歳"},
        {"label": "男女比 (男性/女性)", "labels": ["男性", "女性"], "values": [556, 978], "unit": "人"}
      ],
      "age_gender": {
        "age_labels": ["20代", "30代", "40代", "50代", "60代", "70歳以上"],
        "age_totals": [223, 267, 312, 423, 234, 75],
        "gender_labels": ["男性", "女性"],
        "gender_totals": [556, 978]
      },
      "averages": {"希望勤務地数": 5.73, "保有資格数": 1.76}
    },
    "flow": {
      "nearby_regions": [
        {"prefecture": "大阪府", "municipality": "大阪市北区", "lat": 34.7024, "lng": 135.5023, "key": "osaka-kita", "type": "inflow", "flow_count": 126},
        {"prefecture": "大阪府", "municipality": "大阪市西区", "lat": 34.6781, "lng": 135.4867, "key": "osaka-nishi", "type": "inflow", "flow_count": 95},
        {"prefecture": "大阪府", "municipality": "大阪市浪速区", "lat": 34.6612, "lng": 135.4988, "key": "osaka-naniwa", "type": "outflow", "flow_count": 108},
        {"prefecture": "大阪府", "municipality": "大阪市天王寺区", "lat": 34.6515, "lng": 135.5158, "key": "osaka-tennoji", "type": "outflow", "flow_count": 89}
      ]
    }
  },
  {
    "id": "tokyo-shibuya",
    "name": "東京都 渋谷区",
    "region": {"key": "tokyo-shibuya", "prefecture": "東京都", "municipality": "渋谷区"},
    "center": [35.6628, 139.6981],
    "updated": "2025-10-31",
    "overview": {
      "kpis": [
        {"label": "求職者数", "value": 1876, "unit": "人"},
        {"label": "平均年齢", "value": 44.2, "unit": "歳"},
        {"label": "男女比 (男性/女性)", "labels": ["男性", "女性"], "values": [698, 1178], "unit": "人"}
      ],
      "age_gender": {
        "age_labels": ["20代", "30代", "40代", "50代", "60代", "70歳以上"],
        "age_totals": [289, 345, 387, 478, 267, 110],
        "gender_labels": ["男性", "女性"],
        "gender_totals": [698, 1178]
      },
      "averages": {"希望勤務地数": 7.24, "保有資格数": 2.03}
    },
    "flow": {
      "nearby_regions": [
        {"prefecture": "東京都", "municipality": "新宿区", "lat": 35.6938, "lng": 139.7036, "key": "tokyo-shinjuku", "type": "inflow", "flow_count": 234},
        {"prefecture": "東京都", "municipality": "世田谷区", "lat": 35.6462, "lng": 139.6531, "key": "tokyo-setagaya", "type": "inflow", "flow_count": 198},
        {"prefecture": "東京都", "municipality": "港区", "lat": 35.6586, "lng": 139.7514, "key": "tokyo-minato", "type": "outflow", "flow_count": 287},
        {"prefecture": "東京都", "municipality": "中央区", "lat": 35.6704, "lng": 139.7711, "key": "tokyo-chuo", "type": "outflow", "flow_count": 156}
      ]
    }
  }
  ]
}
</script>

  <script>
  // =====================================
  // GAS 連携想定：サーバ側
  // function getMapCompleteData(){
  //   // return [{ id, name, center:[lat,lng], updated, overview:{kpis:[],age_gender:{},averages:{}}, ... }];
  // }
  // =====================================
  (function(){
    const numberFmt = new Intl.NumberFormat('ja-JP');
    const percentFmt = new Intl.NumberFormat('ja-JP',{style:'percent',minimumFractionDigits:1,maximumFractionDigits:1});
    const COLOR = ['#38bdf8','#f97316','#a855f7','#22c55e','#facc15','#ec4899','#8b5cf6']; // 旧配色のアクセント群

    const embeddedNode = document.getElementById('embeddedData');
    function normalizePayload(payload){
      if(!payload){ return { cities: [], selectedRegion: null, regionOptions: null, availableRegions: [] }; }
      if(Array.isArray(payload)){
        return { cities: payload, selectedRegion: null, regionOptions: null, availableRegions: [] };
      }
      return {
        cities: Array.isArray(payload.cities) ? payload.cities : [],
        selectedRegion: payload.selectedRegion || null,
        regionOptions: payload.regionOptions || null,
        availableRegions: Array.isArray(payload.availableRegions) ? payload.availableRegions : []
      };
    }
    let embeddedPayload;
    try {
      embeddedPayload = embeddedNode ? JSON.parse(embeddedNode.textContent) : [];
    } catch (e) {
      embeddedPayload = [];
    }
    const fallbackPayload = normalizePayload(embeddedPayload);

    const qs = (s)=>document.querySelector(s);
    const qsa = (s)=>Array.from(document.querySelectorAll(s));

    const sidebar = qs('#sidebar');
    const handle = qs('#resizeHandle');
    const MIN_W = 280;

    let DATA = fallbackPayload.cities.slice();
    let charts = {};
    let map, baseLayer, markersLayer, flowLayer;
    let activeTab = 'overview';
    let activeCity = 0;
    let selectedRegion = fallbackPayload.selectedRegion;
    let selectedPrefecture = ''; // 選択中の都道府県
    let regionOptions = fallbackPayload.regionOptions;
    let availableRegions = fallbackPayload.availableRegions.slice();
    let ro; // ResizeObserver

    // -------- Leaflet 初期化 --------
    function initMap(){
      map = L.map('map',{zoomControl:true});
      baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'});
      baseLayer.addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      flowLayer = L.layerGroup().addTo(map); // フロー矢印用レイヤー初期化
      const center = (DATA?.[activeCity]?.center && Array.isArray(DATA[activeCity].center)) ? DATA[activeCity].center : [35.68, 139.76];
      map.setView(center, 11);
      renderMarkers();
    }

    // -------- サイドバー リサイズ --------
    let pointerId=null, startX=0, startW=0;
    function stopResize(){
      if(pointerId!==null){
        handle.releasePointerCapture(pointerId);
        pointerId=null;
        document.body.classList.remove('resizing');
        sidebar.classList.remove('resizing');
      }
    }
    handle.addEventListener('pointerdown', (e)=>{
      pointerId = e.pointerId; startX = e.clientX; startW = sidebar.getBoundingClientRect().width;
      handle.setPointerCapture(pointerId);
      document.body.classList.add('resizing'); sidebar.classList.add('resizing');
    });
    handle.addEventListener('pointermove', (e)=>{
      if(pointerId===null) return;
      const delta = startX - e.clientX; // 右サイドバーなので逆向き
      const maxW = Math.max(MIN_W, window.innerWidth - 40);
      let w = startW + delta; w = Math.max(MIN_W, Math.min(maxW, w));
      sidebar.style.width = w + 'px';
      requestAnimationFrame(()=> Object.values(charts).forEach(ch=> ch.resize()));
    });
    handle.addEventListener('pointerup', stopResize);
    handle.addEventListener('pointercancel', stopResize);
    handle.addEventListener('lostpointercapture', stopResize);
    window.addEventListener('resize', ()=>{
      const cur = sidebar.getBoundingClientRect().width;
      const maxW = Math.max(MIN_W, window.innerWidth - 40);
      if(cur>maxW) sidebar.style.width = maxW + 'px';
      requestAnimationFrame(()=>{
        Object.values(charts).forEach(ch=> ch.resize());
        if(map) map.invalidateSize();
      });
    });

    // -------- タブ --------
    const TABS = [
      {id:'overview',label:'総合概要'},
      {id:'supply',label:'人材供給'},
      {id:'career',label:'キャリア分析'},
      {id:'urgency',label:'緊急度分析'},
      {id:'persona',label:'ペルソナ分析'},
      {id:'cross',label:'クロス分析'},
      {id:'flow',label:'フロー分析'},
      {id:'dashboard',label:'📊 ダッシュボード'}
    ];
    function renderTabbar(){
      const nav = qs('#tabbar');
      nav.innerHTML = TABS.map(t=>`<button class="tab${t.id===activeTab?' active':''}" data-tab="${t.id}">${t.label}</button>`).join('');
      qsa('.tab').forEach(btn=> btn.addEventListener('click', ()=>{ activeTab = btn.dataset.tab; syncTabs(); }));
    }
    function syncTabs(){
      qsa('.tab').forEach(btn=> btn.classList.toggle('active', btn.dataset.tab===activeTab));
      qsa('.panel').forEach(p=> p.classList.toggle('active', p.dataset.panel===activeTab));
    }

    // -------- 都市選択 --------
    function populateSelector(){
      const prefSel = qs('#prefectureSelect');
      const muniSel = qs('#municipalitySelect');
      if(!prefSel || !muniSel){ return; }

      // デバッグ用ログ
      console.log('[populateSelector] 初期化開始');
      console.log('[populateSelector] regionOptions:', regionOptions);
      console.log('[populateSelector] availableRegions総数:', availableRegions.length);

      // 都道府県リストを取得（regionOptionsから、またはavailableRegionsから抽出）
      let prefectures = [];
      if(regionOptions && Array.isArray(regionOptions.prefectures) && regionOptions.prefectures.length){
        prefectures = regionOptions.prefectures.slice().sort();
        console.log('[populateSelector] 都道府県リスト（regionOptionsから）:', prefectures.length);
      } else if(availableRegions.length){
        prefectures = [...new Set(availableRegions.map(r => r.prefecture).filter(Boolean))].sort();
        console.log('[populateSelector] 都道府県リスト（availableRegionsから）:', prefectures.length);
      }

      if(prefectures.length){

        // 都道府県プルダウンを設定
        prefSel.innerHTML = '<option value="">-- 都道府県を選択 --</option>' +
          prefectures.map(pref => `<option value="${pref}">${pref}</option>`).join('');

        // 初期選択の都道府県を設定
        const initialPref = selectedRegion?.prefecture || prefectures[0] || '';
        if(initialPref){
          selectedPrefecture = initialPref;
          prefSel.value = initialPref;
          populateMunicipalitySelector(initialPref); // 市区町村プルダウンのみ更新
        }

        // 都道府県変更時のイベント
        prefSel.onchange = (e)=>{
          const pref = e.target.value;
          selectedPrefecture = pref;
          if(pref){
            // GAS環境: 都道府県変更時に新しいavailableRegionsを取得
            if(typeof google !== 'undefined' && google.script && google.script.run){
              google.script.run
                .withSuccessHandler(function(payload){
                  if(payload && payload.availableRegions){
                    // 新しい市区町村リストで更新
                    availableRegions = payload.availableRegions;
                    selectedRegion = payload.selectedRegion;
                    populateMunicipalitySelector(pref);
                    // 自動的に最初の市区町村を選択してデータをロード
                    const firstMuni = payload.selectedRegion?.municipality;
                    if(firstMuni){
                      requestRegion(pref, firstMuni);
                    }
                  }
                })
                .withFailureHandler(function(err){
                  console.error('都道府県変更時のデータ取得に失敗しました', err);
                })
                .getMapCompleteData(pref, '');
            } else {
              // ローカルモード: フォールバックデータから検索
              populateMunicipalitySelector(pref);
            }
          } else {
            muniSel.innerHTML = '<option value="">-- 市区町村を選択 --</option>';
          }
        };
      } else {
        // フォールバック（availableRegionsがない場合）
        prefSel.innerHTML = '<option value="">データなし</option>';
        muniSel.innerHTML = '<option value="">データなし</option>';
      }
    }

    function populateMunicipalitySelector(prefecture, autoLoad = false){
      const muniSel = qs('#municipalitySelect');
      if(!muniSel){ return; }

      // デバッグ用ログ
      console.log(`[populateMunicipalitySelector] 都道府県: ${prefecture}`);
      console.log(`[populateMunicipalitySelector] availableRegions総数: ${availableRegions.length}`);

      // 選択された都道府県の市区町村リストを抽出
      const municipalities = availableRegions
        .filter(r => r.prefecture === prefecture)
        .map(r => ({
          key: r.key,
          municipality: r.municipality || '全域',
          label: r.municipality || '全域'
        }))
        .sort((a, b) => a.municipality.localeCompare(b.municipality, 'ja'));

      console.log(`[populateMunicipalitySelector] フィルタ後の市区町村数: ${municipalities.length}`);

      if(municipalities.length === 0){
        muniSel.innerHTML = '<option value="">市区町村なし</option>';
        console.warn(`[populateMunicipalitySelector] ${prefecture}の市区町村が見つかりません`);
        return;
      }

      // 市区町村プルダウンを設定
      muniSel.innerHTML = municipalities.map(m =>
        `<option value="${m.key}">${m.label}</option>`
      ).join('');

      // 初期選択の市区町村を設定
      const targetKey = selectedRegion?.key || municipalities[0]?.key || '';
      muniSel.value = targetKey;

      // 市区町村変更時のイベント
      muniSel.onchange = (e)=>{
        const key = e.target.value;
        const hit = availableRegions.find(r => r.key === key);
        if(hit){
          requestRegion(hit.prefecture, hit.municipality);
        }
      };

      // 初回ロード時のみデータをリクエスト
      if(autoLoad && targetKey){
        const hit = availableRegions.find(r => r.key === targetKey);
        if(hit){
          requestRegion(hit.prefecture, hit.municipality);
        }
      }
    }
    function panToCity(){
      const c = DATA[activeCity];
      if(c?.center && map){ map.setView(c.center, 12, {animate:true}); }
    }
    function toRGBA(hex, alpha){
      if(!hex){ return `rgba(56,189,248,${alpha})`; }
      const cleaned = hex.replace('#','');
      const parseComponent = (pair)=> parseInt(pair,16) || 0;
      let r,g,b;
      if(cleaned.length===3){
        r = parseComponent(cleaned[0]+cleaned[0]);
        g = parseComponent(cleaned[1]+cleaned[1]);
        b = parseComponent(cleaned[2]+cleaned[2]);
      } else if(cleaned.length===6){
        r = parseComponent(cleaned.slice(0,2));
        g = parseComponent(cleaned.slice(2,4));
        b = parseComponent(cleaned.slice(4,6));
      } else {
        return `rgba(56,189,248,${alpha})`;
      }
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    function selectCityByIndex(index, city){
      if(typeof index !== 'number' || !DATA[index]){
        return;
      }
      activeCity = index;
      const target = city || DATA[index];
      if(target && target.region){
        selectedRegion = target.region;
      }
      renderCity();
    }
    function renderMarkers(){
      if(!map || !markersLayer){
        return;
      }
      markersLayer.clearLayers();

      // 選択中の地域のピン（赤色）
      const currentCity = DATA[activeCity];
      if(currentCity && Array.isArray(currentCity.center) && currentCity.center.length >= 2){
        const currentMarker = L.circleMarker(currentCity.center, {
          radius: 11,
          weight: 3,
          color: '#ef4444',
          fillColor: '#ef4444',
          fillOpacity: 0.92
        });
        currentMarker.bindTooltip(currentCity.name || '選択中', {direction:'top', permanent:false});
        markersLayer.addLayer(currentMarker);
      }

      // 近隣地域のピン（青色、クリック可能）
      const nearbyRegions = currentCity?.flow?.nearby_regions || [];
      nearbyRegions.forEach((region)=>{
        if(!region || !region.lat || !region.lng){
          return;
        }

        const nearbyMarker = L.circleMarker([region.lat, region.lng], {
          radius: 8,
          weight: 2,
          color: region.type === 'inflow' ? '#3b82f6' : '#f97316', // 流入=青、流出=オレンジ
          fillColor: region.type === 'inflow' ? '#3b82f6' : '#f97316',
          fillOpacity: 0.7
        });

        const flowLabel = region.type === 'inflow' ? '流入元' : '流出先';
        const tooltip = `${region.prefecture} ${region.municipality}\n${flowLabel}: ${region.flow_count}人`;
        nearbyMarker.bindTooltip(tooltip, {direction:'top'});

        // クリック時に該当地域に切り替え
        nearbyMarker.on('click', ()=>{
          requestRegion(region.prefecture, region.municipality);
        });

        markersLayer.addLayer(nearbyMarker);
      });
    }
    function requestRegion(prefecture, municipality){
      if(typeof google !== 'undefined' && google.script && google.script.run){
        google.script.run
          .withSuccessHandler(applyPayload)
          .withFailureHandler(function(err){
            console.error('地域データ取得に失敗しました', err);
          })
          .getMapCompleteData(prefecture || '', municipality || '');
      } else {
        // ローカルモード：フォールバックデータから該当地域を検索
        const targetCity = fallbackPayload.cities.find(c => {
          if(!c.region) return false;
          const prefMatch = !prefecture || c.region.prefecture === prefecture;
          const muniMatch = !municipality || c.region.municipality === municipality;
          return prefMatch && muniMatch;
        });

        if(targetCity){
          // 該当地域が見つかった場合、そのデータを表示
          const payload = {
            cities: fallbackPayload.cities,
            selectedRegion: targetCity.region,
            regionOptions: null,
            availableRegions: fallbackPayload.availableRegions
          };
          applyPayload(payload);
        } else {
          console.warn('該当する地域データが見つかりませんでした:', prefecture, municipality);
        }
      }
    }

    // -------- チャート共通 --------
    function chartBase(){ return { responsive:true, maintainAspectRatio:false, animation:{duration:350} }; }
    function upsertChart(id, cfg){
      if(charts[id]){ charts[id].destroy(); delete charts[id]; }
      const cv = document.getElementById(id); if(!cv) return;
      charts[id] = new Chart(cv.getContext('2d'), cfg);
    }

    // -------- タブ描画 --------
    function renderOverview(city){
      const panel = qs('.panel[data-panel="overview"]');
      const o = city.overview || {kpis:[],age_gender:{},averages:{}};
      const kpiHTML = (o.kpis||[]).map(k=>{
        const v = Array.isArray(k.values)
          ? k.values.map((vv,i)=>`${k.labels?.[i]||''}: ${numberFmt.format(vv)}${k.unit||''}`).join(' / ')
          : (k.unit==='割合' ? percentFmt.format(k.value||0) : (typeof k.value==='number' ? numberFmt.format(k.value)+ (k.unit||'') : (k.value||'-')));
        return `<div class="kpi"><div class="label">${k.label}</div><div class="value">${v}</div>${k.note?`<div class="row" style="font-size:11px;color:var(--muted)">${k.note}</div>`:''}</div>`;
      }).join('');
      const avgRows = Object.entries(o.averages||{}).map(([label,val])=>`<div class="row"><span>${label}</span><span>${Number(val).toFixed(2)}</span></div>`).join('');

      panel.innerHTML = `
        <div class="kpis">${kpiHTML}</div>
        <div class="section"><h2>主要指標の平均値</h2><div class="stats">${avgRows}</div></div>
        <div class="section"><h2>ビジュアルサマリー</h2>
          <div class="chart-grid">
            <div class="chart-card"><header>性別構成</header><div class="chart-body"><canvas id="ovGender"></canvas></div></div>
            <div class="chart-card"><header>年齢帯別求職者数</header><div class="chart-body"><canvas id="ovAge"></canvas></div></div>
          </div>
        </div>`;

      const gl = o.age_gender?.gender_labels || ['男性','女性'];
      const gt = o.age_gender?.gender_totals || [];
      upsertChart('ovGender', {
        type:'doughnut',
        data:{ labels:gl, datasets:[{ data:gt, backgroundColor:COLOR.slice(0,gl.length) }] },
        options:{...chartBase(), plugins:{legend:{position:'bottom'}}}
      });

      const al = o.age_gender?.age_labels || [];
      const at = o.age_gender?.age_totals || [];
      upsertChart('ovAge', {
        type:'bar',
        data:{ labels:al, datasets:[{ label:'人数', data:at, backgroundColor:COLOR[0] }] },
        options:{...chartBase(), scales:{ y:{ beginAtZero:true } }}
      });
    }

    function renderSupply(city){
      const panel = qs('.panel[data-panel="supply"]');
      const s = city.supply||{status_counts:{},qualification_buckets:[]};
      const statusRows = Object.entries(s.status_counts||{}).map(([k,v])=>`<div class="row"><span>${k}</span><span>${numberFmt.format(v)}人</span></div>`).join('');
      const extras = `
        <div class="row"><span>国家資格保有者</span><span>${numberFmt.format(s.national_license_count||0)}人</span></div>
        <div class="row"><span>平均資格保有数</span><span>${Number(s.avg_qualifications||0).toFixed(2)}</span></div>`;
      const qRows = (s.qualification_buckets||[]).map(b=>`<tr><th>${b.label}</th><td>${numberFmt.format(b.value)}人</td></tr>`).join('');
      const qualificationSummary = Array.isArray(city.persona?.qualification_summary) ? city.persona.qualification_summary.slice(0,6) : [];
      const personaQualHTML = qualificationSummary.length ? `
        <div class="section">
          <h2>ペルソナ別平均資格保有数</h2>
          <div class="chart-grid supply-qualification-grid">
            <div class="chart-card chart-card--tight"><header>平均資格数</header><div class="chart-body"><canvas id="spPersonaQual"></canvas></div></div>
          </div>
          <div class="table-wrap"><table class="data-table">
            <thead><tr><th>ペルソナ</th><th>平均資格数</th><th>主資格カテゴリ</th><th>人数</th></tr></thead>
            <tbody>${qualificationSummary.map(item=>`<tr><td>${item.persona}</td><td>${Number(item.avg_qualifications||0).toFixed(2)}</td><td>${item.top_bucket||'-'}</td><td>${numberFmt.format(item.count||0)}</td></tr>`).join('')}</tbody>
          </table></div>
        </div>
      ` : '';

      panel.innerHTML = `
        <div class="section"><h2>ステータスサマリー</h2><div class="stats">${statusRows}${extras}</div></div>
        <div class="section"><h2>ビジュアル</h2>
          <div class="chart-grid">
            <div class="chart-card"><header>就業ステータス</header><div class="chart-body"><canvas id="spStatus"></canvas></div></div>
            <div class="chart-card"><header>保有資格カテゴリ</header><div class="chart-body"><canvas id="spQual"></canvas></div></div>
          </div>
        </div>
        <div class="matrix"><table><thead><tr><th>カテゴリ</th><th>人数</th></tr></thead><tbody>${qRows}</tbody></table></div>
        ${personaQualHTML}`;

      const stEntries = Object.entries(s.status_counts||{});
      upsertChart('spStatus', {
        type:'bar',
        data:{ labels:stEntries.map(([k])=>k), datasets:[{ label:'人数', data:stEntries.map(([,v])=>v), backgroundColor:COLOR.slice(0,stEntries.length)}] },
        options:{...chartBase(), scales:{ y:{ beginAtZero:true } }}
      });

      const buckets = s.qualification_buckets||[];
      const colors = buckets.map((_,idx)=>COLOR[idx % COLOR.length]);
      upsertChart('spQual', {
        type:'doughnut',
        data:{ labels:buckets.map(b=>b.label), datasets:[{ data:buckets.map(b=>b.value), backgroundColor:colors }]},
        options:{...chartBase(), plugins:{legend:{position:'bottom'}} }
      });

      if(qualificationSummary.length){
        const qualLabels = qualificationSummary.map(item=>item.persona);
        const qualValues = qualificationSummary.map(item=>Number(item.avg_qualifications||0));
        upsertChart('spPersonaQual', {
          type:'bar',
          data:{ labels:qualLabels, datasets:[{ label:'平均資格数', data:qualValues, backgroundColor:COLOR.slice(0,qualLabels.length)}]},
          options:{...chartBase(), indexAxis:'y', scales:{ x:{ beginAtZero:true } }, plugins:{legend:{display:false}} }
        });
      }
    }

    function renderCareer(city){
      const panel = qs('.panel[data-panel="career"]');
      const c = city.career||{summary:{},employment_age:{age_labels:[],rows:[]}};
      const sumRows = Object.entries(c.summary||{}).map(([k,v])=> k==='国家資格保有率'
        ? `<div class="row"><span>${k}</span><span>${percentFmt.format(v)}</span></div>`
        : `<div class="row"><span>${k}</span><span>${Number(v).toFixed(2)}</span></div>`).join('');
      const al = c.employment_age?.age_labels||[];

      panel.innerHTML = `
        <div class="section"><h2>キャリア指標</h2><div class="stats">${sumRows}</div></div>
        <div class="section"><h2>就業ステータス × 年齢帯</h2>
          <div class="chart-grid">
            <div class="chart-card"><header>年齢帯別構成</header><div class="chart-body"><canvas id="crEmp"></canvas></div></div>
          </div>
        </div>`;

      const ds = (c.employment_age?.rows||[]).map((row,i)=>({ label:row.status, data:row.counts, backgroundColor:COLOR[i%COLOR.length], stack:'career' }));
      upsertChart('crEmp', { type:'bar', data:{ labels:al, datasets:ds }, options:{...chartBase(), scales:{ x:{stacked:true}, y:{stacked:true, beginAtZero:true} } }});
    }

    function renderUrgency(city){
      const panel = qs('.panel[data-panel="urgency"]');
      const u = city.urgency||{summary:{},by_age:[],by_employment:[]};
      const sumRows = Object.entries(u.summary||{}).map(([k,v])=> k==='平均スコア'
        ? `<div class="row"><span>${k}</span><span>${v?Number(v).toFixed(2):'-'}</span></div>`
        : `<div class="row"><span>${k}</span><span>${numberFmt.format(v)}人</span></div>`).join('');

      panel.innerHTML = `
        <div class="section"><h2>緊急度サマリー</h2><div class="stats">${sumRows}</div></div>
        <div class="section"><h2>緊急度チャート</h2>
          <div class="chart-grid">
            <div class="chart-card"><header>年齢帯別</header><div class="chart-body"><canvas id="ugAge"></canvas></div></div>
            <div class="chart-card"><header>就業ステータス別</header><div class="chart-body"><canvas id="ugEmp"></canvas></div></div>
          </div>
        </div>`;

      const ageL = (u.by_age||[]).map(r=>r.age_group), ageC=(u.by_age||[]).map(r=>r.count), ageS=(u.by_age||[]).map(r=>r.avg_score||0);
      upsertChart('ugAge', {
        type:'bar',
        data:{
          labels:ageL,
          datasets:[
            {type:'bar',label:'人数',data:ageC,backgroundColor:COLOR[0],yAxisID:'y'},
            {type:'line',label:'平均スコア',data:ageS,borderColor:COLOR[1],backgroundColor:COLOR[1],tension:.3,yAxisID:'y1'}
          ]
        },
        options:{...chartBase(), scales:{ y:{ beginAtZero:true, title:{display:true,text:'人数'} }, y1:{ position:'right', min:0, max:10, title:{display:true,text:'平均スコア'}, grid:{ drawOnChartArea:false } } }}
      });

      const empL = (u.by_employment||[]).map(r=>r.status), empC=(u.by_employment||[]).map(r=>r.count), empS=(u.by_employment||[]).map(r=>r.avg_score||0);
      upsertChart('ugEmp', {
        type:'bar',
        data:{
          labels:empL,
          datasets:[
            {type:'bar',label:'人数',data:empC,backgroundColor:COLOR[2],yAxisID:'y'},
            {type:'line',label:'平均スコア',data:empS,borderColor:COLOR[3],backgroundColor:COLOR[3],tension:.3,yAxisID:'y1'}
          ]
        },
        options:{...chartBase(), scales:{ y:{ beginAtZero:true, title:{display:true,text:'人数'} }, y1:{ position:'right', min:0, max:10, title:{display:true,text:'平均スコア'}, grid:{ drawOnChartArea:false } } }}
      });
    }

    function renderPersona(city){
      const panel = qs('.panel[data-panel="persona"]');
      const list = (city.persona?.top)||[];
      const li = list.map(it=>`<li class="row"><span>${it.label}</span><span>${numberFmt.format(it.count)}人 / ${percentFmt.format(it.share||0)}</span></li>`).join('');

      // ペルソナ詳細データ（難易度分析用）
      const personaDetails = city.persona?.details || generateMockPersonaDetails(list);

      panel.innerHTML = `
        <div class="section"><h2>主要ペルソナ</h2>
          <div class="chart-grid"><div class="chart-card"><header>構成比</header><div class="chart-body"><canvas id="psShare"></canvas></div></div></div>
          <ul style="display:grid;gap:8px;font-size:13px;list-style:none;padding-left:0">${li}</ul>
        </div>

        <div class="section" style="margin-top:24px">
          <h2>🎯 ペルソナ難易度分析</h2>
          <p style="color:var(--muted);font-size:13px;margin-bottom:16px">
            ※ 選択中の市町村「<span id="targetMunicipality" style="color:var(--accent);font-weight:bold"></span>」を希望勤務地とする人材を分析
          </p>
          <div class="persona-filter-panel">
            <div class="filter-grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))">
              <div class="filter-group">
                <label class="filter-label">難易度レベル</label>
                <select id="difficultyFilter" multiple>
                  <option value="S">S級（最難）</option>
                  <option value="A">A級（難）</option>
                  <option value="B">B級（やや難）</option>
                  <option value="C">C級（普通）</option>
                  <option value="D">D級（やや易）</option>
                  <option value="E">E級（易）</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">年齢層</label>
                <select id="ageGroupFilter" multiple>
                  <option value="新卒層">新卒層（～24歳）</option>
                  <option value="若手層">若手層（25～29歳）</option>
                  <option value="若手中堅層">若手中堅層（30～34歳）</option>
                  <option value="中堅層">中堅層（35～39歳）</option>
                  <option value="ミドル層">ミドル層（40～44歳）</option>
                  <option value="シニアミドル層">シニアミドル層（45～49歳）</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">性別</label>
                <select id="genderFilter" multiple>
                  <option value="女性">女性</option>
                  <option value="男性">男性</option>
                  <option value="その他">その他・無回答</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">保有資格</label>
                <select id="qualificationFilter" multiple>
                  <option value="介護福祉士">介護福祉士</option>
                  <option value="看護師">看護師</option>
                  <option value="保育士">保育士</option>
                  <option value="准看護師">准看護師</option>
                  <option value="社会福祉士">社会福祉士</option>
                  <option value="ケアマネジャー">ケアマネジャー</option>
                  <option value="実務者研修">実務者研修</option>
                  <option value="初任者研修">初任者研修</option>
                  <option value="無資格">無資格</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">居住地</label>
                <select id="residenceFilter" multiple>
                  <option value="京都府">京都府</option>
                  <option value="大阪府">大阪府</option>
                  <option value="東京都">東京都</option>
                  <option value="兵庫県">兵庫県</option>
                  <option value="奈良県">奈良県</option>
                  <option value="滋賀県">滋賀県</option>
                  <option value="その他">その他</option>
                </select>
              </div>
            </div>
            <div style="margin-top:16px;display:flex;gap:10px">
              <button class="btn-filter-apply" onclick="applyPersonaFilters()">絞り込み実行</button>
              <button class="btn-filter-reset" onclick="resetPersonaFilters()">フィルタークリア</button>
            </div>
          </div>
          <div id="personaCardsContainer" class="persona-grid"></div>
        </div>
      `;

      upsertChart('psShare', {
        type:'doughnut',
        data:{ labels:list.map(i=>i.label), datasets:[{ data:list.map(i=>i.count), backgroundColor:list.map((_,i)=>COLOR[i%COLOR.length]) }] },
        options:{...chartBase(), plugins:{legend:{position:'bottom'}}}
      });

      // ペルソナカード初期表示
      window.currentPersonaDetails = personaDetails;
      displayPersonaCards(personaDetails);

      // 選択中の市町村名を表示
      const targetMuniSpan = qs('#targetMunicipality');
      if(targetMuniSpan && city.name){
        targetMuniSpan.textContent = city.name;
      }
    }

    // モックペルソナ詳細データ生成（実データがない場合）
    function generateMockPersonaDetails(topList){
      const difficultyLevels = ['S','A','B','C','D','E'];
      const ageGroups = ['新卒層','若手層','若手中堅層','中堅層','ミドル層','シニアミドル層'];
      const genders = ['女性', '男性', '女性', '女性', '男性', 'その他'];
      const residences = ['京都府', '大阪府', '京都府', '兵庫県', '大阪府', '奈良県', '滋賀県', '東京都'];
      const qualsList = [
        ['介護福祉士', '実務者研修'],
        ['看護師'],
        ['保育士'],
        ['介護福祉士', 'ケアマネジャー'],
        ['准看護師', '初任者研修'],
        ['無資格'],
        ['社会福祉士', '介護福祉士'],
        ['初任者研修']
      ];

      return topList.map((item, idx) => ({
        segmentId: `SEG${idx+1}`,
        segmentName: item.label,
        count: item.count,
        percentage: (item.share || 0) * 100,
        difficultyLevel: difficultyLevels[idx % difficultyLevels.length],
        difficultyScore: 85 - (idx * 10),
        avgAge: 28 + (idx * 3),
        femaleRatio: 0.6 + (idx * 0.05),
        avgQualifications: 2.5 - (idx * 0.3),
        avgDesiredLocations: 3.2 - (idx * 0.4),
        ageGroup: ageGroups[idx % ageGroups.length],
        gender: genders[idx % genders.length],
        residence: residences[idx % residences.length],
        qualifications: qualsList[idx % qualsList.length],
        qualificationLevel: qualsList[idx % qualsList.length][0] || '無資格',
        mobilityLevel: idx < 3 ? '狭域希望' : '中域希望',
        genderCategory: '女性優勢層',
        marketSizeCategory: idx === 0 ? '大規模' : idx < 3 ? '中規模' : '小規模'
      }));
    }

    // ペルソナカード表示
    function displayPersonaCards(personas){
      const container = qs('#personaCardsContainer');
      if(!container) return;

      if(!personas || personas.length === 0){
        container.innerHTML = '<div class="empty-placeholder">ペルソナデータがありません</div>';
        return;
      }

      const cards = personas.map(p => {
        const diffClass = `difficulty-${p.difficultyLevel}`;
        const genderIcon = p.gender === '男性' ? '👨' : p.gender === '女性' ? '👩' : '👤';
        const qualsDisplay = Array.isArray(p.qualifications)
          ? p.qualifications.join('、')
          : p.qualificationLevel || '-';

        return `
          <div class="persona-card">
            <div class="difficulty-badge ${diffClass}">
              ${p.difficultyLevel}級 (${p.difficultyScore}点)
            </div>
            <div class="persona-header">
              <div class="persona-title">${genderIcon} ${p.segmentName}</div>
              <div class="persona-subtitle">
                セグメントID: ${p.segmentId} | ${numberFmt.format(p.count)}人 (${p.percentage.toFixed(1)}%)
              </div>
            </div>
            <div class="persona-metrics">
              <div class="metric-item">
                <div class="metric-label">年齢/性別</div>
                <div class="metric-value">${p.avgAge.toFixed(1)}歳 ${p.gender}</div>
              </div>
              <div class="metric-item">
                <div class="metric-label">居住地</div>
                <div class="metric-value">${p.residence || '-'}</div>
              </div>
              <div class="metric-item">
                <div class="metric-label">女性比率</div>
                <div class="metric-value">${(p.femaleRatio * 100).toFixed(1)}%</div>
              </div>
              <div class="metric-item">
                <div class="metric-label">希望勤務地数</div>
                <div class="metric-value">${p.avgDesiredLocations.toFixed(1)}箇所</div>
              </div>
            </div>
            <div style="margin:12px 0;padding:10px;background:rgba(148,163,184,0.08);border-radius:6px">
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px">保有資格</div>
              <div style="font-size:13px;color:var(--text);font-weight:500">${qualsDisplay}</div>
            </div>
            <div class="score-bar">
              <div class="score-fill" style="width: ${p.difficultyScore}%"></div>
            </div>
            <div class="persona-categories">
              <div class="category-tag">${p.ageGroup}</div>
              <div class="category-tag">${p.mobilityLevel}</div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = cards;
    }

    // フィルタリング機能
    window.applyPersonaFilters = function(){
      const difficultyFilter = Array.from(qs('#difficultyFilter')?.selectedOptions || []).map(o => o.value);
      const ageGroupFilter = Array.from(qs('#ageGroupFilter')?.selectedOptions || []).map(o => o.value);
      const genderFilter = Array.from(qs('#genderFilter')?.selectedOptions || []).map(o => o.value);
      const qualFilter = Array.from(qs('#qualificationFilter')?.selectedOptions || []).map(o => o.value);
      const residenceFilter = Array.from(qs('#residenceFilter')?.selectedOptions || []).map(o => o.value);

      let filtered = window.currentPersonaDetails || [];

      if(difficultyFilter.length > 0){
        filtered = filtered.filter(p => difficultyFilter.includes(p.difficultyLevel));
      }
      if(ageGroupFilter.length > 0){
        filtered = filtered.filter(p => ageGroupFilter.includes(p.ageGroup));
      }
      if(genderFilter.length > 0){
        filtered = filtered.filter(p => genderFilter.includes(p.gender));
      }
      if(qualFilter.length > 0){
        // 保有資格は配列なので、選択された資格のいずれかを持っているペルソナを抽出
        filtered = filtered.filter(p => {
          if(!Array.isArray(p.qualifications)) return false;
          return p.qualifications.some(q => qualFilter.includes(q));
        });
      }
      if(residenceFilter.length > 0){
        filtered = filtered.filter(p => residenceFilter.includes(p.residence));
      }

      displayPersonaCards(filtered);
    };

    window.resetPersonaFilters = function(){
      qs('#difficultyFilter').selectedIndex = -1;
      qs('#ageGroupFilter').selectedIndex = -1;
      qs('#genderFilter').selectedIndex = -1;
      qs('#qualificationFilter').selectedIndex = -1;
      qs('#residenceFilter').selectedIndex = -1;
      displayPersonaCards(window.currentPersonaDetails || []);
    };

    // ========== Dashboard Tab ==========
    function renderDashboard(city){
      const panel = qs('.panel[data-panel="dashboard"]');
      if(!panel) return;

      const phases = [
        {id:'phase1', label:'Phase 1: 基礎集計', data:city.overview},
        {id:'phase2', label:'Phase 2: 統計解析', data:city.stats},
        {id:'phase3', label:'Phase 3: ペルソナ分析', data:city.persona},
        {id:'phase7', label:'Phase 7: 高度分析', data:city.supply},
        {id:'phase8', label:'Phase 8: 学歴・キャリア', data:city.career},
        {id:'phase10', label:'Phase 10: 転職意欲', data:city.urgency}
      ];

      const phaseTabs = phases.map(p=>
        `<button class="phase-tab-btn" data-phase="${p.id}">${p.label}</button>`
      ).join('');

      panel.innerHTML = `
        <div class="dashboard-container">
          <h2 style="color:var(--text);margin-bottom:20px">📊 地域別ダッシュボード</h2>
          <div class="phase-tabs">${phaseTabs}</div>
          <div id="dashboardContent">
            <div class="empty-placeholder">Phase を選択してください</div>
          </div>
        </div>
      `;

      qsa('.phase-tab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          qsa('.phase-tab-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const phaseId = btn.dataset.phase;
          const phase = phases.find(p=>p.id===phaseId);
          renderDashboardPhase(phase, city);
        });
      });
    }

    function renderDashboardPhase(phase, city){
      const content = qs('#dashboardContent');
      if(!content || !phase) return;

      let html = `<h3 style="color:var(--text);margin-bottom:16px">${phase.label}</h3>`;

      if(!phase.data){
        html += `<div class="empty-placeholder">このPhaseのデータがありません</div>`;
      } else {
        // KPIs表示
        const kpis = phase.data.kpis || [];
        if(kpis.length){
          html += `<div class="summary-grid">`;
          kpis.forEach(kpi=>{
            const val = kpi.unit==='割合' ? percentFmt.format(kpi.value||0) : numberFmt.format(kpi.value||0)+(kpi.unit||'');
            html += `<div class="summary-card"><div class="label">${kpi.label}</div><div class="value">${val}</div></div>`;
          });
          html += `</div>`;
        }

        // テーブル表示（top10など）
        if(phase.data.top){
          const rows = phase.data.top.map(item=>
            `<tr><td>${item.label}</td><td>${numberFmt.format(item.count)}人</td><td>${percentFmt.format(item.share||0)}</td></tr>`
          ).join('');
          html += `
            <div class="table-group">
              <div class="table-title">主要項目</div>
              <div class="table-wrap">
                <table class="data-table">
                  <thead><tr><th>項目</th><th>人数</th><th>割合</th></tr></thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>
            </div>
          `;
        }
      }

      content.innerHTML = html;
    }


    function formatValue(value, key){
      if (value === null || value === undefined || value === '') {
        return '-';
      }
      if (typeof value === 'number') {
        if (key && /share|rate|ratio|比率|構成|割合/i.test(key) && value >= 0 && value <= 1) {
          return percentFmt.format(value);
        }
        return numberFmt.format(value);
      }
      const num = Number(value);
      if (!Number.isNaN(num)) {
        if (key && /share|rate|ratio|比率|構成|割合/i.test(key) && num >= 0 && num <= 1) {
          return percentFmt.format(num);
        }
        return numberFmt.format(num);
      }
      return String(value);
    }

    function renderRecordsTable(title, records, options){
      if(!records || !records.length){
        return null;
      }
      const limit = options?.limit || 20;
      const sample = records[0];
      const excluded = options?.exclude || [];
      let keys = options?.keys || Object.keys(sample || {}).filter(key => !excluded.includes(key)).slice(0, options?.maxColumns || 6);
      if(!keys.length){
        keys = Object.keys(sample || {});
      }
        const rows = records.slice(0, limit).map(rec=>{
          const cells = keys.map(key=>`<td>${formatValue(rec[key], key)}</td>`).join('');
        return `<tr>${cells}</tr>`;
      }).join('');
      const header = keys.map(key=>`<th>${key}</th>`).join('');
      return {
        html: `<div class="section"><h2>${title}</h2><div class="table-wrap"><table class="data-table"><thead><tr>${header}</tr></thead><tbody>${rows}</tbody></table></div></div>`
      };
    }

    function renderMatrixSection(title, matrix, options){
      if(!matrix || !matrix.rows || !matrix.columns || !matrix.rows.length){
        return null;
      }
      const rowLabel = options?.rowLabel || '';
      const columnLabel = options?.columnLabel || '';
      const chartId = options?.chartId || `${title.replace(/[^a-zA-Z0-9]/g,'')}-chart`;
      const chartHeader = options?.chartTitle || `${title}（グラフ）`;
      const headerCells = matrix.columns.map(col=>`<th>${col}</th>`).join('');
      const body = matrix.rows.map((rowLabelValue, rowIndex)=>{
        const valueCells = (matrix.values[rowIndex] || []).map(val=>`<td>${formatValue(val)}</td>`).join('');
        const total = matrix.row_totals ? formatValue(matrix.row_totals[rowIndex]) : '';
        return `<tr><th>${rowLabelValue}</th>${valueCells}${matrix.row_totals ? `<td>${total}</td>` : ''}</tr>`;
      }).join('');
      const totals = matrix.column_totals ? `<tr><th>合計</th>${matrix.column_totals.map(val=>`<td>${formatValue(val)}</td>`).join('')}<td>${formatValue(matrix.total)}</td></tr>` : '';
      const totalHeader = matrix.column_totals ? '<th>合計</th>' : '';
      const html = `
        <div class="section">
          <h2>${title}</h2>
          <div class="chart-grid"><div class="chart-card"><header>${chartHeader}</header><div class="chart-body"><canvas id="${chartId}"></canvas></div></div></div>
          <div class="matrix"><table><thead><tr><th>${rowLabel}</th>${headerCells}${totalHeader}</tr></thead><tbody>${body}${totals}</tbody></table></div>
        </div>
      `;
      return {
        html: html,
        chart: { id: chartId, matrix: matrix, rowLabel: rowLabel, columnLabel: columnLabel }
      };
    }

    function renderMatrixChart(job){
      if(!job || !job.id || !job.matrix){
        return;
      }
      const labels = job.matrix.rows || [];
      const datasets = (job.matrix.columns || []).map(function (columnLabel, columnIndex){
        const data = (job.matrix.values || []).map(function (rowValues){ return rowValues[columnIndex] || 0; });
        return {
          label: columnLabel,
          data: data,
          backgroundColor: COLOR[columnIndex % COLOR.length],
          stack: 'stack'
        };
      });
      upsertChart(job.id, {
        type: 'bar',
        data: { labels: labels, datasets: datasets },
        options: {
          ...chartBase(),
          indexAxis: 'y',
          scales: {
            x: { beginAtZero: true, stacked: true, title: { display: true, text: job.columnLabel || '' } },
            y: { stacked: true, title: { display: !!job.rowLabel, text: job.rowLabel || '' } }
          },
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function renderCross(city){
      const panel = qs('.panel[data-panel="cross"]');
      const insights = city.cross_insights || {};
      const persona = city.persona || {};
      const blocks = [];
      const chartJobs = [];
      const highlights = [];

      const avgDifficulty = Number(insights.personaDifficulty?.summary?.averageDifficultyScore);
      if (Number.isFinite(avgDifficulty)) {
        highlights.push({ label: '平均募集難易度', main: avgDifficulty.toFixed(1), sub: 'スコア(1=易〜5=難)' });
      }

      const topPersona = Array.isArray(persona.top) && persona.top.length ? persona.top[0] : null;
      if (topPersona) {
        const share = typeof topPersona.share === 'number' ? percentFmt.format(topPersona.share) : null;
        const sub = share || `${numberFmt.format(topPersona.count || 0)}人`;
        highlights.push({ label: '最多ペルソナ', main: topPersona.label || '-', sub: sub });
      }

      const qualLeader = Array.isArray(persona.qualification_summary) && persona.qualification_summary.length ? persona.qualification_summary[0] : null;
      if (qualLeader) {
        highlights.push({
          label: '資格レベル先頭',
          main: qualLeader.persona || '-',
          sub: `平均${Number(qualLeader.avg_qualifications || 0).toFixed(2)}資格`
        });
      }

      const urgencyHotspot = Array.isArray(city.urgency?.municipality) && city.urgency.municipality.length ? city.urgency.municipality[0] : null;
      if (urgencyHotspot) {
        highlights.push({
          label: '応募集中地域',
          main: urgencyHotspot.municipality || urgencyHotspot.city || '-',
          sub: `${numberFmt.format(urgencyHotspot.count || 0)}件`
        });
      }

      if (highlights.length) {
        const chipHtml = highlights.map(item => `<div class="chip"><span class="chip-label">${item.label}</span><strong>${item.main}</strong>${item.sub ? `<span class="chip-sub">${item.sub}</span>` : ''}</div>`).join('');
        blocks.push(`<div class="section cross-highlights"><h2>クロス重点指標</h2><div class="chip-grid">${chipHtml}</div></div>`);
      }

      const difficulty = renderRecordsTable('ペルソナ難易度サマリー', insights.personaDifficulty?.table, {limit:20});
      if(difficulty){ blocks.push(difficulty.html); }


      const personaDetailTable = renderRecordsTable('ペルソナ詳細トップ', persona.details, {limit:20, keys:['persona','attribute','count']});
      if(personaDetailTable){ blocks.push(personaDetailTable.html); }

      const careerDistributionTable = renderRecordsTable('キャリア分布', city.career?.distributions?.career, {limit:20});
      if(careerDistributionTable){ blocks.push(careerDistributionTable.html); }

      const graduationTable = renderRecordsTable('卒業年分布', city.career?.distributions?.graduation, {limit:20});
      if(graduationTable){ blocks.push(graduationTable.html); }


      const personaMatrix = renderMatrixSection('ペルソナ × 移動許容度', persona.mobility_matrix, {
        rowLabel:'ペルソナ', columnLabel:'移動許容度', chartId:'personaMobilityMatrixChart'});
      if(personaMatrix){ blocks.push(personaMatrix.html); chartJobs.push(personaMatrix.chart); }

      const educationMatrix = renderMatrixSection('学歴 × 年齢帯', insights.educationMatrix, {
        rowLabel:'学歴', columnLabel:'年齢帯', chartId:'educationMatrixChart'});
      if(educationMatrix){ blocks.push(educationMatrix.html); chartJobs.push(educationMatrix.chart); }

      const careerMatrix = renderMatrixSection('キャリア × 年齢帯', insights.careerMatrix, {
        rowLabel:'キャリア', columnLabel:'年齢帯', chartId:'careerMatrixChart'});
      if(careerMatrix){ blocks.push(careerMatrix.html); chartJobs.push(careerMatrix.chart); }

      const urgencyAgeMatrix = renderMatrixSection('緊急度 × 年齢帯', city.urgency?.matrices?.age, {
        rowLabel:'年齢帯', columnLabel:'緊急度ランク', chartId:'urgencyAgeMatrixChart'});
      if(urgencyAgeMatrix){ blocks.push(urgencyAgeMatrix.html); chartJobs.push(urgencyAgeMatrix.chart); }

      const urgencyEmploymentMatrix = renderMatrixSection('緊急度 × 就業ステータス', city.urgency?.matrices?.employment, {
        rowLabel:'就業ステータス', columnLabel:'緊急度ランク', chartId:'urgencyEmploymentMatrixChart'});
      if(urgencyEmploymentMatrix){ blocks.push(urgencyEmploymentMatrix.html); chartJobs.push(urgencyEmploymentMatrix.chart); }

      const municipalityTable = renderRecordsTable('市区町村別 緊急度', city.urgency?.municipality, {limit:30});
      if(municipalityTable){ blocks.push(municipalityTable.html); }

      const personaRegionTable = renderRecordsTable('ペルソナ×地域サマリー', persona.personaSummaryByMunicipality, {limit:30, maxColumns:5});
      if(personaRegionTable){ blocks.push(personaRegionTable.html); }

      const personaQualTable = renderRecordsTable('ペルソナ別資格サマリー', persona.qualification_summary, {limit:20, keys:['persona','avg_qualifications','top_bucket','count']});
      if(personaQualTable){ blocks.push(personaQualTable.html); }

      if(!blocks.length){
        panel.innerHTML = `<div class="section"><div class="stats">クロス分析データが存在しません。</div></div>`;
        return;
      }

      panel.innerHTML = blocks.join('');
      chartJobs.forEach(job=> renderMatrixChart(job));
    }

    function renderFlowArrows(city) {
      // 地図が初期化されていない場合は終了
      if (!map) {
        console.warn('renderFlowArrows: 地図が初期化されていません');
        return;
      }

      // 既存のフローレイヤーをクリア
      if (flowLayer) {
        flowLayer.clearLayers();
      } else {
        flowLayer = L.layerGroup().addTo(map);
      }

      const flow = city.flow || {};
      const topInflows = flow.top_inflows || [];
      const topOutflows = flow.top_outflows || [];

      // Phase1_MapMetricsから座標データを取得（全地域）
      const mapMetricsData = DATA.flatMap(c => c.overview?.map_metrics || []);

      // 座標マップを作成（地域キー → {lat, lng}）
      const coordMap = {};
      mapMetricsData.forEach(record => {
        const pref = String(record.prefecture || '').trim();
        const muni = String(record.municipality || '').trim();
        const lat = Number(record.latitude || record.lat);
        const lng = Number(record.longitude || record.lng || record.lon);

        if (pref && muni && Number.isFinite(lat) && Number.isFinite(lng)) {
          const key = `${pref}${muni}`;
          coordMap[key] = { lat, lng };
        }
      });

      // 現在の地域の座標
      const currentCenter = city.center;
      if (!currentCenter || !Array.isArray(currentCenter) || currentCenter.length < 2) {
        return; // 座標がない場合は矢印を描画しない
      }

      const currentLat = currentCenter[0];
      const currentLng = currentCenter[1];

      // 流入矢印を描画（origin → current）
      topInflows.forEach((flow, index) => {
        const originPref = String(flow.origin_pref || '').trim();
        const originMuni = String(flow.origin_muni || '').trim();
        const originKey = `${originPref}${originMuni}`;
        const originCoord = coordMap[originKey];

        if (!originCoord) {
          return; // 座標が見つからない場合はスキップ
        }

        const flowCount = Number(flow.flow_count || 0);
        const weight = Math.max(2, Math.min(10, flowCount / 10)); // 2-10pxの範囲で太さを調整
        const opacity = Math.min(0.8, 0.3 + (flowCount / 100)); // 流入数に応じて透明度調整

        // ポリライン（曲線）を描画
        const latlngs = [
          [originCoord.lat, originCoord.lng],
          [currentLat, currentLng]
        ];

        const polyline = L.polyline(latlngs, {
          color: '#38bdf8', // 青色（流入）
          weight: weight,
          opacity: opacity,
          dashArray: '5, 5' // 破線
        }).addTo(flowLayer);

        // 矢印装飾を追加
        const decorator = L.polylineDecorator(polyline, {
          patterns: [
            {
              offset: '50%',
              repeat: 0,
              symbol: L.Symbol.arrowHead({
                pixelSize: 10,
                polygon: false,
                pathOptions: {
                  color: '#38bdf8',
                  fillOpacity: 1,
                  weight: 2
                }
              })
            }
          ]
        }).addTo(flowLayer);

        // ポップアップを追加
        polyline.bindPopup(`
          <strong>流入: ${flow.origin || '-'}</strong><br>
          人数: ${numberFmt.format(flowCount)}人<br>
          平均年齢: ${flow.avg_age ? Number(flow.avg_age).toFixed(1) : '-'}歳<br>
          性別: ${flow.gender_mode || '-'}
        `);
      });

      // 流出矢印を描画（current → destination）
      topOutflows.forEach((flow, index) => {
        const destPref = String(flow.destination_pref || '').trim();
        const destMuni = String(flow.destination_muni || '').trim();
        const destKey = `${destPref}${destMuni}`;
        const destCoord = coordMap[destKey];

        if (!destCoord) {
          return; // 座標が見つからない場合はスキップ
        }

        const flowCount = Number(flow.flow_count || 0);
        const weight = Math.max(2, Math.min(10, flowCount / 10)); // 2-10pxの範囲で太さを調整
        const opacity = Math.min(0.8, 0.3 + (flowCount / 100)); // 流出数に応じて透明度調整

        // ポリライン（曲線）を描画
        const latlngs = [
          [currentLat, currentLng],
          [destCoord.lat, destCoord.lng]
        ];

        const polyline = L.polyline(latlngs, {
          color: '#f97316', // オレンジ色（流出）
          weight: weight,
          opacity: opacity,
          dashArray: '5, 5' // 破線
        }).addTo(flowLayer);

        // 矢印装飾を追加
        const decorator = L.polylineDecorator(polyline, {
          patterns: [
            {
              offset: '50%',
              repeat: 0,
              symbol: L.Symbol.arrowHead({
                pixelSize: 10,
                polygon: false,
                pathOptions: {
                  color: '#f97316',
                  fillOpacity: 1,
                  weight: 2
                }
              })
            }
          ]
        }).addTo(flowLayer);

        // ポップアップを追加
        polyline.bindPopup(`
          <strong>流出: ${flow.destination || '-'}</strong><br>
          人数: ${numberFmt.format(flowCount)}人<br>
          平均年齢: ${flow.avg_age ? Number(flow.avg_age).toFixed(1) : '-'}歳<br>
          性別: ${flow.gender_mode || '-'}
        `);
      });
    }

    function renderFlow(city){
      const panel = qs('.panel[data-panel="flow"]');
      const flow = city.flow || {};
      const summary = flow.summary || {};
      const blocks = [];
      const chartJobs = [];
      const highlights = [];

      // 重要指標（KPI）
      const totalInflow = Number(summary.total_inflow);
      const totalOutflow = Number(summary.total_outflow);
      const netFlow = Number(summary.net_flow);

      if (Number.isFinite(totalInflow)) {
        highlights.push({ label: '総流入数', main: numberFmt.format(totalInflow), sub: '人' });
      }
      if (Number.isFinite(totalOutflow)) {
        highlights.push({ label: '総流出数', main: numberFmt.format(totalOutflow), sub: '人' });
      }
      if (Number.isFinite(netFlow)) {
        const netLabel = netFlow > 0 ? '純流入' : (netFlow < 0 ? '純流出' : '流入流出均衡');
        highlights.push({
          label: '純フロー',
          main: (netFlow > 0 ? '+' : '') + numberFmt.format(netFlow),
          sub: netLabel
        });
      }

      const inflowSources = Number(summary.inflow_sources);
      const outflowDestinations = Number(summary.outflow_destinations);

      if (Number.isFinite(inflowSources)) {
        highlights.push({ label: '流入元地域数', main: numberFmt.format(inflowSources), sub: '地域' });
      }
      if (Number.isFinite(outflowDestinations)) {
        highlights.push({ label: '流出先地域数', main: numberFmt.format(outflowDestinations), sub: '地域' });
      }

      if (highlights.length) {
        const chipHtml = highlights.map(item => `<div class="chip"><span class="chip-label">${item.label}</span><strong>${item.main}</strong>${item.sub ? `<span class="chip-sub">${item.sub}</span>` : ''}</div>`).join('');
        blocks.push(`<div class="section flow-highlights"><h2>フロー分析 重点指標</h2><div class="chip-grid">${chipHtml}</div></div>`);
      }

      // TOP 10流入テーブル
      const topInflowsTable = renderRecordsTable('TOP 10 流入元', flow.top_inflows, {
        limit: 10,
        keys: ['origin', 'flow_count', 'avg_age', 'gender_mode']
      });
      if (topInflowsTable) { blocks.push(topInflowsTable.html); }

      // TOP 10流出テーブル
      const topOutflowsTable = renderRecordsTable('TOP 10 流出先', flow.top_outflows, {
        limit: 10,
        keys: ['destination', 'flow_count', 'avg_age', 'gender_mode']
      });
      if (topOutflowsTable) { blocks.push(topOutflowsTable.html); }

      // すべての流入テーブル（上限100件）
      const allInflowsTable = renderRecordsTable('すべての流入（最大100件）', flow.all_inflows, {
        limit: 100,
        keys: ['origin', 'origin_pref', 'origin_muni', 'flow_count', 'avg_age', 'gender_mode']
      });
      if (allInflowsTable) { blocks.push(allInflowsTable.html); }

      // すべての流出テーブル（上限100件）
      const allOutflowsTable = renderRecordsTable('すべての流出（最大100件）', flow.all_outflows, {
        limit: 100,
        keys: ['destination', 'destination_pref', 'destination_muni', 'flow_count', 'avg_age', 'gender_mode']
      });
      if (allOutflowsTable) { blocks.push(allOutflowsTable.html); }

      if (!blocks.length) {
        panel.innerHTML = `<div class="section"><div class="stats">フロー分析データが存在しません。</div></div>`;
        return;
      }

      panel.innerHTML = blocks.join('');
      chartJobs.forEach(job => renderMatrixChart(job));

      // 地図上に矢印フローを描画
      renderFlowArrows(city);
    }

    function renderCity(){
      const c = DATA[activeCity];
      if(!c){
        qs('#cityName').textContent = '-';
        qs('#cityMeta').textContent = 'データを取得できませんでした';
        qsa('.panel').forEach(p=> p.innerHTML = `<div class="section"><div class="stats">データなし</div></div>`);
        return;
      }
      qs('#cityName').textContent = c.name || '-';
      const ppl = c.overview?.kpis?.find(k=>k.label==='求職者数');
      const upd = c.updated ? ` / 更新日: ${c.updated}` : '';
      qs('#cityMeta').textContent = `求職者数: ${ppl?numberFmt.format(ppl.value):'-'}人${upd}`;
      if(c.region){
        selectedRegion = c.region;
      }
      const badge = qs('#qualityBadge');
      if(badge){
        const q = c.quality || {};
        if(q && (q.status || (Array.isArray(q.issues)&&q.issues.length) || (Array.isArray(q.warnings)&&q.warnings.length))){
          const baseColor = q.color || '#38bdf8';
          badge.textContent = q.label || '品質情報';
          const tooltipParts = [];
          if(q.message){ tooltipParts.push(q.message); }
          if(Array.isArray(q.warnings) && q.warnings.length){ tooltipParts.push(q.warnings.join('\n')); }
          badge.title = tooltipParts.filter(Boolean).join('\n');
          badge.style.background = toRGBA(baseColor, 0.22);
          badge.style.borderColor = toRGBA(baseColor, 0.55);
          badge.style.color = '#f8fafc';
          badge.dataset.status = q.status || 'notice';
          badge.hidden = false;
        } else {
          badge.hidden = true;
          badge.title = '';
        }
      }
      const prefSel = qs('#prefectureSelect');
      const muniSel = qs('#municipalitySelect');
      if(prefSel && muniSel){
        if(availableRegions.length && c.region){
          // 都道府県を更新
          if(c.region.prefecture){
            if(prefSel.value !== c.region.prefecture){
              prefSel.value = c.region.prefecture;
              selectedPrefecture = c.region.prefecture;
            }
            // 都道府県が変わっていなくても、市区町村プルダウンが正しく設定されているか確認
            if(selectedPrefecture !== c.region.prefecture || muniSel.value !== c.region.key){
              selectedPrefecture = c.region.prefecture;
              populateMunicipalitySelector(c.region.prefecture);
            }
          }
          // 市区町村を更新
          if(c.region.key && muniSel.value !== c.region.key){
            muniSel.value = c.region.key;
          }
        }
      }

      renderOverview(c);
      renderSupply(c);
      renderCareer(c);
      renderUrgency(c);
      renderPersona(c);
      renderCross(c);
      renderFlow(c);
      renderDashboard(c);
      syncTabs();
      panToCity();
      renderMarkers();
    }

    function initResizeObserver(){
      if(ro) ro.disconnect();
      ro = new ResizeObserver(()=> requestAnimationFrame(()=> Object.values(charts).forEach(ch=> ch.resize())) );
      ro.observe(sidebar);
    }

    function renderAll(){
      renderTabbar();
      populateSelector();
      if(!map){ initMap(); }
      initResizeObserver();
      renderCity();
    }

    function applyPayload(payload){
      const normalized = normalizePayload(payload);
      const effectiveCities = normalized.cities.length
        ? normalized.cities
        : (DATA.length ? DATA : fallbackPayload.cities);
      DATA = effectiveCities.slice();
      const resolvedRegion = normalized.selectedRegion || selectedRegion || fallbackPayload.selectedRegion;
      selectedRegion = resolvedRegion;
      regionOptions = normalized.regionOptions || regionOptions || fallbackPayload.regionOptions;
      if(normalized.availableRegions.length){
        availableRegions = normalized.availableRegions.slice();
      } else if(!availableRegions.length){
        availableRegions = fallbackPayload.availableRegions.slice();
      }
      let defaultIndex = 0;
      if(selectedRegion && selectedRegion.key){
        const found = DATA.findIndex(city => (city.region && city.region.key === selectedRegion.key) || city.id === selectedRegion.key);
        if(found >= 0){
          defaultIndex = found;
        }
      }
      activeCity = defaultIndex;
      renderAll();
    }

    async function loadData(){
      // GAS 環境では google.script.run から取得。ローカルでは埋め込みデータを採用。
      const bootstrap = ()=> applyPayload(fallbackPayload);
      try{
        if(typeof google !== 'undefined' && google.script && google.script.run){
          const pref = selectedRegion?.prefecture || '';
          const muni = selectedRegion?.municipality || '';
          google.script.run
            .withSuccessHandler(function(payload){
              if(payload){
                applyPayload(payload);
              } else {
                console.warn('GAS からデータが返却されませんでした。フォールバックを使用します。');
                bootstrap();
              }
            })
            .withFailureHandler(function(err){
              console.error('getMapCompleteData 取得に失敗しました。フォールバック起動。', err);
              bootstrap();
            })
            .getMapCompleteData(pref, muni);
        } else {
          bootstrap();
        }
      }catch(e){
        console.warn('google.script.run 不可。埋め込みデータで起動します。', e);
        bootstrap();
      }
    }

    // 起動
    loadData();
  })();
  </script>
</body>
</html>






