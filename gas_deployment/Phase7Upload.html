<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      padding: 30px;
    }
    h2 {
      color: #667eea;
      margin-top: 0;
      text-align: center;
      font-size: 28px;
    }
    .upload-zone {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin: 30px 0;
    }
    .file-drop {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 20px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      min-height: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .file-drop:hover {
      border-color: #667eea;
      background: #f5f5ff;
    }
    .file-drop.dragover {
      border-color: #667eea;
      background: #e8e8ff;
      transform: scale(1.05);
    }
    .file-drop.uploaded {
      border-color: #34A853;
      background: #e6f4ea;
    }
    .file-drop-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    .file-drop-label {
      font-size: 11px;
      font-weight: bold;
      color: #666;
      margin-bottom: 5px;
    }
    .file-drop-status {
      font-size: 10px;
      color: #999;
    }
    .file-drop-filename {
      font-size: 9px;
      color: #34A853;
      margin-top: 5px;
      font-weight: bold;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .file-input {
      display: none;
    }
    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }
    .button {
      padding: 12px 30px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .button-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .button-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .button-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .button-secondary {
      background: #6c757d;
      color: white;
    }
    .button-secondary:hover {
      background: #5a6268;
    }
    .status {
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      display: none;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
    }
    .progress-container {
      width: 100%;
      height: 40px;
      background: #f0f0f0;
      border-radius: 20px;
      margin: 20px 0;
      overflow: hidden;
      display: none;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      font-weight: bold;
    }
    .file-summary {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #dee2e6;
    }
    .summary-item:last-child {
      border-bottom: none;
    }
    .summary-label {
      font-weight: bold;
      color: #666;
    }
    .summary-value {
      color: #667eea;
      font-weight: bold;
    }
    .instructions {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    .instructions-title {
      font-weight: bold;
      color: #856404;
      margin-bottom: 10px;
    }
    .instructions-list {
      font-size: 14px;
      color: #856404;
      margin: 5px 0;
      padding-left: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ“ˆ Phase 7é«˜åº¦åˆ†æ - ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>

    <div class="instructions">
      <div class="instructions-title">ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ‰‹é †</div>
      <div class="instructions-list">
        1. Pythonã§ <code>run_complete.py</code> ã‚’å®Ÿè¡Œ<br>
        2. <code>gas_output_phase7</code> ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰7ã¤ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ<br>
        3. ã€Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
        4. å®Œäº†å¾Œã€å¯è¦–åŒ–æ©Ÿèƒ½ãŒä½¿ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™
      </div>
    </div>

    <div class="upload-zone">
      <!-- 1. äººæä¾›çµ¦å¯†åº¦ãƒãƒƒãƒ— -->
      <div class="file-drop" id="drop-supply" onclick="selectFile('supply')">
        <div class="file-drop-icon">ğŸ—ºï¸</div>
        <div class="file-drop-label">äººæä¾›çµ¦<br>å¯†åº¦ãƒãƒƒãƒ—</div>
        <div class="file-drop-status" id="status-supply">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-drop-filename" id="filename-supply"></div>
      </div>
      <input type="file" id="file-supply" class="file-input" accept=".csv" onchange="handleFile('supply')">

      <!-- 2. è³‡æ ¼åˆ¥äººæåˆ†å¸ƒ -->
      <div class="file-drop" id="drop-qualification" onclick="selectFile('qualification')">
        <div class="file-drop-icon">ğŸ“</div>
        <div class="file-drop-label">è³‡æ ¼åˆ¥<br>äººæåˆ†å¸ƒ</div>
        <div class="file-drop-status" id="status-qualification">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-drop-filename" id="filename-qualification"></div>
      </div>
      <input type="file" id="file-qualification" class="file-input" accept=".csv" onchange="handleFile('qualification')">

      <!-- 3. å¹´é½¢å±¤Ã—æ€§åˆ¥ã‚¯ãƒ­ã‚¹åˆ†æ -->
      <div class="file-drop" id="drop-agegender" onclick="selectFile('agegender')">
        <div class="file-drop-icon">ğŸ‘¥</div>
        <div class="file-drop-label">å¹´é½¢Ã—æ€§åˆ¥<br>ã‚¯ãƒ­ã‚¹åˆ†æ</div>
        <div class="file-drop-status" id="status-agegender">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-drop-filename" id="filename-agegender"></div>
      </div>
      <input type="file" id="file-agegender" class="file-input" accept=".csv" onchange="handleFile('agegender')">

      <!-- 4. ç§»å‹•è¨±å®¹åº¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚° -->
      <div class="file-drop" id="drop-mobility" onclick="selectFile('mobility')">
        <div class="file-drop-icon">ğŸš—</div>
        <div class="file-drop-label">ç§»å‹•è¨±å®¹åº¦<br>ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°</div>
        <div class="file-drop-status" id="status-mobility">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-drop-filename" id="filename-mobility"></div>
      </div>
      <input type="file" id="file-mobility" class="file-input" accept=".csv" onchange="handleFile('mobility')">

      <!-- 5. ãƒšãƒ«ã‚½ãƒŠè©³ç´°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ« -->
      <div class="file-drop" id="drop-persona" onclick="selectFile('persona')">
        <div class="file-drop-icon">ğŸ“Š</div>
        <div class="file-drop-label">ãƒšãƒ«ã‚½ãƒŠè©³ç´°<br>ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</div>
        <div class="file-drop-status" id="status-persona">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-drop-filename" id="filename-persona"></div>
      </div>
      <input type="file" id="file-persona" class="file-input" accept=".csv" onchange="handleFile('persona')">

      <!-- 6. ãƒšãƒ«ã‚½ãƒŠåœ°å›³ãƒ‡ãƒ¼ã‚¿ -->
      <div class="file-drop" id="drop-personamap" onclick="selectFile('personamap')">
        <div class="file-drop-icon">ğŸ—ºï¸</div>
        <div class="file-drop-label">ãƒšãƒ«ã‚½ãƒŠ<br>åœ°å›³ãƒ‡ãƒ¼ã‚¿</div>
        <div class="file-drop-status" id="status-personamap">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-drop-filename" id="filename-personamap"></div>
      </div>
      <input type="file" id="file-personamap" class="file-input" accept=".csv" onchange="handleFile('personamap')">

      <!-- 7. ãƒšãƒ«ã‚½ãƒŠÃ—ç§»å‹•è¨±å®¹åº¦ã‚¯ãƒ­ã‚¹ -->
      <div class="file-drop" id="drop-personamobility" onclick="selectFile('personamobility')">
        <div class="file-drop-icon">ğŸš—</div>
        <div class="file-drop-label">ãƒšãƒ«ã‚½ãƒŠÃ—<br>ç§»å‹•è¨±å®¹åº¦</div>
        <div class="file-drop-status" id="status-personamobility">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-drop-filename" id="filename-personamobility"></div>
      </div>
      <input type="file" id="file-personamobility" class="file-input" accept=".csv" onchange="handleFile('personamobility')">
    </div>

    <div class="file-summary" id="fileSummary">
      <div class="summary-item">
        <span class="summary-label">é¸æŠæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«</span>
        <span class="summary-value" id="selectedCount">0 / 7</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">åˆè¨ˆã‚µã‚¤ã‚º</span>
        <span class="summary-value" id="totalSize">0 KB</span>
      </div>
    </div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div class="status" id="status"></div>

    <div class="button-group">
      <button class="button button-primary" id="uploadButton" disabled onclick="uploadFiles()">
        ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹
      </button>
      <button class="button button-secondary" onclick="clearAll()">
        ğŸ”„ ã‚¯ãƒªã‚¢
      </button>
      <button class="button button-secondary" onclick="google.script.host.close()">
        âœ–ï¸ é–‰ã˜ã‚‹
      </button>
    </div>
  </div>

<script>
// ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
const files = {
  supply: { file: null, name: 'SupplyDensityMap.csv', sheetName: 'Phase7_SupplyDensity' },
  qualification: { file: null, name: 'QualificationDistribution.csv', sheetName: 'Phase7_QualificationDist' },
  agegender: { file: null, name: 'AgeGenderCrossAnalysis.csv', sheetName: 'Phase7_AgeGenderCross' },
  mobility: { file: null, name: 'MobilityScore.csv', sheetName: 'Phase7_MobilityScore' },
  persona: { file: null, name: 'DetailedPersonaProfile.csv', sheetName: 'Phase7_PersonaProfile' },
  personamap: { file: null, name: 'PersonaMapData.csv', sheetName: 'PersonaMapData' },
  personamobility: { file: null, name: 'PersonaMobilityCross.csv', sheetName: 'PersonaMobilityCross' }
};

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
Object.keys(files).forEach(key => {
  const dropZone = document.getElementById('drop-' + key);

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');

    if (e.dataTransfer.files.length > 0) {
      const file = e.dataTransfer.files[0];
      if (file.name.endsWith('.csv')) {
        files[key].file = file;
        updateFileStatus(key);
      } else {
        showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
      }
    }
  });
});

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
function selectFile(type) {
  document.getElementById('file-' + type).click();
}

function handleFile(type) {
  const input = document.getElementById('file-' + type);
  if (input.files.length > 0) {
    files[type].file = input.files[0];
    updateFileStatus(type);
  }
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
function updateFileStatus(type) {
  const file = files[type].file;
  const dropZone = document.getElementById('drop-' + type);
  const statusElement = document.getElementById('status-' + type);
  const filenameElement = document.getElementById('filename-' + type);

  if (file) {
    dropZone.classList.add('uploaded');
    statusElement.textContent = 'âœ… é¸æŠæ¸ˆã¿';
    filenameElement.textContent = file.name;
  } else {
    dropZone.classList.remove('uploaded');
    statusElement.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ';
    filenameElement.textContent = '';
  }

  updateSummary();
}

// ã‚µãƒãƒªãƒ¼æ›´æ–°
function updateSummary() {
  const selectedFiles = Object.values(files).filter(f => f.file !== null);
  const selectedCount = selectedFiles.length;
  const totalSize = selectedFiles.reduce((sum, f) => sum + f.file.size, 0);

  document.getElementById('selectedCount').textContent = `${selectedCount} / 7`;
  document.getElementById('totalSize').textContent = (totalSize / 1024).toFixed(2) + ' KB';

  if (selectedCount > 0) {
    document.getElementById('fileSummary').style.display = 'block';
  }

  // å…¨ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆä»»æ„ã§å¤‰æ›´å¯èƒ½ï¼‰
  document.getElementById('uploadButton').disabled = selectedCount === 0;
}

// ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
async function uploadFiles() {
  const selectedFiles = Object.entries(files).filter(([key, data]) => data.file !== null);

  if (selectedFiles.length === 0) {
    showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    return;
  }

  showStatus(`${selectedFiles.length}ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™...`, 'info');
  showProgress(0);

  let successCount = 0;
  let errorCount = 0;

  for (let i = 0; i < selectedFiles.length; i++) {
    const [key, data] = selectedFiles[i];
    const progress = ((i + 1) / selectedFiles.length) * 100;

    try {
      showStatus(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­: ${data.name} (${i + 1}/${selectedFiles.length})`, 'info');

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
      const content = await readFileAsText(data.file);

      // CSVãƒ‘ãƒ¼ã‚¹
      const csvData = parseCSV(content);

      // GASã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
      await uploadToSheet(data.sheetName, csvData);

      successCount++;
      showProgress(progress);

    } catch (error) {
      console.error(`Error uploading ${data.name}:`, error);
      errorCount++;
    }
  }

  showProgress(100);

  if (errorCount === 0) {
    showStatus(`âœ… ${successCount}ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼`, 'success');
    setTimeout(() => {
      google.script.host.close();
    }, 2000);
  } else {
    showStatus(`âš ï¸ ${successCount}ãƒ•ã‚¡ã‚¤ãƒ«æˆåŠŸã€${errorCount}ãƒ•ã‚¡ã‚¤ãƒ«å¤±æ•—`, 'error');
  }
}

// ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
function readFileAsText(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.onerror = (e) => reject(e);
    reader.readAsText(file, 'UTF-8');
  });
}

// CSVãƒ‘ãƒ¼ã‚¹
function parseCSV(text) {
  // BOMé™¤å»
  const cleanText = text.replace(/^\uFEFF/, '');

  // è¡Œåˆ†å‰²
  const lines = cleanText.split(/\r?\n/).filter(line => line.trim());

  // CSVè§£æ
  const result = lines.map(line => {
    // ç°¡æ˜“CSVãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆã‚¯ã‚©ãƒ¼ãƒˆå‡¦ç†ã¯çœç•¥ï¼‰
    return line.split(',').map(cell => cell.trim());
  });

  return result;
}

// GASã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
function uploadToSheet(sheetName, csvData) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .importPhase7CSV(sheetName, csvData);
  });
}

// UIé–¢æ•°
function showStatus(message, type) {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = 'status ' + type;
  status.style.display = 'block';
}

function showProgress(percent) {
  const container = document.getElementById('progressContainer');
  const bar = document.getElementById('progressBar');

  container.style.display = 'block';
  bar.style.width = percent + '%';
  bar.textContent = Math.round(percent) + '%';
}

function clearAll() {
  Object.keys(files).forEach(key => {
    files[key].file = null;
    updateFileStatus(key);
  });

  document.getElementById('fileSummary').style.display = 'none';
  document.getElementById('progressContainer').style.display = 'none';
  document.getElementById('status').style.display = 'none';
  document.getElementById('uploadButton').disabled = true;
}
</script>
</body>
</html>
