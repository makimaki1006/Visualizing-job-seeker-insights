<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <style>
    body{font-family:Arial,sans-serif;padding:20px;max-width:1200px;margin:0 auto}
    .upload-area{border:2px dashed #ccc;border-radius:8px;padding:40px;text-align:center;margin:20px 0;cursor:pointer;transition:0.3s}
    .upload-area:hover{border-color:#4285f4;background:#f8f9ff}
    .upload-area.dragover{background:#e3f2fd;border-color:#2196f3}
    #fileInput{display:none}
    .button{background:#4285f4;color:#fff;padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-size:14px;margin:5px;transition:0.3s}
    .button:hover{background:#357ae8}
    .button:disabled{background:#ccc;cursor:not-allowed}
    .button.secondary{background:#6c757d}
    .button.secondary:hover{background:#5a6268}
    .button.danger{background:#dc3545}
    .button.danger:hover{background:#c82333}
    .button.success{background:#28a745}
    .button.success:hover{background:#218838}
    .status{margin:10px 0;padding:12px;border-radius:4px;display:none}
    .status.success{background:#d4edda;color:#155724;border-left:4px solid #28a745}
    .status.error{background:#f8d7da;color:#721c24;border-left:4px solid #dc3545}
    .status.info{background:#d1ecf1;color:#0c5460;border-left:4px solid #17a2b8}
    .status.warning{background:#fff3cd;color:#856404;border-left:4px solid #ffc107}
    .file-list{margin:20px 0;max-height:400px;overflow-y:auto}
    .phase-group{margin:15px 0;border:1px solid #dee2e6;border-radius:8px;overflow:hidden}
    .phase-header{background:#f8f9fa;padding:12px 15px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #dee2e6}
    .phase-header h4{margin:0;color:#333;font-size:16px}
    .phase-badge{background:#4285f4;color:white;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:bold}
    .file-item{padding:10px 15px;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center}
    .file-item:last-child{border-bottom:none}
    .file-item:hover{background:#f8f9fa}
    .file-name{font-size:14px;color:#333;flex:1}
    .file-size{font-size:12px;color:#666;margin-left:10px}
    .file-remove{color:#dc3545;cursor:pointer;padding:4px 8px;border-radius:4px;transition:0.3s}
    .file-remove:hover{background:#f8d7da}
    .progress-container{width:100%;height:30px;background:#f0f0f0;border-radius:15px;margin:20px 0;overflow:hidden;display:none}
    .progress-bar{height:100%;background:linear-gradient(90deg,#4285f4,#66a6ff);transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:white;font-size:14px;font-weight:bold}
    .tabs{display:flex;gap:10px;margin:20px 0;border-bottom:2px solid #dee2e6}
    .tab{padding:12px 20px;background:transparent;border:none;cursor:pointer;transition:0.3s;border-bottom:3px solid transparent;color:#666;font-size:14px;font-weight:500}
    .tab.active{color:#4285f4;border-bottom-color:#4285f4}
    .tab:hover{color:#4285f4}
    .tab-content{display:none;margin:20px 0}
    .tab-content.active{display:block}
    .phase-selector{margin:20px 0}
    .phase-checkbox{display:flex;align-items:center;padding:10px;margin:5px 0;background:#f8f9fa;border-radius:4px;cursor:pointer}
    .phase-checkbox:hover{background:#e9ecef}
    .phase-checkbox input{margin-right:10px}
    .empty-state{text-align:center;padding:40px;color:#999}
    .empty-state-icon{font-size:48px;margin-bottom:10px}
    .stats-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:20px 0}
    .stat-card{padding:15px;background:white;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);text-align:center}
    .stat-value{font-size:24px;font-weight:bold;color:#4285f4}
    .stat-label{font-size:12px;color:#666;margin-top:5px}
  </style>
</head>
<body>
  <h3>ğŸ“¥ Phaseåˆ¥CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆè¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ä¸€æ‹¬å¯¾å¿œï¼‰</h3>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('upload')">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</div>
    <div class="tab" onclick="switchTab('files')">ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ</div>
    <div class="tab" onclick="switchTab('options')">âš™ï¸ ã‚ªãƒ—ã‚·ãƒ§ãƒ³</div>
  </div>

  <!-- ã‚¿ãƒ–1: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
  <div class="tab-content active" id="upload-tab">
    <div class="upload-area" id="uploadArea">
      <div class="empty-state-icon">ğŸ“‚</div>
      <p><strong>è¤‡æ•°ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</strong><br>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„</p>
      <p style="font-size:12px;color:#666;">Phase 1, 2, 3, 6, 7, 8, 10ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾å¿œ</p>
    </div>
    <input type="file" id="fileInput" accept=".csv" multiple/>

    <div class="status" id="status"></div>

    <div style="text-align:center;margin-top:20px;">
      <button class="button success" id="uploadAllButton" disabled onclick="uploadAll()">ğŸ“¤ å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
      <button class="button" id="uploadByPhaseButton" disabled onclick="uploadByPhase()">ğŸ“Š Phaseåˆ¥ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
      <button class="button secondary" onclick="clearAll()">ğŸ”„ ã‚¯ãƒªã‚¢</button>
      <button class="button secondary" onclick="google.script.host.close()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- ã‚¿ãƒ–2: ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ -->
  <div class="tab-content" id="files-tab">
    <div class="stats-summary" id="statsSummary">
      <div class="stat-card">
        <div class="stat-value" id="totalFilesCount">0</div>
        <div class="stat-label">ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalSizeCount">0 MB</div>
        <div class="stat-label">åˆè¨ˆã‚µã‚¤ã‚º</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="phaseCount">0</div>
        <div class="stat-label">æ¤œå‡ºPhaseæ•°</div>
      </div>
    </div>

    <div class="file-list" id="fileList">
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“­</div>
        <p>ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
      </div>
    </div>
  </div>

  <!-- ã‚¿ãƒ–3: ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
  <div class="tab-content" id="options-tab">
    <h4>ğŸ“Š ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯¾è±¡Phaseé¸æŠ</h4>
    <div class="phase-selector" id="phaseSelector">
      <label class="phase-checkbox">
        <input type="checkbox" value="Phase1" checked> Phase 1ï¼ˆåŸºç¤é›†è¨ˆï¼‰
      </label>
      <label class="phase-checkbox">
        <input type="checkbox" value="Phase2" checked> Phase 2ï¼ˆçµ±è¨ˆåˆ†æï¼‰
      </label>
      <label class="phase-checkbox">
        <input type="checkbox" value="Phase3" checked> Phase 3ï¼ˆãƒšãƒ«ã‚½ãƒŠåˆ†æï¼‰
      </label>
      <label class="phase-checkbox">
        <input type="checkbox" value="Phase6" checked> Phase 6ï¼ˆãƒ•ãƒ­ãƒ¼åˆ†æï¼‰
      </label>
      <label class="phase-checkbox">
        <input type="checkbox" value="Phase7" checked> Phase 7ï¼ˆé«˜åº¦åˆ†æï¼‰
      </label>
      <label class="phase-checkbox">
        <input type="checkbox" value="Phase8" checked> Phase 8ï¼ˆã‚­ãƒ£ãƒªã‚¢ãƒ»å­¦æ­´åˆ†æï¼‰
      </label>
      <label class="phase-checkbox">
        <input type="checkbox" value="Phase10" checked> Phase 10ï¼ˆè»¢è·æ„æ¬²ãƒ»ç·Šæ€¥åº¦åˆ†æï¼‰
      </label>
    </div>

    <div style="text-align:center;margin-top:20px;">
      <button class="button" onclick="selectAllPhases()">âœ… å…¨ã¦é¸æŠ</button>
      <button class="button secondary" onclick="deselectAllPhases()">âŒ å…¨ã¦è§£é™¤</button>
    </div>
  </div>

  <div class="progress-container" id="progressContainer">
    <div class="progress-bar" id="progressBar">0%</div>
  </div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
var selectedFiles = [];
var phaseFileMap = {};

// Phaseåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«åãƒãƒƒãƒ”ãƒ³ã‚°
const PHASE_FILE_MAP = {
  'Phase1': [
    'Phase1_MapMetrics.csv', 'MapMetrics.csv',
    'Phase1_Applicants.csv', 'Applicants.csv',
    'Phase1_DesiredWork.csv', 'DesiredWork.csv',
    'Phase1_AggDesired.csv', 'AggDesired.csv',
    'P1_QualityReport.csv', 'QualityReport.csv',
    'P1_QualityReport_Descriptive.csv', 'QualityReport_Descriptive.csv', 'P1_QualityDesc.csv',
    'Phase1_EmploymentStatusMaster.csv',
    'Phase1_PersonaByMunicipality_WithResidence.csv',
    'Phase1_PrefectureMaster.csv',
    'Phase1_QualificationDistributionByMunicipality.csv',
    'Phase1_QualificationMaster.csv'
  ],
  'Phase2': [
    'Phase2_ChiSquare.csv', 'ChiSquareTests.csv', 'Phase2_ChiSquareTests.csv',
    'Phase2_ANOVA.csv', 'ANOVATests.csv', 'Phase2_ANOVATests.csv',
    'P2_QualityReport_Inferential.csv', 'QualityReport_Inferential.csv'
  ],
  'Phase3': [
    'Phase3_PersonaSummary.csv', 'PersonaSummary.csv',
    'Phase3_PersonaDetails.csv', 'PersonaDetails.csv',
    'Phase3_PersonaByMunicipality.csv', 'PersonaSummaryByMunicipality.csv',
    'Phase3_PersonaSummaryByMunicipality.csv',
    'P3_QualityReport_Inferential.csv', 'QualityReport_Inferential.csv'
  ],
  'Phase6': [
    'Phase6_FlowEdges.csv', 'MunicipalityFlowEdges.csv', 'Phase6_MunicipalityFlowEdges.csv',
    'Phase6_FlowNodes.csv', 'MunicipalityFlowNodes.csv', 'Phase6_MunicipalityFlowNodes.csv',
    'Phase6_Proximity.csv', 'ProximityAnalysis.csv', 'Phase6_ProximityAnalysis.csv',
    'Phase6_AggregatedFlowEdges.csv',
    'P6_QualityReport_Inferential.csv', 'QualityReport_Inferential.csv'
  ],
  'Phase7': [
    'Phase7_SupplyDensity.csv', 'SupplyDensityMap.csv', 'Phase7_SupplyDensityMap.csv',
    'Phase7_QualificationDist.csv', 'QualificationDistribution.csv', 'Phase7_QualificationDistribution.csv',
    'Phase7_AgeGenderCross.csv', 'AgeGenderCrossAnalysis.csv', 'Phase7_AgeGenderCrossAnalysis.csv',
    'Phase7_MobilityScore.csv', 'MobilityScore.csv',
    'Phase7_PersonaProfile.csv', 'DetailedPersonaProfile.csv', 'Phase7_DetailedPersonaProfile.csv',
    'Phase7_PersonaMapData.csv', 'PersonaMapData.csv',
    'Phase7_PersonaMobilityCross.csv', 'PersonaMobilityCross.csv',
    'P7_QualityReport_Inferential.csv', 'QualityReport_Inferential.csv'
  ],
  'Phase8': [
    'Phase8_EducationDist.csv', 'EducationDistribution.csv',
    'Phase8_EduAgeCross.csv', 'EducationAgeCross.csv',
    'Phase8_EduAgeMatrix.csv', 'EducationAgeCross_Matrix.csv',
    'Phase8_GradYearDist.csv', 'GraduationYearDistribution.csv', 'Phase8_GraduationYearDistribution.csv',
    'Phase8_CareerDistribution.csv', 'CareerDistribution.csv',
    'Phase8_CareerAgeCross.csv', 'CareerAgeCross.csv',
    'Phase8_CareerAgeMatrix.csv', 'CareerAgeCross_Matrix.csv', 'Phase8_CareerAgeCross_Matrix.csv',
    'P8_QualityReport.csv', 'QualityReport.csv',
    'P8_QualityReport_Inferential.csv', 'QualityReport_Inferential.csv'
  ],
  'Phase10': [
    'Phase10_UrgencyDist.csv', 'UrgencyDistribution.csv', 'Phase10_UrgencyDistribution.csv',
    'Phase10_UrgencyAge.csv', 'UrgencyAgeCross.csv', 'Phase10_UrgencyAgeCross.csv',
    'Phase10_UrgencyAge_Matrix.csv', 'UrgencyAgeCross_Matrix.csv', 'Phase10_UrgencyAgeCross_Matrix.csv',
    'Phase10_UrgencyEmployment.csv', 'UrgencyEmploymentCross.csv', 'Phase10_UrgencyEmploymentCross.csv',
    'Phase10_UrgencyEmployment_Matrix.csv', 'UrgencyEmploymentCross_Matrix.csv', 'Phase10_UrgencyEmploymentCross_Matrix.csv',
    'Phase10_UrgencyByMunicipality.csv', 'UrgencyByMunicipality.csv',
    'Phase10_UrgencyAge_ByMunicipality.csv', 'UrgencyAgeCross_ByMunicipality.csv', 'Phase10_UrgencyAgeCross_ByMunicipality.csv',
    'Phase10_UrgencyEmployment_ByMunicipality.csv', 'UrgencyEmploymentCross_ByMunicipality.csv', 'Phase10_UrgencyEmploymentCross_ByMunicipality.csv',
    'P10_QualityReport.csv', 'QualityReport.csv',
    'P10_QualityReport_Inferential.csv', 'QualityReport_Inferential.csv'
  ],
  'Phase12': [
    'Phase12_SupplyDemandGap.csv', 'SupplyDemandGap.csv',
    'P12_QualityReport.csv',
    'P12_QualityReport_Descriptive.csv'
  ],
  'Phase13': [
    'Phase13_RarityScore.csv', 'RarityScore.csv',
    'P13_QualityReport.csv',
    'P13_QualityReport_Descriptive.csv'
  ],
  'Phase14': [
    'Phase14_CompetitionProfile.csv', 'CompetitionProfile.csv',
    'P14_QualityReport.csv',
    'P14_QualityReport_Descriptive.csv'
  ]
};


// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.getElementById('uploadArea').addEventListener('click', function() {
  document.getElementById('fileInput').click();
});

document.getElementById('uploadArea').addEventListener('dragover', function(e) {
  e.preventDefault();
  e.stopPropagation();
  this.classList.add('dragover');
});

document.getElementById('uploadArea').addEventListener('dragleave', function(e) {
  e.preventDefault();
  e.stopPropagation();
  this.classList.remove('dragover');
});

document.getElementById('uploadArea').addEventListener('drop', function(e) {
  e.preventDefault();
  e.stopPropagation();
  this.classList.remove('dragover');

  if (e.dataTransfer.files.length > 0) {
    handleFiles(e.dataTransfer.files);
  }
});

document.getElementById('fileInput').addEventListener('change', function(e) {
  if (e.target.files.length > 0) {
    handleFiles(e.target.files);
  }
});

// è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
function handleFiles(files) {
  const newFiles = Array.from(files).filter(file => file.name.endsWith('.csv'));

  if (newFiles.length === 0) {
    showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    return;
  }

  // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒãƒ¼ã‚¸ï¼ˆé‡è¤‡æ’é™¤ï¼‰
  newFiles.forEach(file => {
    const exists = selectedFiles.some(f => f.name === file.name);
    if (!exists) {
      selectedFiles.push(file);
    }
  });

  // Phaseåˆ¥ã«åˆ†é¡
  categorizeFiles();

  // UIã‚’æ›´æ–°
  updateFileList();
  updateStats();

  // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
  document.getElementById('uploadAllButton').disabled = false;
  document.getElementById('uploadByPhaseButton').disabled = false;

  showStatus(`${selectedFiles.length}å€‹ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');

  // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
  switchTab('files');
}

// Phaseåˆ¤åˆ¥
function detectPhase(filename) {
  for (const [phase, files] of Object.entries(PHASE_FILE_MAP)) {
    if (files.includes(filename)) {
      return phase;
    }
  }
  return 'Unknown';
}

// Phaseåˆ¥ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†é¡
function categorizeFiles() {
  phaseFileMap = {};

  selectedFiles.forEach(file => {
    const phase = detectPhase(file.name);
    if (!phaseFileMap[phase]) {
      phaseFileMap[phase] = [];
    }
    phaseFileMap[phase].push(file);
  });
}

// ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆè¡¨ç¤º
function updateFileList() {
  const fileListDiv = document.getElementById('fileList');

  if (selectedFiles.length === 0) {
    fileListDiv.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“­</div>
        <p>ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
      </div>
    `;
    return;
  }

  let html = '';

  // Phaseé †ã§ã‚½ãƒ¼ãƒˆ
  const sortedPhases = Object.keys(phaseFileMap).sort();

  sortedPhases.forEach(phase => {
    const files = phaseFileMap[phase];
    const phaseLabel = phase === 'Unknown' ? 'ä¸æ˜ãªPhase' : phase;
    const phaseBadgeColor = phase === 'Unknown' ? '#dc3545' : '#4285f4';

    html += `
      <div class="phase-group">
        <div class="phase-header">
          <h4>${phaseLabel}</h4>
          <span class="phase-badge" style="background:${phaseBadgeColor}">${files.length}ãƒ•ã‚¡ã‚¤ãƒ«</span>
        </div>
    `;

    files.forEach((file, index) => {
      const sizeKB = (file.size / 1024).toFixed(2);
      html += `
        <div class="file-item">
          <span class="file-name">ğŸ“„ ${file.name}</span>
          <span class="file-size">${sizeKB} KB</span>
          <span class="file-remove" onclick="removeFile('${phase}', ${index})">ğŸ—‘ï¸</span>
        </div>
      `;
    });

    html += '</div>';
  });

  fileListDiv.innerHTML = html;
}

// çµ±è¨ˆæƒ…å ±æ›´æ–°
function updateStats() {
  document.getElementById('totalFilesCount').textContent = selectedFiles.length;

  const totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
  document.getElementById('totalSizeCount').textContent = (totalSize / 1024 / 1024).toFixed(2) + ' MB';

  const phaseKeys = Object.keys(phaseFileMap).filter(p => p !== 'Unknown');
  document.getElementById('phaseCount').textContent = phaseKeys.length;
}

// ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
function removeFile(phase, index) {
  const file = phaseFileMap[phase][index];
  selectedFiles = selectedFiles.filter(f => f.name !== file.name);

  categorizeFiles();
  updateFileList();
  updateStats();

  if (selectedFiles.length === 0) {
    document.getElementById('uploadAllButton').disabled = true;
    document.getElementById('uploadByPhaseButton').disabled = true;
  }

  showStatus(`${file.name}ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'info');
}

// å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
function uploadAll() {
  if (selectedFiles.length === 0) {
    showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
    return;
  }

  showStatus('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æº–å‚™ä¸­...', 'info');
  showProgress(0);

  // FileReaderã§å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
  const promises = selectedFiles.map(file => readFileAsText(file));

  Promise.all(promises)
    .then(results => {
      const fileDataMap = {};

      results.forEach((content, index) => {
        const file = selectedFiles[index];
        const phase = detectPhase(file.name);

        if (!fileDataMap[phase]) {
          fileDataMap[phase] = {};
        }

        fileDataMap[phase][file.name] = {
          content: content,
          size: file.size
        };
      });

      showProgress(50);

      // GASã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
      google.script.run
        .withSuccessHandler(onUploadSuccess)
        .withFailureHandler(onUploadFailure)
        .importMultiplePhaseCSVs(fileDataMap);

      showProgress(100);
    })
    .catch(error => {
      showStatus('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    });
}

// Phaseåˆ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
function uploadByPhase() {
  if (selectedFiles.length === 0) {
    showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
    return;
  }

  // é¸æŠã•ã‚ŒãŸPhaseã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  const selectedPhases = getSelectedPhases();

  if (selectedPhases.length === 0) {
    showStatus('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯¾è±¡ã®Phaseã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
    switchTab('options');
    return;
  }

  showStatus(`${selectedPhases.length}å€‹ã®Phaseã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...`, 'info');
  showProgress(0);

  // é¸æŠã•ã‚ŒãŸPhaseã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿èª­ã¿è¾¼ã¿
  const filesToUpload = selectedFiles.filter(file => {
    const phase = detectPhase(file.name);
    return selectedPhases.includes(phase);
  });

  if (filesToUpload.length === 0) {
    showStatus('é¸æŠã•ã‚ŒãŸPhaseã«è©²å½“ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
    return;
  }

  const promises = filesToUpload.map(file => readFileAsText(file));

  Promise.all(promises)
    .then(results => {
      const fileDataMap = {};

      results.forEach((content, index) => {
        const file = filesToUpload[index];
        const phase = detectPhase(file.name);

        if (!fileDataMap[phase]) {
          fileDataMap[phase] = {};
        }

        fileDataMap[phase][file.name] = {
          content: content,
          size: file.size
        };
      });

      showProgress(50);

      // GASã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
      google.script.run
        .withSuccessHandler(onUploadSuccess)
        .withFailureHandler(onUploadFailure)
        .importMultiplePhaseCSVs(fileDataMap);

      showProgress(100);
    })
    .catch(error => {
      showStatus('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    });
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã¿
function readFileAsText(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      resolve(e.target.result);
    };
    reader.onerror = function(e) {
      reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—: ' + file.name));
    };
    reader.readAsText(file, 'UTF-8');
  });
}

// ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ
function onUploadSuccess(result) {
  showProgress(0);
  showStatus(`âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼${result.totalFiles}ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`, 'success');

  setTimeout(function() {
    google.script.host.close();
  }, 2000);
}

// ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—
function onUploadFailure(error) {
  showProgress(0);
  showStatus('âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
}

// é¸æŠã•ã‚ŒãŸPhaseã‚’å–å¾—
function getSelectedPhases() {
  const checkboxes = document.querySelectorAll('#phaseSelector input[type="checkbox"]:checked');
  return Array.from(checkboxes).map(cb => cb.value);
}

// Phaseå…¨é¸æŠ
function selectAllPhases() {
  document.querySelectorAll('#phaseSelector input[type="checkbox"]').forEach(cb => {
    cb.checked = true;
  });
  showStatus('å…¨Phaseã‚’é¸æŠã—ã¾ã—ãŸ', 'info');
}

// Phaseå…¨è§£é™¤
function deselectAllPhases() {
  document.querySelectorAll('#phaseSelector input[type="checkbox"]').forEach(cb => {
    cb.checked = false;
  });
  showStatus('å…¨Phaseã®é¸æŠã‚’è§£é™¤ã—ã¾ã—ãŸ', 'info');
}

// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function switchTab(tabName) {
  // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‹ã‚‰ active ã‚’å‰Šé™¤
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });

  // tabNameã«å¯¾å¿œã™ã‚‹ã‚¿ãƒ–ã‚’ active ã«ã™ã‚‹
  const tabs = document.querySelectorAll('.tab');
  const tabNames = ['upload', 'files', 'options'];
  const index = tabNames.indexOf(tabName);
  if (index >= 0 && index < tabs.length) {
    tabs[index].classList.add('active');
  }

  document.getElementById(tabName + '-tab').classList.add('active');
}

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
function showStatus(message, type) {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = 'status ' + type;
  status.style.display = 'block';

  setTimeout(function() {
    status.style.display = 'none';
  }, 5000);
}

// ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤º
function showProgress(percent) {
  const container = document.getElementById('progressContainer');
  const bar = document.getElementById('progressBar');

  if (percent > 0) {
    container.style.display = 'block';
    bar.style.width = percent + '%';
    bar.textContent = Math.round(percent) + '%';
  } else {
    container.style.display = 'none';
  }
}

// ã‚¯ãƒªã‚¢
function clearAll() {
  selectedFiles = [];
  phaseFileMap = {};

  updateFileList();
  updateStats();

  document.getElementById('uploadAllButton').disabled = true;
  document.getElementById('uploadByPhaseButton').disabled = true;
  document.getElementById('status').style.display = 'none';
  document.getElementById('progressContainer').style.display = 'none';

  switchTab('upload');
  showStatus('ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
}
</script>
</body>
</html>
