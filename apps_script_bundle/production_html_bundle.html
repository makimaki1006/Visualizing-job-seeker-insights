<!-- ===== BubbleMap.html ===== -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>å¸Œæœ›å‹¤å‹™åœ°ãƒãƒ–ãƒ«ãƒãƒƒãƒ—</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Chart.js v3 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
    #map-container { display: flex; height: 100vh; position: relative; }
    #map { flex: 1; height: 100%; z-index: 1; }
    #sidebar { width: 600px; background: white; box-shadow: -2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; padding: 20px; display: none; z-index: 2; }
    #sidebar.active { display: block; }
    .close-btn { position: absolute; right: 10px; top: 10px; cursor: pointer; font-size: 24px; color: #666; z-index: 10; }
    .close-btn:hover { color: #000; }
    .stats-header { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }
    .stats-header h2 { color: #333; font-size: 20px; margin-bottom: 5px; }
    .stats-header .total { font-size: 28px; color: #667eea; font-weight: bold; }
    .chart-container { margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 8px; }
    .chart-title { font-weight: bold; margin-bottom: 10px; color: #555; }
    .chart-wrapper { position: relative; height: 200px; }
    .loading { text-align: center; padding: 50px; color: #999; }
    .error { background: #fee; color: #c00; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .legend { position: absolute; bottom: 30px; right: 10px; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000; }
    .legend-item { display: flex; align-items: center; margin: 5px 0; }
    .legend-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 8px; border: 1px solid #333; }

    /* Controls */
    #controls { position: absolute; top: 10px; left: 10px; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000; }
    #controls label { font-weight: bold; margin-right: 10px; }
    #controls select, #controls input { padding: 5px; }
  </style>
</head>
<body>
  <div id="map-container">
    <div id="map"></div>
    <div id="sidebar">
      <span class="close-btn" onclick="closeSidebar()">Ã—</span>
      <div id="sidebar-content">
        <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div id="controls">
    <div style="margin-bottom: 10px;">
      <label>ãƒãƒ–ãƒ«ã‚µã‚¤ã‚º:</label>
      <input type="range" id="sizeSlider" min="0.5" max="2" step="0.1" value="1" onchange="updateBubbleSize()">
      <span id="sizeValue">1.0</span>
    </div>
  </div>

  <div class="legend">
    <div class="chart-title">å¸Œæœ›è€…æ•°</div>
    <div class="legend-item"><div class="legend-color" style="background: #ff0000;"></div><span>100äººä»¥ä¸Š</span></div>
    <div class="legend-item"><div class="legend-color" style="background: #ff6600;"></div><span>50-99äºº</span></div>
    <div class="legend-item"><div class="legend-color" style="background: #ffaa00;"></div><span>20-49äºº</span></div>
    <div class="legend-item"><div class="legend-color" style="background: #00aa00;"></div><span>10-19äºº</span></div>
    <div class="legend-item"><div class="legend-color" style="background: #0066ff;"></div><span>1-9äºº</span></div>
  </div>

  <script>
    var map;
    var markers = [];
    var charts = {};
    var bubbleSizeMultiplier = 1.0;

    // åœ°å›³åˆæœŸåŒ–
    function initMap() {
      map = L.map('map').setView([36.5, 138.0], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 18
      }).addTo(map);
      loadMapData();
    }

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadMapData() {
      google.script.run
        .withSuccessHandler(function(data) {
          displayMarkers(data);
        })
        .withFailureHandler(function(error) {
          alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
        })
        .getMapMetricsData();
    }

    // ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
    function displayMarkers(points) {
      window.lastPointsData = points;
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      points.forEach(function(point) {
        if (!point.lat || !point.lng) return;

        var color = getColorByCount(point.count);
        var radius = Math.min(Math.max(point.count / 5, 5), 30);

        var marker = L.circleMarker([point.lat, point.lng], {
          radius: radius,
          fillColor: color,
          color: '#333',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.7,
          originalRadius: radius
        });

        marker.bindPopup('<b>' + point.prefecture + '</b><br>å¸Œæœ›è€…æ•°: ' + point.count + 'äºº');

        marker.on('click', (function(p) {
          return function() {
            showDetailedInfo(p.prefecture, p.key, p.count);
          };
        })(point));

        marker.addTo(map);
        markers.push(marker);
      });
    }

    // è©³ç´°æƒ…å ±è¡¨ç¤º
    function showDetailedInfo(prefecture, key, count) {
      document.getElementById('sidebar').classList.add('active');
      document.getElementById('sidebar-content').innerHTML = '<div class="loading">è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';

      google.script.run
        .withSuccessHandler(function(detail) {
          displayDetailedStats(prefecture, key, detail);
        })
        .withFailureHandler(function(error) {
          document.getElementById('sidebar-content').innerHTML =
            '<div class="error">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error + '</div>';
        })
        .getApplicantsStats();
    }

    // è©³ç´°çµ±è¨ˆè¡¨ç¤º
    function displayDetailedStats(prefecture, key, detail) {
      var html = `
        <div class="stats-header">
          <h2>${prefecture}</h2>
          <div class="total">å¸Œæœ›è€…æ•°: ${detail.total}äºº</div>
        </div>
      `;

      // æ€§åˆ¥åˆ†å¸ƒ
      if (detail.byGender) {
        html += `
          <div class="chart-container">
            <div class="chart-title">æ€§åˆ¥åˆ†å¸ƒ</div>
            <div class="chart-wrapper"><canvas id="genderChart"></canvas></div>
          </div>`;
      }

      // å¹´é½¢åˆ†å¸ƒ
      if (detail.byAge) {
        html += `
          <div class="chart-container">
            <div class="chart-title">å¹´é½¢åˆ†å¸ƒ</div>
            <div class="chart-wrapper"><canvas id="ageChart"></canvas></div>
          </div>`;
      }

      document.getElementById('sidebar-content').innerHTML = html;

      // ã‚°ãƒ©ãƒ•æç”»
      setTimeout(function() {
        drawCharts(detail);
      }, 100);
    }

    // ã‚°ãƒ©ãƒ•æç”»
    function drawCharts(detail) {
      // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
      Object.values(charts).forEach(function(chart) {
        if (chart) {
          try { chart.destroy(); } catch(e) {}
        }
      });
      charts = {};

      // æ€§åˆ¥ã‚°ãƒ©ãƒ•
      if (detail.byGender && document.getElementById('genderChart')) {
        var genderCanvas = document.getElementById('genderChart');
        var genderData = detail.byGender;
        charts.gender = new Chart(genderCanvas, {
          type: 'pie',
          data: {
            labels: Object.keys(genderData),
            datasets: [{
              data: Object.values(genderData),
              backgroundColor: ['#667eea', '#764ba2', '#f4b400'],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 15,
                  font: { size: 12 }
                }
              }
            }
          }
        });
      }

      // å¹´é½¢ã‚°ãƒ©ãƒ•
      if (detail.byAge && document.getElementById('ageChart')) {
        var ageCanvas = document.getElementById('ageChart');
        var ageLabels = Object.keys(detail.byAge);
        var ageData = Object.values(detail.byAge);

        charts.age = new Chart(ageCanvas, {
          type: 'bar',
          data: {
            labels: ageLabels,
            datasets: [{
              label: 'äººæ•°',
              data: ageData,
              backgroundColor: '#667eea',
              borderColor: '#5568d3',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      }
    }

    // UIæ“ä½œ
    function closeSidebar() {
      document.getElementById('sidebar').classList.remove('active');
      Object.values(charts).forEach(function(chart) {
        if (chart) {
          try { chart.destroy(); } catch(e) {}
        }
      });
      charts = {};
    }

    function getColorByCount(count) {
      if (count >= 100) return '#ff0000';
      if (count >= 50) return '#ff6600';
      if (count >= 20) return '#ffaa00';
      if (count >= 10) return '#00aa00';
      return '#0066ff';
    }

    function updateBubbleSize() {
      bubbleSizeMultiplier = parseFloat(document.getElementById('sizeSlider').value);
      document.getElementById('sizeValue').textContent = bubbleSizeMultiplier.toFixed(1);

      markers.forEach(function(marker) {
        var originalRadius = marker.options.originalRadius || marker.getRadius();
        marker.setRadius(originalRadius * bubbleSizeMultiplier);
      });
    }

    window.onload = function() {
      initMap();
    };
  </script>
</body>
</html>

<!-- ===== HeatMap.html ===== -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>å¸Œæœ›å‹¤å‹™åœ°ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Chart.js v3 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet.heat Plugin -->
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
    .container { display: flex; height: 100vh; }
    .sidebar { width: 350px; background: white; padding: 20px; overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 2; }
    .map-container { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; z-index: 1; }

    h2 { color: #667eea; font-size: 20px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }

    .stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
    .stats-label { font-size: 12px; opacity: 0.9; margin-bottom: 5px; }
    .stats-value { font-size: 28px; font-weight: bold; }

    .controls { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .control-label { font-size: 13px; font-weight: bold; color: #666; margin-bottom: 10px; display: block; }
    .slider-container { margin-bottom: 15px; }
    .slider { width: 100%; height: 6px; border-radius: 3px; background: #ddd; outline: none; -webkit-appearance: none; }
    .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #667eea; cursor: pointer; }
    .slider-value { font-size: 12px; color: #667eea; font-weight: bold; margin-top: 5px; }

    .top10-list { list-style: none; margin-top: 10px; }
    .top10-item { display: flex; justify-content: space-between; padding: 10px; margin-bottom: 5px; background: #f8f9fa; border-radius: 4px; font-size: 13px; }
    .top10-rank { font-weight: bold; color: #667eea; margin-right: 10px; }
    .top10-prefecture { flex: 1; }
    .top10-count { font-weight: bold; color: #333; }

    .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; font-size: 18px; color: #667eea; z-index: 1000; }
    .error { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; padding: 30px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px; z-index: 1000; }
    .error-icon { font-size: 48px; margin-bottom: 15px; }
    .error-message { color: #721c24; font-size: 14px; line-height: 1.6; }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h2>ğŸ“Š çµ±è¨ˆæƒ…å ±</h2>

      <div class="stats-card">
        <div class="stats-label">ç·æ±‚è·è€…æ•°</div>
        <div class="stats-value" id="totalCount">-</div>
      </div>

      <div class="stats-card">
        <div class="stats-label">å¹³å‡å¹´é½¢</div>
        <div class="stats-value" id="avgAge">-</div>
      </div>

      <h2>âš™ï¸ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—è¨­å®š</h2>
      <div class="controls">
        <div class="slider-container">
          <label class="control-label">å¼·åº¦ï¼ˆIntensityï¼‰</label>
          <input type="range" min="0.1" max="1.0" step="0.1" value="0.5" class="slider" id="intensitySlider">
          <div class="slider-value" id="intensityValue">0.5</div>
        </div>

        <div class="slider-container">
          <label class="control-label">åŠå¾„ï¼ˆRadiusï¼‰</label>
          <input type="range" min="10" max="50" value="25" class="slider" id="radiusSlider">
          <div class="slider-value" id="radiusValue">25 px</div>
        </div>
      </div>

      <h2>ğŸ“ å¸Œæœ›å‹¤å‹™åœ° TOP10</h2>
      <ul class="top10-list" id="top10List"></ul>
    </div>

    <div class="map-container">
      <div class="loading" id="loading">
        ğŸ”„ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
      </div>
      <div id="map"></div>
    </div>
  </div>

  <script>
    var map;
    var heatLayer;
    var heatmapData = [];
    var heatRadius = 25;
    var heatIntensity = 0.5;

    // åœ°å›³åˆæœŸåŒ–
    function initMap() {
      map = L.map('map').setView([36.5, 138.0], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 18
      }).addTo(map);

      // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¨­å®š
      setupControls();

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      loadData();
    }

    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¨­å®š
    function setupControls() {
      var intensitySlider = document.getElementById('intensitySlider');
      var radiusSlider = document.getElementById('radiusSlider');

      intensitySlider.addEventListener('input', function(e) {
        heatIntensity = parseFloat(e.target.value);
        document.getElementById('intensityValue').textContent = heatIntensity.toFixed(1);
        updateHeatmap();
      });

      radiusSlider.addEventListener('input', function(e) {
        heatRadius = parseInt(e.target.value);
        document.getElementById('radiusValue').textContent = heatRadius + ' px';
        updateHeatmap();
      });
    }

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadData() {
      document.getElementById('loading').style.display = 'block';

      Promise.all([
        callGAS('getMapMetricsData'),
        callGAS('getApplicantsStats'),
        callGAS('getDesiredWorkTop10')
      ]).then(function(results) {
        var mapData = results[0];
        var stats = results[1];
        var top10 = results[2];

        document.getElementById('loading').style.display = 'none';

        // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
        displayStats(stats);

        // TOP10è¡¨ç¤º
        displayTop10(top10);

        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿æº–å‚™
        prepareHeatmapData(mapData);

        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—è¡¨ç¤º
        displayHeatmap();

      }).catch(function(error) {
        document.getElementById('loading').innerHTML =
          '<div class="error">' +
            '<div class="error-icon">âš ï¸</div>' +
            '<div class="error-message">' +
              '<strong>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</strong><br><br>' +
              error.message +
            '</div>' +
          '</div>';
      });
    }

    // GASé–¢æ•°å‘¼ã³å‡ºã—ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function callGAS(functionName) {
      return new Promise(function(resolve, reject) {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          [functionName]();
      });
    }

    // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
    function displayStats(stats) {
      document.getElementById('totalCount').textContent = stats.total.toLocaleString();
      document.getElementById('avgAge').textContent = stats.avgAge + 'æ­³';
    }

    // TOP10è¡¨ç¤º
    function displayTop10(top10) {
      var listEl = document.getElementById('top10List');
      listEl.innerHTML = '';

      top10.forEach(function(item, index) {
        var li = document.createElement('li');
        li.className = 'top10-item';
        li.innerHTML =
          '<span class="top10-rank">' + (index + 1) + '</span>' +
          '<span class="top10-prefecture">' + item.prefecture + '</span>' +
          '<span class="top10-count">' + item.count.toLocaleString() + 'äºº</span>';
        listEl.appendChild(li);
      });
    }

    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿æº–å‚™
    function prepareHeatmapData(data) {
      heatmapData = data
        .filter(function(item) {
          return item.lat && item.lng && item.count;
        })
        .map(function(item) {
          return [item.lat, item.lng, item.count / 100];
        });
    }

    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—è¡¨ç¤º
    function displayHeatmap() {
      if (heatLayer) {
        map.removeLayer(heatLayer);
      }

      heatLayer = L.heatLayer(heatmapData, {
        radius: heatRadius,
        blur: 15,
        maxZoom: 17,
        max: heatIntensity,
        gradient: {
          0.0: 'blue',
          0.2: 'cyan',
          0.4: 'lime',
          0.6: 'yellow',
          0.8: 'orange',
          1.0: 'red'
        }
      }).addTo(map);
    }

    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—æ›´æ–°
    function updateHeatmap() {
      if (!heatLayer) return;

      map.removeLayer(heatLayer);

      heatLayer = L.heatLayer(heatmapData, {
        radius: heatRadius,
        blur: 15,
        maxZoom: 17,
        max: heatIntensity,
        gradient: {
          0.0: 'blue',
          0.2: 'cyan',
          0.4: 'lime',
          0.6: 'yellow',
          0.8: 'orange',
          1.0: 'red'
        }
      }).addTo(map);
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    window.onload = function() {
      initMap();
    };
  </script>
</body>
</html>

<!-- ===== MapComplete.html ===== -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>æ±‚è·è€…ãƒ‡ãƒ¼ã‚¿åˆ†æãƒãƒƒãƒ—</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Leaflet Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Yu Gothic', 'Hiragino Kaku Gothic Pro', Meiryo, sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    #map {
      flex: 1;
      height: 100%;
    }

    .sidebar {
      width: 350px;
      background: #2d2d5f;
      color: white;
      padding: 20px;
      overflow-y: auto;
      box-shadow: -5px 0 20px rgba(0,0,0,0.3);
    }

    .sidebar-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
      color: #667eea;
    }

    .stat-card {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .stat-label {
      font-size: 12px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }

    .chart-container {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      height: 200px;
    }

    .control-group {
      margin-bottom: 15px;
    }

    .control-label {
      font-size: 12px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 8px;
      display: block;
    }

    select {
      width: 100%;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 13px;
    }

    .top10-list {
      list-style: none;
      max-height: 250px;
      overflow-y: auto;
    }

    .top10-item {
      display: flex;
      justify-content: space-between;
      padding: 8px;
      margin-bottom: 5px;
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }

    .top10-rank {
      font-weight: bold;
      color: #667eea;
      margin-right: 10px;
    }

    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 9999;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    ğŸ”„ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
  </div>

  <div class="container">
    <div id="map"></div>

    <div class="sidebar">
      <div class="sidebar-title">ğŸ“Š æ±‚è·è€…åˆ†æ</div>

      <div class="stat-card">
        <div class="stat-label">ç·æ±‚è·è€…æ•°</div>
        <div class="stat-value" id="totalCount">-</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">å¹³å‡å¹´é½¢</div>
        <div class="stat-value" id="avgAge">-</div>
      </div>

      <div class="control-group">
        <label class="control-label">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</label>
        <select id="displayMode" onchange="changeDisplayMode()">
          <option value="markers">å€‹åˆ¥ãƒãƒ¼ã‚«ãƒ¼</option>
          <option value="cluster">ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼</option>
          <option value="heatmap">ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</option>
        </select>
      </div>

      <div class="control-group">
        <label class="control-label">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
        <select id="dataFilter" onchange="applyFilter()">
          <option value="all">å…¨ãƒ‡ãƒ¼ã‚¿</option>
          <option value="male">ç”·æ€§ã®ã¿</option>
          <option value="female">å¥³æ€§ã®ã¿</option>
          <option value="young">20-30ä»£</option>
          <option value="middle">40-50ä»£</option>
          <option value="senior">60ä»£ä»¥ä¸Š</option>
        </select>
      </div>

      <div class="stat-card">
        <div class="stat-label">å¸Œæœ›å‹¤å‹™åœ° TOP10</div>
        <ul class="top10-list" id="top10List"></ul>
      </div>

      <div class="chart-container">
        <canvas id="genderChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    let map;
    let markers = [];
    let markerCluster;
    let heatLayer;
    let allData = {
      mapMetrics: [],
      applicants: [],
      desiredWork: [],
      aggDesired: []
    };

    // åœ°å›³åˆæœŸåŒ–
    function initMap() {
      console.log('[DEBUG] Initializing map...');

      map = L.map('map', {
        center: [35.0116, 135.7681],
        zoom: 10
      });

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap',
        maxZoom: 18
      }).addTo(map);

      markerCluster = L.markerClusterGroup({
        chunkedLoading: true,
        maxClusterRadius: 60
      });

      console.log('[DEBUG] Map initialized');
    }

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadData() {
      console.log('[DEBUG] Loading data...');

      google.script.run
        .withSuccessHandler(function(data) {
          console.log('[DEBUG] Data loaded:', data);
          allData = data;
          document.getElementById('loading').style.display = 'none';
          processData();
        })
        .withFailureHandler(function(error) {
          console.error('[ERROR]', error);
          alert('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
          document.getElementById('loading').style.display = 'none';
        })
        .getAllVisualizationData();
    }

    // ãƒ‡ãƒ¼ã‚¿å‡¦ç†
    function processData() {
      console.log('[DEBUG] Processing data...');

      // çµ±è¨ˆæƒ…å ±æ›´æ–°
      updateStats();

      // åœ°å›³æ›´æ–°
      updateMap();

      // TOP10æ›´æ–°
      updateTop10();

      // ã‚°ãƒ©ãƒ•æ›´æ–°
      updateGenderChart();
    }

    // çµ±è¨ˆæƒ…å ±æ›´æ–°
    function updateStats() {
      const total = allData.applicants.length;
      document.getElementById('totalCount').textContent = total.toLocaleString();

      // å¹³å‡å¹´é½¢è¨ˆç®—
      let totalAge = 0;
      let validCount = 0;
      allData.applicants.forEach(row => {
        const age = row['å¹´é½¢'];
        if (age && age > 0) {
          totalAge += age;
          validCount++;
        }
      });

      const avgAge = validCount > 0 ? (totalAge / validCount).toFixed(1) : 0;
      document.getElementById('avgAge').textContent = avgAge + 'æ­³';
    }

    // åœ°å›³æ›´æ–°
    function updateMap() {
      clearMap();

      const mode = document.getElementById('displayMode').value;
      const filter = document.getElementById('dataFilter').value;

      let data = allData.mapMetrics;

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      if (filter !== 'all') {
        data = applyFilterToData(data, filter);
      }

      switch(mode) {
        case 'markers':
          displayMarkers(data);
          break;
        case 'cluster':
          displayClusters(data);
          break;
        case 'heatmap':
          displayHeatmap(data);
          break;
      }
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function applyFilterToData(data, filterType) {
      // Applicantsã‹ã‚‰å¯¾è±¡IDã‚’å–å¾—
      const targetIds = new Set();

      allData.applicants.forEach(row => {
        let include = false;

        switch(filterType) {
          case 'male':
            include = row['æ€§åˆ¥'] === 'ç”·æ€§';
            break;
          case 'female':
            include = row['æ€§åˆ¥'] === 'å¥³æ€§';
            break;
          case 'young':
            include = row['å¹´é½¢'] >= 20 && row['å¹´é½¢'] < 40;
            break;
          case 'middle':
            include = row['å¹´é½¢'] >= 40 && row['å¹´é½¢'] < 60;
            break;
          case 'senior':
            include = row['å¹´é½¢'] >= 60;
            break;
        }

        if (include) {
          targetIds.add(row['ID']);
        }
      });

      // DesiredWorkã‹ã‚‰è©²å½“ã®å¸Œæœ›å‹¤å‹™åœ°ã‚’å–å¾—
      const targetMunicipalities = new Set();
      allData.desiredWork.forEach(row => {
        if (targetIds.has(row['ç”³è«‹è€…ID'])) {
          targetMunicipalities.add(row['å¸Œæœ›å‹¤å‹™åœ°_å¸‚åŒºç”ºæ‘']);
        }
      });

      // MapMetricsã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      return data.filter(row => targetMunicipalities.has(row['å¸‚åŒºç”ºæ‘']));
    }

    // ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
    function displayMarkers(data) {
      data.forEach(row => {
        if (row['ç·¯åº¦'] && row['çµŒåº¦']) {
          const marker = L.marker([row['ç·¯åº¦'], row['çµŒåº¦']])
            .bindPopup(`
              <strong>${row['å¸‚åŒºç”ºæ‘']}</strong><br>
              æ±‚è·è€…æ•°: ${row['ã‚«ã‚¦ãƒ³ãƒˆ']}å<br>
              éƒ½é“åºœçœŒ: ${row['éƒ½é“åºœçœŒ']}
            `);
          marker.on('click', function() {
            handleRegionSelection(row['éƒ½é“åºœçœŒ'], row['å¸‚åŒºç”ºæE]);
          });
          markers.push(marker);
          marker.addTo(map);
        }
      });
    }

    // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼è¡¨ç¤º
    function displayClusters(data) {
      markerCluster.clearLayers();
      data.forEach(row => {
        if (row['ç·¯åº¦'] && row['çµŒåº¦']) {
          const marker = L.marker([row['ç·¯åº¦'], row['çµŒåº¦']])
            .bindPopup(`
              <strong>${row['å¸‚åŒºç”ºæ‘']}</strong><br>
              æ±‚è·è€…æ•°: ${row['ã‚«ã‚¦ãƒ³ãƒˆ']}å
            `);
          marker.on('click', function() {
            handleRegionSelection(row['éƒ½é“åºœçœŒ'], row['å¸‚åŒºç”ºæE]);
          });
          markerCluster.addLayer(marker);
        }
      });
      map.addLayer(markerCluster);
    }

    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—è¡¨ç¤º
    function displayHeatmap(data) {
      const heatData = data
        .filter(row => row['ç·¯åº¦'] && row['çµŒåº¦'] && row['ã‚«ã‚¦ãƒ³ãƒˆ'])
        .map(row => [row['ç·¯åº¦'], row['çµŒåº¦'], row['ã‚«ã‚¦ãƒ³ãƒˆ']]);

      if (heatLayer) {
        map.removeLayer(heatLayer);
      }

      heatLayer = L.heatLayer(heatData, {
        radius: 25,
        blur: 15,
        maxZoom: 17
      }).addTo(map);
    }

    // åœ°å›³ã‚¯ãƒªã‚¢
    function clearMap() {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
      markerCluster.clearLayers();
      map.removeLayer(markerCluster);
    if (heatLayer) {
      map.removeLayer(heatLayer);
    }
  }

  function handleRegionSelection(prefecture, municipality) {
    if (!prefecture) {
      return;
    }
    google.script.run
      .withSuccessHandler(() => {
        console.log('[INFO] Region selection saved:', prefecture, municipality);
      })
      .withFailureHandler(error => {
        console.error('[ERROR] Failed to save region selection', error);
      })
      .saveSelectedRegion(prefecture, municipality || null);
  }

  // TOP10æ›´æ–°
  function updateTop10() {
      const listEl = document.getElementById('top10List');
      listEl.innerHTML = '';

      // AggDesiredã‹ã‚‰ä¸Šä½10ä»¶å–å¾—
      const top10 = allData.aggDesired
        .sort((a, b) => b['ã‚«ã‚¦ãƒ³ãƒˆ'] - a['ã‚«ã‚¦ãƒ³ãƒˆ'])
        .slice(0, 10);

      top10.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'top10-item';
        li.innerHTML = `
          <span>
            <span class="top10-rank">${index + 1}</span>
            ${item['å¸‚åŒºç”ºæ‘'] || item['å¸Œæœ›å‹¤å‹™åœ°_å¸‚åŒºç”ºæ‘']}
          </span>
          <span><strong>${item['ã‚«ã‚¦ãƒ³ãƒˆ']}äºº</strong></span>
        `;
        listEl.appendChild(li);
      });
    }

    // æ€§åˆ¥ã‚°ãƒ©ãƒ•æ›´æ–°
    function updateGenderChart() {
      const ctx = document.getElementById('genderChart');
      if (!ctx) return;

      // æ€§åˆ¥é›†è¨ˆ
      const genderCounts = {};
      allData.applicants.forEach(row => {
        const gender = row['æ€§åˆ¥'] || 'ä¸æ˜';
        genderCounts[gender] = (genderCounts[gender] || 0) + 1;
      });

      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(genderCounts),
          datasets: [{
            data: Object.values(genderCounts),
            backgroundColor: [
              'rgba(102, 126, 234, 0.8)',
              'rgba(255, 99, 132, 0.8)',
              'rgba(255, 206, 86, 0.8)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: 'white'
              }
            }
          }
        }
      });
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    function changeDisplayMode() {
      updateMap();
    }

    function applyFilter() {
      updateMap();
    }

    // åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', function() {
      try {
        initMap();
        loadData();
      } catch (error) {
        console.error('[ERROR]', error);
        alert('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    });
  </script>
</body>
</html>

<!-- ===== PersonaDifficultyCheckerUI.html ===== -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
      margin: 0;
    }

    h2 {
      color: #1976d2;
      margin-bottom: 20px;
      text-align: center;
    }

    .filter-panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-label {
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
    }

    select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      background: white;
    }

    select[multiple] {
      min-height: 120px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    button {
      padding: 10px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #1976d2;
      color: white;
    }

    .btn-primary:hover {
      background: #1565c0;
    }

    .btn-secondary {
      background: #757575;
      color: white;
    }

    .btn-secondary:hover {
      background: #616161;
    }

    .stats-panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
    }

    .stat-card {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 4px;
      text-align: center;
    }

    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #1976d2;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    .persona-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .persona-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .persona-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .difficulty-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      color: white;
    }

    .difficulty-S { background: #d32f2f; }
    .difficulty-A { background: #f57c00; }
    .difficulty-B { background: #fbc02d; }
    .difficulty-C { background: #7cb342; }
    .difficulty-D { background: #66bb6a; }
    .difficulty-E { background: #81c784; }

    .persona-header {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }

    .persona-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }

    .persona-subtitle {
      font-size: 14px;
      color: #666;
    }

    .persona-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .metric-item {
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
    }

    .metric-label {
      font-size: 11px;
      color: #666;
      margin-bottom: 3px;
    }

    .metric-value {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }

    .persona-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .category-tag {
      padding: 4px 10px;
      background: #e0e0e0;
      border-radius: 12px;
      font-size: 11px;
      color: #333;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .no-results {
      text-align: center;
      padding: 60px;
      color: #999;
      font-size: 18px;
    }

    .help-text {
      font-size: 12px;
      color: #666;
      font-style: italic;
      margin-top: 5px;
    }

    .score-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }

    .score-fill {
      height: 100%;
      background: linear-gradient(90deg, #81c784 0%, #fbc02d 50%, #d32f2f 100%);
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <h2>ğŸ¯ ãƒšãƒ«ã‚½ãƒŠé›£æ˜“åº¦ç¢ºèª</h2>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒãƒ« -->
  <div class="filter-panel">
    <h3 style="margin-top: 0; color: #1976d2;">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</h3>

    <div class="filter-grid">
      <!-- é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ« -->
      <div class="filter-group">
        <div class="filter-label">é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ«</div>
        <select id="difficultyFilter" multiple>
          <option value="Sç´šï¼ˆæœ€é›£ï¼‰">Sç´šï¼ˆæœ€é›£ï¼‰</option>
          <option value="Aç´šï¼ˆé›£ï¼‰">Aç´šï¼ˆé›£ï¼‰</option>
          <option value="Bç´šï¼ˆã‚„ã‚„é›£ï¼‰">Bç´šï¼ˆã‚„ã‚„é›£ï¼‰</option>
          <option value="Cç´šï¼ˆæ™®é€šï¼‰">Cç´šï¼ˆæ™®é€šï¼‰</option>
          <option value="Dç´šï¼ˆã‚„ã‚„æ˜“ï¼‰">Dç´šï¼ˆã‚„ã‚„æ˜“ï¼‰</option>
          <option value="Eç´šï¼ˆæ˜“ï¼‰">Eç´šï¼ˆæ˜“ï¼‰</option>
        </select>
        <div class="help-text">æ¡ç”¨é›£æ˜“åº¦ãƒ©ãƒ³ã‚¯</div>
      </div>

      <!-- å¹´é½¢ã‚°ãƒ«ãƒ¼ãƒ— -->
      <div class="filter-group">
        <div class="filter-label">å¹´é½¢å±¤</div>
        <select id="ageGroupFilter" multiple>
          <option value="æ–°å’å±¤ï¼ˆï½24æ­³ï¼‰">æ–°å’å±¤ï¼ˆï½24æ­³ï¼‰</option>
          <option value="è‹¥æ‰‹å±¤ï¼ˆ25ï½29æ­³ï¼‰">è‹¥æ‰‹å±¤ï¼ˆ25ï½29æ­³ï¼‰</option>
          <option value="è‹¥æ‰‹ä¸­å …å±¤ï¼ˆ30ï½34æ­³ï¼‰">è‹¥æ‰‹ä¸­å …å±¤ï¼ˆ30ï½34æ­³ï¼‰</option>
          <option value="ä¸­å …å±¤ï¼ˆ35ï½39æ­³ï¼‰">ä¸­å …å±¤ï¼ˆ35ï½39æ­³ï¼‰</option>
          <option value="ãƒŸãƒ‰ãƒ«å±¤ï¼ˆ40ï½44æ­³ï¼‰">ãƒŸãƒ‰ãƒ«å±¤ï¼ˆ40ï½44æ­³ï¼‰</option>
          <option value="ã‚·ãƒ‹ã‚¢ãƒŸãƒ‰ãƒ«å±¤ï¼ˆ45ï½49æ­³ï¼‰">ã‚·ãƒ‹ã‚¢ãƒŸãƒ‰ãƒ«å±¤ï¼ˆ45ï½49æ­³ï¼‰</option>
          <option value="ãƒ—ãƒ¬ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ50ï½54æ­³ï¼‰">ãƒ—ãƒ¬ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ50ï½54æ­³ï¼‰</option>
          <option value="ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ55ï½59æ­³ï¼‰">ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ55ï½59æ­³ï¼‰</option>
          <option value="ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ60ï½64æ­³ï¼‰">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ‹ã‚¢å±¤ï¼ˆ60ï½64æ­³ï¼‰</option>
          <option value="é«˜é½¢å±¤ï¼ˆ65æ­³ï½ï¼‰">é«˜é½¢å±¤ï¼ˆ65æ­³ï½ï¼‰</option>
        </select>
        <div class="help-text">å¹³å‡å¹´é½¢ã«ã‚ˆã‚‹ã‚°ãƒ«ãƒ¼ãƒ—åˆ†é¡</div>
      </div>

      <!-- è³‡æ ¼ãƒ¬ãƒ™ãƒ« -->
      <div class="filter-group">
        <div class="filter-label">è³‡æ ¼ä¿æœ‰ãƒ¬ãƒ™ãƒ«</div>
        <select id="qualificationFilter" multiple>
          <option value="è¶…é«˜è³‡æ ¼å±¤ï¼ˆ5å€‹ä»¥ä¸Šï¼‰">è¶…é«˜è³‡æ ¼å±¤ï¼ˆ5å€‹ä»¥ä¸Šï¼‰</option>
          <option value="é«˜è³‡æ ¼å±¤ï¼ˆ3ï½4å€‹ï¼‰">é«˜è³‡æ ¼å±¤ï¼ˆ3ï½4å€‹ï¼‰</option>
          <option value="ä¸­è³‡æ ¼å±¤ï¼ˆ2ï½3å€‹ï¼‰">ä¸­è³‡æ ¼å±¤ï¼ˆ2ï½3å€‹ï¼‰</option>
          <option value="ä½è³‡æ ¼å±¤ï¼ˆ1ï½2å€‹ï¼‰">ä½è³‡æ ¼å±¤ï¼ˆ1ï½2å€‹ï¼‰</option>
          <option value="å¾®è³‡æ ¼å±¤ï¼ˆ0.5ï½1å€‹ï¼‰">å¾®è³‡æ ¼å±¤ï¼ˆ0.5ï½1å€‹ï¼‰</option>
          <option value="ç„¡è³‡æ ¼å±¤ï¼ˆ0.5å€‹æœªæº€ï¼‰">ç„¡è³‡æ ¼å±¤ï¼ˆ0.5å€‹æœªæº€ï¼‰</option>
        </select>
        <div class="help-text">å¹³å‡è³‡æ ¼ä¿æœ‰æ•°</div>
      </div>

      <!-- ç§»å‹•æ€§ãƒ¬ãƒ™ãƒ« -->
      <div class="filter-group">
        <div class="filter-label">å¸Œæœ›å‹¤å‹™åœ°ã®åºƒã•</div>
        <select id="mobilityFilter" multiple>
          <option value="è¶…åºƒåŸŸå¸Œæœ›ï¼ˆ10ç®‡æ‰€ä»¥ä¸Šï¼‰">è¶…åºƒåŸŸå¸Œæœ›ï¼ˆ10ç®‡æ‰€ä»¥ä¸Šï¼‰</option>
          <option value="åºƒåŸŸå¸Œæœ›ï¼ˆ6ï½9ç®‡æ‰€ï¼‰">åºƒåŸŸå¸Œæœ›ï¼ˆ6ï½9ç®‡æ‰€ï¼‰</option>
          <option value="ä¸­åŸŸå¸Œæœ›ï¼ˆ4ï½5ç®‡æ‰€ï¼‰">ä¸­åŸŸå¸Œæœ›ï¼ˆ4ï½5ç®‡æ‰€ï¼‰</option>
          <option value="ç‹­åŸŸå¸Œæœ›ï¼ˆ2.5ï½3.5ç®‡æ‰€ï¼‰">ç‹­åŸŸå¸Œæœ›ï¼ˆ2.5ï½3.5ç®‡æ‰€ï¼‰</option>
          <option value="é™å®šå¸Œæœ›ï¼ˆ1.5ï½2.5ç®‡æ‰€ï¼‰">é™å®šå¸Œæœ›ï¼ˆ1.5ï½2.5ç®‡æ‰€ï¼‰</option>
          <option value="å›ºå®šå¸Œæœ›ï¼ˆ1.5ç®‡æ‰€æœªæº€ï¼‰">å›ºå®šå¸Œæœ›ï¼ˆ1.5ç®‡æ‰€æœªæº€ï¼‰</option>
        </select>
        <div class="help-text">å¸Œæœ›å‹¤å‹™åœ°æ•°ã«ã‚ˆã‚‹æŸ”è»Ÿæ€§</div>
      </div>

      <!-- æ€§åˆ¥ã‚«ãƒ†ã‚´ãƒª -->
      <div class="filter-group">
        <div class="filter-label">æ€§åˆ¥æ§‹æˆ</div>
        <select id="genderFilter" multiple>
          <option value="å¥³æ€§ç‰¹åŒ–å±¤ï¼ˆ90%ä»¥ä¸Šï¼‰">å¥³æ€§ç‰¹åŒ–å±¤ï¼ˆ90%ä»¥ä¸Šï¼‰</option>
          <option value="å¥³æ€§å„ªå‹¢å±¤ï¼ˆ70ï½89%ï¼‰">å¥³æ€§å„ªå‹¢å±¤ï¼ˆ70ï½89%ï¼‰</option>
          <option value="å¥³æ€§ã‚„ã‚„å¤šå±¤ï¼ˆ55ï½69%ï¼‰">å¥³æ€§ã‚„ã‚„å¤šå±¤ï¼ˆ55ï½69%ï¼‰</option>
          <option value="ç”·å¥³å‡è¡¡å±¤ï¼ˆ45ï½54%ï¼‰">ç”·å¥³å‡è¡¡å±¤ï¼ˆ45ï½54%ï¼‰</option>
          <option value="ç”·æ€§ã‚„ã‚„å¤šå±¤ï¼ˆ31ï½44%ï¼‰">ç”·æ€§ã‚„ã‚„å¤šå±¤ï¼ˆ31ï½44%ï¼‰</option>
          <option value="ç”·æ€§å„ªå‹¢å±¤ï¼ˆ11ï½30%ï¼‰">ç”·æ€§å„ªå‹¢å±¤ï¼ˆ11ï½30%ï¼‰</option>
          <option value="ç”·æ€§ç‰¹åŒ–å±¤ï¼ˆ10%ä»¥ä¸‹ï¼‰">ç”·æ€§ç‰¹åŒ–å±¤ï¼ˆ10%ä»¥ä¸‹ï¼‰</option>
        </select>
        <div class="help-text">å¥³æ€§æ¯”ç‡ã«ã‚ˆã‚‹åˆ†é¡</div>
      </div>

      <!-- å¸‚å ´è¦æ¨¡ -->
      <div class="filter-group">
        <div class="filter-label">å¸‚å ´è¦æ¨¡</div>
        <select id="marketSizeFilter" multiple>
          <option value="è¶…å¤§è¦æ¨¡ï¼ˆ20%ä»¥ä¸Šï¼‰">è¶…å¤§è¦æ¨¡ï¼ˆ20%ä»¥ä¸Šï¼‰</option>
          <option value="å¤§è¦æ¨¡ï¼ˆ15ï½19%ï¼‰">å¤§è¦æ¨¡ï¼ˆ15ï½19%ï¼‰</option>
          <option value="ä¸­è¦æ¨¡ï¼ˆ10ï½14%ï¼‰">ä¸­è¦æ¨¡ï¼ˆ10ï½14%ï¼‰</option>
          <option value="ã‚„ã‚„å°è¦æ¨¡ï¼ˆ7ï½9%ï¼‰">ã‚„ã‚„å°è¦æ¨¡ï¼ˆ7ï½9%ï¼‰</option>
          <option value="å°è¦æ¨¡ï¼ˆ4ï½6%ï¼‰">å°è¦æ¨¡ï¼ˆ4ï½6%ï¼‰</option>
          <option value="è¶…å°è¦æ¨¡ï¼ˆ2ï½3%ï¼‰">è¶…å°è¦æ¨¡ï¼ˆ2ï½3%ï¼‰</option>
          <option value="ãƒ‹ãƒƒãƒï¼ˆ2%æœªæº€ï¼‰">ãƒ‹ãƒƒãƒï¼ˆ2%æœªæº€ï¼‰</option>
        </select>
        <div class="help-text">å…¨ä½“ã«å ã‚ã‚‹å‰²åˆ</div>
      </div>
    </div>

    <div class="button-group">
      <button class="btn-primary" onclick="applyFilters()">çµã‚Šè¾¼ã¿å®Ÿè¡Œ</button>
      <button class="btn-secondary" onclick="resetFilters()">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <!-- çµ±è¨ˆãƒ‘ãƒãƒ« -->
  <div class="stats-panel" id="statsPanel" style="display: none;">
    <h3 style="margin-top: 0; color: #1976d2;">çµ±è¨ˆã‚µãƒãƒªãƒ¼</h3>
    <div class="stats-grid" id="statsGrid"></div>
  </div>

  <!-- ãƒšãƒ«ã‚½ãƒŠè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div id="personaContainer" class="loading">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>

  <script>
    let allPersonas = [];

    // åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          allPersonas = result.personas;
          displayPersonas(allPersonas);
          loadStatistics();
        } else {
          document.getElementById('personaContainer').innerHTML =
            '<div class="no-results">ã‚¨ãƒ©ãƒ¼: ' + result.message + '</div>';
        }
      })
      .withFailureHandler(function(error) {
        document.getElementById('personaContainer').innerHTML =
          '<div class="no-results">ã‚¨ãƒ©ãƒ¼: ' + error + '</div>';
      })
      .getPersonaDataForDifficulty();

    // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
    function loadStatistics() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
              <div class="stat-card">
                <div class="stat-value">${result.totalPersonas}</div>
                <div class="stat-label">ãƒšãƒ«ã‚½ãƒŠæ•°</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${result.totalCount.toLocaleString()}</div>
                <div class="stat-label">ç·æ±‚è·è€…æ•°</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${result.avgDifficultyScore.toFixed(1)}</div>
                <div class="stat-label">å¹³å‡é›£æ˜“åº¦</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${Object.keys(result.difficultyDistribution).length}</div>
                <div class="stat-label">é›£æ˜“åº¦ç¨®é¡</div>
              </div>
            `;
            document.getElementById('statsPanel').style.display = 'block';
          }
        })
        .getPersonaDifficultyStatistics();
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
    function applyFilters() {
      const filters = {
        difficultyLevels: getSelectedValues('difficultyFilter'),
        ageGroups: getSelectedValues('ageGroupFilter'),
        qualificationLevels: getSelectedValues('qualificationFilter'),
        mobilityLevels: getSelectedValues('mobilityFilter'),
        genderCategories: getSelectedValues('genderFilter'),
        marketSizeCategories: getSelectedValues('marketSizeFilter')
      };

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            displayPersonas(result.personas);
          }
        })
        .filterPersonasByConditions(filters);
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
    function resetFilters() {
      document.querySelectorAll('select[multiple]').forEach(select => {
        select.selectedIndex = -1;
      });
      displayPersonas(allPersonas);
    }

    // é¸æŠå€¤å–å¾—
    function getSelectedValues(selectId) {
      const select = document.getElementById(selectId);
      return Array.from(select.selectedOptions).map(opt => opt.value);
    }

    // ãƒšãƒ«ã‚½ãƒŠè¡¨ç¤º
    function displayPersonas(personas) {
      const container = document.getElementById('personaContainer');

      if (personas.length === 0) {
        container.innerHTML = '<div class="no-results">è©²å½“ã™ã‚‹ãƒšãƒ«ã‚½ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        return;
      }

      container.innerHTML = '';
      container.className = 'persona-grid';

      personas.forEach(function(p) {
        const difficultyClass = 'difficulty-' + p.difficultyLevel.charAt(0);
        const scorePercent = p.difficultyScore;

        const card = document.createElement('div');
        card.className = 'persona-card';
        card.innerHTML = `
          <div class="difficulty-badge ${difficultyClass}">
            ${p.difficultyLevel} (${p.difficultyScore}ç‚¹)
          </div>

          <div class="persona-header">
            <div class="persona-title">${p.segmentName}</div>
            <div class="persona-subtitle">
              ã‚»ã‚°ãƒ¡ãƒ³ãƒˆID: ${p.segmentId} | ${p.count.toLocaleString()}äºº (${p.percentage.toFixed(1)}%)
            </div>
          </div>

          <div class="persona-metrics">
            <div class="metric-item">
              <div class="metric-label">å¹³å‡å¹´é½¢</div>
              <div class="metric-value">${p.avgAge.toFixed(1)}æ­³</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">å¥³æ€§æ¯”ç‡</div>
              <div class="metric-value">${(p.femaleRatio * 100).toFixed(1)}%</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">å¹³å‡è³‡æ ¼æ•°</div>
              <div class="metric-value">${p.avgQualifications.toFixed(2)}å€‹</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">å¸Œæœ›å‹¤å‹™åœ°æ•°</div>
              <div class="metric-value">${p.avgDesiredLocations.toFixed(1)}ç®‡æ‰€</div>
            </div>
          </div>

          <div class="score-bar">
            <div class="score-fill" style="width: ${scorePercent}%"></div>
          </div>

          <div class="persona-categories" style="margin-top: 15px;">
            <div class="category-tag">${p.ageGroup}</div>
            <div class="category-tag">${p.qualificationLevel}</div>
            <div class="category-tag">${p.mobilityLevel}</div>
            <div class="category-tag">${p.genderCategory}</div>
            <div class="category-tag">${p.marketSizeCategory}</div>
          </div>
        `;

        container.appendChild(card);
      });
    }
  </script>
</body>
</html>

<!-- ===== RegionalDashboard.html ===== -->
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>åœ°åŸŸåˆ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <style>
      :root {
        --bg: #f5f7fb;
        --surface: #ffffff;
        --primary: #1a73e8;
        --primary-light: #e8f0fe;
        --border: #dfe4ea;
        --text: #202124;
        --muted: #5f6368;
        --warn: #c5221f;
        --accent: #34a853;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 32px 24px 48px;
      }

      h1 {
        margin: 0;
        font-size: 26px;
        font-weight: 600;
      }

      .description {
        margin-top: 6px;
        color: var(--muted);
      }

      .region-controls {
        margin-top: 28px;
        display: grid;
        grid-template-columns: 1fr 1fr auto;
        gap: 12px;
        align-items: end;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      label {
        font-size: 13px;
        color: var(--muted);
      }

      select {
        height: 40px;
        border-radius: 8px;
        border: 1px solid var(--border);
        padding: 0 12px;
        font-size: 14px;
        background: var(--surface);
        transition: border 0.2s ease;
      }

      select:focus {
        border-color: var(--primary);
        outline: none;
      }

      button.primary {
        height: 40px;
        min-width: 120px;
        border: none;
        border-radius: 8px;
        background: var(--primary);
        color: #fff;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      button.primary:disabled {
        background: #aac7f6;
        cursor: default;
      }

      button.primary:hover:not(:disabled) {
        background: #1557b0;
      }

      .tabs {
        margin-top: 32px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .tab-button {
        padding: 10px 18px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--muted);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .tab-button.active {
        background: var(--primary);
        border-color: var(--primary);
        color: #fff;
        box-shadow: 0 6px 16px rgba(26, 115, 232, 0.25);
      }

      .tab-button:disabled {
        opacity: 0.7;
        cursor: default;
      }

      .panel {
        margin-top: 24px;
        padding: 24px;
        border-radius: 16px;
        background: var(--surface);
        box-shadow: 0 12px 24px rgba(32, 33, 36, 0.08);
      }

      .filters {
        margin-bottom: 12px;
        display: none;
        gap: 12px;
        flex-wrap: wrap;
      }

      .filters.active {
        display: flex;
      }

      .filters select {
        min-width: 220px;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 16px;
      }

      .summary-card {
        padding: 18px;
        border-radius: 14px;
        background: var(--primary-light);
        border: 1px solid #d2e3fc;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .summary-card .label {
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .summary-card .value {
        font-size: 20px;
        font-weight: 700;
        color: var(--primary);
      }

      .summary-card .note {
        font-size: 12px;
        color: var(--muted);
      }

      .warnings {
        margin-top: 24px;
        padding: 16px 20px;
        border-radius: 12px;
        border: 1px solid rgba(197, 34, 31, 0.35);
        background: rgba(197, 34, 31, 0.08);
        color: var(--warn);
        display: none;
        gap: 8px;
        flex-direction: column;
      }

      .warnings.visible {
        display: flex;
      }

      .warning-title {
        font-weight: 600;
      }

      .table-group {
        margin-top: 28px;
      }

      .table-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: inset 0 0 0 1px var(--border);
        background: var(--surface);
      }

      th,
      td {
        padding: 10px 14px;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
        text-align: left;
      }

      th {
        background: #f1f4f9;
        font-weight: 600;
      }

      tr:last-child td {
        border-bottom: none;
      }

      .empty-placeholder {
        padding: 18px;
        border-radius: 12px;
        background: #f8f9fb;
        color: var(--muted);
        font-size: 13px;
      }

      .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .loading-overlay.visible {
        display: flex;
      }

      .spinner {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 4px solid rgba(26, 115, 232, 0.15);
        border-top-color: var(--primary);
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .toast {
        position: fixed;
        right: 24px;
        top: 24px;
        padding: 14px 18px;
        background: rgba(32, 33, 36, 0.9);
        color: #fff;
        border-radius: 10px;
        font-size: 13px;
        display: none;
        z-index: 1100;
      }

      .toast.visible {
        display: block;
      }

      @media (max-width: 720px) {
        .region-controls {
          grid-template-columns: 1fr;
        }
        .tabs {
          overflow-x: auto;
        }
        .tab-button {
          white-space: nowrap;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>åœ°åŸŸåˆ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <p class="description">
          éƒ½é“åºœçœŒãƒ»å¸‚åŒºç”ºæ‘ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã€Phase1 / 2 / 3 / 7 / 8 / 10 ã®ä¸»è¦æŒ‡æ¨™ã¨å“è³ªæƒ…å ±ã‚’æ¨ªæ–­çš„ã«ç¢ºèªã§ãã¾ã™ã€‚
        </p>
      </header>

      <section class="region-controls">
        <div class="field">
          <label for="prefectureSelect">éƒ½é“åºœçœŒ</label>
          <select id="prefectureSelect" disabled>
            <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
          </select>
        </div>
        <div class="field">
          <label for="municipalitySelect">å¸‚åŒºç”ºæ‘</label>
          <select id="municipalitySelect" disabled>
            <option value="">éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        <button class="primary" id="refreshButton" disabled>æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</button>
      </section>

      <nav class="tabs" id="phaseTabs"></nav>

      <section class="panel">
        <div class="filters" id="filterPanel"></div>
        <div class="summary-grid" id="summaryGrid"></div>
        <div class="warnings" id="warningsBox">
          <div class="warning-title">âš ï¸ æ³¨æ„äº‹é …</div>
          <div class="warning-list" id="warningList"></div>
        </div>
        <div id="tablesContainer"></div>
      </section>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
    </div>
    <div class="toast" id="toast"></div>

    <script>
      const PHASE_CONFIG = [
        {
          id: "phase1",
          label: "Phase 1 åŸºç¤é›†è¨ˆ",
          fetch: "fetchPhase1Metrics",
          hasFilters: false,
          summaryLabels: {
            applicantCount: "å¿œå‹Ÿè€…æ•°",
            mapRecords: "MapMetrics è¡Œæ•°",
            aggDesiredRecords: "AggDesired è¡Œæ•°"
          }
        },
        {
          id: "phase2",
          label: "Phase 2 çµ±è¨ˆè§£æ",
          fetch: "fetchPhase2Stats",
          hasFilters: false,
          summaryLabels: {
            chiSquareTests: "ã‚«ã‚¤äºŒä¹—æ¤œå®š",
            anovaTests: "ANOVAæ¤œå®š"
          }
        },
        {
          id: "phase3",
          label: "Phase 3 ãƒšãƒ«ã‚½ãƒŠåˆ†æ",
          fetch: "fetchPhase3Persona",
          hasFilters: true,
          summaryLabels: {
            personaSegments: "ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°",
            averageDifficultyScore: "å¹³å‡é›£æ˜“åº¦ã‚¹ã‚³ã‚¢",
            topDifficultyLevel: "æœ€é›£ãƒ©ãƒ³ã‚¯"
          }
        },
        {
          id: "phase7",
          label: "Phase 7 é«˜åº¦åˆ†æ",
          fetch: "fetchPhase7Supply",
          hasFilters: false,
          summaryLabels: {
            supplyRecords: "ä¾›çµ¦å¯†åº¦ãƒ¬ã‚³ãƒ¼ãƒ‰",
            qualificationRecords: "è³‡æ ¼åˆ†å¸ƒãƒ¬ã‚³ãƒ¼ãƒ‰",
            mobilityRecords: "ç§»å‹•è¨±å®¹åº¦ãƒ¬ã‚³ãƒ¼ãƒ‰"
          }
        },
        {
          id: "phase8",
          label: "Phase 8 å­¦æ­´ãƒ»ã‚­ãƒ£ãƒªã‚¢",
          fetch: "fetchPhase8Education",
          hasFilters: false,
          summaryLabels: {
            educationBuckets: "å­¦æ­´ç¨®åˆ¥",
            graduationBuckets: "å’æ¥­å¹´åˆ†å¸ƒ"
          }
        },
        {
          id: "phase10",
          label: "Phase 10 è»¢è·æ„æ¬²",
          fetch: "fetchPhase10Urgency",
          hasFilters: false,
          summaryLabels: {
            urgencyRecords: "ç·Šæ€¥åº¦åˆ†å¸ƒ",
            ageCrossRecords: "å¹´é½¢ã‚¯ãƒ­ã‚¹é›†è¨ˆ",
            employmentCrossRecords: "é›‡ç”¨å½¢æ…‹ã‚¯ãƒ­ã‚¹"
          }
        }
      ];

      const RESERVED_ALIAS_KEYS = new Set([
        "prefecture",
        "municipality",
        "regionKey",
        "latitude",
        "longitude",
        "count",
        "ratio",
        "score",
        "urgencyLevel",
        "urgencyScore",
        "segmentId",
        "segmentName"
      ]);

      const state = {
        region: {
          prefecture: null,
          municipality: null,
          key: null
        },
        municipalities: [],
        activePhase: "phase1",
        phaseCache: {},
        phase3Filters: {
          segmentId: "",
          difficultyLevel: ""
        }
      };

      const dom = {
        prefSelect: document.getElementById("prefectureSelect"),
        muniSelect: document.getElementById("municipalitySelect"),
        refreshButton: document.getElementById("refreshButton"),
        tabs: document.getElementById("phaseTabs"),
        filterPanel: document.getElementById("filterPanel"),
        summaryGrid: document.getElementById("summaryGrid"),
        warningsBox: document.getElementById("warningsBox"),
        warningList: document.getElementById("warningList"),
        tablesContainer: document.getElementById("tablesContainer"),
        loadingOverlay: document.getElementById("loadingOverlay"),
        toast: document.getElementById("toast")
      };

      function showToast(message, timeout = 3500) {
        dom.toast.textContent = message;
        dom.toast.classList.add("visible");
        setTimeout(() => dom.toast.classList.remove("visible"), timeout);
      }

      function setLoading(isLoading) {
        dom.loadingOverlay.classList.toggle("visible", isLoading);
        dom.refreshButton.disabled = isLoading;
        dom.prefSelect.disabled = isLoading;
        dom.muniSelect.disabled = isLoading;
      }

      function initialize() {
        setLoading(true);
        google.script.run
          .withSuccessHandler(handleInitialOptions)
          .withFailureHandler(handleError)
          .getRegionOptions();
      }

      function handleInitialOptions(payload) {
        state.region = payload.state || state.region;
        populatePrefectures(payload.prefectures || []);
        populateMunicipalities(payload.municipalities || []);
        renderTabs();
        registerEvents();
        setLoading(false);
        activatePhase(state.activePhase);
      }

      function populatePrefectures(prefectures) {
        const select = dom.prefSelect;
        select.innerHTML = "";

        if (!prefectures.length) {
          select.innerHTML = '<option value="">åˆ©ç”¨å¯èƒ½ãªéƒ½é“åºœçœŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</option>';
          select.disabled = true;
          return;
        }

        prefectures.forEach(pref => {
          const option = document.createElement("option");
          option.value = pref;
          option.textContent = pref;
          if (pref === state.region.prefecture) {
            option.selected = true;
          }
          select.append(option);
        });

        select.disabled = false;
      }

      function populateMunicipalities(municipalities) {
        state.municipalities = municipalities;
        const select = dom.muniSelect;
        select.innerHTML = "";

        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = municipalities.length ? "å¸‚åŒºç”ºæ‘ã‚’é¸æŠï¼ˆä»»æ„ï¼‰" : "è©²å½“ã™ã‚‹å¸‚åŒºç”ºæ‘ãŒã‚ã‚Šã¾ã›ã‚“";
        select.append(placeholder);

        municipalities.forEach(muni => {
          const option = document.createElement("option");
          option.value = muni;
          option.textContent = muni;
          if (muni === state.region.municipality) {
            option.selected = true;
          }
          select.append(option);
        });

        select.disabled = false;
      }

      function renderTabs() {
        dom.tabs.innerHTML = "";
        PHASE_CONFIG.forEach(phase => {
          const button = document.createElement("button");
          button.type = "button";
          button.className = "tab-button" + (phase.id === state.activePhase ? " active" : "");
          button.textContent = phase.label;
          button.dataset.phase = phase.id;
          dom.tabs.append(button);
        });
      }

      function registerEvents() {
        dom.prefSelect.addEventListener("change", handlePrefectureChange);
        dom.muniSelect.addEventListener("change", handleMunicipalityChange);
        dom.refreshButton.addEventListener("click", () => refreshPhase(state.activePhase, { force: true }));
        dom.tabs.addEventListener("click", evt => {
          const target = evt.target.closest(".tab-button");
          if (!target) return;
          const phaseId = target.dataset.phase;
          activatePhase(phaseId);
        });
      }

      function handlePrefectureChange() {
        const selectedPref = dom.prefSelect.value || null;
        if (!selectedPref) {
          return;
        }

        setLoading(true);
        google.script.run
          .withSuccessHandler(municipalities => {
            populateMunicipalities(municipalities || []);
            const selectedMuni = municipalities.includes(state.region.municipality)
              ? state.region.municipality
              : municipalities[0] || null;
            saveRegion(selectedPref, selectedMuni, true);
          })
          .withFailureHandler(handleError)
          .getMunicipalitiesForPrefecture(selectedPref);
      }

      function handleMunicipalityChange() {
        const selectedMuni = dom.muniSelect.value || null;
        saveRegion(state.region.prefecture, selectedMuni, true);
      }

      function saveRegion(prefecture, municipality, refreshAfter = false) {
        setLoading(true);
        google.script.run
          .withSuccessHandler(updated => {
            state.region = updated;
            state.phaseCache = {};
            setLoading(false);
            if (refreshAfter) {
              refreshPhase(state.activePhase, { force: true });
            }
          })
          .withFailureHandler(handleError)
          .saveSelectedRegion(prefecture, municipality);
      }

      function activatePhase(phaseId) {
        if (!phaseId) return;
        state.activePhase = phaseId;
        Array.from(dom.tabs.querySelectorAll(".tab-button")).forEach(button => {
          button.classList.toggle("active", button.dataset.phase === phaseId);
        });
        refreshPhase(phaseId);
      }

      function refreshPhase(phaseId, options = {}) {
        const phase = PHASE_CONFIG.find(p => p.id === phaseId);
        if (!phase) return;

        const useCache = !options.force && state.phaseCache[phaseId];
        if (useCache) {
          renderPhaseData(phase, state.phaseCache[phaseId], { fromCache: true });
          return;
        }

        setLoading(true);
        const args = buildPhaseArgs(phaseId);

        let runner = google.script.run
          .withSuccessHandler(data => {
            state.phaseCache[phaseId] = data;
            renderPhaseData(phase, data, { fromCache: false });
            setLoading(false);
            if (!options.fromFilter && phaseId === "phase3") {
              updatePhase3Filters(data);
            }
          })
          .withFailureHandler(handleError);

        runner = runner[phase.fetch];
        runner.apply(null, args);
      }

      function buildPhaseArgs(phaseId) {
        const base = [state.region.prefecture, state.region.municipality];
        if (phaseId === "phase3") {
          return [
            ...base,
            {
              segmentId: state.phase3Filters.segmentId || "",
              difficultyLevel: state.phase3Filters.difficultyLevel || ""
            }
          ];
        }
        return base;
      }

      function renderPhaseData(phase, data, meta) {
        renderSummary(phase, data.summary || {});
        renderWarnings(data.warnings || []);
        renderTables(data.tables || {});
        renderFilters(phase, data);
        if (meta.fromCache) {
          showToast("ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸçµæœã‚’è¡¨ç¤ºä¸­ï¼ˆæœ€æ–°ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ãªå ´åˆã¯æ›´æ–°ã—ã¦ãã ã•ã„ï¼‰", 2500);
        }
      }

      function renderSummary(phase, summary) {
        dom.summaryGrid.innerHTML = "";
        const labels = phase.summaryLabels || {};
        const entries = Object.entries(summary || {});

        if (!entries.length) {
          const placeholder = document.createElement("div");
          placeholder.className = "empty-placeholder";
          placeholder.textContent = "ã“ã®ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯è¡¨ç¤ºå¯èƒ½ãªã‚µãƒãƒªãƒ¼æŒ‡æ¨™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
          dom.summaryGrid.append(placeholder);
          return;
        }

        entries.forEach(([key, value]) => {
          const card = document.createElement("div");
          card.className = "summary-card";

          const label = document.createElement("div");
          label.className = "label";
          label.textContent = labels[key] || key;

          const val = document.createElement("div");
          val.className = "value";
          val.textContent = formatValue(value);

          card.append(label, val);
          dom.summaryGrid.append(card);
        });
      }

      function renderWarnings(warnings) {
        if (!warnings || !warnings.length) {
          dom.warningsBox.classList.remove("visible");
          dom.warningList.innerHTML = "";
          return;
        }

        dom.warningsBox.classList.add("visible");
        dom.warningList.innerHTML = "";
        warnings.forEach(message => {
          const row = document.createElement("div");
          row.textContent = message;
          dom.warningList.append(row);
        });
      }

      function renderTables(tables) {
        dom.tablesContainer.innerHTML = "";
        const entries = Object.entries(tables || {});
        if (!entries.length) {
          const placeholder = document.createElement("div");
          placeholder.className = "empty-placeholder";
          placeholder.textContent = "è¡¨ç¤ºã§ãã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
          dom.tablesContainer.append(placeholder);
          return;
        }

        entries.forEach(([tableKey, rows]) => {
          const group = document.createElement("section");
          group.className = "table-group";

          const title = document.createElement("div");
          title.className = "table-title";
          title.textContent = deriveTableTitle(tableKey);

          group.append(title);
          if (!Array.isArray(rows) || !rows.length) {
            const placeholder = document.createElement("div");
            placeholder.className = "empty-placeholder";
            placeholder.textContent = "è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
            group.append(placeholder);
          } else {
            const sanitized = sanitizeRecords(rows);
            const table = buildTableElement(sanitized);
            group.append(table);
          }
          dom.tablesContainer.append(group);
        });
      }

      function deriveTableTitle(key) {
        const map = {
          mapMetrics: "MapMetrics",
          aggDesired: "AggDesired",
          quality: "å“è³ªãƒ¬ãƒãƒ¼ãƒˆ",
          chiSquare: "ChiSquareTests",
          anova: "ANOVATests",
          personaSummary: "PersonaSummary",
          personaDetails: "PersonaDetails",
          supplyDensity: "SupplyDensityMap",
          qualificationDistribution: "QualificationDistribution",
          ageGenderCross: "AgeGenderCrossAnalysis",
          mobilityScore: "MobilityScore",
          personaProfile: "DetailedPersonaProfile",
          educationDistribution: "EducationDistribution",
          educationCross: "EducationAgeCross",
          graduationDistribution: "GraduationYearDistribution",
          urgencyDistribution: "UrgencyDistribution",
          ageCross: "UrgencyAgeCross",
          employmentCross: "UrgencyEmploymentCross",
          desiredWorkCross: "UrgencyDesiredWorkCross"
        };
        return map[key] || key;
      }

      function sanitizeRecords(records) {
        return records.map(record => {
          const cleaned = {};
          Object.keys(record).forEach(key => {
            if (key === "__normalized") return;
            if (RESERVED_ALIAS_KEYS.has(key)) return;
            cleaned[key] = record[key];
          });
          if (!Object.keys(cleaned).length) {
            Object.keys(record).forEach(key => {
              if (key !== "__normalized" && !cleaned.hasOwnProperty(key)) {
                cleaned[key] = record[key];
              }
            });
          }
          return cleaned;
        });
      }

      function buildTableElement(records) {
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const tbody = document.createElement("tbody");

        const columns = deriveColumns(records);
        const headerRow = document.createElement("tr");
        columns.forEach(col => {
          const th = document.createElement("th");
          th.textContent = col;
          headerRow.append(th);
        });
        thead.append(headerRow);

        records.forEach(record => {
          const row = document.createElement("tr");
          columns.forEach(col => {
            const td = document.createElement("td");
            td.textContent = formatValue(record[col]);
            row.append(td);
          });
          tbody.append(row);
        });

        table.append(thead, tbody);
        return table;
      }

      function deriveColumns(records) {
        if (!records.length) return [];
        const ordered = Object.keys(records[0]);
        const seen = new Set();
        return ordered.filter(col => {
          if (seen.has(col)) return false;
          seen.add(col);
          return true;
        });
      }

      function formatValue(value) {
        if (value === null || value === undefined || value === "") {
          return "-";
        }
        if (typeof value === "number") {
          return Number.isInteger(value) ? value.toLocaleString("ja-JP") : Number(value).toLocaleString("ja-JP", { maximumFractionDigits: 3 });
        }
        if (typeof value === "boolean") {
          return value ? "ã¯ã„" : "ã„ã„ãˆ";
        }
        return String(value);
      }

      function renderFilters(phase, data) {
        if (!phase.hasFilters) {
          dom.filterPanel.classList.remove("active");
          dom.filterPanel.innerHTML = "";
          return;
        }

        dom.filterPanel.classList.add("active");
        dom.filterPanel.innerHTML = "";

        if (phase.id === "phase3") {
          const { personaSummary = [] } = data.tables || {};
          const segmentOptions = personaSummary
            .map(record => {
              const id = record.segment_id ?? record.segmentId;
              const name = record.segment_name ?? record.segmentName ?? id;
              if (id === undefined || id === null || id === "") return null;
              return { id: String(id), name: String(name) };
            })
            .filter(Boolean);

          const difficultyOptions = personaSummary
            .map(record => record.difficulty_level ?? record.difficultyLevel)
            .filter(level => level && level !== "");

          const uniqueSegments = [];
          const seenSegments = new Set();
          segmentOptions.forEach(option => {
            if (seenSegments.has(option.id)) return;
            seenSegments.add(option.id);
            uniqueSegments.push(option);
          });

          const uniqueDifficulties = Array.from(new Set(difficultyOptions));

          const segmentWrapper = document.createElement("div");
          segmentWrapper.className = "field";

          const segmentLabel = document.createElement("label");
          segmentLabel.textContent = "ãƒšãƒ«ã‚½ãƒŠ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ";
          segmentLabel.htmlFor = "segmentFilter";

          const segmentSelect = document.createElement("select");
          segmentSelect.id = "segmentFilter";
          segmentSelect.innerHTML = '<option value="">å…¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</option>';

          uniqueSegments.forEach(option => {
            const opt = document.createElement("option");
            opt.value = option.id;
            opt.textContent = `${option.id}: ${option.name}`;
            if (option.id === state.phase3Filters.segmentId) {
              opt.selected = true;
            }
            segmentSelect.append(opt);
          });

          segmentSelect.addEventListener("change", () => {
            state.phase3Filters.segmentId = segmentSelect.value;
            state.phaseCache.phase3 = null;
            refreshPhase("phase3", { force: true, fromFilter: true });
          });

          segmentWrapper.append(segmentLabel, segmentSelect);
          dom.filterPanel.append(segmentWrapper);

          const difficultyWrapper = document.createElement("div");
          difficultyWrapper.className = "field";

          const difficultyLabel = document.createElement("label");
          difficultyLabel.textContent = "é›£æ˜“åº¦ãƒ©ãƒ³ã‚¯";
          difficultyLabel.htmlFor = "difficultyFilter";

          const difficultySelect = document.createElement("select");
          difficultySelect.id = "difficultyFilter";
          difficultySelect.innerHTML = '<option value="">å…¨ãƒ©ãƒ³ã‚¯</option>';

          uniqueDifficulties.forEach(level => {
            const opt = document.createElement("option");
            opt.value = level;
            opt.textContent = level;
            if (level === state.phase3Filters.difficultyLevel) {
              opt.selected = true;
            }
            difficultySelect.append(opt);
          });

          difficultySelect.addEventListener("change", () => {
            state.phase3Filters.difficultyLevel = difficultySelect.value;
            state.phaseCache.phase3 = null;
            refreshPhase("phase3", { force: true, fromFilter: true });
          });

          difficultyWrapper.append(difficultyLabel, difficultySelect);
          dom.filterPanel.append(difficultyWrapper);
        }
      }

      function updatePhase3Filters(data) {
        if (state.activePhase !== "phase3") return;
        renderFilters(PHASE_CONFIG.find(p => p.id === "phase3"), data);
      }

      function handleError(error) {
        setLoading(false);
        console.error(error);
        const message = error && error.message ? error.message : "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
        showToast(message);
      }

      document.addEventListener("DOMContentLoaded", initialize);
    </script>
  </body>
</html>

<!-- ===== Upload_Bulk37.html ===== -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f7fa; }
    .container { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h3 { color: #667eea; margin-top: 0; }
    .upload-area { border: 3px dashed #667eea; border-radius: 12px; padding: 50px; text-align: center; margin: 20px 0; cursor: pointer; background: #f8f9ff; transition: 0.3s; }
    .upload-area:hover { border-color: #5568d3; background: #f0f2ff; }
    .upload-area.dragover { background: #e3e8ff; border-color: #4a5bbf; transform: scale(1.02); }
    #fileInput { display: none; }
    .button { background: #667eea; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; margin: 5px; transition: 0.3s; }
    .button:hover { background: #5568d3; }
    .button:disabled { background: #ccc; cursor: not-allowed; }
    .button-secondary { background: #6c757d; }
    .status { margin: 15px 0; padding: 12px; border-radius: 6px; display: none; font-weight: 500; }
    .status.success { background: #d1f2eb; color: #0f5132; display: block; }
    .status.error { background: #f8d7da; color: #842029; display: block; }
    .status.info { background: #cfe2ff; color: #084298; display: block; }
    .status.warning { background: #fff3cd; color: #856404; display: block; }
    .file-list { margin: 20px 0; max-height: 400px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 15px; }
    .file-item { padding: 10px; margin: 5px 0; background: white; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #667eea; }
    .file-name { font-weight: 500; color: #333; flex: 1; }
    .file-size { color: #666; font-size: 12px; margin: 0 10px; }
    .file-status { font-size: 12px; padding: 4px 8px; border-radius: 4px; }
    .file-status.waiting { background: #e9ecef; color: #6c757d; }
    .file-status.uploading { background: #cfe2ff; color: #084298; }
    .file-status.success { background: #d1f2eb; color: #0f5132; }
    .file-status.error { background: #f8d7da; color: #842029; }
    .progress-container { width: 100%; height: 30px; background: #e9ecef; border-radius: 15px; margin: 20px 0; overflow: hidden; display: none; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 500; }
    .summary { background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #667eea; }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
    .summary-item { text-align: center; padding: 10px; background: white; border-radius: 6px; }
    .summary-value { font-size: 24px; font-weight: bold; color: #667eea; }
    .summary-label { font-size: 12px; color: #666; margin-top: 5px; }
    .info-box { background: #fff3cd; padding: 12px; border-radius: 6px; margin: 15px 0; font-size: 14px; border-left: 4px solid #ffc107; }
  </style>
</head>
<body>
  <div class="container">
    <h3>âš¡ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆ37ãƒ•ã‚¡ã‚¤ãƒ«ä¸€æ‹¬å¯¾å¿œï¼‰</h3>

    <div class="info-box">
      ğŸ’¡ <strong>ä½¿ã„æ–¹</strong>: output_v2ãƒ•ã‚©ãƒ«ãƒ€å†…ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ37å€‹ï¼‰ã‚’é¸æŠã—ã¦ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚<br>
      ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã¯è‡ªå‹•ã§èªè­˜ã•ã‚Œã€é©åˆ‡ãªã‚·ãƒ¼ãƒˆã«æŒ¯ã‚Šåˆ†ã‘ã‚‰ã‚Œã¾ã™ã€‚
    </div>

    <div class="upload-area" id="uploadArea">
      <p style="font-size: 18px; margin: 10px 0;">ğŸ“ 37ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
      <p style="color: #666; font-size: 14px;">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
      <p style="color: #999; font-size: 12px; margin-top: 10px;">
        â€» Phase 1-10ã®å…¨CSVãƒ•ã‚¡ã‚¤ãƒ« + geocache.json<br>
        â€» Ctrl+Aã§å…¨é¸æŠã—ã¦ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
      </p>
    </div>

    <input type="file" id="fileInput" accept=".csv,.json" multiple/>

    <div id="summary" class="summary" style="display: none;">
      <strong>ğŸ“Š é¸æŠãƒ•ã‚¡ã‚¤ãƒ«ã‚µãƒãƒªãƒ¼</strong>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-value" id="totalFiles">0</div>
          <div class="summary-label">ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" id="totalSize">0 MB</div>
          <div class="summary-label">åˆè¨ˆã‚µã‚¤ã‚º</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" id="detectedPhases">0</div>
          <div class="summary-label">æ¤œå‡ºPhaseæ•°</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" id="uploadedCount">0</div>
          <div class="summary-label">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿</div>
        </div>
      </div>
    </div>

    <div class="file-list" id="fileList" style="display: none;"></div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div class="status" id="status"></div>

    <div style="text-align: center; margin-top: 20px;">
      <button class="button" id="uploadButton" disabled onclick="startBulkUpload()">ğŸ“¤ ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹</button>
      <button class="button button-secondary" onclick="clearAll()">ğŸ”„ ã‚¯ãƒªã‚¢</button>
      <button class="button button-secondary" onclick="google.script.host.close()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let selectedFiles = [];
let uploadedCount = 0;
let phaseMapping = {};

// ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰Phaseã¨ã‚·ãƒ¼ãƒˆåã‚’åˆ¤å®šï¼ˆPythonCSVImporter.gsã¨å®Œå…¨ä¸€è‡´ï¼‰
const FILE_MAPPING = {
  // Phase 1: åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ï¼ˆå¿…é ˆï¼‰
  'MapMetrics.csv': { phase: 1, sheet: 'MapMetrics', required: true },
  'Applicants.csv': { phase: 1, sheet: 'Applicants', required: true },
  'DesiredWork.csv': { phase: 1, sheet: 'DesiredWork', required: true },
  'AggDesired.csv': { phase: 1, sheet: 'AggDesired', required: true },
  'P1_QualityReport.csv': { phase: 1, sheet: 'P1_QualityReport', required: false },
  'QualityReport_Descriptive.csv': { phase: 1, sheet: 'P1_QualityDesc', required: false },

  // Phase 2: çµ±è¨ˆçš„æ¤œå®šçµæœ
  'ChiSquareTests.csv': { phase: 2, sheet: 'ChiSquareTests', required: false },
  'ANOVATests.csv': { phase: 2, sheet: 'ANOVATests', required: false },
  'P2_QualityReport_Inferential.csv': { phase: 2, sheet: 'P2_QualityInfer', required: false },

  // Phase 3: ãƒšãƒ«ã‚½ãƒŠåˆ†æçµæœ
  'PersonaSummary.csv': { phase: 3, sheet: 'PersonaSummary', required: false },
  'PersonaDetails.csv': { phase: 3, sheet: 'PersonaDetails', required: false },
  'P3_QualityReport_Inferential.csv': { phase: 3, sheet: 'P3_QualityInfer', required: false },

  // Phase 6: ãƒ•ãƒ­ãƒ¼ãƒ»è¿‘æ¥åˆ†æ
  'MunicipalityFlowEdges.csv': { phase: 6, sheet: 'Phase6_MunicipalityFlowEdges', required: false },
  'MunicipalityFlowNodes.csv': { phase: 6, sheet: 'Phase6_MunicipalityFlowNodes', required: false },
  'ProximityAnalysis.csv': { phase: 6, sheet: 'ProximityAnalysis', required: false },
  'P6_QualityReport_Inferential.csv': { phase: 6, sheet: 'P6_QualityInfer', required: false },

  // Phase 7: é«˜åº¦åˆ†æ
  'SupplyDensityMap.csv': { phase: 7, sheet: 'Phase7_SupplyDensity', required: false },
  'QualificationDistribution.csv': { phase: 7, sheet: 'Phase7_QualificationDist', required: false },
  'AgeGenderCrossAnalysis.csv': { phase: 7, sheet: 'Phase7_AgeGenderCross', required: false },
  'MobilityScore.csv': { phase: 7, sheet: 'Phase7_MobilityScore', required: false },
  'DetailedPersonaProfile.csv': { phase: 7, sheet: 'Phase7_PersonaProfile', required: false },
  'P7_QualityReport_Inferential.csv': { phase: 7, sheet: 'P7_QualityInfer', required: false },

  // Phase 8: ã‚­ãƒ£ãƒªã‚¢ãƒ»å­¦æ­´åˆ†æ
  'EducationDistribution.csv': { phase: 8, sheet: 'P8_EducationDist', required: false },
  'EducationAgeCross.csv': { phase: 8, sheet: 'P8_EduAgeCross', required: false },
  'EducationAgeCross_Matrix.csv': { phase: 8, sheet: 'P8_EduAgeMatrix', required: false },
  'GraduationYearDistribution.csv': { phase: 8, sheet: 'P8_GradYearDist', required: false },
  'P8_QualityReport.csv': { phase: 8, sheet: 'P8_QualityReport', required: false },
  'P8_QualityReport_Inferential.csv': { phase: 8, sheet: 'P8_QualityInfer', required: false },

  // Phase 10: è»¢è·æ„æ¬²ãƒ»ç·Šæ€¥åº¦åˆ†æ
  'UrgencyDistribution.csv': { phase: 10, sheet: 'P10_UrgencyDist', required: false },
  'UrgencyDistribution_ByMunicipality.csv': { phase: 10, sheet: 'P10_UrgencyDist_Muni', required: false },
  'UrgencyAgeCross.csv': { phase: 10, sheet: 'P10_UrgencyAge', required: false },
  'UrgencyAgeCross_ByMunicipality.csv': { phase: 10, sheet: 'P10_UrgencyAge_Muni', required: false },
  'UrgencyAgeCross_Matrix.csv': { phase: 10, sheet: 'P10_UrgencyAgeMatrix', required: false },
  'UrgencyEmploymentCross.csv': { phase: 10, sheet: 'P10_UrgencyEmp', required: false },
  'UrgencyEmploymentCross_Matrix.csv': { phase: 10, sheet: 'P10_UrgencyEmpMatrix', required: false },
  'UrgencyEmploymentCross_ByMunicipality.csv': { phase: 10, sheet: 'P10_UrgencyEmp_Muni', required: false },
  'UrgencyDesiredWorkCross.csv': { phase: 10, sheet: 'P10_UrgencyDesired', required: false },
  'P10_QualityReport.csv': { phase: 10, sheet: 'P10_QualityReport', required: false },
  'P10_QualityReport_Inferential.csv': { phase: 10, sheet: 'P10_QualityInfer', required: false },

  // Rootçµ±åˆå“è³ªãƒ¬ãƒãƒ¼ãƒˆ
  'OverallQualityReport.csv': { phase: 0, sheet: 'OverallQuality', required: false },
  'OverallQualityReport_Inferential.csv': { phase: 0, sheet: 'OverallQualityInfer', required: false },
  'geocache.json': { phase: 0, sheet: 'Geocache', required: false }
};

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.getElementById('uploadArea').addEventListener('click', () => {
  document.getElementById('fileInput').click();
});

document.getElementById('uploadArea').addEventListener('dragover', (e) => {
  e.preventDefault();
  e.target.classList.add('dragover');
});

document.getElementById('uploadArea').addEventListener('dragleave', (e) => {
  e.target.classList.remove('dragover');
});

document.getElementById('uploadArea').addEventListener('drop', (e) => {
  e.preventDefault();
  e.target.classList.remove('dragover');
  if (e.dataTransfer.files.length) {
    handleFiles(e.dataTransfer.files);
  }
});

document.getElementById('fileInput').addEventListener('change', (e) => {
  if (e.target.files.length) {
    handleFiles(e.target.files);
  }
});

// è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
function handleFiles(files) {
  selectedFiles = Array.from(files);

  if (selectedFiles.length === 0) {
    showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
    return;
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆè¡¨ç¤º
  displayFileList();

  // ã‚µãƒãƒªãƒ¼æ›´æ–°
  updateSummary();

  // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
  document.getElementById('uploadButton').disabled = false;

  showStatus(`${selectedFiles.length}ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸ`, 'info');
}

// ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆè¡¨ç¤º
function displayFileList() {
  const listEl = document.getElementById('fileList');
  listEl.innerHTML = '';
  listEl.style.display = 'block';

  phaseMapping = {};

  selectedFiles.forEach((file, index) => {
    const mapping = FILE_MAPPING[file.name];
    const phase = mapping ? mapping.phase : 'ä¸æ˜';
    const sheet = mapping ? mapping.sheet : 'æœªå¯¾å¿œ';

    if (mapping) {
      if (!phaseMapping[phase]) phaseMapping[phase] = [];
      phaseMapping[phase].push(file.name);
    }

    const item = document.createElement('div');
    item.className = 'file-item';
    item.id = `file-${index}`;

    const statusClass = mapping ? 'waiting' : 'error';
    const statusText = mapping ? 'å¾…æ©Ÿä¸­' : 'æœªå¯¾å¿œ';

    item.innerHTML = `
      <div class="file-name">${file.name}</div>
      <div class="file-size">${formatFileSize(file.size)}</div>
      <div class="file-status ${statusClass}" id="status-${index}">${statusText}</div>
    `;

    listEl.appendChild(item);
  });
}

// ã‚µãƒãƒªãƒ¼æ›´æ–°
function updateSummary() {
  const summaryEl = document.getElementById('summary');
  summaryEl.style.display = 'block';

  const totalSize = selectedFiles.reduce((sum, f) => sum + f.size, 0);
  const phases = Object.keys(phaseMapping).length;

  document.getElementById('totalFiles').textContent = selectedFiles.length;
  document.getElementById('totalSize').textContent = formatFileSize(totalSize);
  document.getElementById('detectedPhases').textContent = phases;
  document.getElementById('uploadedCount').textContent = uploadedCount;
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / 1024 / 1024).toFixed(1) + ' MB';
}

// ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹
async function startBulkUpload() {
  uploadedCount = 0;
  document.getElementById('uploadButton').disabled = true;
  document.getElementById('progressContainer').style.display = 'block';

  showStatus('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹...', 'info');

  for (let i = 0; i < selectedFiles.length; i++) {
    const file = selectedFiles[i];
    const mapping = FILE_MAPPING[file.name];

    if (!mapping) {
      updateFileStatus(i, 'error', 'ã‚¹ã‚­ãƒƒãƒ—');
      continue;
    }

    try {
      updateFileStatus(i, 'uploading', 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­');

      // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
      const content = await readFileContent(file);

      // GASå´ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      await uploadToGAS(file.name, mapping.sheet, content);

      updateFileStatus(i, 'success', 'å®Œäº†');
      uploadedCount++;

    } catch (error) {
      updateFileStatus(i, 'error', 'ã‚¨ãƒ©ãƒ¼');
      console.error(`${file.name} ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—:`, error);
    }

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
    const progress = ((i + 1) / selectedFiles.length * 100).toFixed(0);
    updateProgress(progress);
    document.getElementById('uploadedCount').textContent = uploadedCount;
  }

  // å®Œäº†
  showStatus(`âœ… ${uploadedCount}/${selectedFiles.length}ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼`, 'success');

  setTimeout(() => {
    google.script.host.close();
  }, 2000);
}

// ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹èª­ã¿è¾¼ã¿
function readFileContent(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = (e) => {
      resolve(e.target.result);
    };

    reader.onerror = (e) => {
      reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'));
    };

    if (file.name.endsWith('.json')) {
      reader.readAsText(file, 'UTF-8');
    } else {
      reader.readAsText(file, 'UTF-8');
    }
  });
}

// GASã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
function uploadToGAS(fileName, sheetName, content) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler((result) => {
        resolve(result);
      })
      .withFailureHandler((error) => {
        reject(error);
      })
      .importSingleCSVFromHTML(fileName, sheetName, content);
  });
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
function updateFileStatus(index, statusClass, statusText) {
  const statusEl = document.getElementById(`status-${index}`);
  if (statusEl) {
    statusEl.className = `file-status ${statusClass}`;
    statusEl.textContent = statusText;
  }
}

// ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
function updateProgress(percent) {
  const bar = document.getElementById('progressBar');
  bar.style.width = percent + '%';
  bar.textContent = percent + '%';
}

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
function showStatus(message, type) {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = 'status ' + type;
  status.style.display = 'block';
}

// ã‚¯ãƒªã‚¢
function clearAll() {
  selectedFiles = [];
  uploadedCount = 0;
  phaseMapping = {};

  document.getElementById('fileList').style.display = 'none';
  document.getElementById('summary').style.display = 'none';
  document.getElementById('progressContainer').style.display = 'none';
  document.getElementById('status').style.display = 'none';
  document.getElementById('uploadButton').disabled = true;
  document.getElementById('fileInput').value = '';
}
</script>
</body>
</html>

<!-- ===== Upload_Enhanced.html ===== -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <style>
    body{font-family:Arial,sans-serif;padding:20px}
    .upload-area{border:2px dashed #ccc;border-radius:4px;padding:30px;text-align:center;margin:20px 0;cursor:pointer}
    .upload-area:hover{border-color:#4285f4}
    .upload-area.dragover{background:#f5f7ff}
    #fileInput{display:none}
    .button{background:#4285f4;color:#fff;padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-size:14px;margin:5px}
    .button:disabled{background:#ccc;cursor:not-allowed}
    .button.secondary{background:#6c757d}
    .status{margin:10px 0;padding:10px;border-radius:4px;display:none}
    .status.success{background:#d4edda;color:#155724}
    .status.error{background:#f8d7da;color:#721c24}
    .status.info{background:#d1ecf1;color:#0c5460}
    .status.warning{background:#fff3cd;color:#856404}
    .file-info{margin:10px 0;padding:10px;background:#f5f5f5;border-radius:4px;display:none;font-size:14px}
    .progress-container{width:100%;height:30px;background:#f0f0f0;border-radius:15px;margin:20px 0;overflow:hidden;display:none}
    .progress-bar{height:100%;background:linear-gradient(90deg,#4285f4,#66a6ff);transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:white;font-size:14px}
    .analysis-results{margin:20px 0;padding:15px;background:#f8f9fa;border-radius:8px;display:none}
    .result-item{margin:10px 0;padding:8px;background:white;border-radius:4px;border-left:4px solid #4285f4}
    .tabs{display:flex;gap:10px;margin:20px 0}
    .tab{padding:8px 16px;background:#e0e0e0;border-radius:4px;cursor:pointer;transition:0.3s}
    .tab.active{background:#4285f4;color:white}
    .tab-content{display:none;margin:20px 0}
    .tab-content.active{display:block}
    h4{color:#333;margin-top:20px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:15px 0}
    .stat-card{padding:15px;background:white;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);text-align:center}
    .stat-value{font-size:24px;font-weight:bold;color:#4285f4}
    .stat-label{font-size:12px;color:#666;margin-top:5px}
  </style>
</head>
<body>
  <h3>ğŸš€ é«˜é€ŸCSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆPythonå‡¦ç†ã‚¨ãƒ³ã‚¸ãƒ³æ­è¼‰ï¼‰</h3>
  
  <div class="tabs">
    <div class="tab active" onclick="switchTab('import')">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
    <div class="tab" onclick="switchTab('analysis')">åˆ†æçµæœ</div>
    <div class="tab" onclick="switchTab('settings')">è¨­å®š</div>
  </div>
  
  <div class="tab-content active" id="import-tab">
    <div class="upload-area" id="uploadArea">
      <p>ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
    </div>
    <input type="file" id="fileInput" accept=".csv" multiple/>
    <div class="file-info" id="fileInfo"></div>
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>
    <div class="status" id="status"></div>
    
    <div style="text-align:center;margin-top:20px;">
      <button class="button" id="analyzeButton" disabled onclick="analyzeCSV()">ğŸ” é«˜é€Ÿåˆ†æ</button>
      <button class="button" id="importButton" disabled onclick="importToSheets()">ğŸ“Š ã‚·ãƒ¼ãƒˆã«å±•é–‹</button>
      <button class="button secondary" onclick="clearAll()">ğŸ”„ ã‚¯ãƒªã‚¢</button>
      <button class="button secondary" onclick="google.script.host.close()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  
  <div class="tab-content" id="analysis-tab">
    <div class="analysis-results" id="analysisResults">
      <h4>ğŸ“ˆ åˆ†æçµæœã‚µãƒãƒªãƒ¼</h4>
      <div class="stats-grid" id="statsGrid"></div>
      
      <h4>ğŸ¯ æ¤œå‡ºã•ã‚ŒãŸå¸Œæœ›å‹¤å‹™åœ°ã‚«ãƒ©ãƒ </h4>
      <div id="desiredColumns"></div>
      
      <h4>ğŸ“ å¸Œæœ›å‹¤å‹™åœ°TOP10</h4>
      <div id="topLocations"></div>
      
      <h4>ğŸ‘¥ äººå£çµ±è¨ˆ</h4>
      <div id="demographics"></div>
      
      <h4>ğŸ’¡ ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h4>
      <div id="insights"></div>
    </div>
  </div>
  
  <div class="tab-content" id="settings-tab">
    <h4>âš™ï¸ å‡¦ç†è¨­å®š</h4>
    <div class="result-item">
      <label><input type="checkbox" id="fullScan" checked> å…¨è¡Œã‚¹ã‚­ãƒ£ãƒ³ï¼ˆç²¾åº¦å„ªå…ˆï¼‰</label>
    </div>
    <div class="result-item">
      <label><input type="checkbox" id="autoGeocode"> è‡ªå‹•ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</label>
    </div>
    <div class="result-item">
      <label>ã‚µãƒ³ãƒ—ãƒ«è¡Œæ•°: <input type="number" id="sampleSize" value="1000" min="100" max="10000"></label>
    </div>
  </div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
var selectedFile = null;
var csvData = null;
var analysisResult = null;
var processedData = null;

// éƒ½é“åºœçœŒåº§æ¨™ãƒ‡ãƒ¼ã‚¿
const prefectureCoords = {
  'åŒ—æµ·é“': {lat: 43.0642, lng: 141.3469},
  'é’æ£®çœŒ': {lat: 40.8244, lng: 140.7400},
  'å²©æ‰‹çœŒ': {lat: 39.7036, lng: 141.1527},
  'å®®åŸçœŒ': {lat: 38.2682, lng: 140.8694},
  'ç§‹ç”°çœŒ': {lat: 39.7186, lng: 140.1024},
  'å±±å½¢çœŒ': {lat: 38.2405, lng: 140.3634},
  'ç¦å³¶çœŒ': {lat: 37.7503, lng: 140.4676},
  'èŒ¨åŸçœŒ': {lat: 36.3418, lng: 140.4468},
  'æ ƒæœ¨çœŒ': {lat: 36.5657, lng: 139.8836},
  'ç¾¤é¦¬çœŒ': {lat: 36.3907, lng: 139.0604},
  'åŸ¼ç‰çœŒ': {lat: 35.8570, lng: 139.6489},
  'åƒè‘‰çœŒ': {lat: 35.6050, lng: 140.1233},
  'æ±äº¬éƒ½': {lat: 35.6762, lng: 139.6503},
  'ç¥å¥ˆå·çœŒ': {lat: 35.4478, lng: 139.6425},
  'æ–°æ½ŸçœŒ': {lat: 37.9022, lng: 139.0235},
  'å¯Œå±±çœŒ': {lat: 36.6953, lng: 137.2113},
  'çŸ³å·çœŒ': {lat: 36.5946, lng: 136.6256},
  'ç¦äº•çœŒ': {lat: 36.0652, lng: 136.2216},
  'å±±æ¢¨çœŒ': {lat: 35.6640, lng: 138.5684},
  'é•·é‡çœŒ': {lat: 36.6513, lng: 138.1810},
  'å²é˜œçœŒ': {lat: 35.3912, lng: 136.7223},
  'é™å²¡çœŒ': {lat: 34.9769, lng: 138.3831},
  'æ„›çŸ¥çœŒ': {lat: 35.1802, lng: 136.9066},
  'ä¸‰é‡çœŒ': {lat: 34.7303, lng: 136.5086},
  'æ»‹è³€çœŒ': {lat: 35.0045, lng: 135.8685},
  'äº¬éƒ½åºœ': {lat: 35.0116, lng: 135.7681},
  'å¤§é˜ªåºœ': {lat: 34.6862, lng: 135.5200},
  'å…µåº«çœŒ': {lat: 34.6913, lng: 135.1830},
  'å¥ˆè‰¯çœŒ': {lat: 34.6851, lng: 135.8327},
  'å’Œæ­Œå±±çœŒ': {lat: 34.2260, lng: 135.1675},
  'é³¥å–çœŒ': {lat: 35.5039, lng: 134.2378},
  'å³¶æ ¹çœŒ': {lat: 35.4723, lng: 133.0505},
  'å²¡å±±çœŒ': {lat: 34.6618, lng: 133.9345},
  'åºƒå³¶çœŒ': {lat: 34.3966, lng: 132.4596},
  'å±±å£çœŒ': {lat: 34.1860, lng: 131.4705},
  'å¾³å³¶çœŒ': {lat: 34.0658, lng: 134.5593},
  'é¦™å·çœŒ': {lat: 34.3401, lng: 134.0434},
  'æ„›åª›çœŒ': {lat: 33.8416, lng: 132.7658},
  'é«˜çŸ¥çœŒ': {lat: 33.5597, lng: 133.5311},
  'ç¦å²¡çœŒ': {lat: 33.6064, lng: 130.4183},
  'ä½è³€çœŒ': {lat: 33.2494, lng: 130.2988},
  'é•·å´çœŒ': {lat: 32.7448, lng: 129.8737},
  'ç†Šæœ¬çœŒ': {lat: 32.7898, lng: 130.7417},
  'å¤§åˆ†çœŒ': {lat: 33.2382, lng: 131.6126},
  'å®®å´çœŒ': {lat: 31.9111, lng: 131.4239},
  'é¹¿å…å³¶çœŒ': {lat: 31.5602, lng: 130.5581},
  'æ²–ç¸„çœŒ': {lat: 26.2124, lng: 127.6809}
};

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.getElementById('uploadArea').addEventListener('click', () => {
  document.getElementById('fileInput').click();
});

document.getElementById('uploadArea').addEventListener('dragover', (e) => {
  e.preventDefault();
  e.target.classList.add('dragover');
});

document.getElementById('uploadArea').addEventListener('dragleave', (e) => {
  e.target.classList.remove('dragover');
});

document.getElementById('uploadArea').addEventListener('drop', (e) => {
  e.preventDefault();
  e.target.classList.remove('dragover');
  if (e.dataTransfer.files.length) {
    handleFile(e.dataTransfer.files[0]);
  }
});

document.getElementById('fileInput').addEventListener('change', (e) => {
  if (e.target.files.length) {
    handleFile(e.target.files[0]);
  }
});

// ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
function handleFile(file) {
  if (!file.name.endsWith('.csv')) {
    showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    return;
  }
  
  selectedFile = file;
  document.getElementById('fileInfo').textContent = 
    `ğŸ“„ ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
  document.getElementById('fileInfo').style.display = 'block';
  document.getElementById('analyzeButton').disabled = false;
  showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸ', 'info');
}

// CSVåˆ†æï¼ˆPythonãƒ­ã‚¸ãƒƒã‚¯ã®ç§»æ¤ï¼‰
async function analyzeCSV() {
  if (!selectedFile) return;
  
  showStatus('åˆ†æã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...', 'info');
  showProgress(0);
  
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      // CSVãƒ‘ãƒ¼ã‚¹
      csvData = parseCSV(e.target.result);
      showProgress(20);
      
      // ã‚«ãƒ©ãƒ æ¤œå‡º
      analysisResult = await detectColumns(csvData);
      showProgress(40);
      
      // ãƒ‡ãƒ¼ã‚¿å‡¦ç†
      processedData = await processData(csvData, analysisResult);
      showProgress(60);
      
      // çµ±è¨ˆåˆ†æ
      const stats = await analyzeStatistics(processedData);
      showProgress(80);
      
      // çµæœè¡¨ç¤º
      displayAnalysisResults(analysisResult, stats);
      showProgress(100);
      
      showStatus('åˆ†æå®Œäº†ï¼ã€Œã‚·ãƒ¼ãƒˆã«å±•é–‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜ã§ãã¾ã™', 'success');
      document.getElementById('importButton').disabled = false;
      
      // åˆ†æã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
      switchTab('analysis');
      
    } catch (error) {
      showStatus('åˆ†æã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      console.error(error);
    }
  };
  
  reader.readAsText(selectedFile, 'UTF-8');
}

// CSVãƒ‘ãƒ¼ã‚¹
function parseCSV(text) {
  const lines = text.split(/\r?\n/);
  const result = [];
  
  for (let line of lines) {
    if (line.trim()) {
      // ç°¡æ˜“CSVãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
      const row = line.split(',').map(cell => cell.trim());
      result.push(row);
    }
  }
  
  return result;
}

// ã‚«ãƒ©ãƒ æ¤œå‡ºï¼ˆPythonãƒ­ã‚¸ãƒƒã‚¯ç§»æ¤ï¼‰
async function detectColumns(data) {
  const headers = data[0];
  const dataRows = headers[0].includes('u-fw-bold') ? data.slice(1) : data;
  
  const result = {
    headers: headers,
    hasHTMLHeaders: headers[0].includes('u-fw-bold'),
    desiredColumns: [],
    totalRows: dataRows.length,
    totalColumns: headers.length
  };
  
  // o-line__itemã‚«ãƒ©ãƒ ã®æ¤œå‡º
  const oLineItems = [];
  headers.forEach((header, idx) => {
    if (header.includes('o-line__item')) {
      oLineItems.push(idx);
    }
  });
  
  showStatus(`${oLineItems.length}å€‹ã® o-line__item ã‚«ãƒ©ãƒ ã‚’æ¤œå‡ºä¸­...`, 'info');
  
  // å…¨è¡Œã‚¹ã‚­ãƒ£ãƒ³ã¾ãŸã¯ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
  const fullScan = document.getElementById('fullScan').checked;
  const sampleSize = fullScan ? dataRows.length : 
                     Math.min(parseInt(document.getElementById('sampleSize').value), dataRows.length);
  
  // å¸Œæœ›å‹¤å‹™åœ°ã‚«ãƒ©ãƒ ã®åˆ¤å®š
  for (let colIdx of oLineItems) {
    if (colIdx === 3 || colIdx >= 13) {
      let addressCount = 0;
      const checkRows = Math.min(sampleSize, dataRows.length);
      
      for (let i = 0; i < checkRows; i++) {
        if (dataRows[i][colIdx]) {
          const val = String(dataRows[i][colIdx]);
          // éƒ½é“åºœçœŒãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
          if (/[éƒ½é“åºœçœŒ].+[å¸‚åŒºç”ºæ‘]/.test(val)) {
            addressCount++;
          }
        }
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
        if (i % 100 === 0) {
          const progress = 20 + (20 * (oLineItems.indexOf(colIdx) + 1) / oLineItems.length);
          showProgress(progress);
        }
      }
      
      // 0.1%ä»¥ä¸Šã§æ¡ç”¨ï¼ˆã‚¹ãƒ‘ãƒ¼ã‚¹å¯¾å¿œï¼‰
      if (addressCount > checkRows * 0.001) {
        result.desiredColumns.push({
          index: colIdx,
          count: addressCount,
          ratio: (addressCount / checkRows * 100).toFixed(2)
        });
      }
    }
  }
  
  return result;
}

// ãƒ‡ãƒ¼ã‚¿å‡¦ç†
async function processData(data, analysis) {
  const processedRows = [];
  const dataRows = analysis.hasHTMLHeaders ? data.slice(1) : data;
  const locationCounts = {};
  
  for (let i = 0; i < dataRows.length; i++) {
    const row = dataRows[i];
    const processed = {
      id: i + 1,
      age: null,
      gender: null,
      residence: null,
      desiredLocations: []
    };
    
    // å¹´é½¢ãƒ»æ€§åˆ¥ã®æŠ½å‡ºï¼ˆ3åˆ—ç›®ã¨ä»®å®šï¼‰
    if (row[2]) {
      const ageGenderMatch = row[2].match(/(\d+)æ­³.*([ç”·å¥³])æ€§/);
      if (ageGenderMatch) {
        processed.age = parseInt(ageGenderMatch[1]);
        processed.gender = ageGenderMatch[2] === 'ç”·' ? 'ç”·æ€§' : 'å¥³æ€§';
      }
    }
    
    // å±…ä½åœ°ï¼ˆ2åˆ—ç›®ã¨ä»®å®šï¼‰
    if (row[1]) {
      processed.residence = extractPrefecture(row[1]);
    }
    
    // å¸Œæœ›å‹¤å‹™åœ°ã®æŠ½å‡º
    for (let colInfo of analysis.desiredColumns) {
      if (row[colInfo.index]) {
        const pref = extractPrefecture(row[colInfo.index]);
        if (pref) {
          processed.desiredLocations.push(pref);
          locationCounts[pref] = (locationCounts[pref] || 0) + 1;
        }
      }
    }
    
    processedRows.push(processed);
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
    if (i % 100 === 0) {
      showProgress(60 + (20 * i / dataRows.length));
    }
  }
  
  return {
    rows: processedRows,
    locationCounts: locationCounts
  };
}

// éƒ½é“åºœçœŒæŠ½å‡º
function extractPrefecture(address) {
  if (!address) return null;
  
  const prefectures = Object.keys(prefectureCoords);
  for (let pref of prefectures) {
    if (address.includes(pref)) {
      return pref;
    }
  }
  return null;
}

// çµ±è¨ˆåˆ†æ
async function analyzeStatistics(data) {
  const stats = {
    totalApplicants: data.rows.length,
    avgAge: 0,
    genderRatio: {},
    topLocations: [],
    insights: []
  };
  
  // å¹´é½¢çµ±è¨ˆ
  const ages = data.rows.map(r => r.age).filter(a => a);
  if (ages.length > 0) {
    stats.avgAge = (ages.reduce((a, b) => a + b, 0) / ages.length).toFixed(1);
  }
  
  // æ€§åˆ¥çµ±è¨ˆ
  const genders = data.rows.map(r => r.gender).filter(g => g);
  stats.genderRatio = {
    male: genders.filter(g => g === 'ç”·æ€§').length,
    female: genders.filter(g => g === 'å¥³æ€§').length
  };
  
  // TOP10å¸Œæœ›å‹¤å‹™åœ°
  const sorted = Object.entries(data.locationCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);
  stats.topLocations = sorted.map(([pref, count]) => ({pref, count}));
  
  // ã‚¤ãƒ³ã‚µã‚¤ãƒˆç”Ÿæˆ
  if (stats.topLocations.length > 0) {
    const topPref = stats.topLocations[0];
    const concentration = (topPref.count / data.rows.length * 100).toFixed(1);
    if (concentration > 20) {
      stats.insights.push({
        type: 'concentration',
        message: `${topPref.pref}ã¸ã®é›†ä¸­å‚¾å‘ï¼ˆ${concentration}%ï¼‰ãŒè¦‹ã‚‰ã‚Œã¾ã™`
      });
    }
  }
  
  if (stats.avgAge > 45) {
    stats.insights.push({
      type: 'age',
      message: `å¹³å‡å¹´é½¢${stats.avgAge}æ­³ã€‚ä¸­é«˜å¹´å±¤ãŒä¸»åŠ›ã§ã™`
    });
  }
  
  return stats;
}

// åˆ†æçµæœè¡¨ç¤º
function displayAnalysisResults(analysis, stats) {
  // çµ±è¨ˆã‚°ãƒªãƒƒãƒ‰
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${stats.totalApplicants.toLocaleString()}</div>
      <div class="stat-label">ç·æ±‚è·è€…æ•°</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${analysis.desiredColumns.length}</div>
      <div class="stat-label">å¸Œæœ›å‹¤å‹™åœ°ã‚«ãƒ©ãƒ </div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.avgAge || '-'}</div>
      <div class="stat-label">å¹³å‡å¹´é½¢</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.genderRatio.male || 0}/${stats.genderRatio.female || 0}</div>
      <div class="stat-label">ç”·æ€§/å¥³æ€§</div>
    </div>
  `;
  
  // å¸Œæœ›å‹¤å‹™åœ°ã‚«ãƒ©ãƒ 
  let columnsHTML = '<div style="max-height:200px;overflow-y:auto;">';
  analysis.desiredColumns.forEach(col => {
    columnsHTML += `<div class="result-item">åˆ—${col.index}: ${col.count}ä»¶ (${col.ratio}%)</div>`;
  });
  columnsHTML += '</div>';
  document.getElementById('desiredColumns').innerHTML = columnsHTML;
  
  // TOP10å¸Œæœ›å‹¤å‹™åœ°
  let locationsHTML = '';
  stats.topLocations.forEach((loc, idx) => {
    locationsHTML += `<div class="result-item">${idx + 1}. ${loc.pref}: ${loc.count}äºº</div>`;
  });
  document.getElementById('topLocations').innerHTML = locationsHTML;
  
  // ã‚¤ãƒ³ã‚µã‚¤ãƒˆ
  let insightsHTML = '';
  stats.insights.forEach(insight => {
    insightsHTML += `<div class="result-item">ğŸ’¡ ${insight.message}</div>`;
  });
  document.getElementById('insights').innerHTML = insightsHTML || '<div class="result-item">ãƒ‡ãƒ¼ã‚¿åˆ†æä¸­...</div>';
  
  document.getElementById('analysisResults').style.display = 'block';
}

// ã‚·ãƒ¼ãƒˆã¸ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
function importToSheets() {
  if (!processedData) {
    showStatus('å…ˆã«åˆ†æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'warning');
    return;
  }
  
  showStatus('ã‚·ãƒ¼ãƒˆã«å±•é–‹ä¸­...', 'info');
  
  // GASå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
  const mapMetrics = prepareMapMetrics(processedData);
  const applicants = prepareApplicants(processedData);
  const desiredWork = prepareDesiredWork(processedData);
  
  // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
  google.script.run
    .withSuccessHandler((result) => {
      showStatus('ã‚·ãƒ¼ãƒˆã¸ã®å±•é–‹ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
      setTimeout(() => {
        google.script.host.close();
      }, 2000);
    })
    .withFailureHandler((error) => {
      showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    })
    .importProcessedData({
      mapMetrics: mapMetrics,
      applicants: applicants,
      desiredWork: desiredWork,
      metadata: {
        fileName: selectedFile.name,
        processedAt: new Date().toISOString(),
        totalRows: processedData.rows.length,
        desiredColumns: analysisResult.desiredColumns.length
      }
    });
}

// MapMetricsãƒ‡ãƒ¼ã‚¿æº–å‚™
function prepareMapMetrics(data) {
  const metrics = [];
  
  Object.entries(data.locationCounts).forEach(([pref, count]) => {
    if (prefectureCoords[pref]) {
      metrics.push([
        pref,
        '',  // å¸‚åŒºç”ºæ‘
        pref,  // ã‚­ãƒ¼
        count,
        prefectureCoords[pref].lat,
        prefectureCoords[pref].lng
      ]);
    }
  });
  
  return metrics;
}

// Applicantsãƒ‡ãƒ¼ã‚¿æº–å‚™
function prepareApplicants(data) {
  return data.rows.map(row => [
    'ID_' + row.id,
    row.gender || '',
    row.age || '',
    getAgeBucket(row.age),
    row.residence || '',
    ''  // å¸‚åŒºç”ºæ‘
  ]);
}

// DesiredWorkãƒ‡ãƒ¼ã‚¿æº–å‚™
function prepareDesiredWork(data) {
  const desired = [];
  
  data.rows.forEach(row => {
    row.desiredLocations.forEach(loc => {
      desired.push([
        'ID_' + row.id,
        loc,
        '',  // å¸‚åŒºç”ºæ‘
        loc  // ã‚­ãƒ¼
      ]);
    });
  });
  
  return desired;
}

// å¹´é½¢ãƒã‚±ãƒƒãƒˆ
function getAgeBucket(age) {
  if (!age) return '';
  if (age < 30) return '20ä»£';
  if (age < 40) return '30ä»£';
  if (age < 50) return '40ä»£';
  if (age < 60) return '50ä»£';
  if (age < 70) return '60ä»£';
  return '70ä»£ä»¥ä¸Š';
}

// UIé–¢æ•°
function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  
  event.target.classList.add('active');
  document.getElementById(tabName + '-tab').classList.add('active');
}

function showStatus(message, type) {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = 'status ' + type;
  status.style.display = 'block';
}

function showProgress(percent) {
  const container = document.getElementById('progressContainer');
  const bar = document.getElementById('progressBar');
  
  container.style.display = 'block';
  bar.style.width = percent + '%';
  bar.textContent = Math.round(percent) + '%';
}

function clearAll() {
  selectedFile = null;
  csvData = null;
  analysisResult = null;
  processedData = null;
  
  document.getElementById('fileInfo').style.display = 'none';
  document.getElementById('progressContainer').style.display = 'none';
  document.getElementById('status').style.display = 'none';
  document.getElementById('analysisResults').style.display = 'none';
  document.getElementById('analyzeButton').disabled = true;
  document.getElementById('importButton').disabled = true;
  
  switchTab('import');
}
</script>
</body>
</html>
