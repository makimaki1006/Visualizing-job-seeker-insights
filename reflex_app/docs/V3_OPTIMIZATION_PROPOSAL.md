# V3データ最適化提案

**作成日**: 2025年11月21日
**目的**: データベース行数を抑えつつ、ユーザー要件を満たす最小限のV3拡張設計

---

## 現状分析

### 現在のV3 CSV

| 項目 | 値 |
|------|------|
| 総行数 | 17,631行 |
| カラム数 | 36カラム |
| row_type数 | 12種類 |
| ファイルサイズ | 約2.5MB |

### row_type別分布

| row_type | 行数 | 割合 | UI実装状況 |
|----------|------|------|-----------|
| RARITY | 4,950行 | 28.1% | 4グラフ（希少人材タブ）|
| AGE_GENDER | 4,231行 | 24.0% | 3要素（年齢・性別タブ）|
| URGENCY_AGE | 2,942行 | 16.7% | 1グラフ（緊急度タブ）|
| URGENCY_EMPLOYMENT | 1,666行 | 9.4% | 1グラフ（緊急度タブ）|
| GAP | 966行 | 5.5% | 6要素（需給バランスタブ）|
| **FLOW** | **966行** | **5.5%** | **❌ 完全未使用** |
| **COMPETITION** | **966行** | **5.5%** | **⚠️ 1グラフのみ（薄い）** |
| SUMMARY | 944行 | 5.4% | 4KPI + 2グラフ（概要タブ）|
| その他 | 他 | - | - |

**実装率**: 21/67機能 (31%)

---

## 削減提案

### オプション1: FLOW完全削除

**削減**: -966行 (-5.5%)
**影響**: なし（完全未使用）
**推奨**: ✅ **実施推奨**

### オプション2: COMPETITION削除

**削減**: -966行 (-5.5%)
**影響**: 1グラフ（性別分布）が削除される
**代替案**: 性別分布は他のタブ（概要タブ）で代替可能
**推奨**: ✅ **実施推奨**

### 削減合計

```
現在: 17,631行
削減: -1,932行 (-11.0%)
削減後: 15,699行 (89.0%)
```

**余裕**: 約2,000行の削減により、新機能追加のための余裕を確保

---

## ユーザー要件（未実装5機能）

### 抽象度高い要件

**「どの地域にどのような人がいるのか」**

### 具体的な5機能

1. **資格詳細分析**
   - どんな資格を持っている人がいるのか？
   - その人たちの年齢・性別分布は？
   - 要求データ: 個別資格名（"介護福祉士"、"喀痰吸引"等）

2. **学歴詳細分析**
   - どんな学歴を持っている人がいるのか？
   - その人たちの年齢・性別分布は？
   - 要求データ: 学歴種別（"専門学校"、"高校"、"大学"等）

3. **希望地域複数選択パターン**
   - プルダウンで選択した市町村を希望している人は、他にどこを希望しているのか？
   - その人たちの年齢・性別分布は？
   - 要求データ: 併願市町村リスト

4. **居住地→希望地フロー**
   - プルダウンで選択した市町村を希望している人は、どこに住んでいるのか？
   - その人たちの年齢・性別分布は？
   - 要求データ: 居住市町村 → 希望市町村のフロー

5. **通勤距離許容度**
   - プルダウンで選択した市町村を希望している人は、どの程度の通勤距離を許容しているのか？
   - 年齢・性別ごとの差はあるのか？
   - 要求データ: 居住地→希望地の距離（km）

---

## 新row_type設計（最小限）

### 方針

- **Top N制限**: 全データではなくTop 20/30のみ保持（行数削減）
- **市町村レベル集計**: 都道府県レベルは除外（既存データで代替）
- **必須カラムのみ**: prefecture, municipality, category1-3, count, その他最小限

### 1. QUALIFICATION_DETAIL（資格詳細）

**目的**: 個別資格名×年齢×性別クロス分析

**カラム構成**:
```csv
row_type,prefecture,municipality,category1,category2,category3,count,avg_age,national_license_rate
QUALIFICATION_DETAIL,京都府,京都市,介護福祉士,50代,女性,120,52.3,1.0
```

| カラム | 説明 | 例 |
|--------|------|-----|
| row_type | 固定値 | QUALIFICATION_DETAIL |
| prefecture | 都道府県 | 京都府 |
| municipality | 市区町村 | 京都市 |
| category1 | 資格名 | 介護福祉士 |
| category2 | 年齢層 | 50代 |
| category3 | 性別 | 女性 |
| count | 人数 | 120 |
| avg_age | 平均年齢 | 52.3 |
| national_license_rate | 国家資格保有率 | 1.0 |

**行数見積もり**:
- 市町村数: 約100
- 資格種別（Top 20のみ）: 20種類
- 年齢層: 6種類（20代、30代、40代、50代、60代、70代以上）
- 性別: 2種類
- 計算: 100 × 20 × 6 × 2 = **24,000行**

**行数削減策**:
- **Top 10に制限**: 100 × 10 × 6 × 2 = **12,000行**
- **都道府県レベルのみ**: 47 × 20 × 6 × 2 = **11,280行**

**推奨**: Top 10制限 → **12,000行**

---

### 2. EDUCATION_DETAIL（学歴詳細）

**目的**: 学歴種別×年齢×性別クロス分析

**カラム構成**:
```csv
row_type,prefecture,municipality,category1,category2,category3,count,avg_age,graduation_year_avg
EDUCATION_DETAIL,京都府,京都市,専門学校,40代,女性,80,42.5,2002
```

| カラム | 説明 | 例 |
|--------|------|-----|
| category1 | 学歴種別 | 専門学校、高校、大学、大学院 |
| category2 | 年齢層 | 40代 |
| category3 | 性別 | 女性 |
| graduation_year_avg | 平均卒業年 | 2002 |

**行数見積もり**:
- 市町村数: 約100
- 学歴種別: 5種類（専門学校、高校、大学、大学院、その他）
- 年齢層: 6種類
- 性別: 2種類
- 計算: 100 × 5 × 6 × 2 = **6,000行**

**推奨**: そのまま → **6,000行**

---

### 3. DESIRED_AREA_PATTERN（希望地域パターン）

**目的**: 併願市町村分析

**カラム構成**:
```csv
row_type,prefecture,municipality,category1,category2,category3,count,avg_age,avg_desired_areas
DESIRED_AREA_PATTERN,京都府,京都市,大阪市,50代,女性,45,52.0,3.2
```

| カラム | 説明 | 例 |
|--------|------|-----|
| category1 | 併願市町村 | 大阪市 |
| category2 | 年齢層 | 50代 |
| category3 | 性別 | 女性 |
| avg_desired_areas | 平均希望地域数 | 3.2 |

**行数見積もり**:
- 市町村数: 約100
- 併願先（Top 20のみ）: 20市町村
- 年齢層: 6種類
- 性別: 2種類
- 計算: 100 × 20 × 6 × 2 = **24,000行**

**行数削減策**:
- **Top 10に制限**: 100 × 10 × 6 × 2 = **12,000行**

**推奨**: Top 10制限 → **12,000行**

---

### 4. RESIDENCE_FLOW（居住地→希望地フロー）

**目的**: 居住市町村からの流入分析

**カラム構成**:
```csv
row_type,prefecture,municipality,category1,category2,category3,count,avg_age,avg_distance_km
RESIDENCE_FLOW,京都府,京都市,大阪府大阪市,50代,女性,35,51.5,62.3
```

| カラム | 説明 | 例 |
|--------|------|-----|
| category1 | 居住地（都道府県+市町村） | 大阪府大阪市 |
| category2 | 年齢層 | 50代 |
| category3 | 性別 | 女性 |
| avg_distance_km | 平均距離（km） | 62.3 |

**行数見積もり**:
- 市町村数: 約100
- 居住地（Top 20のみ）: 20市町村
- 年齢層: 6種類
- 性別: 2種類
- 計算: 100 × 20 × 6 × 2 = **24,000行**

**行数削減策**:
- **Top 10に制限**: 100 × 10 × 6 × 2 = **12,000行**

**推奨**: Top 10制限 → **12,000行**

---

### 5. COMMUTE_TOLERANCE（通勤距離許容度）

**目的**: 距離帯別の通勤許容度分析

**カラム構成**:
```csv
row_type,prefecture,municipality,category1,category2,category3,count,avg_distance_km
COMMUTE_TOLERANCE,京都府,京都市,10-20km,50代,女性,25,15.3
```

| カラム | 説明 | 例 |
|--------|------|-----|
| category1 | 距離帯 | 0-10km、10-20km、20-50km、50km以上 |
| category2 | 年齢層 | 50代 |
| category3 | 性別 | 女性 |
| avg_distance_km | 平均距離 | 15.3 |

**行数見積もり**:
- 市町村数: 約100
- 距離帯: 4種類
- 年齢層: 6種類
- 性別: 2種類
- 計算: 100 × 4 × 6 × 2 = **4,800行**

**推奨**: そのまま → **4,800行**

---

## 最終行数見積もり

### 削減

| 項目 | 行数 |
|------|------|
| 現在のV3 CSV | 17,631行 |
| 削減: FLOW | -966行 |
| 削減: COMPETITION | -966行 |
| **削減後** | **15,699行** |

### 追加（最小限設計）

| row_type | 行数 |
|----------|------|
| QUALIFICATION_DETAIL | 12,000行 |
| EDUCATION_DETAIL | 6,000行 |
| DESIRED_AREA_PATTERN | 12,000行 |
| RESIDENCE_FLOW | 12,000行 |
| COMMUTE_TOLERANCE | 4,800行 |
| **追加合計** | **46,800行** |

### 最終合計

```
削減後: 15,699行
追加: +46,800行
最終: 62,499行 (現在の3.5倍)
```

**データベース負荷**: 17,631行 → 62,499行 (+254%)

---

## 代替案: 超圧縮版

### 方針

- **都道府県レベルのみ**（市町村レベル削除）
- **Top 5制限**（Top 10ではなくTop 5）
- **年齢層統合**（6種類→3種類: 若年、中年、高齢）

### 行数再計算

| row_type | 通常版 | 超圧縮版 |
|----------|--------|----------|
| QUALIFICATION_DETAIL | 12,000行 | **2,820行** (47都道府県 × 20資格 × 3年齢 × 2性別 × 0.5) |
| EDUCATION_DETAIL | 6,000行 | **1,410行** (47 × 5学歴 × 3 × 2) |
| DESIRED_AREA_PATTERN | 12,000行 | **2,820行** (47 × 20併願 × 3 × 2 × 0.5) |
| RESIDENCE_FLOW | 12,000行 | **2,820行** (47 × 20居住 × 3 × 2 × 0.5) |
| COMMUTE_TOLERANCE | 4,800行 | **2,256行** (47 × 4距離 × 3 × 2 × 2) |
| **追加合計** | 46,800行 | **12,126行** |

### 最終合計（超圧縮版）

```
削減後: 15,699行
追加: +12,126行
最終: 27,825行 (現在の1.58倍)
```

**データベース負荷**: 17,631行 → 27,825行 (+58%)

---

## 推奨案

### オプションA: 通常版（市町村レベル）

**メリット**:
- ✅ 市町村レベルの詳細分析が可能
- ✅ ユーザー要件を100%満たす

**デメリット**:
- ❌ 行数3.5倍増加（62,499行）
- ❌ データベース負荷が高い

### オプションB: 超圧縮版（都道府県レベル）

**メリット**:
- ✅ 行数1.58倍増加（27,825行）
- ✅ データベース負荷が低い

**デメリット**:
- ❌ 市町村レベルの詳細が失われる
- ⚠️ ユーザー要件を70%程度満たす

### オプションC: ハイブリッド版（推奨）

**方針**:
- 重要なrow_type（QUALIFICATION_DETAIL、RESIDENCE_FLOW）は**市町村レベル**
- 補助的なrow_type（EDUCATION_DETAIL、COMMUTE_TOLERANCE）は**都道府県レベル**
- DESIRED_AREA_PATTERNは**Top 5制限**

**行数計算**:

| row_type | レベル | 行数 |
|----------|--------|------|
| QUALIFICATION_DETAIL | 市町村（Top 10） | 12,000行 |
| EDUCATION_DETAIL | **都道府県** | **1,410行** |
| DESIRED_AREA_PATTERN | 市町村（**Top 5**） | **6,000行** |
| RESIDENCE_FLOW | 市町村（Top 10） | 12,000行 |
| COMMUTE_TOLERANCE | **都道府県** | **2,256行** |
| **追加合計** | - | **33,666行** |

**最終合計（ハイブリッド版）**:

```
削減後: 15,699行
追加: +33,666行
最終: 49,365行 (現在の2.8倍)
```

**データベース負荷**: 17,631行 → 49,365行 (+180%)

---

## 次のステップ

### 質問事項

1. **行数増加の許容範囲**
   - オプションA: +254% (62,499行)
   - オプションB: +58% (27,825行)
   - オプションC: +180% (49,365行) ← 推奨
   - どれを選択しますか？

2. **削減の承認**
   - FLOW row_type（966行）を削除してよいか？
   - COMPETITION row_type（966行）を削除してよいか？

3. **タブ構成**
   - 現在7タブ → 何タブに削減すべきか？（推奨: 3-5タブ）

### 実装順序（オプションC推奨の場合）

1. **Python側（Phase 15-19追加）**: 2-3日
   - run_complete_v2_perfect.pyに5つの新Phase追加
   - 最小限データ生成（Top 10制限、都道府県/市町村ハイブリッド）

2. **V3統合側（generate_mapcomplete_complete_sheets.py修正）**: 半日
   - FLOW、COMPETITION削除
   - 新5種類のrow_type読み込み

3. **Reflexアプリ側（受け入れ準備）**: 2-3日
   - 新row_type対応
   - タブ削減・統合
   - State計算プロパティ追加（約15個）

**合計工数**: 5-7日

---

## まとめ

**推奨**: オプションC（ハイブリッド版）

- 削減: -1,932行（FLOW、COMPETITION削除）
- 追加: +33,666行（5つの新row_type）
- 最終: 49,365行（現在の2.8倍、+180%）

**メリット**:
- ✅ ユーザー要件を90%満たす
- ✅ 行数増加を2.8倍に抑制（通常版3.5倍より軽量）
- ✅ 重要機能（資格、居住地フロー）は市町村レベル詳細維持

**デメリット**:
- ⚠️ 学歴・通勤距離は都道府県レベルのみ（詳細度が下がる）

**次のアクション**: ユーザー承認後、実装開始

