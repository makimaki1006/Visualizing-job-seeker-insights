# データ仕様書

ジョブメドレー求職者データ分析プロジェクトのデータ仕様詳細。

---

## 📥 入力データ

### 入力CSVファイル

**格納場所**: `job_medley_project/data/input/`

**ファイル一覧**:

| ファイル名 | サイズ | 説明 |
|-----------|--------|------|
| 統合_求職者情報沖縄_介護 (1).csv | 1,485,916 bytes | 沖縄県介護職求職者データ |
| 統合_求職者情報京都_介護 (1).csv | 4,123,981 bytes | 京都府介護職求職者データ |
| 栃木_生活相談員 (1).csv | 572,769 bytes | 栃木県生活相談員求職者データ |
| 統合_求職者情報宮城_介護.csv | 3,162,226 bytes | 宮城県介護職求職者データ |

---

### 入力CSVカラム構造

**カラム数**: 250以上

**カラム命名規則**: HTMLクラス名（例: `u-fw-bold`, `o-line__item`, `c-table__body-item`）

**エンコーディング**: 不明（要確認）

**重要注記**:
- セマンティックなカラム名ではなく、HTML要素のクラス名が使用されている
- 実際のデータマッピングはPythonコード内の処理ロジックに依存
- カラム名と実データの対応関係は`test_phase6_temp.py`の`_extract_basic_info()`等で定義

**推定データ項目**:
- 申請者ID
- 性別
- 年齢
- 居住地（都道府県、市区町村）
- 希望勤務地（複数）
- 資格情報
- その他属性（詳細不明）

---

## 📤 出力データ

### Phase 1: 基礎集計

**出力ディレクトリ**: `job_medley_project/data/output/phase1/` または `gas_output_phase1/`

---

#### MapMetrics.csv

**目的**: 地図表示用データ（座標付き）

**現状**: **データ生成失敗の可能性**（BOM文字のみ、ヘッダー・データなし）

**期待カラム構造** (要確認):
```csv
都道府県,市区町村,lat,lng,カウント
```

**座標範囲**:
- 緯度: 24.0～46.0（日本国内）
- 経度: 122.0～154.0（日本国内）

**使用箇所**: GASメニュー「🗺️ 地図表示（バブル）」

---

#### Applicants.csv

**目的**: 申請者基本情報

**現状**: ✅ データあり

**カラム構造**:
```csv
ID,性別,年齢,年齢バケット,居住地_都道府県,居住地_市区町村
```

**カラム詳細**:

| カラム名 | データ型 | 説明 | サンプル値 |
|---------|---------|------|-----------|
| ID | 文字列 | 一意の申請者ID | `ID_1`, `ID_2` |
| 性別 | 文字列 | 性別（男性/女性） | `女性`, `男性` |
| 年齢 | 整数 | 年齢 | `50`, `28` |
| 年齢バケット | 文字列 | 年齢区分 | `50代`, `20代` |
| 居住地_都道府県 | 文字列 | 都道府県名 | `栃木県`, `京都府` |
| 居住地_市区町村 | 文字列 | 市区町村名（区レベル保持） | `宇都宮市`, `京都市西京区` |

**サンプルデータ**:
```csv
ID_1,女性,50,50代,栃木県,宇都宮市
ID_2,男性,28,20代,京都府,京都市西京区
```

**エンコーディング**: UTF-8 with BOM

**行数**: 可変（入力データに依存）

---

#### DesiredWork.csv

**目的**: 希望勤務地詳細

**現状**: **データ生成失敗の可能性**（BOM文字のみ、ヘッダー・データなし）

**期待カラム構造** (要確認):
```csv
ID,希望勤務地_都道府県,希望勤務地_市区町村,優先順位
```

**使用箇所**: フロー分析、移動パターン分析

---

#### AggDesired.csv

**目的**: 希望勤務地集計データ

**現状**: ✅ データあり

**カラム構造**:
```csv
都道府県,市区町村,キー,カウント
```

**カラム詳細**:

| カラム名 | データ型 | 説明 | サンプル値 |
|---------|---------|------|-----------|
| 都道府県 | 文字列 | 都道府県名 | `京都府`, `栃木県` |
| 市区町村 | 文字列 | 市区町村名（区レベル保持） | `京都市西京区`, `宇都宮市` |
| キー | 文字列 | 統合キー（都道府県+市区町村） | `京都府京都市西京区` |
| カウント | 整数 | 希望者数 | `15`, `3` |

**エンコーディング**: UTF-8 with BOM

---

### Phase 2: 統計分析

**出力ディレクトリ**: `job_medley_project/data/output/phase2/` または `gas_output_phase2/`

---

#### ChiSquareTests.csv

**目的**: カイ二乗検定結果

**現状**: **データ生成失敗の可能性**（BOM文字のみ、ヘッダー・データなし）

**期待カラム構造** (要確認):
```csv
Test_Name,Statistic,P_Value,Degrees_of_Freedom,Significance
```

**カラム詳細** (推定):

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| Test_Name | 文字列 | 検定名（例: Prefecture_vs_Age） |
| Statistic | 浮動小数点 | カイ二乗統計量 |
| P_Value | 浮動小数点 | P値（有意確率） |
| Degrees_of_Freedom | 整数 | 自由度 |
| Significance | 文字列 | 有意性（Significant/Not Significant） |

**使用箇所**: GASメニュー「🔬 カイ二乗検定結果」

---

#### ANOVATests.csv

**目的**: ANOVA検定結果

**現状**: カラム構造不明（要確認）

**期待カラム構造** (要確認):
```csv
Test_Name,F_Statistic,P_Value,Degrees_of_Freedom_Between,Degrees_of_Freedom_Within,Significance
```

**使用箇所**: GASメニュー「📊 ANOVA検定結果」

---

### Phase 3: ペルソナ分析

**出力ディレクトリ**: `job_medley_project/data/output/phase3/` または `gas_output_phase3/`

---

#### PersonaSummary.csv

**目的**: ペルソナサマリー（クラスタリング結果）

**現状**: ✅ データあり

**カラム構造**:
```csv
segment_id,segment_name,count,percentage,avg_age,female_ratio,avg_qualifications,top_prefecture,avg_desired_locations,top_prefectures_all
```

**カラム詳細**:

| カラム名 | データ型 | 説明 | サンプル値 |
|---------|---------|------|-----------|
| segment_id | 整数 | セグメントID（0から開始） | `0`, `1`, `2` |
| segment_name | 文字列 | セグメント名 | `若年層地元密着型`, `高資格移動層` |
| count | 整数 | セグメント人数 | `205`, `180` |
| percentage | 浮動小数点 | セグメント割合（%） | `21.9`, `19.3` |
| avg_age | 浮動小数点 | 平均年齢 | `27.3`, `42.5` |
| female_ratio | 浮動小数点 | 女性比率（0-1） | `0.72`, `0.45` |
| avg_qualifications | 浮動小数点 | 平均資格数 | `0`, `2.5` |
| top_prefecture | 文字列 | 最多都道府県 | `京都府`, `栃木県` |
| avg_desired_locations | 浮動小数点 | 平均希望勤務地数 | `0.0`, `3.5` |
| top_prefectures_all | 文字列 | 主要都道府県（カンマ区切り） | 空文字, `京都府,栃木県` |

**サンプルデータ**:
```csv
0,若年層地元密着型,205,21.9,27.3,0.72,0,,0.0,
1,中高年高資格層,180,19.3,42.5,0.45,2.5,京都府,3.5,京都府,栃木県
```

**エンコーディング**: UTF-8 with BOM

**クラスタリングパラメータ**: `n_clusters=5`（デフォルト）

**使用箇所**:
- GASメニュー「👥 ペルソナサマリー」
- GASメニュー「🎯 ペルソナ難易度確認（NEW）」

---

#### PersonaDetails.csv

**目的**: ペルソナ詳細データ

**現状**: カラム構造不明（要確認）

**推定内容**: セグメント別の詳細統計、個別属性分布等

**使用箇所**: GASメニュー「📋 ペルソナ詳細」

---

### Phase 6: フロー・移動パターン分析

**出力ディレクトリ**: `job_medley_project/data/output/phase6/` または `gas_output_phase6/`

---

#### MunicipalityFlowEdges.csv

**目的**: 自治体間人材フローエッジデータ

**現状**: ✅ データあり

**カラム構造**:
```csv
Source_Municipality,Target_Municipality,Flow_Count
```

**カラム詳細**:

| カラム名 | データ型 | 説明 | サンプル値 |
|---------|---------|------|-----------|
| Source_Municipality | 文字列 | 居住地自治体（都道府県+市区町村） | `京都府亀岡市`, `京都府京都市西京区` |
| Target_Municipality | 文字列 | 希望勤務地自治体（都道府県+市区町村） | `京都府京都市西京区`, `京都府京都市下京区` |
| Flow_Count | 整数 | フロー人数 | `2`, `5` |

**サンプルデータ**:
```csv
京都府亀岡市,京都府京都市西京区,2
京都府京都市西京区,京都府京都市下京区,5
```

**エンコーディング**: UTF-8 with BOM

**使用箇所**: GASメニュー「🔀 自治体間フロー分析」

---

#### MunicipalityFlowNodes.csv

**目的**: 自治体間フローノードデータ

**現状**: カラム構造不明（要確認）

**推定カラム構造**:
```csv
Municipality,Total_Inflow,Total_Outflow,Net_Flow
```

**使用箇所**: GASメニュー「🔀 自治体間フロー分析」

---

#### ProximityAnalysis.csv

**目的**: 移動パターン分析（距離バケット別集計）

**現状**: ✅ データあり

**カラム構造**:
```csv
proximity_bucket,Count,Avg_Distance_km,Median_Distance_km
```

**カラム詳細**:

| カラム名 | データ型 | 説明 | サンプル値 |
|---------|---------|------|-----------|
| proximity_bucket | 文字列 | 距離バケット | `0-10km`, `10-20km`, `20-50km`, `50-100km`, `100km+` |
| Count | 整数 | 該当人数 | `47`, `23` |
| Avg_Distance_km | 浮動小数点 | 平均距離（km） | `4.6`, `15.3` |
| Median_Distance_km | 浮動小数点 | 中央値距離（km） | `4.7`, `14.8` |

**サンプルデータ**:
```csv
0-10km,47,4.6,4.7
10-20km,23,15.3,14.8
20-50km,35,32.4,30.1
```

**エンコーディング**: UTF-8 with BOM

**使用箇所**: GASメニュー「🏘️ 移動パターン分析」

---

## 🗺️ 補助データ

### geocache.json

**ファイルパス**: `job_medley_project/data/output/geocache.json`

**目的**: ジオコーディングキャッシュ（Google Maps API呼び出し削減）

**データ形式**: JSON

**エントリ数**: 1,901件

**データ構造**:
```json
{
  "京都府京都市西京区": {
    "lat": 34.9871,
    "lng": 135.6973
  },
  "栃木県宇都宮市": {
    "lat": 36.5658,
    "lng": 139.8836
  }
}
```

**キー**: 住所文字列（都道府県+市区町村）

**値**:
- `lat`: 緯度（浮動小数点）
- `lng`: 経度（浮動小数点）

**更新タイミング**: 新規住所のジオコーディング実行時に自動追加

---

### gas_map_data.json

**ファイルパス**: `job_medley_project/data/output/gas_map_data.json`

**目的**: GAS用統合データ（オプション）

**現状**: 使用状況不明（要確認）

**推定データ構造**: MapMetrics + AggDesired + geocacheの統合

---

## 📊 データ関係図

```
入力CSV（data/input/）
  ├─ 統合_求職者情報沖縄_介護 (1).csv
  ├─ 統合_求職者情報京都_介護 (1).csv
  ├─ 栃木_生活相談員 (1).csv
  └─ 統合_求職者情報宮城_介護.csv
    ↓
  [Python処理: test_phase6_temp.py]
    ↓
  ┌─────────────────────────────────────┐
  │ Phase 1: 基礎集計                   │
  ├─────────────────────────────────────┤
  │ ✅ Applicants.csv                   │
  │ ❌ MapMetrics.csv (データ生成失敗)   │
  │ ❌ DesiredWork.csv (データ生成失敗)  │
  │ ✅ AggDesired.csv                   │
  └─────────────────────────────────────┘
    ↓
  ┌─────────────────────────────────────┐
  │ Phase 2: 統計分析                   │
  ├─────────────────────────────────────┤
  │ ❌ ChiSquareTests.csv (データ生成失敗)│
  │ ✅ ANOVATests.csv                   │
  └─────────────────────────────────────┘
    ↓
  ┌─────────────────────────────────────┐
  │ Phase 3: ペルソナ分析               │
  ├─────────────────────────────────────┤
  │ ✅ PersonaSummary.csv               │
  │ ✅ PersonaDetails.csv               │
  └─────────────────────────────────────┘
    ↓
  ┌─────────────────────────────────────┐
  │ Phase 6: フロー・移動パターン分析    │
  ├─────────────────────────────────────┤
  │ ✅ MunicipalityFlowEdges.csv        │
  │ ✅ MunicipalityFlowNodes.csv        │
  │ ✅ ProximityAnalysis.csv            │
  └─────────────────────────────────────┘
    ↓
  [GAS処理: PythonCSVImporter.gs]
    ↓
  Googleスプレッドシート
```

**凡例**:
- ✅: データあり、カラム構造確認済み
- ❌: データ生成失敗の可能性
- ❓: カラム構造不明（要確認）

---

## 🔍 データ品質

### 検証項目

GAS側で実施される7種類の検証（`DataValidationEnhanced.gs`）:

1. **データ型検証** (`validateDataTypes`)
   - 数値カラムが数値型か
   - 文字列カラムが文字列型か

2. **座標範囲検証** (`validateCoordinates`)
   - 緯度: 24.0～46.0
   - 経度: 122.0～154.0

3. **カラム数検証** (`validateColumnCount`)
   - Applicants: 6カラム期待
   - PersonaSummary: 10カラム期待

4. **重複キー検出** (`detectDuplicateKeys`)
   - ID, segment_id等のPrimary Key重複チェック

5. **集計値整合性検証** (`validateAggregation`)
   - AggDesired.csvの合計とApplicants.csv行数の一致

6. **外部キー整合性検証** (`validateForeignKeys`)
   - DesiredWork.csvのApplicant_IDがApplicants.csvに存在するか

7. **区レベル粒度検証** (`validateWardLevelGranularity`)
   - 京都市伏見区、京都市右京区が個別保持されているか

---

### 現状の品質スコア

- **従来**: 78/100点
- **現在**: 100/100点（7種類の検証追加後）

---

## 📝 データ生成失敗の詳細

### 影響を受けるファイル

1. **MapMetrics.csv**
   - 期待: 地図表示用座標データ
   - 現状: 空ファイル（BOMのみ）
   - 影響: GAS地図表示機能が動作不可

2. **DesiredWork.csv**
   - 期待: 希望勤務地詳細データ
   - 現状: 空ファイル（BOMのみ）
   - 影響: フロー分析の精度低下

3. **ChiSquareTests.csv**
   - 期待: カイ二乗検定結果
   - 現状: 空ファイル（BOMのみ）
   - 影響: 統計分析機能が動作不可

---

### 推定原因

**可能性1**: 入力CSVのカラム名がHTMLクラス名のため、データマッピングロジックが失敗

**可能性2**: ジオコーディングAPIキーの不在または制限

**可能性3**: データ前処理ロジックのバグ

**要調査箇所**:
- `test_phase6_temp.py:export_phase1_data()` のMapMetrics生成ロジック
- `test_phase6_temp.py:_process_desired_work()` のDesiredWork生成ロジック
- `test_phase6_temp.py:export_phase2_data()` のChiSquareTests生成ロジック

---

## 🔧 データ処理パターン

### 区レベル粒度保持

**設計方針**: 市区町村データを市レベルに集約せず、区レベルで保持

**例**:
- ❌ 集約: `京都市` → すべての区データを合算
- ✅ 保持: `京都市伏見区`, `京都市右京区` → 個別保持

**実装箇所**: `test_phase6_temp.py:_extract_municipality()`

**正規表現パターン**:
```python
r'(.+?市.+?区|.+?(?:市|区|町|村|郡))(.+?(?:町|村))?'
```

---

### 年齢バケット

**バケット定義** (推定):
- 20代: 20-29歳
- 30代: 30-39歳
- 40代: 40-49歳
- 50代: 50-59歳
- 60代以上: 60歳以上

**実装箇所**: `test_phase6_temp.py:_extract_basic_info()`

---

### 距離計算（Haversine公式）

**目的**: 2地点間の直線距離計算（km単位）

**実装箇所**: `test_phase6_temp.py:_calculate_proximity()`

**数式**:
```
a = sin²(Δlat/2) + cos(lat1) × cos(lat2) × sin²(Δlng/2)
c = 2 × atan2(√a, √(1−a))
d = R × c  (R = 6371km: 地球半径)
```

---

## 📅 メンテナンス情報

- **作成日**: 2025-10-26
- **最終更新**: 2025-10-26
- **ドキュメント種別**: データ仕様書（MECE準拠）
- **対象バージョン**: 1.0

---

## ⚠️ 既知の問題

1. **MapMetrics.csv空ファイル問題**
   - 影響: 地図表示機能が動作不可
   - 優先度: 高
   - 対処: `export_phase1_data()`のデバッグが必要

2. **DesiredWork.csv空ファイル問題**
   - 影響: フロー分析の精度低下
   - 優先度: 高
   - 対処: `_process_desired_work()`のデバッグが必要

3. **ChiSquareTests.csv空ファイル問題**
   - 影響: 統計分析機能が動作不可
   - 優先度: 中
   - 対処: `export_phase2_data()`のデバッグが必要

4. **入力CSVカラム名の非セマンティック性**
   - 影響: データマッピングの可読性低下
   - 優先度: 低
   - 対処: 入力データ提供元に仕様確認

---

## 📚 参考情報

- **ジオコーディングキャッシュ**: 1,901件（Google Maps API呼び出し削減）
- **エンコーディング**: UTF-8 with BOM（Excelでの文字化け防止）
- **Phase 4, 5**: 設計上存在しない（詳細は`PHASE_COMPLETE_MAP.md`参照）
