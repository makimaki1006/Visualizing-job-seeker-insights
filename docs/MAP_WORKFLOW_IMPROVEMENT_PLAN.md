# 地図起点ワークフロー改善計画（ドラフト）

## 1. 現状整理

| 観点 | 現状 | 課題 |
| --- | --- | --- |
| 地図 → ダッシュボード連携 | MapVisualization（Phase1）で市区町村をクリックしても、他のダッシュボードへの連携は行われない | 地図で選んだ地域を起点に Phase6/7/8/10 の可視化へスムーズに遷移できない |
| ダッシュボード側の地域フィルター | 多くの GAS 可視化（SupplyDensity, Qualification, Mobility, MatrixHeatmap 等）に、市区町村レベルのフィルター UI が無い | 同じ地域で各指標を比較するには、毎回シートを開いて手動でフィルターする必要がある |
| データ連携 | Python の出力（MapMetrics / Phase7 データ / 品質レポート etc.）は市区町村キーを持ち、GAS インポートも統一されている | データ側の連携には問題なし。UX 改善（状態共有）が未実装 |

## 2. 目指す姿（例）

1. MapVisualization で市区町村を選択すると、選択内容を GAS 共通メタ（`_PythonMetadata` シートや `PropertiesService`）に保存。
2. 他の可視化メニューを開いた際に保存された市区町村を初期値に設定し、同じ地域の指標が即座に表示される。
3. 各ダッシュボードに市区町村・都道府県フィルター UI を追加し、別の地域へ切り替える操作も容易にする。
4. （可能なら）Python 側で市区町村マスタを出力し、フィルター候補のリスト化を容易にする。

## 3. 対応プラン

| フェーズ | 対応内容 | 概要 | 備考 |
| --- | --- | --- | --- |
| Phase 0 | 状態共有用メタ追加 | `_PythonMetadata` などに `LastSelectedPrefecture` / `LastSelectedMunicipality` を追加 | MapVisualization でのクリックを `PropertiesService` またはシートに書き込む |
| Phase 1 | MapVisualization 側変更 | マーカーをクリックした際、上記メタを更新する処理を追加（既存のダイアログ表示＋α） | 市区町村名/都道府県名をキーに保存 |
| Phase 2 | Phase7 可視化にフィルター追加 | `Phase7*Viz.gs` に市区町村ドロップダウン/テキスト入力を追加し、`LastSelectedMunicipality` を初期値に | 細粒度の地域分析が可能に |
| Phase 3 | Phase6・8・10 のダッシュボード拡張 | ネットワーク図やヒートマップにも同様のフィルターを実装 | 処理負荷とのバランスを見ながら段階導入 |
| Phase 4 | 共通 UI コンポーネント化 | 地域選択 UI を共通関数化し、各ダッシュボードで再利用 | 将来的なメンテナンス性向上 |

## 4. 既存課題リスト

- 地図で選んだ地域が他のダッシュボードに引き継がれない。
- Phase7 以外にも市区町村フィルター UI が存在しない可視化が多く、地域を軸にした分析がしづらい。
- UI カスタムが必要だが、当初の優先度が低かったため未対応。
- 処理負荷（大量データを GAS で扱うと重くなる）を考慮した最適な実装方針の検討が必要。

## 5. 今後の対応メモ

- MapVisualization 側で `google.script.run` を用いてメタ情報を更新→他の GAS スクリプトは `PropertiesService.getUserProperties()` 等で読み出す。
- Phase7 の SupplyDensity / Qualification / AgeGender / Mobility / PersonaProfile 各 UI に共通フィルター部品を追加。
- Phase6 のネットワーク図では、市区町村選択・都道府県選択に応じてエッジ／ノードを再描画するよう調整。
- Phase8・10 のヒートマップは、選択した市区町村にフォーカスできるようにしつつ、データが少ない場合のフォールバック（全体表示）を検討。
- Python 側の出力に市区町村マスタや補助 JSON を追加する場合は `config.py` との整合を確認。
