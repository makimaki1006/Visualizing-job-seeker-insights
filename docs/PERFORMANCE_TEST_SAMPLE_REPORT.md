# パフォーマンステスト・最適化分析レポート（サンプル）

**実行日時**: 2025-11-09T10:30:45.123Z

**テスト環境**:
- 繰り返し回数: 5回
- ウォームアップ: 2回
- 中規模データ: 京都府 (601行想定)

---

## エグゼクティブサマリー

### 性能改善効果

- **改善率**: 87.2%
- **高速化倍率**: 7.8倍
- **削減時間**: 18.5秒/リクエスト

#### 従来方式 vs 新方式

| 方式 | 平均時間 | 中央値 | 最小 | 最大 | 標準偏差 |
|------|---------|--------|------|------|----------|
| MapCompleteDataBridge (15シート読み込み) | 21.20秒 | 21.10秒 | 20.80秒 | 21.70秒 | 0.352秒 |
| PersonaLevelDataBridge (1シート読み込み) | 2.72秒 | 2.68秒 | 2.55秒 | 2.95秒 | 0.158秒 |

---

## 1. データロード時間の詳細分析

**対象**: 京都府 (601行 × 43列)

### 処理内訳

| 処理 | 平均時間 | 中央値 | 標準偏差 | 期待値 | 判定 |
|------|---------|--------|----------|--------|------|
| getDataRange() | 0.42秒 | 0.40秒 | 0.035秒 | 0.5秒 | ✅ |
| getValues() | 1.38秒 | 1.35秒 | 0.082秒 | 1.5秒 | ✅ |
| オブジェクト配列変換 | 0.85秒 | 0.83秒 | 0.051秒 | 1.0秒 | ✅ |
| **合計** | **2.72秒** | 2.68秒 | 0.158秒 | 3.0秒 | ✅ |

### 分析

- ✅ **getValues()が最大のボトルネック** (50.7%)
  - 原因: Spreadsheet APIの呼び出しオーバーヘッド
  - 対策: 必要な列のみ取得する範囲指定を検討

- ✅ **総合評価: 合格** - 期待値以内の性能を達成

---

## 2. 都道府県別のロード時間比較

### 規模別ロード時間

| 規模 | 都道府県 | 行数 | 平均時間 | 中央値 | 1行あたり時間 |
|------|---------|------|---------|--------|---------------|
| small | 鳥取県 | 78行 | 0.35秒 | 0.34秒 | 4.49ms/行 |
| medium | 京都府 | 601行 | 2.72秒 | 2.68秒 | 4.53ms/行 |
| large | 東京都 | 1100行 | 4.98秒 | 4.92秒 | 4.53ms/行 |

### 線形性分析

| 規模 | 1行あたり時間 (ms) |
|------|-------------------|
| small | 4.49ms |
| medium | 4.53ms |
| large | 4.53ms |

✅ **線形性: 良好** - データ量に比例してロード時間が増加（予測可能）

---

## 3. フィルタリング性能

### 条件数別フィルタリング時間

| 条件数 | 結果件数 | 平均時間 | 中央値 | 標準偏差 |
|--------|---------|---------|--------|----------|
| 0条件 (none) | 601件 | 0.08秒 | 0.08秒 | 0.005秒 |
| 1条件 (one) | 151件 | 0.12秒 | 0.12秒 | 0.008秒 |
| 2条件 (two) | 75件 | 0.15秒 | 0.15秒 | 0.011秒 |
| 3条件 (three) | 38件 | 0.18秒 | 0.18秒 | 0.013秒 |
| 4条件 (four) | 12件 | 0.22秒 | 0.21秒 | 0.015秒 |

### 分析

- フィルタなし → 4条件: 175.0%のオーバーヘッド
- ✅ **高速**: 4条件でも1秒未満で処理完了

---

## 4. 集計・分析性能

### 関数別処理時間

| 関数 | 平均時間 | 中央値 | 標準偏差 |
|------|---------|--------|----------|
| summarize() | 0.28秒 | 0.27秒 | 0.018秒 |
| difficulty() | 0.35秒 | 0.34秒 | 0.022秒 |
| ranking() | 0.42秒 | 0.41秒 | 0.028秒 |

### 分析

✅ **高速**: すべての集計・分析関数が1秒未満で処理完了

---

## 5. メモリ使用量推定

### データサイズ

| 対象 | 行数 | 列数 | サイズ (KB) | サイズ (MB) |
|------|------|------|------------|------------|
| 京都府 | 601行 | 43列 | 52KB | 0.05MB |
| 全47都道府県（推定） | - | - | 2444KB | 2.39MB |

### GASメモリ制限との比較（推定）

- **推定メモリ制限**: 100MB
- **使用量**: 2.39MB (2.4%)

✅ **メモリ: 十分な余裕** - 全都道府県を同時ロードしても問題なし

---

## 6. ボトルネック分析

### 処理時間の内訳

| 処理 | 時間 (秒) | 割合 (%) |
|------|----------|----------|
| getDataRange | 0.42秒 | 15.4% |
| getValues | 1.38秒 | 50.7% |
| conversion | 0.85秒 | 31.3% |
| other | 0.07秒 | 2.6% |

### ボトルネック特定

**主要ボトルネック**: getValues (50.7%)

**ボトルネックリスト** (30%以上の処理):

1. getValues: 50.7%
2. conversion: 31.3%

### I/O vs CPU vs メモリの分析

- **I/O（Spreadsheet API）**: 66.1%
- **CPU（オブジェクト変換）**: 31.3%
- **その他**: 2.6%

⚠️ **I/Oボトルネック** - Spreadsheet APIの呼び出しが最大の課題

---

## 最適化提案

### 優先度順の提案

#### 1. [ACHIEVED] システム全体

**提案**: 既に87.2%の改善を達成

**期待改善**: さらに10-20%の余地あり

**実装方法**: ScriptCache導入、非同期処理検討

---

#### 2. [HIGH] データ取得

**提案**: getValues()の範囲を限定する（必要な列のみ取得）

**期待改善**: 30-50%の高速化

**実装方法**: getRange(row, col, numRows, numCols).getValues()

---

#### 3. [MEDIUM] データ取得

**提案**: Spreadsheet APIの呼び出し回数を削減

**期待改善**: 20-30%の高速化

**実装方法**: バッチ処理、キャッシュ活用

---

#### 4. [LOW] キャッシュ

**提案**: ScriptCacheを導入して5分間データを保持

**期待改善**: 2回目以降のアクセスで90%以上の高速化

**実装方法**: CacheService.getScriptCache() を活用

---

## 最終評価

### 性能改善効果

- **改善率**: 87.2%
- **評価**: **EXCELLENT** - 目標を大幅に超過 ✅

### さらなる最適化の余地

- **現在の処理時間**: 2.72秒
- **理論的最小時間**: 1.36秒 (ScriptCache + API最適化)
- **さらなる改善余地**: 50.0%

### 推奨される次の最適化アクション

1. **システム全体**: 既に87.2%の改善を達成
   - 期待改善: さらに10-20%の余地あり
   - 実装方法: ScriptCache導入、非同期処理検討

2. **データ取得**: getValues()の範囲を限定する（必要な列のみ取得）
   - 期待改善: 30-50%の高速化
   - 実装方法: getRange(row, col, numRows, numCols).getValues()

---

**レポート生成日時**: 2025-11-09T10:45:12.456Z

---

## 詳細データ（JSON）

### テスト1: 測定生データ

```json
{
  "measurements": [
    {
      "getDataRange": 0.405,
      "getValues": 1.352,
      "conversion": 0.832,
      "total": 2.689,
      "rowCount": 601,
      "colCount": 43
    },
    {
      "getDataRange": 0.418,
      "getValues": 1.389,
      "conversion": 0.851,
      "total": 2.758,
      "rowCount": 601,
      "colCount": 43
    },
    {
      "getDataRange": 0.432,
      "getValues": 1.412,
      "conversion": 0.878,
      "total": 2.822,
      "rowCount": 601,
      "colCount": 43
    },
    {
      "getDataRange": 0.398,
      "getValues": 1.325,
      "conversion": 0.819,
      "total": 2.642,
      "rowCount": 601,
      "colCount": 43
    },
    {
      "getDataRange": 0.445,
      "getValues": 1.421,
      "conversion": 0.895,
      "total": 2.861,
      "rowCount": 601,
      "colCount": 43
    }
  ]
}
```

### テスト6: 従来方式との詳細比較

```json
{
  "comparison": {
    "legacy": {
      "method": "MapCompleteDataBridge (15シート読み込み)",
      "measurements": [21.05, 20.98, 21.32, 21.15, 20.82],
      "stats": {
        "avg": 21.064,
        "median": 21.05,
        "min": 20.82,
        "max": 21.32,
        "stdDev": 0.198
      }
    },
    "new": {
      "method": "PersonaLevelDataBridge (1シート読み込み)",
      "measurements": [2.689, 2.758, 2.822, 2.642, 2.861],
      "stats": {
        "avg": 2.754,
        "median": 2.758,
        "min": 2.642,
        "max": 2.861,
        "stdDev": 0.087
      }
    }
  },
  "improvement": {
    "avgTimeSaved": 18.31,
    "improvementPercent": 86.9,
    "speedupFactor": 7.65
  }
}
```

---

## グラフ（テキストベース）

### ロード時間の推移（5回測定）

```
従来方式 (MapCompleteDataBridge)
21.32秒 ████████████████████████████████████████████ 100%
21.15秒 ████████████████████████████████████████████ 99.2%
21.05秒 ████████████████████████████████████████████ 98.7%
20.98秒 ████████████████████████████████████████████ 98.4%
20.82秒 ████████████████████████████████████████████ 97.7%

新方式 (PersonaLevelDataBridge)
2.861秒 ██████ 13.4%
2.822秒 ██████ 13.2%
2.758秒 ██████ 12.9%
2.689秒 █████ 12.6%
2.642秒 █████ 12.4%

改善率: 86.9% (7.65倍高速化)
```

### 処理内訳（テスト1）

```
getDataRange()    0.42秒  ████████ 15.4%
getValues()       1.38秒  ██████████████████████████ 50.7%
変換処理          0.85秒  ████████████████ 31.3%
その他            0.07秒  █ 2.6%
```

### フィルタリング性能（テスト3）

```
0条件  0.08秒  ████ 100% (601件)
1条件  0.12秒  ██████ 150% (151件)
2条件  0.15秒  ███████ 187% (75件)
3条件  0.18秒  █████████ 225% (38件)
4条件  0.22秒  ███████████ 275% (12件)
```

---

## 結論

### 達成した成果

1. ✅ **87.2%の性能改善を達成** - 目標（85%）を2.2ポイント上回る
2. ✅ **7.65倍の高速化** - 21.06秒 → 2.75秒
3. ✅ **すべてのテストで期待値以内** - 合格基準をクリア
4. ✅ **線形的なスケーラビリティ** - データ量に比例した性能
5. ✅ **メモリ効率良好** - 2.4%使用（十分な余裕）

### 次のステップ

1. **ScriptCache導入**: 2回目以降のアクセスでさらに90%削減
2. **getValues()範囲限定**: 必要な列のみ取得して30-50%削減
3. **本番環境での検証**: 実ユーザーでの性能測定
4. **監視体制の構築**: PropertiesServiceでキャッシュヒット率を記録

---

**総合評価**: ✅ **EXCELLENT** - 本番運用可能な高性能を実現
