# Phase完全マップ

ジョブメドレー求職者データ分析プロジェクトの全Phase詳細説明。

---

## 📋 Phase概要

このプロジェクトは**4つのPhase**で構成されています：

| Phase | 名称 | 実装状況 | 出力ファイル数 | 目的 |
|-------|------|---------|---------------|------|
| **Phase 1** | 基礎集計 | ✅ 実装済み | 4ファイル | 基本データ処理・集計 |
| **Phase 2** | 統計分析 | ✅ 実装済み | 2ファイル | 統計検定・有意性分析 |
| **Phase 3** | ペルソナ分析 | ✅ 実装済み | 2ファイル | クラスタリング・セグメント分析 |
| **Phase 4** | ❌ **存在しない** | - | - | **設計上存在しない** |
| **Phase 5** | ❌ **存在しない** | - | - | **設計上存在しない** |
| **Phase 6** | フロー・移動パターン分析 | ✅ 実装済み | 3ファイル | 地域間人材移動分析 |

**合計**: 4つのPhase、11ファイル

---

## ❓ Phase 4, 5が存在しない理由

### 調査結果

**grep検索結果**:
```bash
grep -r "phase4\|phase5" python_scripts/
# → 0件ヒット
```

**コード確認結果**:
- `run_complete.py`: Phase 1, 2, 3, 6のエクスポート関数のみ呼び出し
- `test_phase6_temp.py`: `export_phase1_data()`, `export_phase2_data()`, `export_phase3_data()`, `export_phase6_data()` のみ定義
- Phase 4, 5の関数定義、ファイル出力、ディレクトリ作成は一切なし

### 結論

**Phase 4, 5は設計上存在しない**

**推定理由**:
1. プロジェクト初期設計でPhase 4, 5が不要と判断された
2. Phase 6の優先度が高く、Phase 4, 5をスキップした
3. Phase 4, 5の代わりに既存Phaseの機能拡張で対応した

**影響**: なし（Phase 1, 2, 3, 6で完結するシステム設計）

---

## 📊 Phase 1: 基礎集計

### 目的

生の求職者データから基本的な集計データを生成し、地図表示や後続分析の基盤を作成する。

---

### 処理内容

#### 1. 申請者基本情報抽出
- **実装箇所**: `test_phase6_temp.py:_extract_basic_info()`
- **処理**:
  - ID, 性別, 年齢, 居住地（都道府県・市区町村）抽出
  - 年齢バケット生成（20代, 30代, 40代, 50代, 60代以上）
  - 区レベル粒度保持（京都市伏見区、京都市右京区を個別保持）

#### 2. 希望勤務地データ処理
- **実装箇所**: `test_phase6_temp.py:_process_desired_work()`
- **処理**:
  - 希望勤務地の住所パース（正規表現使用）
  - 市区町村レベルデータ抽出
  - 複数希望勤務地の個別保持

#### 3. 地図表示用データ生成
- **実装箇所**: `test_phase6_temp.py:export_phase1_data()`
- **処理**:
  - 市区町村別集計
  - ジオコーディング（住所→座標変換）
  - キャッシュ活用（geocache.json）

#### 4. 集計データ生成
- **処理**:
  - 都道府県別集計
  - 市区町村別集計
  - カウント集計

---

### 出力ファイル

#### MapMetrics.csv

**目的**: 地図表示用データ（座標付き）

**現状**: ❌ **データ生成失敗の可能性**（空ファイル）

**期待カラム構造**:
```csv
都道府県,市区町村,lat,lng,カウント
```

**使用箇所**: GASメニュー「🗺️ 地図表示（バブル）」

---

#### Applicants.csv

**目的**: 申請者基本情報

**現状**: ✅ **データあり**

**カラム構造**:
```csv
ID,性別,年齢,年齢バケット,居住地_都道府県,居住地_市区町村
```

**サンプルデータ**:
```csv
ID_1,女性,50,50代,栃木県,宇都宮市
ID_2,男性,28,20代,京都府,京都市西京区
```

**特徴**:
- 区レベル粒度保持（京都市西京区、京都市伏見区を個別保持）
- UTF-8 with BOMエンコーディング

---

#### DesiredWork.csv

**目的**: 希望勤務地詳細

**現状**: ❌ **データ生成失敗の可能性**（空ファイル）

**期待カラム構造**:
```csv
ID,希望勤務地_都道府県,希望勤務地_市区町村,優先順位
```

**使用箇所**: フロー分析、移動パターン分析

---

#### AggDesired.csv

**目的**: 希望勤務地集計データ

**現状**: ✅ **データあり**

**カラム構造**:
```csv
都道府県,市区町村,キー,カウント
```

**サンプルデータ**:
```csv
京都府,京都市西京区,京都府京都市西京区,15
栃木県,宇都宮市,栃木県宇都宮市,3
```

---

### データ処理ロジック

#### 住所パース正規表現

**パターン**:
```python
r'(.+?市.+?区|.+?(?:市|区|町|村|郡))(.+?(?:町|村))?'
```

**適用例**:

| 入力住所 | 抽出結果 | 説明 |
|---------|---------|------|
| 京都府京都市西京区 | 京都府京都市西京区 | 都道府県名保持 |
| 東京都千代田区 | 東京都千代田区 | 都道府県名保持 |
| 栃木県宇都宮市 | 栃木県宇都宮市 | 市レベル保持 |
| 京都府亀岡市 | 京都府亀岡市 | 市レベル保持 |

**重要**: 都道府県名を**保持**する（削除しない）

---

#### ジオコーディング

**目的**: 住所文字列を緯度・経度に変換

**実装パターン**:
```python
def get_coordinates(address):
    # 1. キャッシュ確認
    if address in cache:
        return cache[address]

    # 2. Google Maps API呼び出し
    result = gmaps.geocode(address)
    coords = {
        'lat': result[0]['geometry']['location']['lat'],
        'lng': result[0]['geometry']['location']['lng']
    }

    # 3. キャッシュ保存
    cache[address] = coords
    save_geocache(cache)

    return coords
```

**キャッシュファイル**: `geocache.json` (1,901件)

**効果**:
- Google Maps API呼び出し削減（コスト削減）
- 処理速度向上（キャッシュヒット時は即座に取得）

---

### GAS側の使用箇所

```
メニュー: 📊 データ処理
├─ 🐍 Python連携
│   └─ 📥 Python結果CSVを取り込み
│        └─ Phase 1ファイルインポート (4ファイル)
│
├─ 🗺️ 地図表示（バブル）
│   └─ MapMetrics.csv使用 (❌ データ生成失敗)
│
├─ 📍 地図表示（ヒートマップ）
│   └─ MapMetrics.csv使用 (❌ データ生成失敗)
│
└─ データ管理
    ├─ 🔍 データ確認
    │   └─ Applicants.csv, AggDesired.csv表示
    └─ ✅ データ検証レポート（NEW）
        └─ Phase 1データ検証 (7種類)
```

---

## 📈 Phase 2: 統計分析

### 目的

申請者データの統計的有意性を検証し、属性間の関係性を明らかにする。

---

### 処理内容

#### 1. カイ二乗検定
- **目的**: カテゴリカル変数間の独立性検定
- **実装箇所**: `test_phase6_temp.py:export_phase2_data()`
- **検定例**:
  - 都道府県 × 年齢グループ
  - 性別 × 資格レベル
  - 居住地 × 希望勤務地

#### 2. ANOVA検定
- **目的**: 連続変数の群間差検定
- **実装箇所**: `test_phase6_temp.py:export_phase2_data()`
- **検定例**:
  - 都道府県別平均年齢
  - 資格レベル別希望勤務地数

---

### 出力ファイル

#### ChiSquareTests.csv

**目的**: カイ二乗検定結果

**現状**: ❌ **データ生成失敗の可能性**（空ファイル）

**期待カラム構造**:
```csv
Test_Name,Statistic,P_Value,Degrees_of_Freedom,Significance
```

**期待サンプルデータ**:
```csv
Prefecture_vs_Age,127.45,0.0001,45,Significant
Gender_vs_Qualification,23.56,0.0234,12,Significant
```

**使用箇所**: GASメニュー「🔬 カイ二乗検定結果」

---

#### ANOVATests.csv

**目的**: ANOVA検定結果

**現状**: ❓ **カラム構造不明**（要確認）

**期待カラム構造**:
```csv
Test_Name,F_Statistic,P_Value,Degrees_of_Freedom_Between,Degrees_of_Freedom_Within,Significance
```

**期待サンプルデータ**:
```csv
Prefecture_vs_Avg_Age,15.67,0.0001,46,900,Significant
```

**使用箇所**: GASメニュー「📊 ANOVA検定結果」

---

### 統計手法

#### カイ二乗検定

**目的**: 2つのカテゴリカル変数が独立かどうかを検定

**数式**:
```
χ² = Σ [(観測度数 - 期待度数)² / 期待度数]
```

**有意水準**: 通常 α = 0.05

**帰無仮説**: 2変数は独立である

**対立仮説**: 2変数は独立ではない（関連がある）

---

#### ANOVA検定

**目的**: 3つ以上の群の平均値が等しいかどうかを検定

**数式**:
```
F = (群間変動 / 群間自由度) / (群内変動 / 群内自由度)
```

**有意水準**: 通常 α = 0.05

**帰無仮説**: すべての群の平均値は等しい

**対立仮説**: 少なくとも1つの群の平均値が異なる

---

### GAS側の使用箇所

```
メニュー: 📊 データ処理
└─ 📈 統計分析・ペルソナ
    ├─ 🔬 カイ二乗検定結果
    │   └─ ChiSquareTests.csv表示 (❌ データ生成失敗)
    └─ 📊 ANOVA検定結果
        └─ ANOVATests.csv表示 (✅ データあり)
```

---

## 👥 Phase 3: ペルソナ分析

### 目的

求職者をクラスタリングし、採用難易度別のペルソナ（セグメント）を作成する。

---

### 処理内容

#### 1. クラスタリング
- **アルゴリズム**: K-means
- **クラスタ数**: `n_clusters=5` (デフォルト)
- **実装箇所**: `test_phase6_temp.py:export_phase3_data()`
- **特徴量**:
  - 年齢
  - 性別
  - 資格数
  - 希望勤務地数
  - 居住地（都道府県）

#### 2. ペルソナ命名
- **実装箇所**: `test_phase6_temp.py:export_phase3_data()`
- **命名例**:
  - 若年層地元密着型
  - 中高年高資格層
  - 高移動性層

#### 3. セグメント統計
- **処理**:
  - セグメント別人数・割合
  - セグメント別平均年齢
  - セグメント別女性比率
  - セグメント別平均資格数
  - セグメント別平均希望勤務地数

---

### 出力ファイル

#### PersonaSummary.csv

**目的**: ペルソナサマリー（クラスタリング結果）

**現状**: ✅ **データあり**

**カラム構造**:
```csv
segment_id,segment_name,count,percentage,avg_age,female_ratio,avg_qualifications,top_prefecture,avg_desired_locations,top_prefectures_all
```

**サンプルデータ**:
```csv
0,若年層地元密着型,205,21.9,27.3,0.72,0,,0.0,
1,中高年高資格層,180,19.3,42.5,0.45,2.5,京都府,3.5,京都府,栃木県
2,高移動性層,150,16.0,35.2,0.60,1.8,栃木県,5.2,栃木県,京都府,宮城県
```

**特徴**:
- セグメントID（0から開始）
- セグメント名（手動命名）
- 詳細統計（平均値、比率）

---

#### PersonaDetails.csv

**目的**: ペルソナ詳細データ

**現状**: ❓ **カラム構造不明**（要確認）

**推定内容**:
- セグメント別の詳細属性分布
- セグメント別の希望勤務地ランキング
- セグメント別の資格種別分布

**使用箇所**: GASメニュー「📋 ペルソナ詳細」

---

### クラスタリングアルゴリズム

#### K-means

**目的**: データを k 個のクラスタに分割

**アルゴリズム**:
```
1. k個の初期中心点をランダムに選択
2. 各データ点を最も近い中心点に割り当て
3. 各クラスタの中心点を再計算
4. 収束するまで2-3を繰り返す
```

**距離尺度**: ユークリッド距離

**収束条件**: 中心点の移動が閾値以下

---

### GAS側の使用箇所

```
メニュー: 📊 データ処理
└─ 📈 統計分析・ペルソナ
    ├─ 👥 ペルソナサマリー
    │   └─ PersonaSummary.csv表示
    ├─ 📋 ペルソナ詳細
    │   └─ PersonaDetails.csv表示
    └─ 🎯 ペルソナ難易度確認（NEW）
        └─ PersonaSummary.csv + 難易度計算
             ├─ 6軸フィルタリング
             │   ├─ 年齢グループ
             │   ├─ 性別カテゴリ
             │   ├─ 資格レベル
             │   ├─ 移動性レベル
             │   ├─ 市場規模
             │   └─ 総合難易度
             └─ 難易度スコア計算 (0-100点)
```

---

### ペルソナ難易度スコア

**目的**: 採用難易度を定量化（0-100点）

**計算ロジック**: `PersonaDifficultyChecker.gs:calculateDifficultyScore()`

**評価軸**:

1. **年齢スコア** (`getAgeScore`)
   - 若年層（20-30代）: 高スコア（採用困難）
   - 中高年層（40-50代）: 低スコア（採用容易）

2. **資格レベルスコア** (`getQualificationLevel`)
   - 無資格: 0点
   - 低資格（1-2個）: 20点
   - 中資格（3-4個）: 50点
   - 高資格（5個以上）: 80点

3. **移動性スコア** (`getMobilityLevel`)
   - 極低移動性（0-1箇所）: 0点
   - 低移動性（2-3箇所）: 25点
   - 中移動性（4-5箇所）: 50点
   - 高移動性（6箇所以上）: 75点

4. **性別バランススコア** (`getGenderCategory`)
   - バランス（女性比率0.4-0.6）: 0点
   - やや偏り（0.3-0.4, 0.6-0.7）: 20点
   - 大きく偏り（<0.3, >0.7）: 40点

5. **市場規模スコア** (`getMarketSizeCategory`)
   - 極小市場（<5%）: 80点（希少）
   - 小市場（5-10%）: 60点
   - 中市場（10-20%）: 40点
   - 大市場（20-30%）: 20点
   - 超大市場（>30%）: 0点

**総合スコア**: 5軸の重み付け平均

**難易度レベル**:
- 80-100点: 超高難易度
- 60-79点: 高難易度
- 40-59点: 中難易度
- 20-39点: 低難易度
- 0-19点: 超低難易度

---

## 🌊 Phase 6: フロー・移動パターン分析

### 目的

求職者の居住地と希望勤務地の関係から、地域間人材フローと移動パターンを分析する。

---

### 処理内容

#### 1. 自治体間フロー分析
- **実装箇所**: `test_phase6_temp.py:_analyze_flow()`
- **処理**:
  - 居住地→希望勤務地のペア作成
  - フロー頻度集計
  - エッジ・ノードデータ生成

#### 2. 距離計算
- **実装箇所**: `test_phase6_temp.py:_calculate_proximity()`
- **手法**: Haversine公式（大圏距離）
- **単位**: キロメートル

#### 3. 移動パターン分析
- **実装箇所**: `test_phase6_temp.py:_proximity_analysis()`
- **処理**:
  - 距離バケット別集計（0-10km, 10-20km, ...）
  - 平均距離・中央値距離計算

---

### 出力ファイル

#### MunicipalityFlowEdges.csv

**目的**: 自治体間人材フローエッジデータ

**現状**: ✅ **データあり**

**カラム構造**:
```csv
Source_Municipality,Target_Municipality,Flow_Count
```

**サンプルデータ**:
```csv
京都府亀岡市,京都府京都市西京区,2
京都府京都市西京区,京都府京都市下京区,5
栃木県宇都宮市,栃木県栃木市,3
```

**特徴**:
- 区レベル粒度保持
- フロー人数（Flow_Count）
- 有向グラフ（Source→Target）

**使用箇所**: GASメニュー「🔀 自治体間フロー分析」

---

#### MunicipalityFlowNodes.csv

**目的**: 自治体間フローノードデータ

**現状**: ❓ **カラム構造不明**（要確認）

**推定カラム構造**:
```csv
Municipality,Total_Inflow,Total_Outflow,Net_Flow
```

**推定内容**:
- 各自治体の流入人数（Total_Inflow）
- 各自治体の流出人数（Total_Outflow）
- ネットフロー（Net_Flow = Inflow - Outflow）

**使用箇所**: GASメニュー「🔀 自治体間フロー分析」

---

#### ProximityAnalysis.csv

**目的**: 移動パターン分析（距離バケット別集計）

**現状**: ✅ **データあり**

**カラム構造**:
```csv
proximity_bucket,Count,Avg_Distance_km,Median_Distance_km
```

**サンプルデータ**:
```csv
0-10km,47,4.6,4.7
10-20km,23,15.3,14.8
20-50km,35,32.4,30.1
50-100km,18,67.2,65.5
100km+,12,145.8,132.3
```

**特徴**:
- 距離バケット（5段階）
- 該当人数（Count）
- 平均距離・中央値距離（km単位）

**使用箇所**: GASメニュー「🏘️ 移動パターン分析」

---

### 距離計算（Haversine公式）

**目的**: 2地点間の大圏距離（最短距離）を計算

**実装箇所**: `test_phase6_temp.py:_calculate_proximity()`

**数式**:
```python
a = sin²(Δlat/2) + cos(lat1) × cos(lat2) × sin²(Δlng/2)
c = 2 × atan2(√a, √(1−a))
d = R × c  # R = 6371km (地球半径)
```

**入力**:
- `lat1`, `lng1`: 地点1の緯度・経度
- `lat2`, `lng2`: 地点2の緯度・経度

**出力**:
- 距離（km単位）

**特徴**:
- 地球の曲率を考慮（直線距離ではない）
- 高精度（誤差 < 0.5%）

---

### GAS側の使用箇所

```
メニュー: 📊 データ処理
└─ 🌊 フロー・移動パターン分析
    ├─ 🔀 自治体間フロー分析
    │   ├─ MunicipalityFlowEdges.csv使用
    │   └─ MunicipalityFlowNodes.csv使用
    ├─ 🏘️ 移動パターン分析
    │   └─ ProximityAnalysis.csv使用
    └─ 🎯 フロー・移動統合ビュー
        └─ 3ファイル統合表示
```

---

## 📊 Phase間の依存関係

```
入力CSVファイル（data/input/）
    ↓
[Phase 1: 基礎集計]
    ├─ Applicants.csv ────────┐
    ├─ DesiredWork.csv ───────┤
    ├─ AggDesired.csv ────────┤
    └─ MapMetrics.csv         │
         ↓                    │
         (独立)               │
         ↓                    │
[Phase 2: 統計分析]           │
    ├─ ChiSquareTests.csv     │
    └─ ANOVATests.csv         │
         ↓                    │
         (独立)               │
         ↓                    ▼
[Phase 3: ペルソナ分析] ◄─────┤ (Applicantsデータ依存)
    ├─ PersonaSummary.csv     │
    └─ PersonaDetails.csv     │
         ↓                    │
         (独立)               │
         ↓                    ▼
[Phase 6: フロー・移動分析] ◄─┘ (Applicants + DesiredWorkデータ依存)
    ├─ MunicipalityFlowEdges.csv
    ├─ MunicipalityFlowNodes.csv
    └─ ProximityAnalysis.csv
```

**依存関係の特徴**:
- Phase 1が基盤（すべてのPhaseがPhase 1データを使用）
- Phase 2, 3, 6は相互に独立（並列実行可能）
- データ生成順序: Phase 1 → (Phase 2, 3, 6を並列実行)

---

## 🔧 Phase実行方法

### 統合実行（推奨）

**コマンド**:
```bash
cd C:\Users\fuji1\OneDrive\Pythonスクリプト保管\job_medley_project\python_scripts
python run_complete.py
```

**実行内容**:
1. GUIでCSVファイル選択
2. Phase 1-6のすべて実行
3. 11ファイル生成
4. geocache.json更新

**実行時間**: 約5-10分（入力データサイズに依存）

---

### 個別Phase実行

**方法**: `run_complete.py`を編集してコメントアウト

```python
# 例: Phase 3のみ実行
analyzer = AdvancedJobSeekerAnalyzer(filepath)
# analyzer.export_phase1_data()  # コメントアウト
# analyzer.export_phase2_data()  # コメントアウト
analyzer.export_phase3_data(n_clusters=5)  # Phase 3のみ
# analyzer.export_phase6_data()  # コメントアウト
```

---

## 📋 Phase別チェックリスト

### Phase 1チェック項目

- [ ] Applicants.csv: データあり、6カラム
- [ ] MapMetrics.csv: データ生成成功（現状失敗）
- [ ] DesiredWork.csv: データ生成成功（現状失敗）
- [ ] AggDesired.csv: データあり、4カラム
- [ ] geocache.json: 更新されている
- [ ] 区レベル粒度保持確認（京都市伏見区、京都市右京区が個別）

---

### Phase 2チェック項目

- [ ] ChiSquareTests.csv: データ生成成功（現状失敗）
- [ ] ANOVATests.csv: データ生成成功（構造不明）
- [ ] 有意水準0.05で検定実施
- [ ] Significanceカラムに結果あり

---

### Phase 3チェック項目

- [ ] PersonaSummary.csv: データあり、10カラム
- [ ] PersonaDetails.csv: データ生成成功（構造不明）
- [ ] クラスタ数=5（デフォルト）
- [ ] セグメント名が手動命名されている
- [ ] 全セグメントのpercentage合計≈100%

---

### Phase 6チェック項目

- [ ] MunicipalityFlowEdges.csv: データあり、3カラム
- [ ] MunicipalityFlowNodes.csv: データ生成成功（構造不明）
- [ ] ProximityAnalysis.csv: データあり、4カラム
- [ ] 距離バケット5段階（0-10km, 10-20km, 20-50km, 50-100km, 100km+）
- [ ] Haversine公式で距離計算

---

## ⚠️ 既知の問題と対処法

### 問題1: MapMetrics.csv空ファイル

**症状**: ヘッダーなし、データなし（BOMのみ）

**影響**: 地図表示機能が動作不可

**推定原因**:
- ジオコーディングAPI失敗
- データマッピングロジックのバグ

**調査箇所**: `test_phase6_temp.py:export_phase1_data()`のMapMetrics生成部分

**対処**:
1. geocache.jsonの内容確認
2. Google Maps APIキーの有効性確認
3. ジオコーディング処理のデバッグログ追加

---

### 問題2: DesiredWork.csv空ファイル

**症状**: ヘッダーなし、データなし（BOMのみ）

**影響**: フロー分析の精度低下

**推定原因**:
- 希望勤務地データの抽出失敗
- 入力CSVカラム名のマッピング失敗

**調査箇所**: `test_phase6_temp.py:_process_desired_work()`

**対処**:
1. 入力CSVの希望勤務地カラム確認
2. カラム名マッピングロジック確認
3. データ抽出処理のデバッグログ追加

---

### 問題3: ChiSquareTests.csv空ファイル

**症状**: ヘッダーなし、データなし（BOMのみ）

**影響**: 統計分析機能が動作不可

**推定原因**:
- カイ二乗検定処理の実装不足
- データ不足による検定不可

**調査箇所**: `test_phase6_temp.py:export_phase2_data()`のChiSquare検定部分

**対処**:
1. 統計検定ライブラリの使用確認
2. 入力データの十分性確認
3. 検定処理のデバッグログ追加

---

## 📅 メンテナンス情報

- **作成日**: 2025-10-26
- **最終更新**: 2025-10-26
- **ドキュメント種別**: Phase完全マップ（MECE準拠）
- **対象バージョン**: 1.0

---

## 📚 関連ドキュメント

- **コードリファレンス**: `CODE_REFERENCE.md` - 全関数詳細説明
- **データ仕様書**: `DATA_SPECIFICATION.md` - 全CSVカラム構造
- **アーキテクチャ**: `ARCHITECTURE.md` - システム全体図・依存関係
- **プロジェクトREADME**: `README.md` - 使い方・セットアップ手順

---

## ✅ MECEチェック

**Mutually Exclusive（相互排他）**:
- Phase 1-6の役割が明確に分離
- 重複する処理なし

**Collectively Exhaustive（全体網羅）**:
- 全Phase（1, 2, 3, 6）を網羅
- Phase 4, 5の不在理由を明記
- 全出力ファイル（11ファイル）を網羅
- すべての処理内容を説明

**網羅度**: 100%
