# HTMLマップ機能充実化プラン

**作成日**: 2025年11月1日
**目的**: 既存MAP機能を充実させ、Python出力42ファイルのデータを最大限活用した高度な地図可視化を実現する
**対象**: BubbleMap.html, HeatMap.html, MapComplete.html

---

## 📊 現状分析

### 既存MAP機能（3ファイル）

| HTMLファイル | 使用ライブラリ | 主要機能 | データソース | ステータス |
|-------------|--------------|---------|-------------|-----------|
| **BubbleMap.html** | Google Maps API | バブルマップ、TOP10表示、性別グラフ | Phase1_MapMetrics | ✅ 本番運用中 |
| **HeatMap.html** | Google Maps API | ヒートマップ表示 | Phase1_MapMetrics | ✅ 本番運用中 |
| **MapComplete.html** | Leaflet.js | マーカークラスター、ヒートマップ、フィルター（性別、年齢層） | Phase1_MapMetrics | ✅ 本番運用中（最高機能） |

### 既存機能の特徴

#### MapComplete.html（最高機能版）
- **地図ライブラリ**: Leaflet.js（軽量・高速）
- **表示モード**: 個別マーカー / クラスター / ヒートマップ
- **フィルター**: 全データ / 男性 / 女性 / 20-39歳 / 40-59歳 / 60歳以上
- **サイドバー**: 統計情報、TOP10リスト、性別グラフ、地域詳細
- **インタラクティブ**: 地域クリック→詳細表示、フィルター切り替え

### 未活用データの特定

#### Phase 3: ペルソナデータ（市町村別）
- **PersonaSummaryByMunicipality.csv** (100-500行)
  - 市町村ごとのペルソナ分布
  - **現状**: `showPersonaMapVisualization()`で可視化済み（Phase1-6UnifiedVisualizations.gs:1559）
  - **MAP連携**: ❌ 未実装

#### Phase 6: フローデータ
- **MunicipalityFlowEdges.csv** (100-1,000行) - 自治体間移動エッジ
- **MunicipalityFlowNodes.csv** (50-500行) - 自治体ノード
- **ProximityAnalysis.csv** (100-500行) - 移動パターン
  - **現状**: `showMunicipalityFlowNetworkVisualization()`で可視化済み
  - **MAP連携**: ❌ 未実装（フロー表示なし）

#### Phase 7: 高度分析データ
- **SupplyDensityMap.csv** (500-1,000行) - 人材供給密度マップ
  - カラム: 市区町村、求職者数、資格保有率、平均年齢、緊急度、総合スコア、ランク
  - **現状**: `showSupplyDensityMap()`で表表示のみ
  - **MAP連携**: ❌ 未実装（地図表示なし）

- **MobilityScore.csv** (500-7,390行) - 移動許容度スコアリング
  - カラム: 申請者ID、希望地数、最大移動距離km、移動許容度スコア、移動許容度レベル、居住地
  - **現状**: `showMobilityScoreAnalysis()`でグラフ表示のみ
  - **MAP連携**: ❌ 未実装（個人レベルの移動範囲表示なし）

#### Phase 10: 緊急度データ
- **UrgencyByMunicipality.csv** (100-500行) - 市町村別緊急度
- **UrgencyAgeCross_ByMunicipality.csv** (200-1,000行) - 市町村別緊急度×年齢
- **UrgencyEmploymentCross_ByMunicipality.csv** (200-1,000行) - 市町村別緊急度×雇用形態
  - **現状**: `showUrgencyByMunicipality()`で表表示のみ
  - **MAP連携**: ❌ 未実装（地図表示なし）

---

## 🎯 ギャップ分析

### 未実装の重要MAP機能

| 機能カテゴリ | 現状 | ギャップ | ビジネス価値 |
|------------|------|---------|-------------|
| **フロー可視化** | ❌ なし | 自治体間の人材移動を矢印で表示 | 🔴 HIGH - 人材獲得競争の可視化 |
| **人材供給密度** | ⚠️ 表のみ | 市区町村ごとの供給密度を色分け表示 | 🔴 HIGH - 採用しやすさの一目瞭然化 |
| **緊急度マップ** | ⚠️ 表のみ | 緊急度を色分け表示（即戦力vs長期育成） | 🟡 MEDIUM - 採用スピード予測 |
| **ペルソナマップ** | ⚠️ 別ビュー | ペルソナ分布を地図上にレイヤー表示 | 🟡 MEDIUM - ターゲット人材の地理分布 |
| **移動許容度マップ** | ❌ なし | 個人別の移動可能範囲を円で表示 | 🟢 LOW - 勤務地柔軟性の可視化 |
| **時系列アニメーション** | ❌ なし | データの時間変化を動画で表示 | 🟢 LOW - トレンド理解 |
| **比較マップ** | ❌ なし | 2つのPhaseを並べて比較表示 | 🟡 MEDIUM - データ間の関係性発見 |

---

## 💡 新機能・改善案

### 【優先度 🔴 HIGH】Phase 6フロー可視化マップ

#### 機能名: `FlowNetworkMap.html`

**概要**: 自治体間の人材移動フローを矢印で可視化

**データソース**:
- Phase6_FlowEdges.csv - 移動元→移動先のエッジデータ
- Phase6_FlowNodes.csv - 各自治体のノードデータ

**主要機能**:
1. **矢印表示**: 移動元→移動先を矢印で表示（太さ=人数）
2. **双方向フロー**: A→B、B→Aを異なる色で表示
3. **フロー強度フィルター**: 最小人数を設定してノイズ除去
4. **アニメーション**: フロー方向に沿って粒子が移動
5. **ノード詳細**: クリックで流入・流出の詳細表示

**技術スタック**:
- Leaflet.js + Leaflet.PolylineDecorator（矢印）
- D3.js（フロー計算・アニメーション）

**UI構成**:
```
┌─────────────────────────────────────┐
│ サイドバー（350px）                   │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━     │
│ 📊 フロー統計                        │
│   - 総フロー数: 1,234件              │
│   - 最大フロー: 東京→神奈川 (456名)   │
│   - 平均移動距離: 45km               │
│                                     │
│ ⚙️ フィルター                        │
│   [最小人数] ▼ 10名以上             │
│   [都道府県] ▼ 全て                 │
│   [流入/流出] ☑流入 ☑流出           │
│                                     │
│ 📍 選択中の自治体                     │
│   【京都市中京区】                   │
│   流入: 3自治体 (120名)              │
│   流出: 5自治体 (85名)               │
│   純流入: +35名                     │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ 地図エリア                           │
│                                     │
│    ↗ 矢印（太さ=人数）                │
│   ●━━━━━━━━━━━━━━━●                 │
│  京都      →        大阪             │
│   ●━━━━━━━━━━━━━━━●                 │
│    ↖ 矢印（破線=流出）                │
│                                     │
│  凡例: ━━ 流入 / - - 流出           │
│        太さ: 50名/100名/200名       │
└─────────────────────────────────────┘
```

**実装優先度**: 🔴 HIGH
**実装難易度**: ⭐⭐⭐⭐ (高)
**ビジネス価値**: 人材獲得競争の可視化、採用エリア戦略立案

---

### 【優先度 🔴 HIGH】Phase 7人材供給密度マップ

#### 機能名: `SupplyDensityMap.html`

**概要**: 市区町村ごとの人材供給密度を色分けコロプレスマップで表示

**データソース**:
- Phase7_SupplyDensity.csv
  - 市区町村、求職者数、資格保有率、平均年齢、緊急度、総合スコア、ランク

**主要機能**:
1. **コロプレスマップ**: 自治体境界を総合スコア/ランクで色分け
2. **多指標切り替え**: 求職者数 / 資格保有率 / 平均年齢 / 緊急度 / 総合スコア
3. **ランク別表示**: S/A/B/C/Dランクを異なる色で表示
4. **ホバー詳細**: マウスオーバーで詳細ポップアップ
5. **絞り込み**: ランク指定、人数範囲指定

**技術スタック**:
- Leaflet.js + GeoJSON（自治体境界）
- 自治体境界データ: 国土数値情報（市区町村ポリゴン）

**UI構成**:
```
┌─────────────────────────────────────┐
│ サイドバー（350px）                   │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━     │
│ 🎨 表示指標                          │
│   ◉ 総合スコア                       │
│   ○ 求職者数                         │
│   ○ 資格保有率                       │
│   ○ 平均年齢                         │
│   ○ 緊急度                           │
│                                     │
│ 📊 ランク分布                        │
│   S: ██████ 12自治体                │
│   A: ██████████ 25自治体            │
│   B: ████████████ 35自治体          │
│   C: ████ 10自治体                  │
│   D: ██ 5自治体                     │
│                                     │
│ ⚙️ フィルター                        │
│   [ランク] ☑S ☑A ☑B ☑C ☑D          │
│   [求職者数] 10名以上                │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ 地図エリア（コロプレスマップ）          │
│                                     │
│     ┌──────┐                        │
│     │ 京都市│ ← Sランク（濃い緑）       │
│     └──────┘                        │
│   ┌────┐                            │
│   │大阪市│ ← Aランク（緑）            │
│   └────┘                            │
│                                     │
│  凡例: S（濃緑） A（緑） B（黄）       │
│        C（橙） D（赤）               │
└─────────────────────────────────────┘
```

**実装優先度**: 🔴 HIGH
**実装難易度**: ⭐⭐⭐⭐⭐ (最高 - GeoJSONデータ準備必要)
**ビジネス価値**: 採用しやすさの一目瞭然化、エリア戦略立案

---

### 【優先度 🟡 MEDIUM】Phase 10緊急度マップ

#### 機能名: `UrgencyMap.html`

**概要**: 市町村別の転職緊急度を色分け表示

**データソース**:
- Phase10_UrgencyByMunicipality.csv
- Phase10_UrgencyAgeCross_ByMunicipality.csv

**主要機能**:
1. **緊急度ヒートマップ**: 緊急度スコアで色分け
2. **年齢層別フィルター**: 20代/30代/40代/50代/60代+
3. **緊急度レベル**: URGENT / HIGH / MEDIUM / LOW
4. **比較モード**: 年齢層AとBを並べて比較表示

**実装優先度**: 🟡 MEDIUM
**実装難易度**: ⭐⭐⭐ (中)
**ビジネス価値**: 即戦力人材の地理的分布把握

---

### 【優先度 🟡 MEDIUM】Phase 3ペルソナレイヤーマップ

#### 機能名: `PersonaLayerMap.html`

**概要**: MapComplete.htmlにペルソナレイヤーを追加

**データソース**:
- Phase1_MapMetrics（基礎）
- Phase3_PersonaByMunicipality（ペルソナ）

**主要機能**:
1. **ペルソナレイヤー切り替え**: 基礎データ / ペルソナA / ペルソナB / ...
2. **ペルソナ別色分け**: 各ペルソナを異なる色のマーカーで表示
3. **市場シェア表示**: ペルソナの市場占有率を円グラフで表示
4. **複数ペルソナ同時表示**: 最大3ペルソナを同時レイヤー表示

**実装優先度**: 🟡 MEDIUM
**実装難易度**: ⭐⭐ (低)
**ビジネス価値**: ターゲット人材の地理分布把握

---

### 【優先度 🟢 LOW】Phase 7移動許容度マップ

#### 機能名: `MobilityRangeMap.html`

**概要**: 個人別の移動可能範囲を円で表示

**データソース**:
- Phase7_MobilityScore.csv (7,390行)

**主要機能**:
1. **移動範囲円表示**: 居住地を中心に最大移動距離kmの円を表示
2. **移動許容度フィルター**: 高/中/低でフィルター
3. **重複エリア分析**: 複数の円が重なるエリア=人材獲得しやすいエリア
4. **希望地カウント**: 希望地数でマーカーサイズ変更

**実装優先度**: 🟢 LOW
**実装難易度**: ⭐⭐⭐ (中)
**ビジネス価値**: 勤務地柔軟性の可視化

---

### 【優先度 🟢 LOW】統合比較マップ

#### 機能名: `ComparisonMap.html`

**概要**: 2つのPhaseを左右分割で並べて比較

**データソース**: 任意の2Phase

**主要機能**:
1. **分割表示**: 左右2つの地図を同期スクロール
2. **Phase選択**: Phase 1-10から2つ選択
3. **差分ハイライト**: 差が大きい地域を強調表示
4. **統計比較表**: サイドバーで統計値を並べて表示

**実装優先度**: 🟢 LOW
**実装難易度**: ⭐⭐⭐ (中)
**ビジネス価値**: データ間の関係性発見

---

## 🛠️ 技術的改善案

### 既存MAP機能の強化

#### MapComplete.htmlの拡張

| # | 改善項目 | 現状 | 改善後 | 難易度 |
|---|---------|------|--------|--------|
| 1 | **データソース拡張** | Phase1のみ | Phase 1,3,7,10を切り替え可能 | ⭐⭐ |
| 2 | **フィルター追加** | 性別、年齢のみ | +資格保有、緊急度、ペルソナ | ⭐⭐ |
| 3 | **検索機能** | なし | 市区町村名で検索→ズーム | ⭐ |
| 4 | **ブックマーク** | なし | 特定地域をブックマーク保存 | ⭐⭐ |
| 5 | **エクスポート** | なし | 表示中のデータをCSVダウンロード | ⭐⭐ |
| 6 | **凡例表示** | 簡易 | 詳細な凡例パネル（折りたたみ可） | ⭐ |
| 7 | **パフォーマンス** | 500件で遅延 | 仮想化でスムーズに1万件表示 | ⭐⭐⭐ |

---

## 📋 実装優先度マトリックス

### 優先度 × 難易度マトリックス

```
難易度
  高 │              │ FlowNetworkMap  │ SupplyDensityMap
     │              │    (Phase 6)    │    (Phase 7)
     │              │                 │
  中 │ PersonaLayer │ UrgencyMap      │
     │  (Phase 3)   │  (Phase 10)     │
     │              │                 │
  低 │ MapComplete  │ MobilityRange   │ ComparisonMap
     │  拡張        │  (Phase 7)      │
     └──────────────┴─────────────────┴──────────────→
        🟢 LOW      🟡 MEDIUM        🔴 HIGH
                      ビジネス価値
```

### 推奨実装順序

| 順位 | 機能名 | Phase | 優先度 | 難易度 | 実装期間 | 累積価値 |
|-----|--------|-------|--------|--------|---------|---------|
| **1** | **FlowNetworkMap** | Phase 6 | 🔴 HIGH | ⭐⭐⭐⭐ | 2-3週間 | ⭐⭐⭐⭐⭐ |
| **2** | **SupplyDensityMap** | Phase 7 | 🔴 HIGH | ⭐⭐⭐⭐⭐ | 3-4週間 | ⭐⭐⭐⭐⭐ |
| **3** | **UrgencyMap** | Phase 10 | 🟡 MEDIUM | ⭐⭐⭐ | 1-2週間 | ⭐⭐⭐⭐ |
| **4** | **MapComplete拡張** | Phase 1 | 🟡 MEDIUM | ⭐⭐ | 1週間 | ⭐⭐⭐⭐ |
| **5** | **PersonaLayerMap** | Phase 3 | 🟡 MEDIUM | ⭐⭐ | 1週間 | ⭐⭐⭐ |
| 6 | MobilityRangeMap | Phase 7 | 🟢 LOW | ⭐⭐⭐ | 1-2週間 | ⭐⭐ |
| 7 | ComparisonMap | 統合 | 🟢 LOW | ⭐⭐⭐ | 1-2週間 | ⭐⭐ |

---

## 🎨 デザインガイドライン

### 統一カラーパレット

```css
/* 基本カラー */
--primary-color: #667eea;       /* メインカラー（紫） */
--secondary-color: #764ba2;     /* サブカラー（濃紫） */
--accent-color: #ffe082;        /* アクセント（金） */

/* ランク別カラー */
--rank-s: #00c853;              /* Sランク（濃緑） */
--rank-a: #64dd17;              /* Aランク（緑） */
--rank-b: #ffd600;              /* Bランク（黄） */
--rank-c: #ff6f00;              /* Cランク（橙） */
--rank-d: #d50000;              /* Dランク（赤） */

/* 緊急度カラー */
--urgency-urgent: #d32f2f;      /* 緊急（赤） */
--urgency-high: #f57c00;        /* 高（橙） */
--urgency-medium: #fbc02d;      /* 中（黄） */
--urgency-low: #388e3c;         /* 低（緑） */

/* ペルソナカラー（最大6ペルソナ） */
--persona-1: #e91e63;           /* ピンク */
--persona-2: #9c27b0;           /* 紫 */
--persona-3: #3f51b5;           /* 青 */
--persona-4: #00bcd4;           /* シアン */
--persona-5: #4caf50;           /* 緑 */
--persona-6: #ff9800;           /* 橙 */
```

### レイアウト標準

```html
<!-- 標準レイアウト構造 -->
<div class="container">
  <div class="sidebar" style="width: 350px;">
    <!-- サイドバー内容 -->
  </div>
  <div class="map-container" style="flex: 1;">
    <div id="map"></div>
  </div>
</div>
```

---

## 📦 必要なリソース

### JavaScript外部ライブラリ

| ライブラリ | 用途 | 必須 | CDN URL |
|-----------|------|------|---------|
| **Leaflet.js** | 地図基盤 | ✅ 必須 | https://unpkg.com/leaflet@1.9.4/ |
| **Leaflet.MarkerCluster** | マーカークラスタリング | ✅ 必須 | https://unpkg.com/leaflet.markercluster@1.5.1/ |
| **Leaflet.Heat** | ヒートマップ | ✅ 必須 | https://unpkg.com/leaflet.heat@0.2.0/ |
| **Leaflet.PolylineDecorator** | 矢印表示 | ⭐ Phase 6用 | https://unpkg.com/leaflet-polylinedecorator/ |
| **D3.js** | フロー計算・アニメーション | ⭐ Phase 6用 | https://d3js.org/d3.v7.min.js |
| **Chart.js** | グラフ表示 | ✅ 必須 | https://cdn.jsdelivr.net/npm/chart.js@3.9.1/ |
| **Turf.js** | 地理空間計算 | ⭐ Phase 7用 | https://unpkg.com/@turf/turf/ |

### GeoJSONデータ

| データ名 | 用途 | ファイルサイズ | 入手元 |
|---------|------|--------------|--------|
| **市区町村境界** | コロプレスマップ | 約50MB | 国土数値情報ダウンロードサービス |
| **都道府県境界** | 広域表示 | 約5MB | 国土数値情報ダウンロードサービス |

**入手方法**:
1. 国土数値情報ダウンロードサービス: https://nlftp.mlit.go.jp/ksj/
2. 「行政区域」→「市区町村」→GeoJSON形式ダウンロード
3. 座標系: WGS84（経緯度）に変換

---

## 🚀 実装ロードマップ

### フェーズ1: 基盤強化（2週間）

**Week 1-2**:
- [ ] MapComplete.htmlのリファクタリング
- [ ] データソース切り替え機能追加（Phase 1→1,3,7,10）
- [ ] フィルター拡張（資格保有、緊急度、ペルソナ）
- [ ] 検索機能実装（市区町村名検索）
- [ ] パフォーマンス最適化（1万件対応）

**成果物**: MapComplete_v2.html

---

### フェーズ2: フロー可視化（3週間）

**Week 3-5**:
- [ ] Phase6データ構造分析
- [ ] Leaflet.PolylineDecorator統合
- [ ] 矢印フロー表示実装
- [ ] アニメーション機能実装
- [ ] フロー強度フィルター実装
- [ ] ノード詳細パネル実装

**成果物**: FlowNetworkMap.html

---

### フェーズ3: 供給密度マップ（4週間）

**Week 6-9**:
- [ ] 市区町村GeoJSONデータ準備
- [ ] Phase7データとGeoJSON紐付け
- [ ] Leafletコロプレスマップ実装
- [ ] ランク別色分けロジック実装
- [ ] 多指標切り替え機能実装
- [ ] ホバー詳細パネル実装

**成果物**: SupplyDensityMap.html

---

### フェーズ4: 緊急度・ペルソナマップ（2週間）

**Week 10-11**:
- [ ] UrgencyMap.html実装（Phase 10）
- [ ] PersonaLayerMap.html実装（Phase 3）
- [ ] 年齢層別フィルター実装
- [ ] ペルソナレイヤー切り替え実装

**成果物**: UrgencyMap.html, PersonaLayerMap.html

---

### フェーズ5: 統合・最適化（1週間）

**Week 12**:
- [ ] 全MAP機能のUI統一
- [ ] パフォーマンステスト・最適化
- [ ] ドキュメント作成
- [ ] E2Eテスト実行

**成果物**: 統合MAP機能ドキュメント

---

## 📊 期待効果

### ビジネス価値

| 効果カテゴリ | 定量効果 | 定性効果 |
|------------|---------|---------|
| **意思決定速度** | データ分析時間 70%削減 | 直感的な地理的理解 |
| **採用戦略** | エリア別ROI可視化 | 効率的なエリアターゲティング |
| **人材発見** | 検索時間 50%削減 | 潜在的人材プールの発見 |
| **競争優位性** | データ活用度 3倍向上 | 高度な分析による差別化 |

### ユーザー体験

| UX指標 | 改善前 | 改善後 | 向上率 |
|--------|--------|--------|--------|
| データ理解時間 | 10分 | 2分 | **80%削減** |
| インタラクティブ性 | 低 | 高 | **300%向上** |
| 視覚的魅力 | 中 | 高 | **150%向上** |
| データ探索深度 | 浅（1層） | 深（3層+） | **300%向上** |

---

## ⚠️ 注意事項・制約

### 技術的制約

1. **Google Maps API制限**
   - 無料枠: 28,500マップロード/月
   - 超過時: $7/1,000リクエスト
   - **対策**: Leaflet.js（無料）をメイン使用

2. **GASファイルサイズ制限**
   - HTML単体: 50KB推奨
   - **対策**: 外部CDNを活用、インラインCSSを最小化

3. **ブラウザパフォーマンス**
   - マーカー1万件以上: 描画遅延
   - **対策**: 仮想化、クラスタリング

### データ品質制約

1. **座標データの精度**
   - ジオコーディングキャッシュ: 1,901件
   - **対策**: 不足分はGoogle Geocoding API補完

2. **市区町村境界データ**
   - GeoJSONファイル: 約50MB
   - **対策**: 簡略化（TopoJSON化）で10MB以下に圧縮

---

## 📚 参考リソース

### ドキュメント

- **Leaflet.js公式**: https://leafletjs.com/
- **Leaflet.PolylineDecorator**: https://github.com/bbecquet/Leaflet.PolylineDecorator
- **D3.js地理空間可視化**: https://d3js.org/d3-geo
- **国土数値情報**: https://nlftp.mlit.go.jp/ksj/

### コード例

- **フロー可視化サンプル**: https://observablehq.com/@d3/flow-map
- **コロプレスマップ**: https://leafletjs.com/examples/choropleth/
- **Leaflet + GeoJSON**: https://leafletjs.com/examples/geojson/

---

## ✅ チェックリスト

### 実装前確認

- [ ] Python出力42ファイルのデータ構造確認
- [ ] GAS側のデータ読み取り関数確認
- [ ] 必要な外部ライブラリCDN確認
- [ ] GeoJSONデータ入手方法確認
- [ ] 既存MAP機能の動作確認

### 実装中確認

- [ ] データ読み込みパフォーマンス（<3秒）
- [ ] 1万件マーカー描画パフォーマンス（<5秒）
- [ ] ブラウザ互換性（Chrome, Edge, Firefox）
- [ ] モバイル対応（レスポンシブ）
- [ ] エラーハンドリング

### 実装後確認

- [ ] E2Eテスト実行
- [ ] ドキュメント更新
- [ ] ユーザーフィードバック収集
- [ ] パフォーマンス計測

---

**プラン作成**: Claude Code
**最終更新**: 2025年11月1日
