# パフォーマンステスト実行ガイド

**バージョン**: 1.0
**作成日**: 2025年11月9日
**対象**: PersonaLevelDataBridge.gs の性能検証

---

## 目次

1. [概要](#概要)
2. [事前準備](#事前準備)
3. [テスト実行手順](#テスト実行手順)
4. [期待される結果](#期待される結果)
5. [結果の解釈](#結果の解釈)
6. [トラブルシューティング](#トラブルシューティング)

---

## 概要

### 目的

PersonaLevelDataBridge.gs（新方式）の性能を包括的に測定し、従来方式（MapCompleteDataBridge.gs）との比較を行います。

### 測定項目

| テスト番号 | テスト名 | 測定対象 | 期待値 |
|-----------|---------|---------|--------|
| テスト1 | データロード時間詳細分析 | getPersonaLevelData() の内訳 | <3秒 |
| テスト2 | 都道府県別ロード時間比較 | 小規模・中規模・大規模の線形性 | 線形的 |
| テスト3 | フィルタリング性能 | 1-4条件でのフィルタリング時間 | <1秒 |
| テスト4 | 集計・分析性能 | summarize, difficulty, ranking | <1秒 |
| テスト5 | メモリ使用量推定 | 京都府・全47都道府県のサイズ | <50MB |
| テスト6 | 従来方式との比較 | 15シート vs 1シート | >85%改善 |
| テスト7 | ボトルネック分析 | I/O vs CPU vs メモリ | I/O<60% |

### テスト環境

- **繰り返し回数**: 5回（平均・中央値・標準偏差を計算）
- **ウォームアップ**: 2回（キャッシュ効果を安定化）
- **対象都道府県**: 鳥取県（小）、京都府（中）、東京都（大）

---

## 事前準備

### 1. データのインポート

以下のシートが存在することを確認してください：

- **PersonaLevel_京都府**（601行 × 43列）
- **PersonaLevel_鳥取県**（50-100行想定）
- **PersonaLevel_東京都**（1,100行想定）

### 2. スクリプトの配置

以下のファイルをGASプロジェクトに追加：

1. **PersonaLevelDataBridge.gs**（テスト対象）
2. **MapCompleteDataBridge.gs**（比較用）
3. **performance_test_comprehensive.js**（テストスクリプト）
4. **generate_performance_report.js**（レポート生成）

### 3. 権限の確認

GASエディタで以下の権限があることを確認：

- Spreadsheet読み取り権限
- Logger書き込み権限
- PropertiesService読み書き権限（キャッシュ機能の場合）

---

## テスト実行手順

### 方法1: 完全自動実行（推奨）

1. GASエディタで `runTestAndGenerateReport()` を開く
2. 実行ボタンをクリック
3. 5-10分待機（全7テスト実行）
4. ログを確認（Markdownレポート出力）

```javascript
// GASエディタで実行
function runTestAndGenerateReport() {
  // 自動実行：テスト → レポート生成
}
```

**出力**:
- **ログ**: Markdown形式のレポート
- **戻り値**: JSON形式の詳細データ

### 方法2: 個別テスト実行

各テストを個別に実行する場合：

```javascript
// テスト1のみ実行
function runTest1Only() {
  const result = test1_DataLoadDetailedAnalysis();
  Logger.log(JSON.stringify(result, null, 2));
}

// テスト6（従来方式比較）のみ実行
function runTest6Only() {
  const result = test6_LegacyComparison();
  Logger.log(JSON.stringify(result, null, 2));
}
```

### 方法3: 完全レポート生成

```javascript
// すべてのテストを実行してレポート生成
function generateFullReport() {
  const report = runComprehensivePerformanceTest();
  const markdown = generateMarkdownReport(report);
  Logger.log(markdown);
}
```

---

## 期待される結果

### テスト1: データロード時間詳細分析

**対象**: 京都府（601行 × 43列）

| 処理 | 期待値 | 許容範囲 |
|------|--------|---------|
| getDataRange() | 0.5秒 | 0.3-0.8秒 |
| getValues() | 1.5秒 | 1.0-2.0秒 |
| オブジェクト配列変換 | 1.0秒 | 0.5-1.5秒 |
| **合計** | **3.0秒** | **2.0-4.0秒** |

**判定基準**:
- ✅ **合格**: 合計 <3秒
- ⚠️ **要注意**: 合計 3-4秒
- ❌ **不合格**: 合計 >4秒

### テスト2: 都道府県別ロード時間比較

| 規模 | 都道府県 | 行数 | 期待時間 | 1行あたり時間 |
|------|---------|------|---------|--------------|
| 小規模 | 鳥取県 | 50-100行 | 0.3-0.6秒 | 3-6ms/行 |
| 中規模 | 京都府 | 601行 | 2.0-3.0秒 | 3-5ms/行 |
| 大規模 | 東京都 | 1,100行 | 3.5-5.0秒 | 3-5ms/行 |

**線形性判定**:
- ✅ **線形**: 1行あたり時間の変動 <50%
- ❌ **非線形**: 1行あたり時間の変動 >50%

### テスト3: フィルタリング性能

| 条件数 | 期待時間 | 許容範囲 |
|--------|---------|---------|
| 0条件（フィルタなし） | 0.1秒 | 0.05-0.2秒 |
| 1条件 | 0.15秒 | 0.1-0.3秒 |
| 2条件 | 0.2秒 | 0.15-0.4秒 |
| 3条件 | 0.25秒 | 0.2-0.5秒 |
| 4条件 | 0.3秒 | 0.25-0.6秒 |

**判定基準**:
- ✅ **高速**: 4条件で <1秒
- ⚠️ **やや遅い**: 4条件で 1-2秒
- ❌ **遅い**: 4条件で >2秒

### テスト4: 集計・分析性能

| 関数 | 期待時間 | 許容範囲 |
|------|---------|---------|
| summarizePersonaLevelData() | 0.3秒 | 0.2-0.5秒 |
| analyzePersonaDifficulty() | 0.4秒 | 0.3-0.6秒 |
| getMunicipalityDifficultyRanking() | 0.5秒 | 0.4-0.8秒 |

**判定基準**:
- ✅ **高速**: すべて <1秒
- ⚠️ **要改善**: 一部 >1秒
- ❌ **遅い**: すべて >1秒

### テスト5: メモリ使用量推定

| 対象 | 期待サイズ | 許容範囲 |
|------|-----------|---------|
| 京都府（601行） | 50KB | 30-100KB |
| 全47都道府県 | 2-3MB | 1-5MB |
| GAS制限に対する使用率 | <5% | <10% |

**判定基準**:
- ✅ **十分な余裕**: 使用率 <50%
- ⚠️ **やや注意**: 使用率 50-80%
- ❌ **不足の可能性**: 使用率 >80%

### テスト6: 従来方式との比較（最重要）

**期待される改善率**: **85-90%**

| 方式 | 期待時間 | 実測目標 |
|------|---------|---------|
| MapCompleteDataBridge（15シート） | 18-21秒 | 実測値A |
| PersonaLevelDataBridge（1シート） | 2-3秒 | 実測値B |
| **改善率** | **85-90%** | (A-B)/A × 100% |

**判定基準**:
- ✅ **EXCELLENT**: 改善率 >85%
- ⚠️ **GOOD**: 改善率 70-85%
- ❌ **POOR**: 改善率 <70%

### テスト7: ボトルネック分析

**期待される内訳**:

| 処理 | 期待割合 | 許容範囲 |
|------|---------|---------|
| I/O（getDataRange + getValues） | 60-70% | 50-80% |
| CPU（オブジェクト変換） | 20-30% | 10-40% |
| その他 | 10-20% | 5-30% |

**ボトルネック判定**:
- ✅ **バランス良好**: I/O <60%, CPU <40%
- ⚠️ **I/Oボトルネック**: I/O >60%
- ⚠️ **CPUボトルネック**: CPU >40%

---

## 結果の解釈

### 合格基準

以下の条件をすべて満たすこと：

1. ✅ **テスト1**: 合計ロード時間 <3秒
2. ✅ **テスト2**: 線形性が確認できる
3. ✅ **テスト3**: 4条件フィルタ <1秒
4. ✅ **テスト4**: すべての集計関数 <1秒
5. ✅ **テスト5**: メモリ使用率 <50%
6. ✅ **テスト6**: 改善率 >85%
7. ✅ **テスト7**: I/O <60%

### 性能評価基準

#### EXCELLENT（優秀）

- テスト6: 改善率 >85%
- テスト1: 合計 <2.5秒
- すべてのテストで期待値以内

#### GOOD（良好）

- テスト6: 改善率 70-85%
- テスト1: 合計 2.5-3.5秒
- 一部テストで期待値超過

#### FAIR（合格）

- テスト6: 改善率 50-70%
- テスト1: 合計 3.5-4.5秒
- 複数テストで期待値超過

#### POOR（要改善）

- テスト6: 改善率 <50%
- テスト1: 合計 >4.5秒
- 大半のテストで期待値超過

### 最適化の優先度

#### 優先度1（HIGH）

- **条件**: テスト6の改善率 <70%
- **対策**: システムアーキテクチャの根本的見直し

#### 優先度2（MEDIUM）

- **条件**: テスト1の合計時間 >3秒
- **対策**: getValues()の範囲限定、ScriptCache導入

#### 優先度3（LOW）

- **条件**: テスト3または4の一部で1秒超過
- **対策**: フィルタリングアルゴリズムの最適化

---

## トラブルシューティング

### 問題1: テストがタイムアウトする

**症状**: 6分以内にテストが完了しない

**原因**: データ量が多すぎる、またはGASの制限

**解決策**:
1. テストを分割実行（テスト1-3、テスト4-7）
2. `TEST_CONFIG.iterations` を 5 → 3 に削減
3. 大規模都道府県のテストをスキップ

### 問題2: エラーが発生する

**症状**: `Error: シート「PersonaLevel_京都府」が見つかりません`

**原因**: 必要なシートが存在しない

**解決策**:
1. Pythonで `run_complete_v2_perfect.py` を実行
2. Phase 12-14のCSVをインポート
3. シート名が正しいか確認

### 問題3: 従来方式との比較ができない

**症状**: テスト6でエラー

**原因**: MapCompleteDataBridge.gs がない

**解決策**:
1. MapCompleteDataBridge.gs をGASプロジェクトに追加
2. または、テスト6をスキップ

### 問題4: メモリ不足エラー

**症状**: `Error: Service invoked too many times in a short time`

**原因**: GASのQuota制限

**解決策**:
1. テスト間に `Utilities.sleep(1000)` を追加
2. テストを1日に分けて実行

---

## 補足情報

### テスト実行時間の目安

| テスト | 実行時間 | 備考 |
|--------|---------|------|
| テスト1 | 1-2分 | 5回繰り返し |
| テスト2 | 2-3分 | 3都道府県 × 5回 |
| テスト3 | 2-3分 | 5条件 × 5回 |
| テスト4 | 1-2分 | 3関数 × 5回 |
| テスト5 | <1分 | データサイズ計算のみ |
| テスト6 | 3-5分 | 2方式 × 5回（最も時間がかかる） |
| テスト7 | 1-2分 | テスト1の結果を利用 |
| **合計** | **10-18分** | 全テスト完了まで |

### ログの確認方法

1. GASエディタで「実行ログ」タブを開く
2. または、`Logger.log()` の出力を確認
3. Markdownレポートをコピーしてファイルに保存

### レポートの保存方法

1. GASエディタの実行ログからMarkdownをコピー
2. `PERFORMANCE_TEST_RESULTS.md` として保存
3. または、`PropertiesService` に保存して後で取得

```javascript
// レポートを保存
function saveReportToProperties() {
  const report = runTestAndGenerateReport();
  PropertiesService.getScriptProperties().setProperty(
    'lastPerformanceReport',
    report.markdown
  );
}

// レポートを取得
function getLastReport() {
  const markdown = PropertiesService.getScriptProperties().getProperty('lastPerformanceReport');
  Logger.log(markdown);
}
```

---

## 関連ドキュメント

- **PersonaLevelDataBridge.gs**: 新方式のデータブリッジ実装
- **MapCompleteDataBridge.gs**: 従来方式のデータブリッジ実装
- **performance_test_comprehensive.js**: テストスクリプト本体
- **generate_performance_report.js**: Markdownレポート生成スクリプト

---

**作成者**: Claude Code
**バージョン**: 1.0
**最終更新**: 2025年11月9日
