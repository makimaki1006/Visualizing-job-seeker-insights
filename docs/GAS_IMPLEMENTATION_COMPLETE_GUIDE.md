# GAS実装完全ガイド（最適化版対応）

**バージョン**: 1.0
**最終更新**: 2025年10月26日
**対象**: Phase 1-7の最適化実装済みデータをGASにインポートして可視化する手順

---

## 📋 目次

1. [前提条件](#前提条件)
2. [Level 1: データインポート](#level-1-データインポート)
3. [Level 2: データ検証](#level-2-データ検証)
4. [Level 3: データ可視化](#level-3-データ可視化)
5. [トラブルシューティング](#トラブルシューティング)
6. [FAQ](#faq)

---

## 前提条件

### ✅ Python側の準備完了

以下の手順が完了していることを確認してください：

1. **Pythonスクリプト実行済み**
   ```bash
   cd "C:\Users\fuji1\OneDrive\Pythonスクリプト保管\job_medley_project\python_scripts"
   python run_complete.py
   ```

2. **Phase 1-6のCSVファイル生成確認**
   ```
   data/output/phase1/ に 4ファイル（MapMetrics.csv等）
   data/output/phase2/ に 2ファイル（ChiSquareTests.csv等）
   data/output/phase3/ に 2ファイル（PersonaSummary.csv等）
   data/output/phase6/ に 3ファイル（MunicipalityFlowEdges.csv等）
   ```

3. **Phase 7のCSVファイル生成確認**
   ```
   python_scripts/gas_output_phase7/ に 4-5ファイル
   - SupplyDensityMap.csv
   - AgeGenderCrossAnalysis.csv
   - MobilityScore.csv
   - DetailedPersonaProfile.csv
   - QualificationDistribution.csv（オプション）
   ```

### ✅ GAS側の準備完了

1. **Googleスプレッドシート作成済み**
   - 新しいスプレッドシートを作成
   - URLをコピーして保存

2. **GASスクリプト追加済み**（最低限必要なファイル）
   - `PythonCSVImporter.gs`（Phase 1-6インポート用）
   - `Phase7DataImporter.gs`（Phase 7データインポート基盤）
   - `Phase7HTMLUploader.gs`（Phase 7 HTMLアップロード）
   - `MenuIntegration.gs`または`Phase7CompleteMenuIntegration.gs`（メニュー統合）

3. **HTMLファイル追加済み**
   - `Upload_Enhanced.html`（高速CSVアップロード用）
   - `Phase7Upload.html`（Phase 7アップロード用）

---

## Level 1: データインポート

### 1-1: Phase 1-6データインポート

Phase 1-6のデータをGoogleスプレッドシートにインポートします。

#### **方法A: Python結果CSVを取り込み（推奨）**

**メニューパス**:
```
📊 データ処理 → 🐍 Python連携 → 📥 Python結果CSVを取り込み
```

**手順**:

1. Googleスプレッドシートを開く

2. メニューから選択
   - 「📊 データ処理」をクリック
   - 「🐍 Python連携」にマウスオーバー
   - 「📥 Python結果CSVを取り込み」をクリック

3. **インポート処理開始**
   - GASが自動的に以下のファイルを読み込みます：
     ```
     Phase 1: MapMetrics.csv, Applicants.csv, DesiredWork.csv, AggDesired.csv
     Phase 2: ChiSquareTests.csv, ANOVATests.csv
     Phase 3: PersonaSummary.csv, PersonaDetails.csv
     Phase 6: MunicipalityFlowEdges.csv, MunicipalityFlowNodes.csv, ProximityAnalysis.csv
     ```

4. **処理完了確認**
   - サイドバーに「✅ インポート完了」と表示される
   - 各シートが作成されているか確認

**期待される結果**:
```
シート一覧:
- MapMetrics
- Applicants
- DesiredWork
- AggDesired
- ChiSquareTests
- ANOVATests
- PersonaSummary
- PersonaDetails
- MunicipalityFlowEdges
- MunicipalityFlowNodes
- ProximityAnalysis
```

**データサンプル（MapMetrics.csv）**:
| 都道府県 | 市区町村 | 総希望件数 | lat | lng |
|---------|---------|-----------|-----|-----|
| 宮城県 | 仙台市青葉区 | 1,234 | 38.2682 | 140.8694 |
| 宮城県 | 仙台市宮城野区 | 567 | 38.2585 | 140.9065 |

---

#### **方法B: 高速CSVインポート（生CSVから直接）**

**メニューパス**:
```
📊 データ処理 → ⚡ 高速CSVインポート（推奨）
```

**手順**:

1. メニューから「⚡ 高速CSVインポート（推奨）」をクリック

2. **ファイル選択ダイアログ**が表示される
   - ジョブメドレーからダウンロードした生CSVファイルを選択
   - 例: `統合_求職者情報宮城_介護.csv`

3. **アップロード開始**
   - 「アップロード開始」ボタンをクリック
   - 進捗バーが表示される

4. **処理完了**
   - GAS側で自動処理され、Phase 1-6のシートが生成される

**⚠️ 注意**:
- この方法ではPhase 7データは生成されません
- Phase 7を利用する場合は、方法Aを使用してください

---

### 1-2: Phase 7データインポート

Phase 7の高度分析データをインポートします。**3つの方法**から選択できます。

#### **方法A: HTMLアップロード（最も簡単）✨ 推奨**

**メニューパス**:
```
📊 データ処理 → 📈 Phase 7高度分析 → 📥 データインポート → 📤 HTMLアップロード（最も簡単）
```

**手順**:

1. メニューから「📤 HTMLアップロード（最も簡単）」をクリック

2. **HTMLダイアログが表示される**
   - タイトル: 「Phase 7データアップロード」
   - 5つのファイル選択エリアが表示される

3. **各ファイルをドラッグ&ドロップまたは選択**
   ```
   SupplyDensityMap.csv → 人材供給密度マップ
   QualificationDistribution.csv → 資格別人材分布（オプション）
   AgeGenderCrossAnalysis.csv → 年齢層×性別クロス分析
   MobilityScore.csv → 移動許容度スコアリング
   DetailedPersonaProfile.csv → ペルソナ詳細プロファイル
   ```

4. **「アップロード開始」ボタンをクリック**
   - 各ファイルが順次アップロードされる
   - 進捗状況がリアルタイムで表示される

5. **完了確認**
   - 「✅ すべてのファイルのアップロードが完了しました！」と表示される
   - 「閉じる」ボタンをクリック

**期待される結果**:
```
シート一覧（新規追加）:
- SupplyDensityMap
- QualificationDistribution（オプション）
- AgeGenderCrossAnalysis
- MobilityScore
- DetailedPersonaProfile
```

**データサンプル（SupplyDensityMap.csv）**:
| municipality | totalJobseekers | rank | avgAge | avgQualificationRate |
|-------------|----------------|------|--------|---------------------|
| 仙台市青葉区 | 1,234 | S | 35.2 | 0.85 |
| 仙台市宮城野区 | 567 | A | 32.1 | 0.72 |

---

#### **方法B: クイックインポート（Google Drive）**

**メニューパス**:
```
📊 データ処理 → 📈 Phase 7高度分析 → 📥 データインポート → 🚀 クイックインポート（Google Drive）
```

**前提条件**:
- Google Driveに `gas_output_phase7` フォルダを作成済み
- 5つのCSVファイルをアップロード済み

**手順**:

1. **Google Driveフォルダ作成**
   - Google Driveを開く
   - 新しいフォルダ `gas_output_phase7` を作成

2. **CSVファイルをアップロード**
   - `python_scripts/gas_output_phase7/` フォルダ内の全CSVファイルをドラッグ&ドロップ
   - 5つのファイルがアップロードされることを確認

3. **GASメニューから「🚀 クイックインポート（Google Drive）」を選択**
   - 自動的にGoogle Driveから検索
   - `gas_output_phase7` フォルダが見つかる
   - 全ファイルを自動インポート

4. **完了確認**
   - サイドバーに「✅ インポート完了（5/5ファイル）」と表示される
   - 各シートが作成されているか確認

**⚠️ 注意**:
- フォルダ名は正確に `gas_output_phase7` にしてください
- ファイル名も正確にしてください（大文字小文字区別あり）

---

#### **方法C: 手動インポート（Google Drive）**

**メニューパス**:
```
📊 データ処理 → 📈 Phase 7高度分析 → 📥 データインポート → 📂 Google Driveから自動インポート
```

**手順**:

1. **Google Driveフォルダ選択ダイアログが表示される**
   - 自分のGoogle Drive内のフォルダ一覧が表示される

2. **`gas_output_phase7` フォルダを選択**
   - クリックして選択
   - 「選択」ボタンをクリック

3. **インポート処理開始**
   - GASが自動的にファイルを読み込む
   - 進捗状況が表示される

4. **完了確認**
   - 各シートが作成されているか確認

**比較表（3つの方法）**:

| 方法 | 難易度 | Google Drive必要 | 速度 | 推奨度 |
|-----|--------|-----------------|------|--------|
| **方法A: HTMLアップロード** | ⭐ 簡単 | ❌ 不要 | ⚡ 高速 | ✨ 最推奨 |
| 方法B: クイックインポート | ⭐⭐ 普通 | ✅ 必要 | ⚡ 高速 | 🟢 推奨 |
| 方法C: 手動インポート | ⭐⭐⭐ やや難 | ✅ 必要 | 🐢 普通 | 🟡 非推奨 |

---

## Level 2: データ検証

### 2-1: Phase 1-6データ検証

Phase 1-6のデータが正しくインポートされているか検証します。

#### **データ検証レポート実行**

**メニューパス**:
```
📊 データ処理 → データ管理 → ✅ データ検証レポート
```

**手順**:

1. メニューから「✅ データ検証レポート」をクリック

2. **検証処理開始**
   - 7種類の検証が自動実行される

3. **検証結果表示**
   - サイドバーに検証結果が表示される

**検証項目（7種類）**:

| # | 検証項目 | 合格基準 | 不合格時の対処 |
|---|---------|---------|---------------|
| 1 | **必須シート存在確認** | 11シートすべて存在 | Phase 1-6を再インポート |
| 2 | **空シート検出** | すべてのシートにデータあり | 該当フェーズを再実行 |
| 3 | **必須列存在確認** | すべての必須列が存在 | Python側のデータ生成を確認 |
| 4 | **数値型検証** | 数値列が数値型 | データ型変換エラーを確認 |
| 5 | **座標データ検証** | lat/lng が有効範囲内 | geocache.jsonを確認 |
| 6 | **重複データ検出** | 重複率 < 5% | データクリーニング実行 |
| 7 | **データ整合性チェック** | 外部キー整合性あり | データ生成ロジックを確認 |

**合格例**:
```
✅ データ検証スコア: 100/100点

詳細:
- 必須シート: 11/11シート存在
- 空シート: 0件
- 必須列: すべて存在
- 数値型: すべて正常
- 座標データ: すべて有効範囲内
- 重複データ: 0.5%（許容範囲内）
- データ整合性: 正常
```

**不合格例**:
```
⚠️ データ検証スコア: 78/100点

問題:
- Phase 2: ChiSquareTests.csvが空（BOMのみ5バイト）
- Phase 6: MunicipalityFlowEdges.csvが存在しない

対処方法:
1. python run_complete.py を再実行
2. Phase 1-6を再インポート
```

---

### 2-2: Phase 7データ検証

Phase 7のデータが正しくインポートされているか検証します。

#### **Phase 7アップロード状況確認**

**メニューパス**:
```
📊 データ処理 → 📈 Phase 7高度分析 → 📥 データインポート → ✅ アップロード状況確認
```

**手順**:

1. メニューから「✅ アップロード状況確認」をクリック

2. **ダイアログが表示される**
   - 5つのCSVファイルのアップロード状況が表示される

**確認項目**:

| ファイル名 | 必須/オプション | 期待行数 | 確認内容 |
|-----------|---------------|---------|---------|
| SupplyDensityMap.csv | **必須** | 50-200行 | 市区町村別データ |
| QualificationDistribution.csv | オプション | 5-10行 | 資格レベル別データ |
| AgeGenderCrossAnalysis.csv | **必須** | 10-30行 | 年齢層×性別データ |
| MobilityScore.csv | **必須** | 最大7,390行 | 個人別スコアデータ |
| DetailedPersonaProfile.csv | **必須** | 5-10行 | ペルソナ別データ |

**合格例**:
```
✅ Phase 7データ検証: すべて正常

詳細:
- SupplyDensityMap: 123行（✅）
- QualificationDistribution: 7行（✅）
- AgeGenderCrossAnalysis: 18行（✅）
- MobilityScore: 6,411行（✅）
- DetailedPersonaProfile: 5行（✅）
```

**不合格例**:
```
⚠️ Phase 7データ検証: 2ファイル不足

問題:
- QualificationDistribution: シートなし（オプションなのでOK）
- AgeGenderCrossAnalysis: シートなし（❌ 必須）

対処方法:
1. python run_complete.py を再実行
2. HTMLアップロードで再アップロード
```

---

#### **Phase 7データサマリー確認**

**メニューパス**:
```
📊 データ処理 → 📈 Phase 7高度分析 → 🔧 データ管理 → 📊 データサマリー
```

**手順**:

1. メニューから「📊 データサマリー」をクリック

2. **サマリーダイアログが表示される**
   - 各シートの行数、列数、データ型などが表示される

**サマリー例**:
```
=== Phase 7データサマリー ===

SupplyDensityMap:
  - 行数: 123行
  - 列数: 8列
  - 主要列: municipality, totalJobseekers, rank, avgAge
  - ランク分布: S(12), A(25), B(40), C(30), D(16)

AgeGenderCrossAnalysis:
  - 行数: 18行
  - 列数: 5列
  - 主要列: age_group, male_count, female_count, total
  - 多様性スコア: 0.85（高）

MobilityScore:
  - 行数: 6,411行
  - 列数: 6列
  - 主要列: applicant_id, score, category
  - カテゴリ分布: 高(1,234), 中(3,456), 低(1,721)
```

---

## Level 3: データ可視化

### 3-1: Phase 1-6個別可視化

Phase 1-6のデータを個別に可視化します。

#### **3-1-1: 地図表示（バブルチャート）**

**メニューパス**:
```
📊 データ処理 → 🗺️ 地図表示（バブル）
```

**データソース**: `MapMetrics.csv` (Phase 1)

**表示内容**:
- バブルチャート: 市区町村別の総希望件数
- バブルサイズ: 総希望件数に比例
- 座標: lat/lng（ジオコーディング済み）

**手順**:

1. メニューから「🗺️ 地図表示（バブル）」をクリック

2. **バブルチャートダイアログが表示される**
   - Google Chartsを使用
   - インタラクティブなバブルチャート

3. **バブルにマウスオーバー**
   - 詳細情報がツールチップで表示される
   - 市区町村名、総希望件数、座標

**期待される表示**:
```
[バブルチャート]
- 仙台市青葉区: 大きなバブル（1,234件）
- 仙台市宮城野区: 中サイズバブル（567件）
- 石巻市: 小さなバブル（123件）
```

---

#### **3-1-2: 地図表示（ヒートマップ）**

**メニューパス**:
```
📊 データ処理 → 📍 地図表示（ヒートマップ）
```

**データソース**: `MapMetrics.csv` (Phase 1)

**表示内容**:
- ヒートマップ: 市区町村別の密度
- 色: 希望件数の多さに応じた色分け

**手順**:

1. メニューから「📍 地図表示（ヒートマップ）」をクリック

2. **ヒートマップダイアログが表示される**
   - Google Mapsライブラリを使用
   - 色分けされたヒートマップ

3. **地図をズーム・パン**
   - マウスホイールでズーム
   - ドラッグでパン

---

#### **3-1-3: 統計分析結果**

**メニューパス**:
```
📊 データ処理 → 📈 統計分析・ペルソナ
```

##### **カイ二乗検定結果**

**サブメニュー**: `🔬 カイ二乗検定結果`

**データソース**: `ChiSquareTests.csv` (Phase 2)

**表示内容**:
- テーブル: 検定結果一覧
- 列: feature1, feature2, statistic, p_value, significant

**手順**:

1. メニューから「🔬 カイ二乗検定結果」をクリック

2. **テーブルダイアログが表示される**
   - p値が0.05未満のものは「有意」と表示

**期待される表示**:
```
| feature1 | feature2 | statistic | p_value | significant |
|----------|----------|-----------|---------|-------------|
| 性別 | 希望職種 | 12.34 | 0.001 | Yes |
| 年齢層 | 希望勤務地 | 5.67 | 0.02 | Yes |
```

##### **ANOVA検定結果**

**サブメニュー**: `📊 ANOVA検定結果`

**データソース**: `ANOVATests.csv` (Phase 2)

**表示内容**:
- テーブル: ANOVA検定結果
- 列: feature, f_statistic, p_value, significant

---

#### **3-1-4: ペルソナ分析結果**

##### **ペルソナサマリー**

**メニューパス**:
```
📊 データ処理 → 📈 統計分析・ペルソナ → 👥 ペルソナサマリー
```

**データソース**: `PersonaSummary.csv` (Phase 3)

**表示内容**:
- テーブル: ペルソナ別サマリー
- 列: cluster, count, avg_age, gender_ratio, top_qualification

**手順**:

1. メニューから「👥 ペルソナサマリー」をクリック

2. **サマリーテーブルが表示される**
   - 各ペルソナの特徴が一覧表示される

**期待される表示**:
```
| cluster | count | avg_age | gender_ratio | top_qualification |
|---------|-------|---------|--------------|-------------------|
| 0 | 1,234 | 35.2 | 0.65 (女性優位) | 介護福祉士 |
| 1 | 567 | 42.1 | 0.45 (男性優位) | 無資格 |
```

##### **ペルソナ詳細**

**メニューパス**:
```
📊 データ処理 → 📈 統計分析・ペルソナ → 📋 ペルソナ詳細
```

**データソース**: `PersonaDetails.csv` (Phase 3)

**表示内容**:
- 詳細テーブル: 個人別ペルソナ割り当て
- 列: applicant_id, cluster, distance_to_centroid, top_features

---

##### **ペルソナ難易度確認**

**メニューパス**:
```
📊 データ処理 → 📈 統計分析・ペルソナ → 🎯 ペルソナ難易度確認
```

**データソース**: `PersonaDetails.csv` (Phase 3)

**表示内容**:
- **6軸フィルター**による絞り込み
  1. 性別
  2. 年齢層
  3. 資格レベル
  4. 希望職種
  5. 居住地都道府県
  6. 希望勤務地都道府県
- **難易度スコア**表示（高/中/低）
- **カラーコード**（赤/黄/緑）

**手順**:

1. メニューから「🎯 ペルソナ難易度確認」をクリック

2. **フィルターダイアログが表示される**
   - 6つのドロップダウンメニュー

3. **フィルター条件を設定**
   - 各項目を選択（すべて選択可能）

4. **「検索」ボタンをクリック**
   - 条件に合致するペルソナが表示される
   - 難易度スコアとカラーコードが表示される

**期待される表示**:
```
[検索結果]
- ペルソナ0: 難易度高（🔴 赤）
  - 性別: 女性
  - 年齢層: 30-39歳
  - 資格: 介護福祉士
  - 希望職種: 生活相談員
  - 難易度スコア: 0.85
  - 理由: 資格保有率高、競争度高
```

---

#### **3-1-5: フロー・移動パターン分析**

##### **自治体間フロー分析**

**メニューパス**:
```
📊 データ処理 → 🌊 フロー・移動パターン分析 → 🔀 自治体間フロー分析
```

**データソース**:
- `MunicipalityFlowEdges.csv` (Phase 6)
- `MunicipalityFlowNodes.csv` (Phase 6)

**表示内容**:
- **ネットワークグラフ**（Sankey図）
- ノード: 市区町村
- エッジ: 人材の流れ（居住地 → 希望勤務地）
- エッジ幅: フロー量に比例

**手順**:

1. メニューから「🔀 自治体間フロー分析」をクリック

2. **Sankey図ダイアログが表示される**
   - インタラクティブなフローチャート

3. **フローにマウスオーバー**
   - 詳細情報がツールチップで表示される
   - 始点、終点、フロー量

**期待される表示**:
```
[Sankey図]
仙台市青葉区 ─────────────► 仙台市宮城野区 (123件)
               │
               └───────► 仙台市若林区 (67件)
```

##### **移動パターン分析**

**メニューパス**:
```
📊 データ処理 → 🌊 フロー・移動パターン分析 → 🏘️ 移動パターン分析
```

**データソース**: `ProximityAnalysis.csv` (Phase 6)

**表示内容**:
- **散布図**: 距離 vs フロー量
- **ヒストグラム**: 距離分布
- **統計サマリー**: 平均距離、中央値、標準偏差

**手順**:

1. メニューから「🏘️ 移動パターン分析」をクリック

2. **散布図ダイアログが表示される**
   - 距離（横軸）vs フロー量（縦軸）

3. **プロットにマウスオーバー**
   - 詳細情報が表示される

**期待される表示**:
```
[散布図]
- 近距離（0-10km）: 大量のフロー
- 中距離（10-30km）: 中程度のフロー
- 遠距離（30km以上）: 少量のフロー

[統計サマリー]
- 平均距離: 12.5km
- 中央値: 8.3km
- 標準偏差: 15.2km
```

##### **フロー・移動統合ビュー**

**メニューパス**:
```
📊 データ処理 → 🌊 フロー・移動パターン分析 → 🎯 フロー・移動統合ビュー
```

**表示内容**:
- 自治体間フロー分析 + 移動パターン分析の統合表示
- 2つのタブで切り替え可能

---

### 3-2: Phase 7個別可視化

Phase 7の5つの高度分析機能を個別に可視化します。

#### **3-2-1: 人材供給密度マップ**

**メニューパス**:
```
📊 データ処理 → 📈 Phase 7高度分析 → 📊 個別分析 → 🗺️ 人材供給密度マップ
```

**データソース**: `SupplyDensityMap.csv` (Phase 7)

**表示内容**:
- **バブルチャート**: 市区町村別の総求職者数
- **円グラフ**: ランク別分布（S/A/B/C/D）
- **KPIカード**: 総求職者数、平均資格率、平均年齢、平均緊急度

**手順**:

1. メニューから「🗺️ 人材供給密度マップ」をクリック

2. **ダイアログが表示される**
   - 3つのチャート（バブル、円グラフ、KPI）

3. **インタラクティブ操作**
   - バブルにマウスオーバーで詳細表示
   - 円グラフでランク別割合確認

**期待される表示**:
```
[バブルチャート]
- 仙台市青葉区: 大きなバブル（Sランク、1,234人）
- 仙台市宮城野区: 中サイズバブル（Aランク、567人）

[円グラフ]
- Sランク: 12% (赤)
- Aランク: 25% (オレンジ)
- Bランク: 40% (黄)
- Cランク: 18% (緑)
- Dランク: 5% (青)

[KPIカード]
- 総求職者数: 6,411人
- 平均資格率: 72.5%
- 平均年齢: 35.2歳
- 平均緊急度: 3.8/5
```

---

#### **3-2-2: 資格別人材分布**

**メニューパス**:
```
📊 データ処理 → 📈 Phase 7高度分析 → 📊 個別分析 → 🎓 資格別人材分布
```

**データソース**: `QualificationDistribution.csv` (Phase 7)

**表示内容**:
- **棒グラフ**: 資格レベル別人数
- **円グラフ**: 資格レベル割合
- **詳細表**: 資格別統計

**手順**:

1. メニューから「🎓 資格別人材分布」をクリック

2. **ダイアログが表示される**
   - 棒グラフ + 円グラフ + 詳細表

**期待される表示**:
```
[棒グラフ]
- 無資格: 1,234人（19%）
- 介護職員初任者研修: 2,345人（37%）
- 介護福祉士: 1,567人（24%）
- その他資格: 1,265人（20%）

[詳細表]
| 資格レベル | 人数 | 割合 | 平均年齢 |
|-----------|------|------|---------|
| 無資格 | 1,234 | 19% | 28.5歳 |
| 介護職員初任者研修 | 2,345 | 37% | 32.1歳 |
| 介護福祉士 | 1,567 | 24% | 38.2歳 |
```

**⚠️ 注意**:
- このファイルはオプションです
- 生成されていない場合、メニューは表示されるがエラーメッセージが出ます

---

#### **3-2-3: 年齢層×性別クロス分析**

**メニューパス**:
```
📊 データ処理 → 📈 Phase 7高度分析 → 📊 個別分析 → 👥 年齢層×性別クロス分析
```

**データソース**: `AgeGenderCrossAnalysis.csv` (Phase 7)

**表示内容**:
- **積み上げ棒グラフ**: 年齢層別の性別構成
- **多様性スコア**: 世代・性別の多様性指標
- **詳細表**: 年齢層×性別のクロス集計

**手順**:

1. メニューから「👥 年齢層×性別クロス分析」をクリック

2. **ダイアログが表示される**
   - 積み上げ棒グラフ + 多様性スコア + 詳細表

**期待される表示**:
```
[積み上げ棒グラフ]
20-29歳: [男性: 123人(青)] [女性: 567人(ピンク)]
30-39歳: [男性: 234人(青)] [女性: 789人(ピンク)]
40-49歳: [男性: 345人(青)] [女性: 890人(ピンク)]
...

[多様性スコア]
- 世代多様性: 0.85（高）
- 性別多様性: 0.65（中）
- 総合多様性: 0.75（高）

[詳細表]
| 年齢層 | 男性 | 女性 | 合計 | 女性比率 |
|--------|------|------|------|---------|
| 20-29歳 | 123 | 567 | 690 | 82.2% |
| 30-39歳 | 234 | 789 | 1,023 | 77.1% |
```

---

#### **3-2-4: 移動許容度スコアリング**

**メニューパス**:
```
📊 データ処理 → 📈 Phase 7高度分析 → 📊 個別分析 → 🚗 移動許容度スコアリング
```

**データソース**: `MobilityScore.csv` (Phase 7)

**表示内容**:
- **ヒストグラム**: スコア分布
- **散布図**: 距離 vs スコア
- **円グラフ**: 移動性カテゴリ分布（高/中/低）
- **統計サマリー**: 平均・中央値・標準偏差

**手順**:

1. メニューから「🚗 移動許容度スコアリング」をクリック

2. **ダイアログが表示される**
   - 4つのチャート（ヒストグラム、散布図、円グラフ、サマリー）

**期待される表示**:
```
[ヒストグラム]
スコア0-20: 500人
スコア20-40: 1,200人
スコア40-60: 2,500人
スコア60-80: 1,500人
スコア80-100: 700人

[散布図]
- 近距離（0-10km） + 高スコア（80-100）: 密集
- 遠距離（30km+） + 低スコア（0-20）: 少数

[円グラフ]
- 高移動性（スコア60+）: 35% (緑)
- 中移動性（スコア30-60）: 45% (黄)
- 低移動性（スコア0-30）: 20% (赤)

[統計サマリー]
- 平均スコア: 52.3
- 中央値: 48.5
- 標準偏差: 22.1
```

---

#### **3-2-5: ペルソナ詳細プロファイル**

**メニューパス**:
```
📊 データ処理 → 📈 Phase 7高度分析 → 📊 個別分析 → 📊 ペルソナ詳細プロファイル
```

**データソース**: `DetailedPersonaProfile.csv` (Phase 7)

**表示内容**:
- **レーダーチャート**: 8軸評価（難易度、緊急度、競争度等）
- **ペルソナカード**: トップ5ペルソナの詳細情報
- **カラーコード**: 難易度別色分け（赤/黄/緑）

**手順**:

1. メニューから「📊 ペルソナ詳細プロファイル」をクリック

2. **ダイアログが表示される**
   - レーダーチャート + ペルソナカード

**期待される表示**:
```
[レーダーチャート（ペルソナ0）]
        難易度(0.85)
            /\
           /  \
緊急度(0.72)    競争度(0.68)
     |            |
     |    中心    |
     |            |
移動性(0.45)    資格率(0.92)
           \  /
            \/
        年齢層(0.55)

[ペルソナカード: ペルソナ0]
- 名前: 高資格・都市志向型
- 人数: 1,234人
- 難易度: 🔴 高（0.85）
- 特徴:
  - 資格保有率: 92%
  - 平均年齢: 35.2歳
  - 希望勤務地: 都市部集中
  - 競争度: 高
- 推奨戦略:
  - 高報酬提示
  - キャリアパス明示
  - 福利厚生充実
```

---

### 3-3: Phase 7完全統合ダッシュボード ✨

**メニューパス**:
```
📊 データ処理 → 📈 Phase 7高度分析 → 🎯 完全統合ダッシュボード
```

**表示内容**:
- **6つのタブ**で構成（概要 + 5つの個別分析）
- **遅延ロード**: 表示時のみチャート生成（パフォーマンス最適化）
- **統一デザイン**: グラデーション背景、アイコン統一

**手順**:

1. メニューから「🎯 完全統合ダッシュボード」をクリック

2. **タブ型UIダイアログが表示される**
   - デフォルトは「📋 概要」タブ

3. **各タブをクリック**
   - 📋 概要
   - 🗺️ 人材供給密度
   - 🎓 資格別分布
   - 👥 年齢×性別
   - 🚗 移動許容度
   - 📊 ペルソナ詳細

4. **タブ切り替えでチャート表示**
   - 初回表示時のみチャート生成（高速化）
   - 2回目以降はキャッシュ使用

**期待される表示**:
```
[概要タブ]
- Phase 7データサマリー
- 5つの個別分析へのクイックリンク
- データ品質スコア表示

[個別タブ]
- それぞれの分析内容が表示される
- 3-2-1 〜 3-2-5 の内容と同じ
```

**メリット**:
- 1つのダイアログですべての分析にアクセス
- タブ切り替えで素早く比較可能
- 遅延ロードによる高速表示

---

## トラブルシューティング

### 問題1: Phase 1-6インポートで「ファイルが見つかりません」エラー

**症状**:
```
エラー: MapMetrics.csvが見つかりません
```

**原因**:
- Python側でデータ生成が完了していない
- ファイルパスが間違っている

**解決方法**:

1. **Python側で再実行**
   ```bash
   cd "C:\Users\fuji1\OneDrive\Pythonスクリプト保管\job_medley_project\python_scripts"
   python run_complete.py
   ```

2. **ファイル生成確認**
   ```bash
   # Phase 1
   ls data/output/phase1/
   # 期待: MapMetrics.csv, Applicants.csv, DesiredWork.csv, AggDesired.csv

   # Phase 2
   ls data/output/phase2/
   # 期待: ChiSquareTests.csv, ANOVATests.csv

   # Phase 6
   ls data/output/phase6/
   # 期待: MunicipalityFlowEdges.csv, MunicipalityFlowNodes.csv, ProximityAnalysis.csv
   ```

3. **ファイルサイズ確認**
   - MapMetrics.csv: 20KB以上
   - ChiSquareTests.csv: **691バイト以上**（BOM 5バイトのみはNG）
   - MunicipalityFlowEdges.csv: **152KB以上**（空ファイルはNG）

4. **GAS側で再インポート**
   - メニュー: `📊 データ処理` → `🐍 Python連携` → `📥 Python結果CSVを取り込み`

---

### 問題2: Phase 7インポートで「HTMLファイルが見つかりません」エラー

**症状**:
```
エラー: Phase7Upload.htmlが見つかりません
```

**原因**:
- GASプロジェクトにHTMLファイルが追加されていない

**解決方法**:

1. **GASエディタを開く**
   - Googleスプレッドシート → `拡張機能` → `Apps Script`

2. **HTMLファイルを追加**
   - 左サイドバーの「+」ボタン → `HTML`
   - ファイル名: `Phase7Upload`（拡張子なし）
   - 内容をペースト（gas_files/html/Phase7Upload.html）

3. **保存**
   - Ctrl+S で保存

4. **Spreadsheetをリロード**
   - F5でリロード
   - メニューが再生成される

---

### 問題3: Phase 2データが空（BOM 5バイトのみ）

**症状**:
```
ChiSquareTests.csv: 5バイト（BOMのみ）
ANOVATests.csv: 5バイト（BOMのみ）
```

**原因**:
- タイムアウトによりPhase 2が未実行

**解決方法（最適化版で修正済み）**:

1. **最適化版を確認**
   - `test_phase6_temp.py` に `_haversine_distance_vectorized()` メソッドがあることを確認（lines 1543-1603）
   - `_prepare_phase6_data()` メソッドが最適化版であることを確認（lines 2814-2935）

2. **実行順序を確認**
   - `run_complete.py` でPhase 7がPhase 6より先に実行されることを確認（lines 99-124）

3. **再実行**
   ```bash
   python run_complete.py
   ```

4. **処理時間を確認**
   - 合計処理時間が87秒程度（120秒未満）であることを確認
   - Phase 2が7秒程度で完了することを確認

5. **ファイルサイズを確認**
   - ChiSquareTests.csv: 691バイト以上
   - ANOVATests.csv: 200バイト以上

---

### 問題4: Phase 6データが生成されない

**症状**:
```
gas_output_phase6/ フォルダが空
```

**原因**:
- Phase 6の処理時間が30秒超でタイムアウト

**解決方法（最適化版で修正済み）**:

1. **ベクトル化実装を確認**
   - `test_phase6_temp.py:1543-1603` に `_haversine_distance_vectorized()` があることを確認

2. **ユニークマッピング実装を確認**
   - `_prepare_phase6_data()` 内で `drop_duplicates()` が使われていることを確認

3. **再実行**
   ```bash
   python run_complete.py
   ```

4. **Phase 6処理時間を確認**
   - 39秒程度で完了することを確認（予測1.5-3秒より遅いが、タイムアウトは回避）

5. **ファイル生成確認**
   ```bash
   ls python_scripts/gas_output_phase6/
   # 期待:
   # - MunicipalityFlowEdges.csv (152KB)
   # - MunicipalityFlowNodes.csv (8KB)
   # - ProximityAnalysis.csv (40KB)
   ```

---

### 問題5: データ検証スコアが100点未満

**症状**:
```
データ検証スコア: 78/100点
```

**原因**:
- 一部のデータが不完全

**解決方法**:

1. **検証レポートの詳細を確認**
   - メニュー: `データ管理` → `✅ データ検証レポート`
   - どの検証項目が失敗したか確認

2. **失敗項目別の対処**

   **空シート検出失敗**:
   - 該当フェーズをPython側で再実行
   - ファイルサイズが5バイト（BOMのみ）の場合は最適化版を確認

   **座標データ検証失敗**:
   - geocache.jsonを確認
   - 必要に応じてジオコーディングを再実行

   **重複データ検出失敗**:
   - データクリーニングを実行
   - 重複率が5%超の場合は元データを確認

3. **再検証**
   - データ検証レポートを再実行
   - スコアが100点になることを確認

---

### 問題6: 統合ダッシュボードで「シートが見つかりません」エラー

**症状**:
```
エラー: SupplyDensityMapシートが見つかりません
```

**原因**:
- Phase 7データがインポートされていない

**解決方法**:

1. **Phase 7アップロード状況確認**
   - メニュー: `📈 Phase 7高度分析` → `📥 データインポート` → `✅ アップロード状況確認`

2. **不足シートを確認**
   - 必須4ファイルがすべて存在するか確認
   - QualificationDistribution.csvはオプション

3. **HTMLアップロードで再アップロード**
   - メニュー: `📤 HTMLアップロード（最も簡単）`
   - 5つのCSVファイルをドラッグ&ドロップ

4. **再検証**
   - 統合ダッシュボードを再度開く
   - すべてのタブが表示されることを確認

---

### 問題7: グラフが表示されない

**症状**:
- ダイアログは開くが、グラフが真っ白

**原因**:
- Google Chartsライブラリの読み込み失敗
- ブラウザのポップアップブロック

**解決方法**:

1. **ブラウザをリロード**
   - F5でリロード

2. **ポップアップブロックを無効化**
   - ブラウザ設定でポップアップブロックを無効化
   - Googleスプレッドシートのドメインを許可

3. **ブラウザコンソールを確認**
   - F12でデベロッパーツールを開く
   - Consoleタブでエラーを確認
   - Google Chartsライブラリの読み込みエラーがないか確認

4. **インターネット接続を確認**
   - Google Chartsは外部ライブラリなので、インターネット接続が必要

---

### 問題8: 処理時間が120秒を超える（タイムアウト）

**症状**:
```
処理時間: 125秒（タイムアウト）
Phase 2: データなし
Phase 6: データなし
```

**原因**:
- 最適化版が適用されていない

**解決方法**:

1. **最適化版の確認**
   - `test_phase6_temp.py` の内容を確認
   - `_haversine_distance_vectorized()` メソッドが存在するか（lines 1543-1603）
   - `_prepare_phase6_data()` が最適化版か（lines 2814-2935）

2. **実行順序の確認**
   - `run_complete.py` でPhase 7がPhase 6より先に実行されるか（lines 99-124）

3. **再実行**
   ```bash
   python run_complete.py
   ```

4. **処理時間を測定**
   - 合計処理時間が87秒程度であることを確認
   - 33秒の余裕があることを確認

5. **各フェーズの時間を確認**
   ```
   初期化: 1秒
   データ読み込み: 0秒
   データ処理: 1秒
   Phase 1: 25秒
   Phase 2: 7秒  ← 重要
   Phase 3: 4秒
   Phase 7: 10秒
   Phase 6: 39秒  ← 重要
   合計: 87秒
   ```

---

## FAQ

### Q1: Phase 7のQualificationDistribution.csvが生成されないのですが？

**A**: このファイルはオプションです。資格情報が元データに含まれていない場合、生成されません。

**対処**:
- 資格情報が含まれるCSVファイルを使用する
- または、このファイルなしでも他の4つの分析は実行可能

---

### Q2: 最適化版と旧版の違いは何ですか？

**A**: 主な違いは以下の3点です：

| 項目 | 旧版 | 最適化版 |
|-----|------|---------|
| **Phase 6距離計算** | 22,815回のループ | 1回の配列操作（ベクトル化） |
| **ジオコーディング呼び出し** | 45,630回 | 823回（ユニークマッピング） |
| **実行順序** | Phase 3 → Phase 6 → Phase 7 | Phase 3 → Phase 7 → Phase 6 |
| **Phase 2成功率** | 16.7% (1/6) | 100% (6/6) |
| **Phase 6成功率** | 0% (0/4) | 100% (4/4) |
| **総処理時間** | 120秒超（タイムアウト） | 87秒（33秒余裕） |

---

### Q3: Google Driveを使わずにPhase 7をインポートできますか？

**A**: はい、HTMLアップロード方式を使用してください。

**手順**:
1. メニュー: `📤 HTMLアップロード（最も簡単）`
2. 5つのCSVファイルをドラッグ&ドロップ
3. 「アップロード開始」をクリック

この方法ならGoogle Drive不要です。

---

### Q4: データ検証スコアを100点にするには？

**A**: 以下の手順で100点を達成できます：

1. **Python側で最適化版を実行**
   ```bash
   python run_complete.py
   ```
   - 合計処理時間: 87秒（33秒余裕）
   - すべてのフェーズが完了

2. **Phase 1-6を再インポート**
   - メニュー: `📥 Python結果CSVを取り込み`

3. **Phase 7をHTMLアップロード**
   - メニュー: `📤 HTMLアップロード（最も簡単）`

4. **データ検証実行**
   - メニュー: `✅ データ検証レポート`
   - スコア: 100/100点

---

### Q5: Phase 6の処理が39秒かかるのは正常ですか？

**A**: はい、正常です。

**理由**:
- 予測では1.5-3秒でしたが、実測は39秒でした
- 原因: `_get_coords()` のジオコーディングキャッシュ検索オーバーヘッド（823回 × 25-30ms）
- 結論: **予測より遅いが、すべての目標達成（100%テスト成功、タイムアウト回避）**

**改善の余地**:
- geocache.jsonの検索アルゴリズムを最適化（辞書型に変更）
- `apply()` を `vectorize()` に変更

---

### Q6: 最適化版のコードはどこにありますか？

**A**: 以下のファイルに実装されています：

1. **test_phase6_temp.py**
   - `_haversine_distance_vectorized()` メソッド（lines 1543-1603）
   - `_prepare_phase6_data()` メソッド（最適化版、lines 2814-2935）

2. **run_complete.py**
   - 実行順序の変更（Phase 7 → Phase 6、lines 99-124）

**詳細ドキュメント**:
- [最適化実装ガイド](OPTIMIZATION_IMPLEMENTATION_GUIDE.md)
- [最適化レビューレポート](../gas_test/OPTIMIZATION_REVIEW_REPORT.md)
- [実測改善結果](../gas_test/ACTUAL_IMPROVEMENT_RESULTS.md)

---

### Q7: GASメニューが表示されないのですが？

**A**: 以下の手順でメニューを表示できます：

1. **Spreadsheetをリロード**
   - F5でリロード

2. **GASエディタで手動実行**
   - Googleスプレッドシート → `拡張機能` → `Apps Script`
   - `Phase7CompleteMenuIntegration.gs` を開く
   - `onOpen_Phase7Complete()` 関数を選択
   - 「実行」ボタンをクリック

3. **既存の`onOpen()`を置き換え**
   - `MenuIntegration.gs` の `onOpen()` を削除
   - `Phase7CompleteMenuIntegration.gs` の `onOpen_Phase7Complete()` を `onOpen()` にリネーム

4. **Spreadsheetをリロード**
   - F5でリロード
   - メニューが表示される

---

### Q8: ループ削減98.8%の効果を実感できません

**A**: 処理時間の改善を確認してください：

**確認方法**:
```bash
cd "C:\Users\fuji1\OneDrive\Pythonスクリプト保管\job_medley_project\python_scripts"
python test_run_timed.py
```

**期待される出力**:
```
処理時間サマリー:
  初期化: 1秒
  データ読み込み: 0秒
  データ処理: 1秒
  Phase 1: 25秒
  Phase 2: 7秒
  Phase 3: 4秒
  Phase 7: 10秒
  Phase 6: 39秒

合計処理時間: 87秒
タイムアウト余裕: 33秒 (2分制限)
```

**旧版との比較**:
- 旧版: 120秒超（タイムアウト）
- 最適化版: 87秒（33秒余裕）
- **改善率: 27.5%の高速化**

---

### Q9: テスト成功率100%を達成するには？

**A**: 以下の手順で100%を達成できます：

1. **最適化版を適用**
   - `test_phase6_temp.py` に最適化版コードがあることを確認

2. **Python側で実行**
   ```bash
   python run_complete.py
   ```

3. **E2Eテスト実行**
   ```bash
   python COMPREHENSIVE_TEST_SUITE.py
   ```

**期待される結果**:
```
=== 総合テストサマリー ===
総テスト数: 23件
成功: 23件
失敗: 0件
成功率: 100.00%

フェーズ別成功率:
- Phase 1: 100.00% (4/4)
- Phase 2: 100.00% (6/6)  ← 改善（旧: 16.7%）
- Phase 3: 100.00% (4/4)
- Phase 6: 100.00% (4/4)  ← 改善（旧: 0%）
- 統合: 100.00% (5/5)
```

---

### Q10: 最適化作業のドキュメントはどこにありますか？

**A**: 以下の4つのドキュメントを参照してください：

1. **[最適化実装ガイド](OPTIMIZATION_IMPLEMENTATION_GUIDE.md)**
   - 実装詳細、使用方法、GAS実装手順（MECE構造）
   - このガイドの元となったドキュメント

2. **[最適化レビューレポート](../gas_test/OPTIMIZATION_REVIEW_REPORT.md)**
   - 10回繰り返し多角的レビュー結果
   - コード正確性、パフォーマンス、データ整合性など

3. **[期待改善効果分析](../gas_test/EXPECTED_IMPROVEMENT_ANALYSIS.md)**
   - 予測分析（処理時間、ループ削減、メモリ削減）

4. **[実測改善結果](../gas_test/ACTUAL_IMPROVEMENT_RESULTS.md)**
   - 実際の測定結果と分析
   - 予測との差異分析

---

## まとめ

このガイドでは、Phase 1-7の最適化実装済みデータをGASにインポートして可視化する手順を、MECE構造で網羅的に説明しました。

### 重要なポイント

1. **Level 1（データインポート）**
   - Phase 1-6: Python結果CSVを取り込み（推奨）
   - Phase 7: HTMLアップロード（最も簡単）✨

2. **Level 2（データ検証）**
   - Phase 1-6: データ検証レポート（7種類の検証）
   - Phase 7: アップロード状況確認

3. **Level 3（データ可視化）**
   - Phase 1-6: 11の個別可視化機能
   - Phase 7: 5つの高度分析 + 完全統合ダッシュボード✨

### 次のステップ

1. **最適化版の適用確認**
   - `test_phase6_temp.py` の内容を確認
   - `run_complete.py` の実行順序を確認

2. **Python側で実行**
   ```bash
   python run_complete.py
   ```

3. **GAS側でインポート**
   - Phase 1-6: `📥 Python結果CSVを取り込み`
   - Phase 7: `📤 HTMLアップロード（最も簡単）`

4. **データ検証**
   - `✅ データ検証レポート` で100点確認

5. **可視化**
   - `🎯 完全統合ダッシュボード` で全データを確認

**作成者**: Claude Code
**プロジェクト**: ジョブメドレー求職者データ分析
**バージョン**: 1.0（最適化版対応）
**ステータス**: 本番運用可能 ✅
