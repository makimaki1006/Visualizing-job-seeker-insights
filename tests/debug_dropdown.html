<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒ‡ãƒãƒƒã‚°: ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³çµã‚Šè¾¼ã¿</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  max-width: 800px;
  margin: 40px auto;
  padding: 20px;
}
.debug-section {
  background: #f5f5f5;
  padding: 20px;
  margin: 20px 0;
  border-radius: 8px;
}
select {
  width: 100%;
  padding: 8px;
  margin: 10px 0;
  font-size: 14px;
}
.log {
  background: #1f2937;
  color: #f3f4f6;
  padding: 15px;
  border-radius: 6px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  max-height: 400px;
  overflow-y: auto;
  margin-top: 20px;
}
.log-entry {
  margin: 5px 0;
  padding: 5px;
  border-left: 3px solid #3b82f6;
  padding-left: 10px;
}
.log-entry.error {
  border-left-color: #ef4444;
  color: #fecaca;
}
.log-entry.success {
  border-left-color: #10b981;
  color: #a7f3d0;
}
button {
  background: #3b82f6;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  margin: 10px 5px 10px 0;
}
button:hover {
  background: #2563eb;
}
</style>
</head>
<body>

<h1>ğŸ” ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³çµã‚Šè¾¼ã¿ãƒ‡ãƒãƒƒã‚°</h1>

<div class="debug-section">
  <h2>ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³</h2>
  <label>éƒ½é“åºœçœŒ</label>
  <select id="prefectureSelect">
    <option value="">-- éƒ½é“åºœçœŒã‚’é¸æŠ --</option>
  </select>

  <label>å¸‚åŒºç”ºæ‘</label>
  <select id="municipalitySelect">
    <option value="">-- å¸‚åŒºç”ºæ‘ã‚’é¸æŠ --</option>
  </select>
</div>

<div class="debug-section">
  <h2>ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³</h2>
  <button onclick="loadDummyData()">ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</button>
  <button onclick="testFiltering()">ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ</button>
  <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
</div>

<div class="debug-section">
  <h2>ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹</h2>
  <div id="dataState"></div>
</div>

<div class="log" id="logOutput"></div>

<script>
// ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
let regionOptions = null;
let availableRegions = [];
let selectedPrefecture = '';

const dummyData = {
  "regionOptions": {
    "prefectures": ["äº¬éƒ½åºœ", "å¤§é˜ªåºœ", "æ±äº¬éƒ½"],
    "state": {"prefecture": "äº¬éƒ½åºœ", "municipality": "äº¬éƒ½å¸‚ä¼è¦‹åŒº"}
  },
  "availableRegions": [
    {"key": "kyoto-fushimi", "prefecture": "äº¬éƒ½åºœ", "municipality": "äº¬éƒ½å¸‚ä¼è¦‹åŒº", "label": "äº¬éƒ½åºœ äº¬éƒ½å¸‚ä¼è¦‹åŒº"},
    {"key": "kyoto-nakagyo", "prefecture": "äº¬éƒ½åºœ", "municipality": "äº¬éƒ½å¸‚ä¸­äº¬åŒº", "label": "äº¬éƒ½åºœ äº¬éƒ½å¸‚ä¸­äº¬åŒº"},
    {"key": "osaka-kita", "prefecture": "å¤§é˜ªåºœ", "municipality": "å¤§é˜ªå¸‚åŒ—åŒº", "label": "å¤§é˜ªåºœ å¤§é˜ªå¸‚åŒ—åŒº"},
    {"key": "osaka-chuo", "prefecture": "å¤§é˜ªåºœ", "municipality": "å¤§é˜ªå¸‚ä¸­å¤®åŒº", "label": "å¤§é˜ªåºœ å¤§é˜ªå¸‚ä¸­å¤®åŒº"},
    {"key": "tokyo-shibuya", "prefecture": "æ±äº¬éƒ½", "municipality": "æ¸‹è°·åŒº", "label": "æ±äº¬éƒ½ æ¸‹è°·åŒº"}
  ]
};

function log(message, type = 'info') {
  const logOutput = document.getElementById('logOutput');
  const entry = document.createElement('div');
  entry.className = `log-entry ${type}`;
  const timestamp = new Date().toLocaleTimeString('ja-JP');
  entry.textContent = `[${timestamp}] ${message}`;
  logOutput.appendChild(entry);
  logOutput.scrollTop = logOutput.scrollHeight;
}

function clearLog() {
  document.getElementById('logOutput').innerHTML = '';
  log('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
}

function updateDataState() {
  const stateDiv = document.getElementById('dataState');
  stateDiv.innerHTML = `
    <div style="font-family: monospace; font-size: 13px;">
      <div><strong>regionOptions.prefectures:</strong> ${regionOptions?.prefectures?.join(', ') || 'null'}</div>
      <div><strong>availableRegionsç·æ•°:</strong> ${availableRegions.length}</div>
      <div><strong>selectedPrefecture:</strong> ${selectedPrefecture || 'æœªé¸æŠ'}</div>
    </div>
  `;
}

function loadDummyData() {
  log('ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿é–‹å§‹...');

  regionOptions = dummyData.regionOptions;
  availableRegions = dummyData.availableRegions.slice();

  log(`regionOptions.prefectures: ${regionOptions.prefectures.length}ä»¶`, 'success');
  log(`availableRegions: ${availableRegions.length}ä»¶`, 'success');

  // éƒ½é“åºœçœŒãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’è¨­å®š
  populatePrefectureSelector();

  updateDataState();
}

function populatePrefectureSelector() {
  const prefSel = document.getElementById('prefectureSelect');

  log('éƒ½é“åºœçœŒãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–...');

  let prefectures = [];
  if (regionOptions && Array.isArray(regionOptions.prefectures)) {
    prefectures = regionOptions.prefectures.slice().sort();
    log(`éƒ½é“åºœçœŒãƒªã‚¹ãƒˆï¼ˆregionOptionsã‹ã‚‰ï¼‰: ${prefectures.length}ä»¶`, 'success');
    log(`éƒ½é“åºœçœŒ: ${prefectures.join(', ')}`);
  } else if (availableRegions.length) {
    prefectures = [...new Set(availableRegions.map(r => r.prefecture).filter(Boolean))].sort();
    log(`éƒ½é“åºœçœŒãƒªã‚¹ãƒˆï¼ˆavailableRegionsã‹ã‚‰ï¼‰: ${prefectures.length}ä»¶`, 'success');
  }

  if (prefectures.length) {
    prefSel.innerHTML = '<option value="">-- éƒ½é“åºœçœŒã‚’é¸æŠ --</option>' +
      prefectures.map(pref => `<option value="${pref}">${pref}</option>`).join('');
    log('éƒ½é“åºœçœŒãƒ—ãƒ«ãƒ€ã‚¦ãƒ³è¨­å®šå®Œäº†', 'success');
  } else {
    log('éƒ½é“åºœçœŒãƒªã‚¹ãƒˆãŒç©ºã§ã™', 'error');
  }

  // éƒ½é“åºœçœŒå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
  prefSel.onchange = (e) => {
    const pref = e.target.value;
    selectedPrefecture = pref;
    log(`éƒ½é“åºœçœŒã‚’å¤‰æ›´: ${pref}`);

    if (pref) {
      populateMunicipalitySelector(pref);
    } else {
      document.getElementById('municipalitySelect').innerHTML = '<option value="">-- å¸‚åŒºç”ºæ‘ã‚’é¸æŠ --</option>';
    }

    updateDataState();
  };
}

function populateMunicipalitySelector(prefecture) {
  const muniSel = document.getElementById('municipalitySelect');

  log(`å¸‚åŒºç”ºæ‘ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é–‹å§‹: éƒ½é“åºœçœŒ=${prefecture}`);
  log(`ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‰ã®availableRegions: ${availableRegions.length}ä»¶`);

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  const municipalities = availableRegions
    .filter(r => {
      const match = r.prefecture === prefecture;
      if (!match) {
        log(`  é™¤å¤–: ${r.prefecture} ${r.municipality}`, 'info');
      }
      return match;
    })
    .map(r => ({
      key: r.key,
      municipality: r.municipality || 'å…¨åŸŸ',
      label: r.municipality || 'å…¨åŸŸ'
    }))
    .sort((a, b) => a.municipality.localeCompare(b.municipality, 'ja'));

  log(`ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®å¸‚åŒºç”ºæ‘: ${municipalities.length}ä»¶`, municipalities.length > 0 ? 'success' : 'error');

  if (municipalities.length === 0) {
    muniSel.innerHTML = '<option value="">å¸‚åŒºç”ºæ‘ãªã—</option>';
    log(`${prefecture}ã®å¸‚åŒºç”ºæ‘ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`, 'error');
    return;
  }

  // å¸‚åŒºç”ºæ‘ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’è¨­å®š
  muniSel.innerHTML = municipalities.map(m =>
    `<option value="${m.key}">${m.label}</option>`
  ).join('');

  log(`å¸‚åŒºç”ºæ‘ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³è¨­å®šå®Œäº†: ${municipalities.length}ä»¶`, 'success');
  municipalities.forEach(m => {
    log(`  - ${m.label}`);
  });
}

function testFiltering() {
  log('='.repeat(50));
  log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆé–‹å§‹', 'success');

  if (availableRegions.length === 0) {
    log('å…ˆã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'error');
    return;
  }

  // å„éƒ½é“åºœçœŒã§ãƒ†ã‚¹ãƒˆ
  const prefectures = ['äº¬éƒ½åºœ', 'å¤§é˜ªåºœ', 'æ±äº¬éƒ½'];

  prefectures.forEach(pref => {
    log(`--- ${pref} ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° ---`);
    const filtered = availableRegions.filter(r => r.prefecture === pref);
    log(`çµæœ: ${filtered.length}ä»¶`, filtered.length > 0 ? 'success' : 'error');
    filtered.forEach(r => {
      log(`  - ${r.municipality}`);
    });
  });

  log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
  log('='.repeat(50));
}

// åˆæœŸåŒ–
log('ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«èµ·å‹•', 'success');
log('ã€Œãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
</script>

</body>
</html>
